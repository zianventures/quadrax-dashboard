<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QuadraX Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box}
:root{--bg0:#030810;--bg1:#060f28;--green:#18d18a;--amber:#ffb020;--red:#ff4d4d;--pink:#ff3aa5;--blue:#2b6cff;--purple:#a066ff;--text:#e8efff;--muted:rgba(232,239,255,.68);--sh:0 20px 60px rgba(0,0,0,.65);--sh2:0 10px 32px rgba(0,0,0,.50);--r:22px;--font:"IBM Plex Sans",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;--mono:"IBM Plex Mono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;--night:none}
html,body{height:100%}
body{margin:0;font-family:var(--font);color:var(--text);background:radial-gradient(1400px 800px at 15% 10%,rgba(60,120,255,.18),transparent 55%),radial-gradient(900px 700px at 75% 30%,rgba(20,200,160,.14),transparent 55%),radial-gradient(1000px 800px at 30% 90%,rgba(200,60,160,.10),transparent 60%),linear-gradient(175deg,var(--bg0),var(--bg1));overflow-x:hidden;filter:var(--night);transition:filter .6s}
body.night{--night:brightness(.52) sepia(.12) hue-rotate(-5deg)}
.wrap{max-width:1500px;margin:20px auto 50px;padding:0 14px}
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;border-radius:var(--r);background:linear-gradient(180deg,rgba(43,108,255,.50),rgba(25,70,180,.38));border:1px solid rgba(180,220,255,.16);box-shadow:var(--sh);position:sticky;top:10px;z-index:10;backdrop-filter:blur(14px)}
.brand{display:flex;align-items:center;gap:14px;min-width:250px}
.qxlogo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;font-weight:700;font-family:var(--mono);font-size:12px;background:rgba(8,20,52,.55);border:1px solid rgba(180,220,255,.18);box-shadow:0 0 20px rgba(43,108,255,.25);user-select:none}
.brand h1{margin:0;font-size:16px;font-weight:700;line-height:1.15}
.brand .sub{font-size:10px;color:rgba(255,255,255,.60);margin-top:2px}
.top-actions{display:flex;align-items:center;gap:7px;flex-wrap:wrap;justify-content:flex-end}
.pill{display:flex;align-items:center;gap:7px;padding:6px 11px;border-radius:999px;background:rgba(8,20,52,.38);border:1px solid rgba(180,220,255,.14);color:rgba(255,255,255,.88);font-size:11px;white-space:nowrap;font-family:var(--mono)}
.dot{width:9px;height:9px;border-radius:999px;background:var(--green);box-shadow:0 0 0 4px rgba(24,209,138,.20)}
.dot.amber{background:var(--amber);box-shadow:0 0 0 4px rgba(255,176,32,.20)}
.dot.red{background:var(--red);box-shadow:0 0 0 4px rgba(255,77,77,.20)}
.btn{cursor:pointer;border:1px solid rgba(180,220,255,.16);background:rgba(8,20,52,.38);color:rgba(255,255,255,.90);border-radius:999px;padding:7px 13px;font-weight:600;font-size:11px;font-family:var(--font);box-shadow:0 6px 18px rgba(0,0,0,.28);user-select:none;transition:filter .15s}
.btn:hover{filter:brightness(1.12)}.btn:active{transform:translateY(1px)}
.btn.primary{background:rgba(43,108,255,.32);border-color:rgba(100,160,255,.28)}
.btn.night-active{background:rgba(255,176,32,.22);border-color:rgba(255,176,32,.32)}
.btn.syncing{opacity:.6;cursor:not-allowed}
.syncBadge{display:inline-flex;align-items:center;gap:7px;padding:6px 11px;border-radius:999px;font-size:11px;font-family:var(--mono);white-space:nowrap;border:1px solid;transition:all .4s}
.syncBadge.warming{background:rgba(255,176,32,.15);border-color:rgba(255,176,32,.35);color:rgba(255,200,80,.90)}
.syncBadge.synced{background:rgba(24,209,138,.12);border-color:rgba(24,209,138,.30);color:rgba(24,209,138,.90)}
.syncBadge.fbmaster{background:rgba(43,108,255,.18);border-color:rgba(43,108,255,.40);color:rgba(120,190,255,.95);animation:fbPulse 3s ease infinite}.syncBadge.fbreader{background:rgba(160,100,255,.15);border-color:rgba(160,100,255,.38);color:rgba(180,140,255,.95);animation:fbPulse 2s ease infinite}
@keyframes fbPulse{0%,100%{box-shadow:0 0 0 0 rgba(43,108,255,.20)}50%{box-shadow:0 0 0 5px rgba(43,108,255,0)}}
.alertBadge{display:none;align-items:center;gap:7px;padding:6px 11px;border-radius:999px;background:rgba(255,176,32,.22);border:1px solid rgba(255,176,32,.40);color:#fff;font-size:11px;animation:bpulse 2s ease infinite}
.alertBadge.show{display:flex}
@keyframes bpulse{0%,100%{box-shadow:0 0 0 0 rgba(255,176,32,.25)}50%{box-shadow:0 0 0 6px rgba(255,176,32,0)}}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-top:14px}
@media(max-width:1100px){.grid{grid-template-columns:1fr}.brand{min-width:unset}}
.stack{display:grid;gap:14px}
.card{background:linear-gradient(160deg,rgba(8,20,52,.55),rgba(5,10,24,.38));border:1px solid rgba(180,220,255,.14);border-radius:var(--r);box-shadow:var(--sh2);overflow:hidden}
.card .inner{padding:17px}
.card-title{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:13px}
.card-title h2{margin:0;font-size:11.5px;color:rgba(255,255,255,.78);letter-spacing:1px;text-transform:uppercase;font-weight:700}
.card-title .hint{font-size:11px;color:rgba(255,255,255,.44);text-align:right;max-width:400px;line-height:1.4}
.liveBadge{display:inline-flex;align-items:center;gap:5px;padding:3px 8px;border-radius:999px;font-size:9.5px;font-weight:700;letter-spacing:.5px;font-family:var(--mono);white-space:nowrap}
.liveBadge.live{background:rgba(24,209,138,.12);border:1px solid rgba(24,209,138,.25);color:rgba(24,209,138,.90)}
.liveBadge.stale{background:rgba(255,176,32,.12);border:1px solid rgba(255,176,32,.25);color:rgba(255,176,32,.90)}
.liveBadge.error{background:rgba(255,77,77,.10);border:1px solid rgba(255,77,77,.22);color:rgba(255,77,77,.85)}
.muted{color:var(--muted);font-size:12px}.smallNote{color:rgba(255,255,255,.54);font-size:11px;line-height:1.45}
.pos{color:rgba(24,209,138,.95)}.neg{color:rgba(255,77,77,.95)}
.chipRow{display:flex;gap:7px;flex-wrap:wrap;align-items:center;margin-top:9px;position:relative;z-index:1}
.chip{display:flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;font-size:11px;color:rgba(255,255,255,.84);background:rgba(8,20,52,.32);border:1px solid rgba(180,220,255,.12);white-space:nowrap}
.chip b{font-weight:700;font-family:var(--mono)}
.pillTag{font-family:var(--mono);font-size:10.5px;padding:5px 9px;border-radius:999px;border:1px solid rgba(180,220,255,.12);background:rgba(8,20,52,.22);color:rgba(255,255,255,.78)}
.tagOk{font-family:var(--mono);font-size:10px;padding:3px 7px;border-radius:999px;border:1px solid rgba(180,220,255,.10);background:rgba(8,20,52,.22);color:rgba(255,255,255,.70);white-space:nowrap}
.sdot{width:9px;height:9px;border-radius:999px;background:var(--amber);box-shadow:0 0 0 3px rgba(255,176,32,.18)}
.sdot.live{background:var(--green);box-shadow:0 0 0 3px rgba(24,209,138,.18)}
.sdot.err{background:var(--red);box-shadow:0 0 0 3px rgba(255,77,77,.18)}
.cmsGrid{display:grid;grid-template-columns:1.35fr .95fr;gap:11px}
@media(max-width:900px){.cmsGrid{grid-template-columns:1fr}}
.hero{border-radius:20px;background:radial-gradient(800px 400px at 10% 10%,rgba(100,160,255,.11),transparent 55%),rgba(8,20,52,.20);border:1px solid rgba(180,220,255,.09);padding:15px;position:relative;overflow:hidden}
.stateBig{font-size:32px;font-weight:700;margin:4px 0 2px;position:relative;z-index:1;line-height:1.1}
.tlWrap{margin-top:10px;position:relative;z-index:1}
.tlLabel{font-size:10px;color:rgba(255,255,255,.40);margin-bottom:4px;font-family:var(--mono)}
.tlCanvas{width:100%;height:9px;display:block;border-radius:999px;background:rgba(255,255,255,.05)}
.probBlock{margin-top:12px;padding-top:10px;border-top:1px solid rgba(180,220,255,.07);position:relative;z-index:1}
.probRow{display:grid;grid-template-columns:182px 1fr 48px;gap:9px;align-items:center;padding:6px 0;border-top:1px solid rgba(180,220,255,.05)}
.probRow:first-child{border-top:none}
.probName{font-size:11px;color:rgba(255,255,255,.78);display:flex;align-items:center;gap:8px}
.pdot{width:11px;height:5px;border-radius:999px;flex-shrink:0}
.pbar{height:6px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
.pbar>i{display:block;height:100%;width:0%;border-radius:999px;transition:width .55s ease}
.probVal{font-size:11px;color:rgba(255,255,255,.68);text-align:right;font-family:var(--mono)}
.quoteCard{border-radius:20px;background:rgba(8,20,52,.22);border:1px solid rgba(180,220,255,.10);padding:14px;display:grid;gap:8px}
.quoteTop{display:flex;align-items:center;justify-content:space-between;gap:8px}
.quoteSym .sym{font-weight:700;font-size:11.5px;letter-spacing:.8px;text-transform:uppercase}
.quoteSym .prov{font-size:10px;color:rgba(255,255,255,.48);font-family:var(--mono)}
.qStatus{display:inline-flex;align-items:center;gap:7px;padding:5px 9px;border-radius:999px;border:1px solid rgba(180,220,255,.12);background:rgba(8,20,52,.28);font-size:11px;font-weight:700;font-family:var(--mono);white-space:nowrap}
.quotePx{font-size:34px;font-weight:700;font-variant-numeric:tabular-nums;line-height:1.0;font-family:var(--mono)}
.quoteMetaRow{display:flex;align-items:center;justify-content:space-between;color:rgba(255,255,255,.50);font-size:11px;font-family:var(--mono)}
.sparkBar{height:6px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
.sparkBar>i{display:block;height:100%;width:15%;border-radius:999px;transition:width .4s}
.quoteBadges{display:flex;gap:7px;flex-wrap:wrap}
.fpGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:9px}
@media(max-width:1100px){.fpGrid{grid-template-columns:repeat(2,1fr)}}
.fpBox{border-radius:15px;background:rgba(8,20,52,.22);border:1px solid rgba(180,220,255,.10);padding:12px;min-height:84px;display:grid;gap:4px;align-content:start}
.fpBox .k{font-size:10.5px;color:rgba(255,255,255,.50);text-transform:uppercase;letter-spacing:.6px}
.fpBox .v{font-size:22px;font-weight:700;font-family:var(--mono)}
.fpBox .meta{font-size:10.5px;color:rgba(255,255,255,.50);line-height:1.4}
.fpBox.breach .v{animation:apulse 1.2s ease 3}
@keyframes apulse{0%,100%{opacity:1}50%{opacity:.25;color:var(--amber)}}
.coneWrap{border-radius:16px;background:rgba(8,20,52,.18);border:1px solid rgba(180,220,255,.08);overflow:hidden;margin-top:9px}
canvas{display:block;width:100%}
#coneCanvas{height:220px}
.sessionGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:9px;margin-bottom:10px}
@media(max-width:900px){.sessionGrid{grid-template-columns:1fr 1fr}}
.sessBox{border-radius:14px;background:rgba(8,20,52,.22);border:1px solid rgba(180,220,255,.10);padding:11px;display:grid;gap:3px;align-content:start;transition:border-color .4s,background .4s}
.sName{font-size:10.5px;font-weight:700;letter-spacing:.7px;text-transform:uppercase;font-family:var(--mono)}
.sTime{font-size:10px;color:rgba(255,255,255,.44);font-family:var(--mono)}
.sVol{font-size:10px;color:rgba(255,255,255,.52);margin-top:2px}
.sStat{font-size:9.5px;border-radius:999px;padding:2px 7px;display:inline-block;width:fit-content;margin-top:4px}
.sStat.open{background:rgba(24,209,138,.14);color:var(--green);border:1px solid rgba(24,209,138,.22)}
.sStat.closed{background:rgba(255,255,255,.05);color:rgba(255,255,255,.36);border:1px solid rgba(255,255,255,.07)}
.sStat.overlap{background:rgba(43,108,255,.14);color:rgba(100,180,255,.90);border:1px solid rgba(100,180,255,.22)}
.dayRow{border-radius:14px;background:rgba(8,20,52,.22);border:1px solid rgba(180,220,255,.10);padding:11px;display:flex;align-items:center;justify-content:space-between;gap:11px;flex-wrap:wrap}
.dayBadge{font-family:var(--mono);font-size:10.5px;padding:4px 9px;border-radius:999px;border:1px solid rgba(180,220,255,.14);background:rgba(8,20,52,.22);color:rgba(255,255,255,.76)}
.pb3Dom{border-radius:16px;padding:13px 14px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.pb3Dom .dl{font-size:10px;color:rgba(255,255,255,.52);text-transform:uppercase;letter-spacing:.8px;margin-bottom:3px}
.pb3Dom .ds{font-size:25px;font-weight:700}
.pb3Dom .dn{font-size:11px;color:rgba(255,255,255,.58);max-width:215px;text-align:right;line-height:1.4}
.pb3Grid{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.pb3Box{border-radius:14px;background:rgba(8,20,52,.22);border:1px solid rgba(180,220,255,.10);padding:11px;display:grid;gap:6px}
.pb3Top{display:flex;align-items:center;justify-content:space-between;gap:6px}
.pb3Top .k{font-size:10.5px;color:rgba(255,255,255,.66);font-weight:700}
.pb3Top .pct{font-size:20px;font-weight:700;font-family:var(--mono)}
.pb3Bar{height:6px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
.pb3Bar>i{display:block;height:100%;width:0%;border-radius:999px;transition:width .55s ease}
.pb3Note{font-size:10.5px;color:rgba(255,255,255,.48);line-height:1.4}
.archMain{border-radius:16px;padding:14px;margin-bottom:10px}
.archMain .al{font-size:10.5px;color:rgba(255,255,255,.50);text-transform:uppercase;letter-spacing:.8px;margin-bottom:3px}
.archMain .aType{font-size:21px;font-weight:700;margin-bottom:3px}
.archMain .aConf{font-size:11px;color:rgba(255,255,255,.56)}
.archMain .aBias{font-size:11px;margin-top:6px}
.archMain .aNote{font-size:11px;color:rgba(255,255,255,.58);margin-top:5px;line-height:1.4}
.archMain .aAnalog{font-family:var(--mono);font-size:10px;color:rgba(255,255,255,.40);margin-top:6px;padding-top:6px;border-top:1px solid rgba(180,220,255,.07)}
.sharpeGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:9px;margin-bottom:10px}
@media(max-width:900px){.sharpeGrid{grid-template-columns:repeat(2,1fr)}}
.sharpeBox{border-radius:14px;background:rgba(8,20,52,.22);border:1px solid rgba(180,220,255,.10);padding:11px;display:grid;gap:3px}
.sharpeBox .k{font-size:10.5px;color:rgba(255,255,255,.48);text-transform:uppercase;letter-spacing:.6px}
.sharpeBox .v{font-size:20px;font-weight:700;font-family:var(--mono)}
.sharpeBox .meta{font-size:10px;color:rgba(255,255,255,.44)}
.eqWrap{border-radius:14px;background:rgba(8,20,52,.22);border:1px solid rgba(180,220,255,.10);overflow:hidden}
.eqLabel{padding:8px 12px 3px;font-size:10px;color:rgba(255,255,255,.44);text-transform:uppercase;letter-spacing:.6px}
#equityCanvas{height:62px}
.macroGrid{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.macroBox{border-radius:14px;background:rgba(8,20,52,.22);border:1px solid rgba(180,220,255,.10);padding:11px;min-height:86px;display:grid;align-content:start;gap:4px}
.macroBox .k{font-size:10.5px;color:rgba(255,255,255,.60);display:flex;align-items:center;justify-content:space-between;gap:6px}
.macroBox .v{font-size:18px;font-weight:700;font-family:var(--mono);line-height:1.1}
.macroBox .v.fx{font-size:13px;letter-spacing:.3px}
.macroBox .meta{font-size:10px;color:rgba(255,255,255,.46);font-family:var(--mono);line-height:1.4}
.sparkCanvas{width:100%;height:28px;display:block;border-radius:7px;margin-top:3px;background:rgba(255,255,255,.02)}
.macroHint{font-size:11px;color:rgba(255,255,255,.44);line-height:1.4;text-align:right;max-width:300px}
.tmGrid{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.tmBox{border-radius:14px;background:rgba(8,20,52,.22);border:1px solid rgba(180,220,255,.10);padding:11px;display:grid;gap:6px}
.tmTop{display:flex;align-items:center;justify-content:space-between;gap:6px}
.tmTop .k{font-size:10.5px;color:rgba(255,255,255,.68);line-height:1.2}
.tmTop .pct{font-size:20px;font-weight:700;font-family:var(--mono)}
.tmBar{height:6px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
.tmBar>i{display:block;height:100%;width:0%;border-radius:999px;transition:width .55s ease}
.tmMeta{font-size:10.5px;color:rgba(255,255,255,.48);line-height:1.35}
.riskLevel{text-align:center;padding:20px 14px 16px}
.rlabel{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,.60)}
.rbig{font-size:36px;font-weight:700;margin:5px 0 3px;font-family:var(--mono)}
.rrule{font-size:11px;color:rgba(255,255,255,.56);max-width:300px;margin:0 auto;line-height:1.4}
.corrTable{width:100%;border-collapse:collapse}
.corrTable th{text-align:left;padding:8px 11px;font-size:9.5px;font-weight:700;letter-spacing:.7px;text-transform:uppercase;color:rgba(255,255,255,.60);border-bottom:1px solid rgba(180,220,255,.08);background:rgba(8,20,52,.20)}
.corrTable td{padding:8px 11px;border-bottom:1px solid rgba(180,220,255,.05);font-family:var(--mono);font-size:11px;color:rgba(255,255,255,.76)}
.corrTable tr:hover td{background:rgba(255,255,255,.03)}
.sig2{color:var(--green);font-weight:700}.sig1{color:var(--amber)}.sigNS{color:rgba(255,255,255,.33)}
.corrPos{color:var(--green)}.corrNeg{color:var(--red)}
.txMx{width:100%;border-collapse:collapse}
.txMx th{padding:4px;font-size:8.5px;color:rgba(255,255,255,.50);text-align:center;border-bottom:1px solid rgba(180,220,255,.07);background:rgba(8,20,52,.20);font-family:var(--mono)}
.txMx td{padding:3px 4px;text-align:center;font-family:var(--mono);font-size:9px;border:1px solid rgba(180,220,255,.04)}
.txMx .rl{text-align:left;color:rgba(255,255,255,.55);font-size:8.5px;padding:3px 6px}
.tableWrap{border-radius:14px;background:rgba(8,20,52,.20);border:1px solid rgba(180,220,255,.10);overflow:hidden}
table{width:100%;border-collapse:collapse;font-size:11px}
thead th{text-align:left;padding:9px 11px;color:rgba(255,255,255,.68);border-bottom:1px solid rgba(180,220,255,.08);background:rgba(8,20,52,.22);font-weight:700;letter-spacing:.7px;text-transform:uppercase;font-size:9.5px}
tbody td{padding:8px 11px;border-bottom:1px solid rgba(180,220,255,.05);color:rgba(255,255,255,.76);vertical-align:top;font-variant-numeric:tabular-nums}
tbody tr:hover{background:rgba(255,255,255,.03)}
.scroll{overflow:auto}
.link{color:rgba(100,170,255,.88);text-decoration:none;font-weight:600}.link:hover{text-decoration:underline}
.impact{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;border:1px solid rgba(180,220,255,.12);background:rgba(8,20,52,.22);font-weight:700;font-size:10px;color:rgba(255,255,255,.82);white-space:nowrap}
.folder{width:8px;height:8px;border-radius:3px;background:var(--pink);box-shadow:0 0 0 3px rgba(255,58,165,.14)}
.folder.med{background:var(--amber);box-shadow:0 0 0 3px rgba(255,176,32,.14)}
.folder.low{background:rgba(255,255,255,.25);box-shadow:none}
.tvWrap{border-radius:14px;overflow:hidden;border:1px solid rgba(180,220,255,.10);background:rgba(8,20,52,.20);position:relative}
.tvWrap iframe{width:100%;height:330px;border:0;display:block}
.tvFb{display:none;position:absolute;inset:0;align-items:center;justify-content:center;background:rgba(8,20,52,.88);font-size:12px;color:rgba(255,255,255,.60);text-align:center;gap:8px;flex-direction:column}
.tvFb.show{display:flex}


/* ── DEJA VU ── */
.dvGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
@media(max-width:700px){.dvGrid{grid-template-columns:1fr}}
.dvBox{border-radius:14px;background:rgba(8,20,52,.24);border:1px solid rgba(180,220,255,.09);padding:12px 14px}
.dvBox .dk{font-size:9.5px;color:rgba(255,255,255,.46);text-transform:uppercase;letter-spacing:.7px;margin-bottom:5px}
.dvBox .dv{font-size:20px;font-weight:700;font-family:var(--mono);line-height:1.1}
.dvBox .dm{font-size:10px;color:rgba(255,255,255,.42);margin-top:3px;line-height:1.4}
/* Blend bar */
.blendBar{height:12px;border-radius:7px;background:rgba(180,220,255,.07);overflow:hidden;display:flex;margin:8px 0 4px;position:relative}
.blendTrend{height:100%;background:rgba(43,108,255,.82);border-radius:7px 0 0 7px;transition:width .7s ease}
.blendRevert{height:100%;background:rgba(255,138,64,.82);border-radius:0 7px 7px 0;transition:width .7s ease}
.blendUncert{height:100%;background:rgba(180,220,255,.15)}
.blendLabel{display:flex;justify-content:space-between;font-size:9.5px;color:rgba(255,255,255,.40)}
/* State vector */
.svGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:8px 0}
@media(max-width:600px){.svGrid{grid-template-columns:repeat(2,1fr)}}
.svBox{border-radius:10px;padding:8px 10px;border:1px solid rgba(180,220,255,.07);background:rgba(8,20,52,.20);transition:all .4s ease}
.svBox .sl{font-size:8px;color:rgba(255,255,255,.38);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.svBox .sp{font-size:13px;font-weight:700;font-family:var(--mono)}
.svBox .st{font-size:8.5px;color:rgba(255,255,255,.32);margin-top:2px}
/* Risk throttle meter */
.throttleMeter{height:10px;border-radius:6px;background:rgba(180,220,255,.07);overflow:hidden;margin:7px 0 4px}
.throttleFill{height:100%;border-radius:6px;transition:width .6s ease,background .6s ease}
/* Regime quadrant */
.quadGrid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin:8px 0}
.quadBox{border-radius:12px;padding:10px 12px;border:1px solid;transition:all .5s ease;cursor:default}
.quadBox .ql{font-size:9px;text-transform:uppercase;letter-spacing:.6px;margin-bottom:4px;opacity:.65}
.quadBox .qpct{font-size:18px;font-weight:700;font-family:var(--mono)}
.quadBox .qd{font-size:9.5px;opacity:.55;margin-top:3px}
/* Conditional Sharpe */
.cseRow{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(180,220,255,.06)}
.cseRow:last-child{border-bottom:none}
.cseLabel{font-size:10px;color:rgba(255,255,255,.55);width:120px;flex-shrink:0}
.cseBar{flex:1;height:6px;border-radius:4px;background:rgba(180,220,255,.08);overflow:hidden}
.cseFill{height:100%;border-radius:4px;transition:width .5s ease,background .5s ease}
.cseVal{font-size:11px;font-weight:700;font-family:var(--mono);width:36px;text-align:right;flex-shrink:0}

.teGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
@media(max-width:700px){.teGrid{grid-template-columns:1fr}}
.teBox{border-radius:14px;background:rgba(8,20,52,.24);border:1px solid rgba(180,220,255,.09);padding:12px 14px;transition:border-color .4s}
.teBox .tk{font-size:9px;color:rgba(255,255,255,.42);text-transform:uppercase;letter-spacing:.7px;margin-bottom:4px}
.teBox .tv{font-size:20px;font-weight:700;font-family:var(--mono);line-height:1}
.teBox .tm{font-size:10px;color:rgba(255,255,255,.40);margin-top:3px;line-height:1.4}
.teDivTable{width:100%;border-collapse:collapse;font-size:11px;margin-top:8px}
.teDivTable th{font-size:9px;text-transform:uppercase;letter-spacing:.6px;color:rgba(255,255,255,.38);padding:4px 6px;text-align:left;border-bottom:1px solid rgba(180,220,255,.08)}
.teDivTable td{padding:5px 6px;border-bottom:1px solid rgba(180,220,255,.05);vertical-align:top}
.teDivTable tr:last-child td{border-bottom:none}
.teDivTable .tn{color:rgba(255,255,255,.70)}
.teDivTable .tu{font-family:var(--mono);font-size:10.5px}
.teDivTable .tf{font-family:var(--mono);font-size:10px;color:rgba(255,255,255,.42)}
.teDivTable .tc{font-size:9px}
.divBar{height:10px;border-radius:6px;background:rgba(180,220,255,.07);overflow:hidden;position:relative;margin:8px 0 3px}
.divFillUS{height:100%;border-radius:6px 0 0 6px;background:rgba(43,108,255,.80);transition:width .6s ease;position:absolute;right:50%;transform-origin:right}
.divFillEU{height:100%;border-radius:0 6px 6px 0;background:rgba(255,138,64,.80);transition:width .6s ease;position:absolute;left:50%}
.divMid{position:absolute;left:50%;top:-2px;width:2px;height:14px;background:rgba(255,255,255,.28);transform:translateX(-50%)}
.divLabels{display:flex;justify-content:space-between;font-size:9px;color:rgba(255,255,255,.34)}
.surpriseBar{height:8px;border-radius:5px;background:rgba(180,220,255,.07);overflow:hidden;margin:6px 0 3px}
.surpriseFill{height:100%;border-radius:5px;transition:width .6s ease,background .6s ease}
.teCalItem{padding:7px 0;border-bottom:1px solid rgba(180,220,255,.06)}
.teCalItem:last-child{border-bottom:none}
.teCalTime{font-size:9.5px;font-family:var(--mono);color:rgba(255,255,255,.40)}
.teCalName{font-size:11px;color:rgba(255,255,255,.78);margin:2px 0}
.teCalVals{font-size:9.5px;font-family:var(--mono);color:rgba(255,255,255,.50)}
.teImp{font-size:8px;border-radius:3px;padding:1px 5px;font-weight:600;display:inline-block;margin-left:4px;vertical-align:middle}
.teImp.H{background:rgba(255,77,77,.20);color:rgba(255,100,100,.90)}
.teImp.M{background:rgba(255,176,32,.15);color:rgba(255,176,32,.85)}

/* TE */
.teFrame{width:100%;border:none;border-radius:10px;display:block}
.teBadge{font-size:10px;color:rgba(180,220,255,.55);padding:3px 8px;border-radius:10px;background:rgba(180,220,255,.07);border:1px solid rgba(180,220,255,.12)}
.teBox{border-radius:14px;overflow:hidden;border:1px solid rgba(180,220,255,.09);background:rgba(6,14,38,.50);margin-bottom:10px}
.teBoxTitle{font-size:9.5px;text-transform:uppercase;letter-spacing:.7px;color:rgba(255,255,255,.40);padding:8px 12px 5px;border-bottom:1px solid rgba(180,220,255,.05)}
.teGrid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:800px){.teGrid2{grid-template-columns:1fr}}
.tickChart{width:100%;height:72px;display:block;margin:10px 0 4px;border-radius:8px}
.pricePulse{animation:pPulse .4s ease}
@keyframes pPulse{0%{opacity:.6;transform:scaleX(.99)}100%{opacity:1;transform:scaleX(1)}}
.qeGrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px}
@media(max-width:900px){.qeGrid{grid-template-columns:1fr 1fr}}
.qeBox{border-radius:14px;background:rgba(8,20,52,.24);border:1px solid rgba(180,220,255,.09);padding:12px 14px}
.qeBox .qk{font-size:9.5px;color:rgba(255,255,255,.46);text-transform:uppercase;letter-spacing:.7px;margin-bottom:5px}
.qeBox .qv{font-size:22px;font-weight:700;font-family:var(--mono);line-height:1.1}
.qeBox .qm{font-size:10px;color:rgba(255,255,255,.42);margin-top:3px;line-height:1.4}
.hurstBar{height:6px;border-radius:4px;background:rgba(180,220,255,.10);margin:7px 0 4px;position:relative;overflow:hidden}
.hurstFill{height:100%;border-radius:4px;transition:width .6s ease,background .6s ease}
.hurstTick{position:absolute;top:-2px;width:2px;height:10px;background:rgba(255,255,255,.35);left:50%;transform:translateX(-50%)}
.sigStack{display:flex;gap:7px;flex-wrap:wrap;margin:10px 0 4px}
.sigPill{border-radius:20px;padding:4px 10px;font-size:10px;font-weight:600;display:flex;align-items:center;gap:5px;border:1px solid;cursor:default}
.sigPill.on{background:rgba(24,209,138,.14);border-color:rgba(24,209,138,.35);color:rgba(24,209,138,.92)}
.sigPill.off{background:rgba(180,220,255,.05);border-color:rgba(180,220,255,.10);color:rgba(255,255,255,.32)}
.sigPill.against{background:rgba(255,77,77,.12);border-color:rgba(255,77,77,.30);color:rgba(255,100,100,.80)}
.sigPill .sdot{width:5px;height:5px;border-radius:50%;background:currentColor;display:inline-block}
.kellyBar{height:6px;border-radius:4px;background:rgba(180,220,255,.08);overflow:hidden;margin-top:7px}
.kellyFill{height:100%;border-radius:4px;transition:width .5s ease,background .5s ease}
.histWrap{height:52px;display:flex;align-items:flex-end;gap:1.5px;margin-top:8px;overflow:hidden}
.histBar{flex:1;border-radius:2px 2px 0 0;min-height:2px;transition:height .3s ease}
.convicRow{border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:16px;margin-bottom:12px;transition:border-color .6s ease}
.convicText .ck{font-size:9.5px;color:rgba(255,255,255,.46);text-transform:uppercase;letter-spacing:.7px}
.convicText .cv{font-size:26px;font-weight:700;font-family:var(--mono);line-height:1.1;transition:color .5s ease}
.convicText .cm{font-size:10.5px;color:rgba(255,255,255,.48);margin-top:2px}
.stkBar{height:7px;border-radius:5px;background:rgba(180,220,255,.08);overflow:hidden;margin-top:8px}
.stkFill{height:100%;border-radius:5px;transition:width .6s ease,background .6s ease}
.volRingWrap{width:58px;height:58px;position:relative;flex-shrink:0}
.volRingWrap svg{transform:rotate(-90deg)}
.volRingVal{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:10.5px;font-weight:700;font-family:var(--mono)}
.paGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-bottom:11px}
@media(max-width:900px){.paGrid{grid-template-columns:1fr 1fr}}
.paBox{border-radius:14px;background:rgba(8,20,52,.22);border:1px solid rgba(180,220,255,.10);padding:12px;display:grid;gap:4px}
.paBox .k{font-size:10px;color:rgba(255,255,255,.48);text-transform:uppercase;letter-spacing:.6px}
.paBox .v{font-size:22px;font-weight:700;font-family:var(--mono)}
.paBox .meta{font-size:10px;color:rgba(255,255,255,.44);line-height:1.4}
.paCalibRow{border-radius:14px;padding:11px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.paCalibRow .ck{font-size:10px;color:rgba(255,255,255,.50);text-transform:uppercase;letter-spacing:.6px;margin-bottom:3px}
.paCalibRow .cv{font-size:15px;font-weight:700;font-family:var(--mono)}
.paLog{border-radius:14px;background:rgba(8,20,52,.20);border:1px solid rgba(180,220,255,.10);overflow:hidden;margin-top:9px}
.paLogLabel{padding:7px 12px 4px;font-size:10px;color:rgba(255,255,255,.44);text-transform:uppercase;letter-spacing:.6px}
.paLogTable{width:100%;border-collapse:collapse;font-size:10.5px}
.paLogTable th{text-align:left;padding:6px 10px;color:rgba(255,255,255,.55);border-bottom:1px solid rgba(180,220,255,.07);background:rgba(8,20,52,.22);font-size:9.5px;text-transform:uppercase;letter-spacing:.6px}
.paLogTable td{padding:6px 10px;border-bottom:1px solid rgba(180,220,255,.04);font-family:var(--mono);font-size:10.5px}
.hit{color:var(--green)}.miss{color:var(--red)}.pending{color:rgba(255,255,255,.35)}
.foot{margin-top:10px;display:flex;justify-content:space-between;color:rgba(255,255,255,.40);font-size:10.5px;padding:0 4px;gap:8px;flex-wrap:wrap;font-family:var(--mono)}
.mBack{position:fixed;inset:0;background:rgba(0,0,0,.60);display:none;align-items:center;justify-content:center;z-index:999;padding:16px}
.modal{width:min(960px,100%);border-radius:var(--r);background:linear-gradient(160deg,rgba(10,28,76,.94),rgba(5,8,20,.90));border:1px solid rgba(180,220,255,.16);box-shadow:var(--sh);max-height:90vh;overflow-y:auto}
.mHead{padding:12px 17px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(180,220,255,.10);position:sticky;top:0;background:rgba(10,28,76,.95);z-index:1}
.mHead h3{margin:0;font-size:12px;letter-spacing:.8px;text-transform:uppercase;color:rgba(255,255,255,.80)}
.mBody{padding:14px 17px 18px;display:grid;gap:12px}
textarea{width:100%;min-height:130px;resize:vertical;border-radius:12px;border:1px solid rgba(180,220,255,.14);background:rgba(8,20,52,.38);color:rgba(255,255,255,.88);padding:10px;font-family:var(--mono);font-size:11px;line-height:1.4;outline:none}
.fieldRow{display:grid;grid-template-columns:1fr 1fr;gap:11px}
@media(max-width:900px){.fieldRow{grid-template-columns:1fr}}
.field{border-radius:12px;border:1px solid rgba(180,220,255,.12);background:rgba(8,20,52,.22);padding:11px}
.field label{display:block;font-size:11px;color:rgba(255,255,255,.60);margin-bottom:5px;font-weight:700}
.field input,.field select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid rgba(180,220,255,.14);background:rgba(5,8,20,.42);color:rgba(255,255,255,.90);outline:none;font-family:var(--mono);font-size:11px}
.field select option{background:#060f28}
.syncPanel{border-radius:14px;background:rgba(43,108,255,.08);border:1px solid rgba(43,108,255,.18);padding:12px;display:grid;gap:7px}
.syncPanel .sh{font-size:10.5px;font-weight:700;color:rgba(100,180,255,.90);text-transform:uppercase;letter-spacing:.6px}
.syncPanel .sd{font-size:10.5px;color:rgba(255,255,255,.55);line-height:1.45}
.mActions{display:flex;justify-content:flex-end;gap:9px;flex-wrap:wrap}
.vTag{font-size:10.5px;margin-left:5px}.vTag.ok{color:var(--green)}.vTag.fail{color:var(--red)}
.kbhint{display:none;position:fixed;bottom:16px;right:16px;background:rgba(10,28,76,.94);border:1px solid rgba(180,220,255,.16);border-radius:12px;padding:11px 14px;font-size:11px;color:rgba(255,255,255,.70);z-index:998;line-height:1.75;box-shadow:var(--sh2);min-width:183px;font-family:var(--mono)}
.kbhint.show{display:block}.kbhint b{color:rgba(255,255,255,.90)}
</style>
</head>
<body>
<div class="wrap">
<div class="topbar">
  <div class="brand">
    <div class="qxlogo">4X</div>
    <div><h1>QuadraX Dashboard</h1><div class="sub">HMM &middot; PB3 &middot; Session &middot; Archetype &middot; Corr &middot; Adaptive Projection Learning &mdash; Full Team Sync</div></div>
  </div>
  <div class="top-actions">
    <div class="alertBadge" id="alertBadge">&#9889;<span id="alertBadgeText">Alert</span></div>
    <div class="syncBadge warming" id="syncBadge"><span class="dot amber" id="syncDot"></span><span id="syncText">Warming 0/20</span></div>
    <div class="pill"><span class="dot" id="liveDot"></span><span>LIVE</span></div>
    <div class="pill">&#9201; <b id="lastUpdate">--:--:--</b></div>
    <button class="btn" id="pauseBtn">Pause</button>
    <button class="btn primary" id="syncBtn">Sync</button>
    <button class="btn" id="nightBtn">Night</button>
    <button class="btn primary" id="exportBtn">Export</button>
    <button class="btn" id="settingsBtn">Settings</button>
  </div>
</div>
<div class="grid">
<div class="stack">
  <div class="card"><div class="inner">
    <div class="card-title"><h2>Current Market State &middot; HMM Regime Engine</h2><div class="hint">8-state HMM. Deterministic: same EUR/USD feed = identical state on every device after warmup (~20 ticks). No MASTER required — run standalone or sync via Firebase.</div></div>
    <div class="cmsGrid">
      <div class="hero">
        <div class="stateBig" id="policyStateTitle">Policy State: --</div>
        <div class="muted" id="policyStateDesc" style="position:relative;z-index:1">Warming up engine...</div>
        <div class="chipRow">
          <div class="chip">Det <b id="detectorChip">--</b></div><div class="chip">Policy <b id="policyChip">--</b></div>
          <div class="chip">Conf <b id="confChip">--</b></div><div class="chip">Hyst <b id="hystChip">--</b></div>
          <div class="chip">Age <b id="ageChip">0</b></div><div class="chip">Tick <b id="tickChip">0/20</b></div>
          <span class="pillTag" id="modeTag">Mode: --</span>
        </div>
        <div class="chipRow" style="margin-top:7px">
          <div class="chip">Bias <b id="macroBiasChip">--</b></div><div class="chip">EvRisk <b id="eventRiskChip">--</b></div>
          <div class="chip">Tx <b id="txScoreChip">--</b></div><div class="chip">Mom <b id="momChip">--</b></div>
          <div class="chip">Next <b id="nextStateChip">--</b></div>
        </div>
        <div class="tlWrap"><div class="tlLabel">Regime history &middot; <span id="timelineDepth">0</span> ticks</div><canvas id="timelineCanvas" class="tlCanvas"></canvas></div>
        <div class="probBlock"><div class="muted" style="margin-bottom:7px;font-size:11px">P(state|features) &mdash; HMM emission probs. Softmax T=1.35.</div><div id="probList"></div></div>
      </div>
      <div class="quoteCard">
        <div class="quoteTop">
          <div class="quoteSym"><div class="sym">EUR/USD</div><div class="prov" id="quoteProvider">Provider: --</div></div>
          <div class="qStatus"><span class="sdot" id="fxStatusDot"></span><span id="fxSpotStatus">CHECKING</span></div>
        </div>
        <div class="quotePx" id="fxSpotPrice">--</div>
        <div class="quoteMetaRow"><div>&#916;</div><div id="fxSpotDelta">0.00000</div></div>
        <div class="sparkBar"><i id="miniBar"></i></div>
        <canvas class="tickChart" id="tickChart"></canvas>
        <div class="quoteBadges"><span class="tagOk" id="fxLatencyTag">--</span><span class="tagOk" id="fxLastTag">Last: --</span></div>
        <div class="smallNote" id="fxSpotMeta" style="margin-top:3px">Source: --</div>
      </div>
    </div>
  </div></div>

  <div class="card"><div class="inner">
    <div class="card-title"><h2>D&eacute;j&agrave; Vu &middot; Probabilistic Regime Blending</h2><div class="hint">Renaissance Technologies insight: don&rsquo;t choose trend OR reversion &mdash; probabilistically allocate to each based on regime confidence. The HMM probability vector drives capital weighting. Risk is throttled by regime certainty and volatility state.</div></div>

    <!-- Regime Blend Bar -->
    <div class="dvBox" style="margin-bottom:10px">
      <div class="dk">Regime Signal Allocation &mdash; Trend vs Reversion vs Uncertain</div>
      <div class="blendBar">
        <div class="blendTrend" id="dvTrendBar" style="width:33%"></div>
        <div class="blendRevert" id="dvRevertBar" style="width:33%"></div>
        <div class="blendUncert" id="dvUncertBar" style="width:34%"></div>
      </div>
      <div class="blendLabel">
        <span><span style="color:rgba(43,108,255,.90)">&bull;</span> Trend <span id="dvTrendPct" style="font-family:var(--mono);font-weight:700">--%</span></span>
        <span><span style="color:rgba(255,138,64,.90)">&bull;</span> Reversion <span id="dvRevertPct" style="font-family:var(--mono);font-weight:700">--%</span></span>
        <span><span style="color:rgba(180,220,255,.35)">&bull;</span> Uncertain <span id="dvUncertPct" style="font-family:var(--mono);font-weight:700">--%</span></span>
      </div>
      <div class="dm" id="dvBlendMeta">Blending across all 8 HMM state probabilities</div>
    </div>

    <div class="dvGrid">

      <!-- Active Regime Bucket -->
      <div class="dvBox">
        <div class="dk">Dominant Regime Bucket</div>
        <div class="dv" id="dvBucket">--</div>
        <div class="dm" id="dvBucketMeta">--</div>
        <div style="margin-top:8px">
          <div class="dk">Risk Throttle</div>
          <div class="throttleMeter"><div class="throttleFill" id="dvThrottleFill" style="width:100%;background:rgba(24,209,138,.80)"></div></div>
          <div style="display:flex;justify-content:space-between;font-size:9px;color:rgba(255,255,255,.38)">
            <span id="dvThrottlePct">100%</span><span id="dvThrottleLabel">Full risk</span>
          </div>
        </div>
      </div>

      <!-- Conditional Sharpe Expectations -->
      <div class="dvBox">
        <div class="dk">Conditional Sharpe Expectations by Bucket</div>
        <div id="dvCSE">
          <div class="cseRow"><div class="cseLabel">Trending</div><div class="cseBar"><div class="cseFill" id="cse1f" style="width:75%;background:rgba(43,108,255,.75)"></div></div><div class="cseVal" id="cse1v" style="color:rgba(43,108,255,.90)">--</div></div>
          <div class="cseRow"><div class="cseLabel">Mean-Revert</div><div class="cseBar"><div class="cseFill" id="cse2f" style="width:55%;background:rgba(255,138,64,.75)"></div></div><div class="cseVal" id="cse2v" style="color:rgba(255,138,64,.90)">--</div></div>
          <div class="cseRow"><div class="cseLabel">Dislocation</div><div class="cseBar"><div class="cseFill" id="cse3f" style="width:20%;background:rgba(255,77,77,.75)"></div></div><div class="cseVal" id="cse3v" style="color:rgba(255,77,77,.90)">--</div></div>
          <div class="cseRow"><div class="cseLabel">Uncertain</div><div class="cseBar"><div class="cseFill" id="cse4f" style="width:15%;background:rgba(180,220,255,.35)"></div></div><div class="cseVal" id="cse4v" style="color:rgba(180,220,255,.55)">--</div></div>
        </div>
      </div>

    </div>

    <!-- State Vector (8 buckets mapped) -->
    <div class="dk" style="margin-bottom:6px">State Vector &mdash; HMM Probability &times; Regime Character</div>
    <div class="svGrid" id="dvStateVec">
      <div class="svBox"><div class="sl">S1</div><div class="sp">--</div><div class="st">Mean-Rev</div></div>
    </div>

    <!-- 4 Regime Quadrants -->
    <div class="dk" style="margin:10px 0 6px">Regime Quadrant Allocation</div>
    <div class="quadGrid" id="dvQuadGrid">
      <div class="quadBox" id="dqTrend" style="background:rgba(43,108,255,.08);border-color:rgba(43,108,255,.20)">
        <div class="ql" style="color:rgba(43,108,255,.90)">TRENDING</div>
        <div class="qpct" id="dqTrendPct" style="color:rgba(43,108,255,.95)">--%</div>
        <div class="qd">Momentum persists. Follow. Trail stops.</div>
      </div>
      <div class="quadBox" id="dqRevert" style="background:rgba(255,138,64,.08);border-color:rgba(255,138,64,.20)">
        <div class="ql" style="color:rgba(255,138,64,.90)">MEAN-REVERT</div>
        <div class="qpct" id="dqRevertPct" style="color:rgba(255,138,64,.95)">--%</div>
        <div class="qd">Overshoot. Fade extremes. Tight targets.</div>
      </div>
      <div class="quadBox" id="dqDisloc" style="background:rgba(255,77,77,.08);border-color:rgba(255,77,77,.20)">
        <div class="ql" style="color:rgba(255,77,77,.90)">DISLOCATION</div>
        <div class="qpct" id="dqDislocPct" style="color:rgba(255,77,77,.95)">--%</div>
        <div class="qd">Forced flows. De-risk. Protect capital.</div>
      </div>
      <div class="quadBox" id="dqUncert" style="background:rgba(180,220,255,.04);border-color:rgba(180,220,255,.12)">
        <div class="ql" style="color:rgba(180,220,255,.65)">UNCERTAIN</div>
        <div class="qpct" id="dqUncertPct" style="color:rgba(180,220,255,.80)">--%</div>
        <div class="qd">No clear edge. Reduce size. Wait.</div>
      </div>
    </div>

    <div class="smallNote" style="margin-top:10px;line-height:1.65">
      <b>Renaissance rule:</b> "What is the conditional probability of continuation vs mean reversion given this state vector?" &mdash; Capital allocated <em>proportionally</em> to each regime bucket. Hard switching destroys edge. Blend, weight, throttle.
    </div>
  </div></div>

  <div class="card"><div class="inner">
    <div class="card-title"><h2>Quantitative Edge &middot; Renaissance Signal Engine</h2><div class="hint">Jim Simons / Medallion Fund principles applied live: Hurst exponent determines regime type, autocorrelation reveals serial structure in returns, Kelly criterion gives optimal position sizing, vol regime gates risk. 7 independent signals stacked = conviction score.</div></div>

    <div class="convicRow" id="convicRow" style="background:rgba(8,20,52,.28);border:1px solid rgba(180,220,255,.10)">
      <svg width="72" height="72" viewBox="0 0 72 72" id="convicSvg">
        <circle cx="36" cy="36" r="28" fill="none" stroke="rgba(180,220,255,.08)" stroke-width="7"/>
        <circle cx="36" cy="36" r="28" fill="none" stroke="rgba(24,209,138,.80)" stroke-width="7"
          stroke-dasharray="176" stroke-dashoffset="176" id="convicArc" stroke-linecap="round"
          style="transform:rotate(-90deg);transform-origin:36px 36px;transition:stroke-dashoffset .8s ease,stroke .8s ease"/>
        <text x="36" y="40" text-anchor="middle" font-size="13" font-weight="700"
          font-family="ui-monospace,monospace" fill="rgba(232,239,255,.90)" id="convicPct">0%</text>
      </svg>
      <div class="convicText" style="flex:1">
        <div class="ck">Signal Conviction</div>
        <div class="cv" id="convicLabel">NEUTRAL</div>
        <div class="cm" id="convicDesc">Awaiting data...</div>
        <div class="stkBar"><i id="stkFill" style="display:block;height:100%;width:0%;background:rgba(24,209,138,.82);border-radius:5px;transition:width .6s ease,background .6s ease"></i></div>
      </div>
    </div>

    <div class="qeGrid">

      <div class="qeBox" style="grid-column:1/span 2">
        <div class="qk">Hurst Exponent H &mdash; Rescaled Range (R/S)</div>
        <div style="display:flex;align-items:baseline;gap:10px">
          <div class="qv" id="hurstVal">--</div>
          <div style="font-size:12px;color:rgba(255,255,255,.55);transition:color .4s" id="hurstLabel">Loading...</div>
        </div>
        <div class="hurstBar"><div class="hurstFill" id="hurstFill" style="width:50%"></div><div class="hurstTick"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:8.5px;color:rgba(255,255,255,.28)">
          <span>MEAN-REVERT</span><span>RANDOM (0.5)</span><span>TRENDING</span>
        </div>
        <div class="qm" id="hurstMeta">H&gt;0.55: trend-follow &mdash; H&lt;0.45: fade extremes &mdash; H=0.5: no edge</div>
      </div>

      <div class="qeBox">
        <div class="qk">Vol Regime</div>
        <div style="display:flex;align-items:center;gap:10px;margin-top:4px">
          <div class="volRingWrap">
            <svg width="58" height="58" viewBox="0 0 58 58">
              <circle cx="29" cy="29" r="22" fill="none" stroke="rgba(180,220,255,.08)" stroke-width="6"/>
              <circle cx="29" cy="29" r="22" fill="none" stroke="rgba(24,209,138,.80)" stroke-width="6"
                stroke-dasharray="138" stroke-dashoffset="100" id="volArc" stroke-linecap="round"
                style="transform:rotate(-90deg);transform-origin:29px 29px;transition:stroke-dashoffset .6s ease,stroke .6s ease"/>
            </svg>
            <div class="volRingVal" id="volRatioLbl">--</div>
          </div>
          <div>
            <div class="qv" style="font-size:15px" id="volRegimeLbl">--</div>
            <div class="qm" id="volMeta">Short/long vol ratio</div>
          </div>
        </div>
      </div>

      <div class="qeBox" style="grid-column:1/span 2">
        <div class="qk">Return Autocorrelation AC1&ndash;AC5 &mdash; Serial Structure in Returns</div>
        <div style="display:flex;gap:12px;align-items:flex-start;margin-top:6px">
          <div style="flex:1">
            <div style="height:54px;display:flex;gap:5px;align-items:flex-end;position:relative">
              <div style="position:absolute;top:50%;left:0;right:0;height:1px;background:rgba(180,220,255,.15)"></div>
              <div style="flex:1;height:100%;display:flex;flex-direction:column-reverse">
                <div id="ac1b" style="border-radius:3px;min-height:3px;height:50%;background:rgba(100,160,255,.6);transition:height .4s ease,background .4s ease"></div>
              </div>
              <div style="flex:1;height:100%;display:flex;flex-direction:column-reverse">
                <div id="ac2b" style="border-radius:3px;min-height:3px;height:50%;background:rgba(100,160,255,.6);transition:height .4s ease,background .4s ease"></div>
              </div>
              <div style="flex:1;height:100%;display:flex;flex-direction:column-reverse">
                <div id="ac3b" style="border-radius:3px;min-height:3px;height:50%;background:rgba(100,160,255,.6);transition:height .4s ease,background .4s ease"></div>
              </div>
              <div style="flex:1;height:100%;display:flex;flex-direction:column-reverse">
                <div id="ac4b" style="border-radius:3px;min-height:3px;height:50%;background:rgba(100,160,255,.6);transition:height .4s ease,background .4s ease"></div>
              </div>
              <div style="flex:1;height:100%;display:flex;flex-direction:column-reverse">
                <div id="ac5b" style="border-radius:3px;min-height:3px;height:50%;background:rgba(100,160,255,.6);transition:height .4s ease,background .4s ease"></div>
              </div>
            </div>
            <div style="display:flex;gap:5px;margin-top:3px">
              <div style="flex:1;font-size:8.5px;color:rgba(255,255,255,.35);text-align:center">AC1</div>
              <div style="flex:1;font-size:8.5px;color:rgba(255,255,255,.35);text-align:center">AC2</div>
              <div style="flex:1;font-size:8.5px;color:rgba(255,255,255,.35);text-align:center">AC3</div>
              <div style="flex:1;font-size:8.5px;color:rgba(255,255,255,.35);text-align:center">AC4</div>
              <div style="flex:1;font-size:8.5px;color:rgba(255,255,255,.35);text-align:center">AC5</div>
            </div>
          </div>
          <div style="min-width:130px">
            <div class="qk">AC1 Signal</div>
            <div class="qv" style="font-size:18px" id="ac1Val">--</div>
            <div class="qm" id="acMeta">+ve = momentum; -ve = reversion</div>
          </div>
        </div>
      </div>

      <div class="qeBox">
        <div class="qk">Kelly Criterion f*</div>
        <div class="qv" id="kellyVal">--</div>
        <div class="kellyBar"><div class="kellyFill" id="kellyFill" style="width:0%;background:rgba(24,209,138,.82)"></div></div>
        <div class="qm" id="kellyMeta">Optimal fraction of capital</div>
      </div>

      <div class="qeBox">
        <div class="qk">Signal Half-Life</div>
        <div class="qv" id="halfLifeVal">--</div>
        <div class="qm" id="halfLifeMeta">Ticks before edge decays</div>
      </div>

      <div class="qeBox" style="grid-column:1/span 3">
        <div class="qk">Return Distribution &mdash; Last 40 Ticks (pips) &mdash; Fat Tails = Dislocation Risk</div>
        <div class="histWrap" id="retHistWrap">
          <div class="histBar" style="background:rgba(100,160,255,.35);height:10%"></div>
        </div>
        <div class="qm" id="retHistMeta">Simons: "The tail risk is real. Size for survival."</div>
      </div>

    </div>

    <div class="qk" style="margin-bottom:8px">Independent Signal Alignment &mdash; Medallion Stack</div>
    <div class="sigStack" id="sigStack">
      <div class="sigPill off"><span class="sdot"></span>HMM Regime</div>
    </div>
    <div class="smallNote" style="margin-top:10px;line-height:1.6">
      "We are right 50.75% of the time, but we are right 50.75% of the time on a lot of money. It adds up." &mdash; Jim Simons. Signal stacking edges: each aligned signal independently validates the call.
    </div>
  </div></div>

  <div class="card"><div class="inner">
    <div class="card-title"><h2>Forward Projection &middot; Regime-Conditioned Cone</h2><div class="hint">Cone self-calibrates from historical accuracy. Adaptive multiplier adjusts when range hit rate drifts outside 50-80%.</div></div>
    <div class="fpGrid">
      <div class="fpBox"><div class="k">Trade Bias</div><div class="v" id="tradeBias">--</div><div class="meta" id="tradeBiasMeta">--</div></div>
      <div class="fpBox" id="rng1hBox"><div class="k">Move Range 1h</div><div class="v" id="rng1h">--</div><div class="meta" id="rng1hMeta">--</div></div>
      <div class="fpBox"><div class="k">Move Range 4h</div><div class="v" id="rng4h">--</div><div class="meta" id="rng4hMeta">--</div></div>
      <div class="fpBox"><div class="k">Decision Conf</div><div class="v" id="decConf">--</div><div class="meta" id="decConfMeta">Low agreement</div></div>
    </div>
    <div style="display:flex;gap:9px;margin-top:9px;flex-wrap:wrap">
      <span class="tagOk">Calib x<span id="calibMult">1.00</span></span>
      <span class="tagOk">1h Dir <span id="calib1hDir">--%</span></span>
      <span class="tagOk">1h Rng <span id="calib1hRng">--%</span></span>
      <span class="tagOk">4h Dir <span id="calib4hDir">--%</span></span>
      <span class="tagOk">4h Rng <span id="calib4hRng">--%</span></span>
      <span class="tagOk">n=<span id="calibN">0</span></span>
    </div>
    <div class="coneWrap"><canvas id="coneCanvas"></canvas></div>
    <div class="smallNote" style="margin-top:9px">Cone is a probabilistic range. Not a target price.</div>
  </div></div>

  <div class="card"><div class="inner">
    <div class="card-title"><h2>Session Intelligence &middot; 24h Effect</h2><div class="hint">LDN/NY overlap (12:00&ndash;16:00 UTC) = peak volume. Day-of-week effects empirically documented in EUR/USD.</div></div>
    <div class="sessionGrid">
      <div class="sessBox" id="sb_SYDNEY"><div class="sName" style="color:rgba(255,176,32,.88)">Sydney</div><div class="sTime">21:00&ndash;06:00 UTC</div><div class="sVol">Vol: LOW</div><div class="sStat closed" id="ss_SYDNEY">Closed</div></div>
      <div class="sessBox" id="sb_TOKYO"><div class="sName" style="color:rgba(160,120,255,.88)">Tokyo</div><div class="sTime">00:00&ndash;09:00 UTC</div><div class="sVol">Vol: LOW-MED</div><div class="sStat closed" id="ss_TOKYO">Closed</div></div>
      <div class="sessBox" id="sb_LONDON"><div class="sName" style="color:rgba(24,209,138,.88)">London</div><div class="sTime">07:00&ndash;16:00 UTC</div><div class="sVol">Vol: HIGH</div><div class="sStat closed" id="ss_LONDON">Closed</div></div>
      <div class="sessBox" id="sb_NEW_YORK"><div class="sName" style="color:rgba(43,108,255,.90)">New York</div><div class="sTime">12:00&ndash;21:00 UTC</div><div class="sVol">Vol: HIGH</div><div class="sStat closed" id="ss_NEW_YORK">Closed</div></div>
    </div>
    <div class="dayRow">
      <div><div style="font-size:10.5px;color:rgba(255,255,255,.46);margin-bottom:3px">TODAY</div><div style="font-size:20px;font-weight:700;font-family:var(--mono)" id="currentDayName">--</div><div style="font-size:10.5px;color:rgba(255,255,255,.50);margin-top:3px" id="currentSessionLabel">Session: --</div></div>
      <div style="flex:1;max-width:330px"><div style="font-size:10.5px;color:rgba(255,255,255,.46);margin-bottom:3px">24H EFFECT</div><div class="smallNote" id="dayEffectNote">--</div></div>
      <div><div class="dayBadge" id="sessionOverlapBadge">--</div><div style="font-size:10px;color:rgba(255,255,255,.42);margin-top:5px" id="sessionMinsLeft">--</div></div>
    </div>
  </div></div>

  <div class="card"><div class="inner">
    <div class="card-title"><h2>Projection Accuracy &middot; Adaptive Learning</h2><div class="hint">Every LONG/SHORT call is scored at 1h and 4h. Hit rates drive cone width calibration and bias confidence weighting. Engine self-improves over time.</div></div>
    <div class="paGrid">
      <div class="paBox"><div class="k">1h Direction Hit</div><div class="v" id="pa1hDir">--</div><div class="meta" id="pa1hDirMeta">n=0 scored</div></div>
      <div class="paBox"><div class="k">1h Range Hit</div><div class="v" id="pa1hRng">--</div><div class="meta" id="pa1hRngMeta">Target 60-80%</div></div>
      <div class="paBox"><div class="k">4h Direction Hit</div><div class="v" id="pa4hDir">--</div><div class="meta" id="pa4hDirMeta">n=0 scored</div></div>
      <div class="paBox"><div class="k">4h Range Hit</div><div class="v" id="pa4hRng">--</div><div class="meta" id="pa4hRngMeta">Target 60-80%</div></div>
      <div class="paBox"><div class="k">Calibration Mult</div><div class="v" id="paCalibMult">1.00x</div><div class="meta" id="paCalibMeta">Cone width factor</div></div>
      <div class="paBox"><div class="k">Logged / Resolved</div><div class="v" id="paTotalN">0</div><div class="meta" id="paTotalMeta">0 resolved, 0 pending</div></div>
    </div>
    <div class="paCalibRow" id="paCalibRow" style="background:rgba(8,20,52,.28);border:1px solid rgba(180,220,255,.10)">
      <div><div class="ck">Engine Status</div><div class="cv" id="paStatus">Collecting data...</div></div>
      <div><div class="ck">Cone Adaptation</div><div class="cv" id="paConeAdj">Neutral</div></div>
      <div><div class="ck">Bias Adaptation</div><div class="cv" id="paBiasAdj">Neutral</div></div>
    </div>
    <div class="paLog">
      <div class="paLogLabel">Recent projection log &mdash; last 20 calls</div>
      <div class="scroll" style="max-height:175px"><table class="paLogTable"><thead><tr><th>Time</th><th>Bias</th><th>1h Range</th><th>4h Range</th><th>1h Dir</th><th>1h Rng</th><th>4h Dir</th><th>4h Rng</th></tr></thead><tbody id="paLogBody"></tbody></table></div>
    </div>
    <div class="smallNote" style="margin-top:9px">Scores resolve automatically. 1h outcomes scored at +60min, 4h at +240min. Need 10+ resolved before multiplier adapts.</div>
  </div></div>
  <div class="card"><div class="inner">
    <div class="card-title"><h2>Signal Performance &middot; Rolling Sharpe</h2><div class="hint">Hypothetical P&amp;L on live bias signals. Sharpe annualized. Target 2.5. Needs 20+ closed signals.</div></div>
    <div class="sharpeGrid">
      <div class="sharpeBox"><div class="k">Rolling Sharpe</div><div class="v" id="sharpeVal">--</div><div class="meta" id="sharpeMeta">Target: 2.5</div></div>
      <div class="sharpeBox"><div class="k">Win Rate</div><div class="v" id="winRateVal">--</div><div class="meta" id="winRateMeta">0 signals</div></div>
      <div class="sharpeBox"><div class="k">Open P&amp;L</div><div class="v" id="openPLVal">--</div><div class="meta" id="openPLMeta">--</div></div>
      <div class="sharpeBox"><div class="k">Cum Pips</div><div class="v" id="cumPipsVal">--</div><div class="meta" id="cumPipsMeta">Closed only</div></div>
    </div>
    <div class="eqWrap"><div class="eqLabel">Equity curve &middot; hypothetical live signals only</div><canvas id="equityCanvas"></canvas></div>
    <div class="smallNote" style="margin-top:9px">Production: full backtest, in-sample/OOS split, slippage model, per-regime validation.</div>
  </div></div>

  <div class="card"><div class="inner">
    <div class="card-title"><h2>Daily EUR/USD Trend</h2><div class="hint">TradingView embed. Falls back to direct link if blocked by CSP.</div></div>
    <div class="tvWrap">
      <iframe id="tvFrame" title="TradingView EURUSD" loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="https://s.tradingview.com/widgetembed/?frameElementId=tvchart&symbol=FX%3AEURUSD&interval=D&hidesidetoolbar=1&symboledit=0&saveimage=0&toolbarbg=060f28&studies=%5B%5D&hideideas=1&theme=dark&style=1&locale=en&withdateranges=1&hidevolume=0&allow_symbol_change=0&details=0&hotlist=0&calendar=0"></iframe>
      <div class="tvFb" id="tvFallback"><div>Chart embed unavailable.</div><a class="link" href="https://www.tradingview.com/chart/?symbol=FX%3AEURUSD" target="_blank" rel="noopener noreferrer">Open EUR/USD on TradingView &#8594;</a></div>
    </div>
  </div></div>

  <div class="foot">
    <div>Status: <b id="sysStatus">LIVE</b></div><div>Policy: <b id="footPolicy">--</b></div>
    <div>Detector: <b id="footDetector">--</b></div><div>Age: <b id="footAge">0</b></div>
    <div>Sharpe: <b id="footSharpe">--</b></div>
    <div style="opacity:.40;font-size:10px">P=Pause S=Sync N=Night X=Export ?=Keys</div>
  </div>
</div>
<div class="stack">
  <div class="card"><div class="inner riskLevel"><div class="rlabel">Risk Level</div><div class="rbig" id="riskBig">--</div><div class="rrule" id="riskRule">Policy: state-aware sizing and entry gating</div></div></div>


  <div class="card"><div class="inner">
    <div class="card-title"><h2>Fundamental Divergence &middot; ECB vs Fed</h2><div style="display:flex;align-items:center;gap:8px"><span class="teBadge">TradingEconomics.com</span><div class="hint" style="margin:0;max-width:260px">Rate differential, inflation spread &amp; yield spread &mdash; structural EUR/USD regime drivers.</div></div></div>
    <div class="teGrid2">
      <div class="teBox"><div class="teBoxTitle">&#127482;&#127466; ECB Main Rate</div><iframe class="teFrame" style="min-height:210px" src="https://tradingeconomics.com/embed/?s=eurr002w&v=202410&type=chart&title=ECB+Rate&theme=dark&h=210" loading="lazy"></iframe></div>
      <div class="teBox"><div class="teBoxTitle">&#127482;&#127480; Fed Funds Rate</div><iframe class="teFrame" style="min-height:210px" src="https://tradingeconomics.com/embed/?s=fdtr&v=202410&type=chart&title=Fed+Rate&theme=dark&h=210" loading="lazy"></iframe></div>
      <div class="teBox"><div class="teBoxTitle">&#127482;&#127466; Euro Area CPI YoY</div><iframe class="teFrame" style="min-height:210px" src="https://tradingeconomics.com/embed/?s=eccpiyoy&v=202410&type=chart&title=EA+CPI&theme=dark&h=210" loading="lazy"></iframe></div>
      <div class="teBox"><div class="teBoxTitle">&#127482;&#127480; US CPI YoY</div><iframe class="teFrame" style="min-height:210px" src="https://tradingeconomics.com/embed/?s=cpi+yoy&v=202410&type=chart&title=US+CPI&theme=dark&h=210" loading="lazy"></iframe></div>
      <div class="teBox"><div class="teBoxTitle">&#127465;&#127466; Bund 10Y Yield</div><iframe class="teFrame" style="min-height:210px" src="https://tradingeconomics.com/embed/?s=gdbr10&v=202410&type=chart&title=Bund+10Y&theme=dark&h=210" loading="lazy"></iframe></div>
      <div class="teBox"><div class="teBoxTitle">&#127482;&#127480; UST 10Y Yield</div><iframe class="teFrame" style="min-height:210px" src="https://tradingeconomics.com/embed/?s=usgg10yr&v=202410&type=chart&title=UST+10Y&theme=dark&h=210" loading="lazy"></iframe></div>
    </div>
    <div class="teBox"><div class="teBoxTitle">&#128200; EUR/USD &mdash; TradingEconomics Forecast</div><iframe class="teFrame" style="min-height:250px" src="https://tradingeconomics.com/embed/?s=eurusd&v=202410&type=chart&title=EURUSD&theme=dark&h=250" loading="lazy"></iframe></div>
    <div style="font-size:9px;text-align:right;color:rgba(255,255,255,.22);margin-top:4px">Data: <a href="https://tradingeconomics.com" target="_blank" rel="noopener" style="color:rgba(100,160,255,.45);text-decoration:none">TradingEconomics.com</a></div>
    <div class="smallNote" style="margin-top:8px;line-height:1.65">ECB&minus;Fed rate differential = primary structural EUR/USD driver. Bund&minus;UST yield spread independently confirms or contradicts. Regime: rate compression = range, divergence = trend.</div>
  </div></div>
  <div class="card"><div class="inner">
    <div class="card-title"><h2>PB3 Behavioral Model</h2><div class="hint">Panic &middot; Bubble &middot; Boom &middot; Bust. Humans most predictable under stress.</div></div>
    <div class="pb3Dom" id="pb3Dom" style="background:rgba(8,20,52,.28);border:1px solid rgba(180,220,255,.10)">
      <div><div class="dl">DOMINANT STATE</div><div class="ds" id="pb3DomState">--</div></div>
      <div class="dn" id="pb3DomNote">Waiting for data.</div>
    </div>
    <div class="pb3Grid">
      <div class="pb3Box"><div class="pb3Top"><div class="k" style="color:rgba(255,77,77,.90)">&#9889; PANIC</div><div class="pct" id="pb3PanicPct">0%</div></div><div class="pb3Bar"><i id="pb3PanicBar" style="background:rgba(255,77,77,.80)"></i></div><div class="pb3Note">High vol &middot; fear dominant &middot; capital flight &middot; Short EUR</div></div>
      <div class="pb3Box"><div class="pb3Top"><div class="k" style="color:rgba(255,176,32,.90)">&#128155; BUBBLE</div><div class="pct" id="pb3BubblePct">0%</div></div><div class="pb3Bar"><i id="pb3BubbleBar" style="background:rgba(255,176,32,.80)"></i></div><div class="pb3Note">Euphoric momentum &middot; low vol &middot; extended regime &middot; reversal risk</div></div>
      <div class="pb3Box"><div class="pb3Top"><div class="k" style="color:rgba(24,209,138,.90)">&#128200; BOOM</div><div class="pct" id="pb3BoomPct">0%</div></div><div class="pb3Bar"><i id="pb3BoomBar" style="background:rgba(24,209,138,.80)"></i></div><div class="pb3Note">Directional momentum &middot; MomScore high &middot; trend continuation</div></div>
      <div class="pb3Box"><div class="pb3Top"><div class="k" style="color:rgba(255,138,64,.90)">&#128165; BUST</div><div class="pct" id="pb3BustPct">0%</div></div><div class="pb3Bar"><i id="pb3BustBar" style="background:rgba(255,138,64,.80)"></i></div><div class="pb3Note">Post-boom collapse &middot; vol rising &middot; momentum reversal</div></div>
    </div>
    <div class="smallNote" style="margin-top:9px">Production: add options skew, COT positioning, NLP sentiment feeds.</div>
  </div></div>

  <div class="card"><div class="inner">
    <div class="card-title"><h2>Event Archetype Classifier</h2><div class="hint">Supply Shock vs Risk-Off vs Localized vs Rate Play. Archetype determines which levers dominate EUR/USD.</div></div>
    <div class="archMain" id="archMain" style="background:rgba(8,20,52,.28);border:1px solid rgba(180,220,255,.10)">
      <div class="al">CURRENT ARCHETYPE</div><div class="aType" id="archType">--</div>
      <div class="aConf" id="archConf">Confidence: --</div><div class="aBias" id="archBias">EUR/USD Bias: --</div>
      <div class="aNote" id="archNote">--</div><div class="aAnalog" id="archAnalog">--</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div style="border-radius:12px;background:rgba(255,77,77,.06);border:1px solid rgba(255,77,77,.12);padding:9px"><div style="font-size:9.5px;color:rgba(255,77,77,.78);font-weight:700;margin-bottom:3px">SUPPLY SHOCK</div><div style="font-size:10.5px;color:rgba(255,255,255,.58);line-height:1.4">Oil lever dominant. EU imports worsen trade balance. Petrodollar demand rises. Short EUR/USD.</div></div>
      <div style="border-radius:12px;background:rgba(255,176,32,.06);border:1px solid rgba(255,176,32,.12);padding:9px"><div style="font-size:9.5px;color:rgba(255,176,32,.78);font-weight:700;margin-bottom:3px">RISK-OFF PANIC</div><div style="font-size:10.5px;color:rgba(255,255,255,.58);line-height:1.4">Fear+USD dominant. Capital flight from Europe. Gold spikes, EUR/USD crashes.</div></div>
    </div>
  </div></div>

  <div class="card"><div class="inner">
    <div class="card-title"><h2>Macro Drivers</h2><div class="hint hint" id="macroHint">Yahoo Finance: Brent crude BZ=F &middot; Gold COMEX GC=F &middot; Silver COMEX SI=F &middot; Dollar Index DX-Y.NYB. Via AllOrigins proxy.</div></div>
    <div class="teBox" style="margin-bottom:12px">
      <div class="teBoxTitle">Live Currency Strength &mdash; TradingEconomics</div>
      <iframe class="teFrame" style="min-height:180px" src="https://tradingeconomics.com/currencies?embed=true&theme=dark" title="Currency Strength" loading="lazy"></iframe>
    </div>
    <div class="macroGrid">
      <div class="macroBox"><div class="k">Brent Crude ($/bbl) <span class="liveBadge stale" id="oilTag">--</span></div><div class="v" id="oilPx">--</div><div class="meta" id="oilMeta">No data</div><canvas class="sparkCanvas" id="oilSpark"></canvas></div>
      <div class="macroBox"><div class="k">Gold COMEX ($/oz) <span class="liveBadge stale" id="goldTag">--</span></div><div class="v" id="goldPx">--</div><div class="meta" id="goldMeta">No data</div><canvas class="sparkCanvas" id="goldSpark"></canvas></div>
      <div class="macroBox"><div class="k">Silver COMEX ($/oz) <span class="liveBadge stale" id="silverTag">--</span></div><div class="v" id="silverPx">--</div><div class="meta" id="silverMeta">No data</div><canvas class="sparkCanvas" id="silverSpark"></canvas></div>
      <div class="macroBox"><div class="k">DXY Dollar Index <span class="liveBadge stale" id="usdTag">--</span></div><div class="v" id="usdPx">--</div><div class="meta" id="usdMeta">No data</div><canvas class="sparkCanvas" id="usdSpark"></canvas></div>
      <div class="macroBox"><div class="k">GBP/USD <span class="liveBadge stale" id="gbpTag">GBP</span></div><div class="v fx" id="gbpPx">--</div><div class="meta" id="gbpMeta">No data</div><canvas class="sparkCanvas" id="gbpSpark"></canvas></div>
      <div class="macroBox"><div class="k">AUD/USD <span class="liveBadge stale" id="audTag">AUD</span></div><div class="v fx" id="audPx">--</div><div class="meta" id="audMeta">No data</div><canvas class="sparkCanvas" id="audSpark"></canvas></div>
      <div class="macroBox"><div class="k">NZD/USD <span class="liveBadge stale" id="nzdTag">NZD</span></div><div class="v fx" id="nzdPx">--</div><div class="meta" id="nzdMeta">No data</div><canvas class="sparkCanvas" id="nzdSpark"></canvas></div>
      <div class="macroBox"><div class="k">FX Confluence <span class="tagOk" id="fxConfChip">--</span></div><div style="font-size:13px;font-weight:700;font-family:var(--mono);margin-top:4px;line-height:1.3" id="fxConfBig">GBP+AUD+NZD</div><div class="meta" id="fxConfMeta">Correlated pair alignment</div></div>
      <div class="macroBox" style="grid-column:1/span 2"><div class="k">Transmission Score <span class="tagOk" style="margin-left:6px">FX Conf <span id="fxIntChip">--%</span></span></div><div class="v" id="txBig">NEUTRAL</div><div class="meta" id="txMeta">Score 0.00 &middot; Neutral &middot; Intensity 0%</div>
          <div class="meta" id="txStructural" style="margin-top:3px;color:rgba(255,176,32,.72)">TE Structural: loading...</div></div>
    </div>
  </div></div>

  <div class="card"><div class="inner">
    <div class="card-title"><h2>Transmission Mechanism</h2><div class="hint">Oil (terms of trade) &middot; USD (safe haven) &middot; Fear (gold bid) &middot; Event proximity. Four levers drive EUR/USD around macro shocks.</div></div>
    <div class="tmGrid">
      <div class="tmBox"><div class="tmTop"><div class="k">Oil Lever (Brent)</div><div class="pct" id="oilLeverPct">0%</div></div><div class="tmBar"><i id="oilLeverBar"></i></div><div class="tmMeta" id="oilLeverMeta">EU energy drag proxy</div></div>
      <div class="tmBox"><div class="tmTop"><div class="k">Dollar Lever (DXY)</div><div class="pct" id="usdLeverPct">0%</div></div><div class="tmBar"><i id="usdLeverBar"></i></div><div class="tmMeta" id="usdLeverMeta">Dollar index proxy</div></div>
      <div class="tmBox"><div class="tmTop"><div class="k">Fear Lever (Gold)</div><div class="pct" id="fearLeverPct">0%</div></div><div class="tmBar"><i id="fearLeverBar"></i></div><div class="tmMeta" id="fearLeverMeta">Gold bid risk-off proxy</div></div>
      <div class="tmBox"><div class="tmTop"><div class="k">Event Risk</div><div class="pct" id="eventLeverPct">0%</div></div><div class="tmBar"><i id="eventLeverBar"></i></div><div class="tmMeta" id="eventLeverMeta">Calendar proximity</div></div>
      <div class="tmBox" style="grid-column:1/span 2"><div class="tmTop"><div class="k">FX Pair Confluence (GBP+AUD+NZD)</div><div class="pct" id="fxLeverPct">0%</div></div><div class="tmBar"><i id="fxLeverBar" style="background:rgba(160,100,255,.82)"></i></div><div class="tmMeta" id="fxLeverMeta">Correlated pair alignment</div></div>
    </div>
  </div></div>

  <div class="card"><div class="inner">
    <div class="card-title"><h2>Correlation Significance Matrix</h2><div class="hint">Rolling Pearson r vs EUR/USD returns. ** p&lt;0.01 &middot; * p&lt;0.05. Only add p&lt;0.01 signals to model.</div></div>
    <div class="tableWrap"><table class="corrTable"><thead><tr><th>Asset</th><th>r</th><th>t-stat</th><th>Sig</th><th>n</th><th>Expected Dir</th></tr></thead><tbody id="corrBody"></tbody></table></div>
    <div class="smallNote" style="margin-top:9px">Needs 30+ observations. Production: test by regime, rolling windows, Bonferroni correction.</div>
  </div></div>

  <div class="card"><div class="inner">
    <div class="card-title"><h2>HMM Transition Matrix</h2><div class="hint">Online learned P(next|current). Row=from Col=to. Darker=higher probability. Resets on page load (stateless for team sync).</div></div>
    <div style="overflow-x:auto"><table class="txMx"><thead><tr><th>From\To</th><th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>S5</th><th>S6</th><th>S7</th><th>S8</th></tr></thead><tbody id="tmBody"></tbody></table></div>
    <div class="smallNote" style="margin-top:9px">First-order Markov online learning. Stateless per session = deterministic convergence across team instances.</div>
  </div></div>

    <div class="card"><div class="inner">
    <div class="card-title">
      <h2>Macro Fundamentals &middot; Trading Economics</h2>
      <div class="hint">US vs Eurozone structural indicators from Trading Economics. Rate differential, CPI, PMI, GDP and labor markets drive EUR/USD on multi-week timeframes. Feeds directly into the structural bias overlay.</div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap">
      <span class="liveBadge stale" id="teBadge">LOADING</span>
      <span style="font-size:10px;color:rgba(255,255,255,.38)" id="teLastFetch">Fetching from Trading Economics...</span>
      <a href="https://tradingeconomics.com/" target="_blank" rel="noopener noreferrer" class="link" style="font-size:10px;margin-left:auto">tradingeconomics.com &rarr;</a>
    </div>

    <div class="teBox" style="margin-bottom:10px">
      <div class="tk">Monetary Policy Divergence &mdash; Fed Funds Rate vs ECB Deposit Rate</div>
      <div style="display:flex;align-items:flex-end;gap:16px;flex-wrap:wrap;margin-bottom:6px">
        <div>
          <div style="font-size:9px;color:rgba(43,108,255,.80);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">Fed Funds</div>
          <div class="tv" id="teFedRate" style="color:rgba(43,108,255,.95)">--</div>
          <div class="tm" id="teFedMeta">--</div>
        </div>
        <div style="font-size:20px;color:rgba(255,255,255,.12);padding-bottom:4px">vs</div>
        <div>
          <div style="font-size:9px;color:rgba(255,138,64,.80);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">ECB Deposit</div>
          <div class="tv" id="teEcbRate" style="color:rgba(255,138,64,.95)">--</div>
          <div class="tm" id="teEcbMeta">--</div>
        </div>
        <div style="margin-left:auto;text-align:right">
          <div style="font-size:9px;color:rgba(255,255,255,.38)">Spread (US-EU)</div>
          <div class="tv" id="teSpread" style="font-size:26px">--</div>
          <div class="tm" id="teSpreadSig">--</div>
        </div>
      </div>
      <div class="divBar">
        <div class="divFillUS" id="teDivUS" style="width:0%"></div>
        <div class="divFillEU" id="teDivEU" style="width:0%"></div>
        <div class="divMid"></div>
      </div>
      <div class="divLabels"><span>&bull; USD hawkish</span><span>&bull; EUR hawkish</span></div>
    </div>

    <div class="teGrid">
      <div class="teBox">
        <div class="tk">Inflation &mdash; CPI YoY %</div>
        <table class="teDivTable">
          <thead><tr><th>Country</th><th>CPI</th><th>Prev</th><th>Signal</th></tr></thead>
          <tbody>
            <tr><td class="tn">United States</td><td class="tu" id="teUsCpi">--</td><td class="tf" id="teUsCpiP">--</td><td class="tc" id="teUsCpiS">--</td></tr>
            <tr><td class="tn">Eurozone</td><td class="tu" id="teEuCpi">--</td><td class="tf" id="teEuCpiP">--</td><td class="tc" id="teEuCpiS">--</td></tr>
          </tbody>
        </table>
        <div class="tm" id="teCpiMeta" style="margin-top:6px">US CPI &gt; EU CPI = Fed hawkish = USD bid</div>
      </div>
      <div class="teBox">
        <div class="tk">PMI &mdash; Economic Momentum</div>
        <table class="teDivTable">
          <thead><tr><th>Country</th><th>Mfg</th><th>Svcs</th><th>Signal</th></tr></thead>
          <tbody>
            <tr><td class="tn">United States</td><td class="tu" id="teUsMfg">--</td><td class="tu" id="teUsSvc">--</td><td class="tc" id="teUsPmiS">--</td></tr>
            <tr><td class="tn">Eurozone</td><td class="tu" id="teEuMfg">--</td><td class="tu" id="teEuSvc">--</td><td class="tc" id="teEuPmiS">--</td></tr>
          </tbody>
        </table>
        <div class="tm" id="tePmiMeta" style="margin-top:6px">PMI &gt;50 = expansion. US&gt;EU = USD momentum</div>
      </div>
      <div class="teBox">
        <div class="tk">Labor Market</div>
        <table class="teDivTable">
          <thead><tr><th>Indicator</th><th>Latest</th><th>Prev</th></tr></thead>
          <tbody>
            <tr><td class="tn">US Unemployment %</td><td class="tu" id="teUsUnemp">--</td><td class="tf" id="teUsUnempP">--</td></tr>
            <tr><td class="tn">EU Unemployment %</td><td class="tu" id="teEuUnemp">--</td><td class="tf" id="teEuUnempP">--</td></tr>
            <tr><td class="tn">US NFP (000s)</td><td class="tu" id="teUsNfp">--</td><td class="tf" id="teUsNfpP">--</td></tr>
          </tbody>
        </table>
        <div class="tm" id="teLaborMeta" style="margin-top:6px">Strong US labor = Fed patience = USD structural bid</div>
      </div>
      <div class="teBox">
        <div class="tk">GDP Growth QoQ %</div>
        <table class="teDivTable">
          <thead><tr><th>Country</th><th>GDP</th><th>Prev</th><th>Signal</th></tr></thead>
          <tbody>
            <tr><td class="tn">United States</td><td class="tu" id="teUsGdp">--</td><td class="tf" id="teUsGdpP">--</td><td class="tc" id="teUsGdpS">--</td></tr>
            <tr><td class="tn">Eurozone</td><td class="tu" id="teEuGdp">--</td><td class="tf" id="teEuGdpP">--</td><td class="tc" id="teEuGdpS">--</td></tr>
          </tbody>
        </table>
        <div class="tm" id="teGdpMeta" style="margin-top:6px">Growth gap drives rate path expectations</div>
      </div>
    </div>

    <div class="tk" style="margin-bottom:8px">
      Upcoming High-Impact Events &mdash; Trading Economics
      <span class="liveBadge stale" id="teCalBadge" style="margin-left:6px">--</span>
    </div>
    <div id="teCalBody" style="max-height:240px;overflow-y:auto">
      <div style="color:rgba(255,255,255,.35);font-size:11px">Loading...</div>
    </div>

    <div class="teBox" style="margin-top:10px;background:rgba(8,20,52,.36)">
      <div class="tk">Structural Macro Bias &mdash; EUR/USD Multi-Week View</div>
      <div style="display:flex;align-items:baseline;gap:12px;margin-top:4px;flex-wrap:wrap">
        <div class="tv" id="teBiasLabel" style="font-size:24px">--</div>
        <div class="tm" id="teBiasDetail">Derived from rate spread, CPI diff, PMI gap, GDP gap</div>
      </div>
      <div class="surpriseBar"><div class="surpriseFill" id="teBiasBar" style="width:50%;background:rgba(180,220,255,.35)"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:9px;color:rgba(255,255,255,.30);margin-top:2px">
        <span>Bearish EUR/USD</span><span>Neutral</span><span>Bullish EUR/USD</span>
      </div>
      <div class="tm" id="teBiasMeta" style="margin-top:6px">Structural backdrop &mdash; not a short-term signal. Combine with HMM regime for full conviction picture.</div>
    </div>
    <div class="smallNote" style="margin-top:10px">Data from Trading Economics via CORS proxies. Structural indicators update every 30 minutes. Calendar updates every 10 minutes.</div>
  </div></div>

<div class="card"><div class="inner">
    <div class="card-title">
      <h2>World Events Calendar</h2>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <span class="liveBadge live" id="calBadge">&#8635; LIVE</span> <span class="teBadge">TradingEconomics</span>
      </div>
    </div>
    <iframe class="teFrame" style="min-height:480px;margin:8px 0 10px" src="https://tradingeconomics.com/calendar/embed?c=eur,usd&importance=1,2&theme=dark" title="EUR USD Calendar" loading="lazy"></iframe>
    <div style="font-size:9px;text-align:right;color:rgba(255,255,255,.22);margin-bottom:12px">Live: <a href="https://tradingeconomics.com/calendar" target="_blank" rel="noopener" style="color:rgba(100,160,255,.45);text-decoration:none">TradingEconomics.com</a></div>
    <details><summary style="font-size:10px;color:rgba(255,255,255,.28);cursor:pointer;padding:4px 0">&#9660; Internal engine event parser</summary>
    <div class="tableWrap"><div class="scroll" style="max-height:230px"><table><thead><tr><th>When (UTC)</th><th>Event</th><th>Impact</th><th>Forecast</th><th>Previous</th><th>Countdown</th></tr></thead><tbody id="eventsBody"></tbody></table></div></div>
    <div class="muted" style="margin-top:9px;display:flex;align-items:center;gap:8px">High impact: <span class="impact"><span class="folder"></span>HIGH</span> <span class="smallNote" id="calLastFetch" style="margin-left:4px">Fetching...</span></div>
    </details>
  </div></div>

  <div class="card"><div class="inner">
    <div class="card-title">
      <h2>Live Headlines</h2>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <span class="liveBadge live" id="headBadge">&#8635; LIVE</span>
        <div class="hint" style="margin:0;max-width:260px">ForexLive + FXStreet RSS feeds via AllOrigins. Auto-refresh every 5 min.</div>
      </div>
    </div>
    <div class="tableWrap"><div class="scroll" style="max-height:240px"><table><thead><tr><th>Time</th><th>Source</th><th>Headline</th></tr></thead><tbody id="headlinesBody"></tbody></table></div></div>
    <div class="smallNote" style="margin-top:7px" id="headLastFetch">Fetching live headlines...</div>
  </div></div>
</div></div></div>

<div class="kbhint" id="kbHint"><div><b>P</b> &mdash; Pause/Resume</div><div><b>S</b> &mdash; Force sync</div><div><b>N</b> &mdash; Night mode</div><div><b>X</b> &mdash; Export snapshot</div><div><b>?</b> &mdash; Hide this</div></div>

<div class="mBack" id="settingsBack">
  <div class="modal">
    <div class="mHead"><h3>Settings &mdash; QuadraX v4</h3><button class="btn" id="closeSettingsBtn">Close</button></div>
    <div class="mBody">
      <div class="fieldRow">
        <div class="field"><label>TwelveData API Key (optional) <span class="vTag" id="tdKeyValidTag"></span></label><input id="tdKeyInput" placeholder="Paste key (validated on save)"><div class="smallNote" style="margin-top:5px">Enables intraday EUR/USD data for faster regime warmup.</div></div>
        <div class="field"><label>Polling cadence (ms, min 6000)</label><input id="pollInput" placeholder="12000"></div>
      </div>
      <div class="fieldRow">
        <div class="field"><label>Alert: 1h range threshold (pips, 0=off)</label><input id="alertThreshInput" placeholder="e.g. 20"></div>
        <div class="field"><label>Regime history depth (10-120)</label><input id="histDepthInput" placeholder="60"></div>
      </div>
      <div class="syncPanel">
        <div class="sh">&#128257; Team Sync via Firebase</div>
        <div class="sd">All instances using the same Firebase database will share the same computed regime state in real-time. The engine is also deterministic (all instances computing from the same EUR/USD source converge to the same state after ~20 ticks without Firebase).</div>
        <div class="sd"><b>Recommended: AUTO mode (no single point of failure)</b><br>The HMM engine is fully deterministic. Every instance fetching the same EUR/USD price feed will independently converge to <em>identical state</em> within ~20 ticks (~4 minutes). No PC needs to stay on. Firebase is optional &mdash; it just speeds up convergence and shares projection logs.<br><br><b>READER mode requires MASTER to be running.</b> If that PC sleeps or closes the tab, READERs go stale. Use AUTO instead so everyone computes independently and stays live.<br><br><b>Firebase setup (optional, for faster convergence + projection sharing):</b> 1) Go to firebase.google.com &rarr; Create project &rarr; Realtime Database &rarr; Start in test mode. 2) Copy your database URL (e.g. https://my-project-default-rtdb.firebaseio.com). 3) Paste below. 4) All team members use the same URL. The MASTER instance writes state; READER instances display it.</div>
        <div class="fieldRow" style="margin-top:6px">
          <div class="field"><label>Firebase Database URL (optional)</label><input id="fbUrlInput" placeholder="https://your-project.firebaseio.com"></div>
          <div class="field"><label>Sync Role</label>
            <select id="fbRoleInput"><option value="AUTO">AUTO (recommended) — compute independently, sync when MASTER online</option><option value="MASTER">MASTER (compute + write to Firebase)</option><option value="READER">READER (receive from MASTER only — requires MASTER online)</option></select>
          </div>
        </div>
        <div class="smallNote" id="fbStatus" style="margin-top:4px">Firebase: not configured</div>
      </div>
      <div class="mActions"><button class="btn" id="resetProjBtn">Reset Projection Log</button><button class="btn" id="resetSettingsBtn">Reset Settings</button><button class="btn primary" id="saveSettingsBtn">Save</button></div>
    </div>
  </div>
</div>
<script>
(function(){"use strict";
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const fmtTime=ms=>new Date(ms).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"});
const fmtTS=ms=>new Date(ms).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});
const bp=x=>x*10000;
const minsAgo=ts=>ts?Math.round((Date.now()-ts)/60000):null;
const $=id=>document.getElementById(id);
const escH=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
const escA=s=>String(s).replace(/"/g,'&quot;');
function pearsonR(xs,ys){const n=Math.min(xs.length,ys.length);if(n<5)return{r:0,tStat:0,n,sig:"ns"};const mx=xs.slice(0,n).reduce((a,b)=>a+b,0)/n,my=ys.slice(0,n).reduce((a,b)=>a+b,0)/n;let num=0,dx2=0,dy2=0;for(let i=0;i<n;i++){const dx=xs[i]-mx,dy=ys[i]-my;num+=dx*dy;dx2+=dx*dx;dy2+=dy*dy;}const r=(dx2*dy2===0)?0:num/Math.sqrt(dx2*dy2);const rc=clamp(r,-.9999,.9999),t=rc*Math.sqrt(n-2)/Math.sqrt(1-rc*rc),at=Math.abs(t);return{r:rc,tStat:t,n,sig:at>2.576?"**":at>1.960?"*":"ns"};}
const KEY={s:"qx_s_v5",sg:"qx_sg_v1",rh:"qx_rh_v3",proj:"qx_proj_v1"};
function loadObj(k,fb){try{const r=localStorage.getItem(k);if(!r)return fb;const p=JSON.parse(r);return(p&&typeof p==="object")?p:fb;}catch{return fb;}}
function loadArr(k,fb){try{const r=localStorage.getItem(k);if(!r)return fb;const p=JSON.parse(r);return Array.isArray(p)?p:fb;}catch{return fb;}}
function save(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch{}}
let settings=loadObj(KEY.s,{twelvedataKey:"",pollMs:12000,alertThreshPips:0,histDepth:60,fbUrl:"",fbRole:"AUTO",calibMult:1.0,biasConfAdj:1.0});
const STATES=[
  {id:1,name:"Mean-Reverting",  desc:"Range-bound. Fade extremes, keep size disciplined.",       color:"rgba(24,209,138,.85)"},
  {id:2,name:"Liquidity Vacuum",desc:"Thin market. Reduce size, wait for confirmation.",          color:"rgba(255,176,32,.85)"},
  {id:3,name:"Slow Drift",      desc:"Steady grind. Small edges, avoid forcing entries.",         color:"rgba(120,170,255,.85)"},
  {id:4,name:"Strong Trend",    desc:"Directional. Trend-follow, avoid countertrend heroics.",    color:"rgba(43,108,255,.90)"},
  {id:5,name:"Stop Cascade",    desc:"Fast continuation on stops. De-risk, widen filters.",       color:"rgba(255,138,64,.90)"},
  {id:6,name:"News Shock",      desc:"Event-driven volatility. Consider standing down.",          color:"rgba(255,77,77,.90)"},
  {id:7,name:"Dealer Unwind",   desc:"Choppy reversal risk. Protect, demand confirmation.",       color:"rgba(160,120,255,.90)"},
  {id:8,name:"Panic/Forced",    desc:"Dislocation. Risk off. Protect capital first.",             color:"rgba(255,58,165,.90)"},
];
const probEls=[];
function initProbUI(){$("probList").innerHTML="";probEls.length=0;STATES.forEach(s=>{const row=document.createElement("div");row.className="probRow";row.innerHTML=`<div class="probName"><span class="pdot" style="background:${s.color}"></span>S${s.id}: ${s.name}</div><div class="pbar"><i></i></div><div class="probVal">--%</div>`;$("probList").appendChild(row);probEls.push({bar:row.querySelector(".pbar>i"),val:row.querySelector(".probVal")});});}
let recentStates=loadArr(KEY.rh,[]);
function pushState(s){recentStates.push(s);const d=clamp(settings.histDepth||60,10,120);if(recentStates.length>d)recentStates=recentStates.slice(-d);save(KEY.rh,recentStates);}

const SpotFeed=(()=>{
  const free=[{name:"exchangerate.host",url:()=>`https://api.exchangerate.host/latest?base=EUR&symbols=USD&_=${Date.now()}`,parse:j=>j?.rates?.USD},{name:"frankfurter.app",url:()=>`https://api.frankfurter.app/latest?from=EUR&to=USD&_=${Date.now()}`,parse:j=>j?.rates?.USD},{name:"open.er-api.com",url:()=>`https://open.er-api.com/v6/latest/EUR?_=${Date.now()}`,parse:j=>j?.rates?.USD}];
  let last={price:null,ts:0,source:null,provider:null,latencyMs:null,staleCount:0,lastChangeTs:0,lastDelta:0};
  const STALE=60000,MIN=0.000001;let ctrl=null;const bo={};
  const status=(now=Date.now())=>!last.price?{status:"CHECKING",stale:false}:{status:(now-last.ts)>STALE?"STALE":"LIVE",stale:(now-last.ts)>STALE};
  async function ft(url,ms=7000){const t0=performance.now();if(ctrl)ctrl.abort();ctrl=new AbortController();const timer=setTimeout(()=>ctrl.abort(),ms);try{const res=await fetch(url,{method:"GET",cache:"no-store",signal:ctrl.signal});clearTimeout(timer);if(res.status===429)throw Object.assign(new Error("429"),{is429:true});if(!res.ok)throw new Error();return{ok:true,json:await res.json(),latencyMs:Math.round(performance.now()-t0)};}catch(e){clearTimeout(timer);return{ok:false,is429:e?.is429};}}
  async function fetchTD(){const key=(settings.twelvedataKey||"").trim();if(!key)return{ok:false};const r=await ft(`https://api.twelvedata.com/price?symbol=EUR/USD&apikey=${encodeURIComponent(key)}&_=${Date.now()}`);if(!r.ok)return{ok:false};const px=Number(r.json?.price);if(!Number.isFinite(px)||px<=0)return{ok:false};return{ok:true,price:px,source:"TwelveData",provider:"TwelveData",latencyMs:r.latencyMs};}
  async function fetchFree(){const now=Date.now();const av=free.filter(s=>!bo[s.name]||bo[s.name]<now);if(!av.length)return{ok:false};try{return await Promise.any(av.map(s=>ft(s.url(),7000).then(r=>{if(!r.ok){if(r.is429)bo[s.name]=now+300000;throw new Error();}const px=Number(s.parse(r.json));if(!Number.isFinite(px)||px<=0)throw new Error();return{ok:true,price:px,source:s.name,provider:s.name,latencyMs:r.latencyMs};})));}catch{return{ok:false};}}
  async function tick(cb){const now=Date.now();let r=await fetchTD();if(!r.ok)r=await fetchFree();if(!r.ok){last.staleCount++;const el=$("fxSpotStatus");if(el&&last.staleCount>2)el.title="Feed failing "+last.staleCount+"x. Add TwelveData key in Settings for reliable data.";cb?.({ok:false,...last,...status(now)});return;}const prev=last.price,moved=prev==null||Math.abs(r.price-prev)>MIN;last={...last,price:r.price,ts:now,source:r.source,provider:r.provider,latencyMs:r.latencyMs,staleCount:0,lastDelta:prev==null?0:r.price-prev};if(moved)last.lastChangeTs=now;if(!last.lastChangeTs)last.lastChangeTs=now;cb?.({ok:true,...last,...status(now)});}
  return{tick,getLast:()=>({...last})};
})();

const MacroFeed=(()=>{
  const series=[{key:"OIL",sym:"BZ=F",label:"Brent",pxEl:"oilPx",metaEl:"oilMeta",tagEl:"oilTag",sparkEl:"oilSpark"},{key:"GOLD",sym:"GC=F",label:"Gold",pxEl:"goldPx",metaEl:"goldMeta",tagEl:"goldTag",sparkEl:"goldSpark"},{key:"SILV",sym:"SI=F",label:"Silver",pxEl:"silverPx",metaEl:"silverMeta",tagEl:"silverTag",sparkEl:"silverSpark"},{key:"USD",sym:"DX-Y.NYB",label:"DXY",pxEl:"usdPx",metaEl:"usdMeta",tagEl:"usdTag",sparkEl:"usdSpark"},
    {key:"GBP",sym:"GBPUSD=X",label:"GBP/USD",pxEl:"gbpPx",metaEl:"gbpMeta",tagEl:"gbpTag",sparkEl:"gbpSpark"},
    {key:"AUD",sym:"AUDUSD=X",label:"AUD/USD",pxEl:"audPx",metaEl:"audMeta",tagEl:"audTag",sparkEl:"audSpark"},
    {key:"NZD",sym:"NZD=X",label:"NZD/USD",pxEl:"nzdPx",metaEl:"nzdMeta",tagEl:"nzdTag",sparkEl:"nzdSpark"}];
  let cache={};const bo={};
  async function fetchYahoo(sym){const t0=performance.now();const prox="https://api.allorigins.win/raw?url="+encodeURIComponent("https://query1.finance.yahoo.com/v8/finance/chart/"+encodeURIComponent(sym)+"?interval=1d&range=2mo");const c=new AbortController();const timer=setTimeout(()=>c.abort(),12000);try{const res=await fetch(prox,{method:"GET",cache:"no-store",signal:c.signal});clearTimeout(timer);if(res.status===429)throw Object.assign(new Error("429"),{is429:true});if(!res.ok)throw new Error();const json=await res.json();const result=json?.chart?.result?.[0];if(!result)throw new Error();const meta=result.meta;const rawCloses=(result.indicators?.quote?.[0]?.close||[]).filter(v=>v!=null&&Number.isFinite(v));if(rawCloses.length<2)throw new Error();
    // Use closes array directly - meta.previousClose is stale for futures (contract roll gives false 15-25% swings)
    const close=rawCloses.at(-1);
    const prevClose=rawCloses.at(-2);
    const rawChg=prevClose?(close/prevClose-1)*100:0;
    // Sanity cap: >8% daily move on a macro instrument = almost certainly a data artefact
    const changePct=Math.abs(rawChg)>8?0:rawChg;
    return{ok:true,close,prevClose,changePct,closes:rawCloses.slice(-20),latencyMs:Math.round(performance.now()-t0)};}catch(e){clearTimeout(timer);return{ok:false,is429:e?.is429};}}
  const fmtPx=x=>!Number.isFinite(x)?"--":x<10?x.toFixed(4):x.toFixed(2);
  const fmtPct=x=>!Number.isFinite(x)?"--":(x>=0?"+":"")+x.toFixed(2)+"%";
  function paintOne(item){const rec=cache[item.key],pEl=$(item.pxEl),mEl=$(item.metaEl),tEl=$(item.tagEl),sEl=$(item.sparkEl);if(!rec){if(pEl)pEl.textContent="--";if(mEl)mEl.textContent="No data";if(tEl){tEl.textContent=item.label;tEl.className="liveBadge error";}return;}if(pEl)pEl.textContent=fmtPx(rec.close);const ma=minsAgo(rec.ts);if(mEl)mEl.textContent=fmtPct(rec.changePct)+" Prev "+fmtPx(rec.prevClose)+(ma!=null?" "+ma+"m ago":"");if(tEl){tEl.textContent=item.label;tEl.className="liveBadge "+(ma!=null&&ma<120?"live":"stale");}if(pEl){pEl.classList.remove("pos","neg");if(rec.changePct>0.05)pEl.classList.add("pos");if(rec.changePct<-0.05)pEl.classList.add("neg");}if(sEl&&rec.closes?.length>1)drawSparkline(sEl,rec.closes,rec.changePct);}
  const FALLBACKS={GBP:["GBPUSD=X","GBP=X"],AUD:["AUDUSD=X","AUD=X"],NZD:["NZD=X","NZDUSD=X","NZD%3DX"],OIL:["BZ=F","CL=F"],GOLD:["GC=F","XAUUSD=X"],SILV:["SI=F"],USD:["DX-Y.NYB"]};
  async function fetchWithFallback(item){const syms=FALLBACKS[item.key]||[item.sym];for(const sym of syms){const r=await fetchYahoo(sym);if(r.ok)return r;}return{ok:false};}
  async function tick(){const now=Date.now();await Promise.allSettled(series.filter(i=>!bo[i.key]||bo[i.key]<now).map(item=>fetchWithFallback(item).then(r=>{if(!r.ok){if(r.is429)bo[item.key]=now+600000;return;}cache[item.key]={...r,ts:now};})));series.forEach(paintOne);}
  return{tick,get:k=>cache[k]||null,hydrate:()=>series.forEach(paintOne)};
})();

const EventsFeed=(()=>{
  let cache=[],lastFetch=0;const TTL=5*60*1000;
  const FF_URL="https://nfs.faireconomy.media/ff_calendar_thisweek.json";
  const mkProxies=u=>["https://api.allorigins.win/raw?url="+encodeURIComponent(u),"https://corsproxy.io/?"+encodeURIComponent(u),"https://api.codetabs.com/v1/proxy?quest="+encodeURIComponent(u)];
  async function tryFetch(url,ms=10000){for(const prox of mkProxies(url)){const c=new AbortController();const t=setTimeout(()=>c.abort(),ms);try{const res=await fetch(prox,{method:"GET",cache:"no-store",signal:c.signal});clearTimeout(t);if(!res.ok)continue;const txt=await res.text();let parsed;try{parsed=JSON.parse(txt);}catch{const m=txt.match(/^\s*[\[{]/);if(!m)continue;}parsed=parsed||JSON.parse(txt);if(Array.isArray(parsed))return parsed;if(parsed?.data){try{const d=JSON.parse(parsed.data);if(Array.isArray(d))return d;}catch{}}continue;}catch{clearTimeout(t);}}return null;}
  async function tick(){const now=Date.now();if(now-lastFetch<TTL&&cache.length>0)return;const cb=$("calBadge"),cl=$("calLastFetch");
    try{const json=await tryFetch(FF_URL,12000);if(!json||!json.length)throw new Error("no data");
      cache=json.filter(e=>(e.impact==="High"||e.impact==="Medium")&&(e.country==="USD"||e.country==="EUR")).map(e=>({when:e.date,event:e.title+" ("+e.country+")",impact:e.impact==="High"?"HIGH":"MED",forecast:e.forecast||"",previous:e.previous||""}));
      lastFetch=now;if(cb){cb.className="liveBadge live";cb.textContent="LIVE";}if(cl)cl.textContent="Updated "+fmtTime(now)+" — "+cache.length+" events";}
    catch{if(cb){cb.className="liveBadge error";cb.textContent="UNAVAIL";}if(cl)cl.textContent="Calendar unavailable. Will retry in 5 min.";}
    renderEvents();}
  return{tick,get:()=>cache};
})();

const HeadlinesFeed=(()=>{
  const SOURCES=[{url:"https://www.forexlive.com/feed/news",name:"ForexLive"},{url:"https://www.fxstreet.com/rss/news",name:"FXStreet"}];
  let cache=[],lastFetch=0;const TTL=5*60*1000;
  async function tick(){const now=Date.now();if(now-lastFetch<TTL&&cache.length>0)return;const results=await Promise.allSettled(SOURCES.map(async src=>{const proxUrls=["https://api.allorigins.win/raw?url="+encodeURIComponent(src.url),"https://corsproxy.io/?"+encodeURIComponent(src.url)];let res=null,usedTimer=null;for(const prox of proxUrls){const c2=new AbortController();usedTimer=setTimeout(()=>c2.abort(),10000);try{const r=await fetch(prox,{method:"GET",cache:"no-store",signal:c2.signal});clearTimeout(usedTimer);if(r.ok){res=r;break;}}catch{clearTimeout(usedTimer);}}try{if(!res||!res.ok)throw new Error();const text=await res.text();const doc=new DOMParser().parseFromString(text,"application/xml");return[...doc.querySelectorAll("item")].slice(0,6).map(item=>{const rawPub=item.querySelector("pubDate")?.textContent||"";let ts="--";try{const d=new Date(rawPub);if(!isNaN(d))ts=fmtTS(d);}catch{}const title=(item.querySelector("title")?.textContent||"").replace(/<!\[CDATA\[|\]\]>/g,"").trim();const link=(item.querySelector("link")?.textContent||item.querySelector("guid")?.textContent||"#").trim();return{time:ts,source:src.name,title,url:link};}).filter(h=>h.title);}catch(e){clearTimeout(timer);return[];}}));const all=[];results.forEach(r=>{if(r.status==="fulfilled")all.push(...r.value);});if(all.length>0){cache=all.slice(0,12);lastFetch=now;const hb=$("headBadge");if(hb){hb.className="liveBadge live";hb.textContent="LIVE";}const hl=$("headLastFetch");if(hl)hl.textContent="Updated "+fmtTime(now);}else{const hb=$("headBadge");if(hb){hb.className="liveBadge stale";hb.textContent="RETRY";}const hl=$("headLastFetch");if(hl)hl.textContent="RSS fetch failed.";}renderHeadlines();}
  return{tick,get:()=>cache};
})();

const Engine=(()=>{
  const HN=80,MW=8,VW=18,HT=4,PT=1.35,MSW=10,WARMUP=20;
  let tickN=0,regAge=0,lastPol=null;let prices=[],returns=[];let polState=null,hold=0;
  // Seed TM with weak priors so it renders on first tick (self-transitions most likely)
  let TM=Array.from({length:8},(_,i)=>new Array(8).fill(0).map((_,j)=>i===j?2:0.1));let prevPol=null;
  const softmax=lg=>{const m=Math.max(...lg),e=lg.map(v=>Math.exp((v-m)/PT)),s=e.reduce((a,b)=>a+b,0)||1;return e.map(v=>v/s);};
  function feats(){if(prices.length<3)return null;const p=prices.at(-1),pp=prices.at(-2),r=pp?p-pp:0;const mb=prices[Math.max(0,prices.length-1-MW)],mom=mb?p-mb:0;const rr=returns.slice(-VW),avg=rr.length?rr.reduce((a,b)=>a+Math.abs(b),0)/rr.length:0;const volx=clamp(avg/0.00015,0,5),shock=Math.abs(r)>0.0007?1:0;const rrm=returns.slice(-MSW),md=Math.sign(mom);const momScore=rrm.length>0?rrm.filter(v=>Math.sign(v)===md).length/rrm.length:0.5;return{p,r,mom,volx,shock,momScore};}
  function scoreStates(f){const mb=Math.abs(bp(f.mom)),rb=Math.abs(bp(f.r)),v=f.volx;const sc=returns.slice(-10);const sig=sc.length<6?0:sc.reduce((c,_,i)=>i>0&&Math.sign(sc[i])!==Math.sign(sc[i-1])?c+1:c,0);return softmax([2.4-.7*v-.04*mb,1.1+.55*v-.03*mb,1.6-.25*v-.02*mb,.9+.25*v+.045*mb,-.2+.55*v+.02*mb+.04*rb,-.4+(f.shock?3:0)+.2*v,.3+.18*v+.35*clamp(sig/6,0,1)-.02*mb,-.8+.95*Math.max(0,v-2.2)+.04*rb+(f.shock?.6:0)]);}
  const pick=probs=>{let b=0;for(let i=1;i<probs.length;i++)if(probs[i]>probs[b])b=i;return b+1;};
  const conf=(probs,s)=>{const sorted=[...probs].sort((a,b)=>b-a);return clamp(probs[s-1]*.7+(sorted[0]-(sorted[1]||0))*.3,0,1);};
  function updatePol(det){if(polState==null){polState=det;hold=0;return{policy:polState,hold};}if(det===polState){hold=0;return{policy:polState,hold};}hold++;if(hold>=HT){polState=det;hold=0;return{policy:polState,hold};}return{policy:polState,hold};}
  const transRow=si=>{const row=TM[si],total=row.reduce((a,b)=>a+b,0);return total>0?row.map(v=>v/total):new Array(8).fill(.125);};
  function predictNext(pol){const row=transRow(pol-1);let bi=0;for(let i=1;i<row.length;i++)if(row[i]>row[bi])bi=i;return{state:bi+1,prob:row[bi]};}
  function step(price){tickN++;const p=Number(price);if(!Number.isFinite(p)||p<=0)return null;const prev=prices.length?prices.at(-1):null;prices.push(p);if(prices.length>HN)prices.shift();if(prev!=null){returns.push(p-prev);if(returns.length>HN)returns.shift();}const f=feats();if(!f)return null;const probs=scoreStates(f),det=pick(probs),pr=updatePol(det),pol=pr.policy;if(prevPol!=null&&prevPol!==pol)TM[prevPol-1][pol-1]++;if(prevPol!==pol)prevPol=pol;regAge=(lastPol===pol)?regAge+1:0;lastPol=pol;return{tickN,features:f,probs,detector:det,policy:pol,hold:pr.hold,conf:conf(probs,pol),regimeAge:regAge,momScore:f.momScore,predictedNext:predictNext(pol),TM,warmed:tickN>=WARMUP};}
  return{step,getTM:()=>TM,WARMUP};
})();

const SessionEngine=(()=>{
  const SESS=[{id:"SYDNEY",label:"Sydney",startH:21,endH:30,color:"rgba(255,176,32,.85)"},{id:"TOKYO",label:"Tokyo",startH:0,endH:9,color:"rgba(160,120,255,.85)"},{id:"LONDON",label:"London",startH:7,endH:16,color:"rgba(24,209,138,.85)"},{id:"NEW_YORK",label:"New York",startH:12,endH:21,color:"rgba(43,108,255,.90)"}];
  const DAY={1:{name:"MONDAY",effect:"Follows Friday close. Weekend gaps common. Liquidity builds through morning."},2:{name:"TUESDAY",effect:"Reversions to Monday trend common. Fade if Monday move was not sustained."},3:{name:"WEDNESDAY",effect:"Mid-week continuation. Fed speakers frequent. Watch NY afternoon."},4:{name:"THURSDAY",effect:"US Jobless Claims 12:30 UTC. Often most volatile day. Clear directional moves."},5:{name:"FRIDAY",effect:"Position closing before weekend. USD bid into NY close. Reversion risk at end-of-day."}};
  const utcH=()=>{const d=new Date();return d.getUTCHours()+d.getUTCMinutes()/60;};
  const isOpen=s=>{const h=utcH();return s.endH>24?(h>=s.startH||h<(s.endH-24)):(h>=s.startH&&h<s.endH);};
  function minsToEnd(s){const d=new Date(),um=d.getUTCHours()*60+d.getUTCMinutes(),em=(s.endH%24)*60;let diff=em-um;if(diff<0)diff+=1440;return diff;}
  function compute(){const open=SESS.filter(s=>isOpen(s));const dow=new Date().getDay();const dayInfo=DAY[dow]||{name:new Date().toLocaleDateString([],{weekday:"long"}).toUpperCase(),effect:"Weekend. Markets closed."};const isOL=open.some(s=>s.id==="LONDON")&&open.some(s=>s.id==="NEW_YORK");const primary=open.length?open.at(-1):null;return{openSessions:open.map(s=>s.id),primary,isOverlap:isOL,dayInfo,minsLeft:primary?minsToEnd(primary):null};}
  return{compute,SESS};
})();

const PB3=(()=>{
  function compute(step,tx){if(!step)return{panic:0,bubble:0,boom:0,bust:0,dominant:"NORMAL",note:"Insufficient data."};const{volx=1,momScore=.5,mom=0}=step.features||{};const{conf=.3,regimeAge=0,policy=1}=step;const fearInt=tx?.components?.fearInt??0,mb=Math.abs(bp(mom));const panic=clamp(.30*clamp(volx/4,0,1)+.30*fearInt+.25*([6,7,8].includes(policy)?1:0)+.15*(1-momScore),0,1);const bubble=clamp(.30*clamp(regimeAge/60,0,1)+.25*(1-clamp(volx/3,0,1))+.25*clamp(mb/30,0,1)+.20*conf,0,1);const boom=clamp(.35*momScore+.30*clamp(mb/25,0,1)+.20*(policy===4?1:0)+.15*clamp(volx/3,0,1),0,1);const bust=clamp(.35*clamp(volx/3.5,0,1)+.30*([5,7].includes(policy)?1:0)+.20*(1-momScore)+.15*clamp(regimeAge/30,0,1),0,1);const scores={PANIC:panic,BUBBLE:bubble,BOOM:boom,BUST:bust};let dom="NORMAL",ds=0;for(const[k,v]of Object.entries(scores))if(v>ds){ds=v;dom=k;}if(ds<.22)dom="NORMAL";const notes={PANIC:"Capital flight in progress. Short EUR/USD if confirmed.",BUBBLE:"Euphoric extension. Reversal risk high. Reduce size.",BOOM:"Clean directional momentum. Bias with trend, trail stops.",BUST:"Post-move collapse risk. Mean-revert or stand aside.",NORMAL:"No dominant behavioral pattern. Standard regime rules."};return{panic,bubble,boom,bust,dominant:dom,dominantScore:ds,note:notes[dom]};}
  return{compute};
})();

const Classifier=(()=>{
  function classify(tx){if(!tx)return{archetype:"--",confidence:0,eurusdBias:"NEUTRAL",note:"Waiting for macro data.",analog:""};const{oilInt=0,usdInt=0,fearInt=0}=tx.components||{};const total=oilInt+usdInt+fearInt;if(total<.15)return{archetype:"QUIET TAPE",confidence:.60,eurusdBias:"NEUTRAL",note:"All macro levers below threshold. Price driven by micro-structure.",analog:"Watch session overlaps."};const isSupply=oilInt>.35&&oilInt>fearInt*1.4&&oilInt>usdInt*1.2;const isRiskOff=fearInt>.35&&usdInt>.25&&fearInt>oilInt*1.2;const isCombined=oilInt>.30&&fearInt>.30&&usdInt>.30;const isLocalized=total<.40&&!isSupply&&!isRiskOff;const isRate=usdInt>.35&&fearInt<.25&&oilInt<.25;if(isCombined)return{archetype:"COMBINED SHOCK",confidence:clamp(total*.8,0,.95),eurusdBias:"BEARISH",note:"All three major levers elevated. Maximum EUR/USD downside.",analog:"Analog: Gulf War 1990-91, Ukraine energy crisis 2022."};if(isSupply)return{archetype:"SUPPLY SHOCK",confidence:clamp(oilInt*1.2,0,.92),eurusdBias:"BEARISH",note:"Brent lever dominant. EU imports 90% of Brent. Worsens EU trade balance.",analog:"Analog: Iran sanctions 2011-12 (EUR/USD 1.45 to 1.20)."};if(isRiskOff)return{archetype:"RISK-OFF PANIC",confidence:clamp((fearInt+usdInt)*.65,0,.90),eurusdBias:"BEARISH",note:"Fear+USD dominant. EUR/USD falls while Gold spikes. Capital flight.",analog:"Analog: 9/11, Ukraine invasion Feb 2022."};if(isRate)return{archetype:"RATE / DOLLAR PLAY",confidence:clamp(usdInt*1.3,0,.88),eurusdBias:tx.score<-.1?"BEARISH":tx.score>.1?"BULLISH":"NEUTRAL",note:"DXY dominant without commodity shock. Fed/ECB rate differential repricing.",analog:"Analog: Fed pivot cycles, ECB-behind-curve 2022."};if(isLocalized)return{archetype:"LOCALIZED EVENT",confidence:.55,eurusdBias:"NEUTRAL",note:"Muted lever intensity. Impact too small or geographically isolated.",analog:""};return{archetype:"MIXED SIGNALS",confidence:.42,eurusdBias:tx.score<-.15?"BEARISH":tx.score>.15?"BULLISH":"NEUTRAL",note:"Multiple levers active without dominant narrative. Reduce size.",analog:""};}
  return{classify};
})();

const CorrEngine=(()=>{
  const MAX=60;let eurRet=[],mc={OIL:[],GOLD:[],SILV:[],USD:[],GBP:[],AUD:[],NZD:[]},cumEur=0;
  const pushEur=r=>{cumEur+=r;};
  function onMacroUpdate(){["OIL","GOLD","SILV","USD","GBP","AUD","NZD"].forEach(k=>{const d=MacroFeed.get(k);if(d){mc[k].push(d.changePct);if(mc[k].length>MAX)mc[k].shift();}});eurRet.push(cumEur*10000);if(eurRet.length>MAX)eurRet.shift();cumEur=0;}
  function getCorrelations(){const out={};for(const[k,arr]of Object.entries(mc)){const n=Math.min(arr.length,eurRet.length);if(n<5){out[k]={r:0,tStat:0,n,sig:"ns"};continue;}out[k]=pearsonR(eurRet.slice(-n),arr.slice(-n));}return out;}
  // Pair confluence: how strongly do correlated pairs confirm EUR/USD direction?
  function getPairConfluence(){
    const fxKeys=["GBP","AUD","NZD"];
    const dirScores=fxKeys.map(k=>{const arr=mc[k];if(!arr||arr.length<3)return 0;const last=arr.at(-1);return last>0?1:last<0?-1:0;});
    const n=dirScores.filter(v=>v!==0).length;
    if(n===0)return{score:0,count:0,description:"No FX data"};
    const sum=dirScores.reduce((a,b)=>a+b,0);
    return{score:sum/fxKeys.length,count:n,description:fxKeys.filter((_,i)=>dirScores[i]!==0).join("+")+" aligned"};
  }
  return{pushEur,onMacroUpdate,getCorrelations};
})();

const SignalTracker=(()=>{
  const ROLLING=30;const saved=loadObj(KEY.sg,{returns:[],equity:[0],openBias:null,entryPrice:null,totalPips:0,wins:0,losses:0});
  let ret=Array.isArray(saved.returns)?saved.returns.slice(-100):[];let equity=Array.isArray(saved.equity)?saved.equity.slice(-100):[0];
  let openBias=saved.openBias||null,entryPrice=saved.entryPrice||null,totalPips=saved.totalPips||0,wins=saved.wins||0,losses=saved.losses||0;
  function persist(){if((ret.length+wins+losses)%5===0)save(KEY.sg,{returns:ret.slice(-100),equity:equity.slice(-100),openBias,entryPrice,totalPips,wins,losses});}
  function rollingStats(arr){const n=arr.length;if(n<2)return{sharpe:null};const mean=arr.reduce((a,b)=>a+b,0)/n,v=arr.reduce((s,x)=>s+(x-mean)**2,0)/(n-1),std=Math.sqrt(v);return{sharpe:std>0?(mean/std)*Math.sqrt(252):null};}
  function update(price,bias){const p=Number(price);if(!Number.isFinite(p))return;if(openBias&&bias!==openBias&&entryPrice!=null){const pr=(p-entryPrice)*10000*(openBias==="LONG"?1:-1);ret.push(pr);if(ret.length>100)ret.shift();equity.push((equity.at(-1)||0)+pr);if(equity.length>100)equity.shift();totalPips+=pr;if(pr>0)wins++;else if(pr<0)losses++;openBias=null;entryPrice=null;persist();}if((bias==="LONG"||bias==="SHORT")&&!openBias){openBias=bias;entryPrice=p;}}
  function getStats(price){const{sharpe}=rollingStats(ret.slice(-ROLLING));const total=wins+losses,winRate=total>0?wins/total:null;const openPL=(openBias&&entryPrice&&price)?(Number(price)-entryPrice)*10000*(openBias==="LONG"?1:-1):null;return{sharpe,winRate,openPL,totalSignals:total,totalPips,openBias,equity};}
  return{update,getStats};
})();

// ── PROJECTION ACCURACY TRACKER ──────────────────────────────────────────
const ProjTracker=(()=>{
  const MIN_N=5;
  let log=loadArr(KEY.proj,[]).slice(-200);
  let calibMult=Number(settings.calibMult)||1.0;
  let biasConfAdj=Number(settings.biasConfAdj)||1.0;

  function logProjection({spot,bias,r1,r4,policy}){
    if(!spot||bias==="NEUTRAL")return;
    // Don't log more often than every 10 minutes to avoid flooding
    const last=log.length?log.at(-1):null;
    if(last&&(Date.now()-last.ts)<5*60*1000)return;
    log.push({id:Date.now(),ts:Date.now(),spot,bias,r1,r4,policy,outcome1h:null,outcome4h:null});
    if(log.length>200)log=log.slice(-200);
    _persist();
  }

  function scoreOutcomes(currentSpot){
    if(!Number.isFinite(currentSpot))return;
    const now=Date.now();let changed=false;
    log.forEach(p=>{
      const ageMins=(now-p.ts)/60000;
      const movePips=(currentSpot-p.spot)*10000;
      const dirOk=p.bias==="LONG"?movePips>0:movePips<0;
      if(p.outcome1h===null&&ageMins>=60){p.outcome1h={dirHit:dirOk,rngHit:Math.abs(movePips)<=p.r1,movePips,ageMins};changed=true;}
      if(p.outcome4h===null&&ageMins>=240){p.outcome4h={dirHit:dirOk,rngHit:Math.abs(movePips)<=p.r4,movePips,ageMins};changed=true;}
    });
    if(changed){_adapt();_persist();}
  }

  function _stats(){
    const r1=log.filter(p=>p.outcome1h!==null),r4=log.filter(p=>p.outcome4h!==null);
    return{
      n1h:r1.length,
      dir1hRate:r1.length?r1.filter(p=>p.outcome1h.dirHit).length/r1.length:null,
      rng1hRate:r1.length?r1.filter(p=>p.outcome1h.rngHit).length/r1.length:null,
      n4h:r4.length,
      dir4hRate:r4.length?r4.filter(p=>p.outcome4h.dirHit).length/r4.length:null,
      rng4hRate:r4.length?r4.filter(p=>p.outcome4h.rngHit).length/r4.length:null,
      total:log.length,
      pending:log.filter(p=>p.outcome1h===null||p.outcome4h===null).length,
    };
  }

  function _adapt(){
    const s=_stats();
    // CONE: target range hit rate 60-80%. Outside that range -> adjust
    if(s.n1h>=MIN_N&&s.rng1hRate!=null){
      if(s.rng1hRate<0.50)calibMult=clamp(calibMult*1.06,0.40,3.0);       // too narrow -> widen
      else if(s.rng1hRate>0.82)calibMult=clamp(calibMult*0.96,0.40,3.0);  // too wide -> tighten
    }
    // BIAS CONFIDENCE: direction < 50% -> downweight; > 62% -> upweight
    if(s.n1h>=MIN_N&&s.dir1hRate!=null){
      if(s.dir1hRate<0.48)biasConfAdj=clamp(biasConfAdj*0.94,0.20,1.60);
      else if(s.dir1hRate>0.62)biasConfAdj=clamp(biasConfAdj*1.04,0.20,1.60);
    }
    calibMult=Math.round(calibMult*1000)/1000;
    biasConfAdj=Math.round(biasConfAdj*1000)/1000;
    settings.calibMult=calibMult;settings.biasConfAdj=biasConfAdj;
    save(KEY.s,settings);
  }

  function _persist(){save(KEY.proj,log.slice(-200));}
  function reset(){log=[];calibMult=1.0;biasConfAdj=1.0;settings.calibMult=1.0;settings.biasConfAdj=1.0;save(KEY.s,settings);save(KEY.proj,[]);updateProjAccuracyUI();}
  return{logProjection,scoreOutcomes,getStats:_stats,getCalibMult:()=>calibMult,getBiasConfAdj:()=>biasConfAdj,getLog:()=>log.slice(-20).reverse(),reset};
})();



// == DEJA VU ENGINE (Renaissance Probabilistic Regime Blending) ============
const DejaVuEngine=(()=>{
  // Per-state regime character: [trend, revert, disloc, uncert]
  const SC=[
    [0.05,0.90,0.00,0.05],[0.10,0.10,0.10,0.70],[0.60,0.20,0.00,0.20],
    [0.95,0.00,0.05,0.00],[0.65,0.15,0.20,0.00],[0.05,0.10,0.60,0.25],
    [0.05,0.70,0.20,0.05],[0.00,0.30,0.65,0.05],
  ];
  const BS={TRENDING:2.4,MEAN_REVERT:1.6,DISLOCATION:-0.5,UNCERTAIN:0.4};
  function throttle(blend,vr,cf){
    let b=Math.max(blend.trend,blend.revert);
    if(vr==="VOL SPIKE")b*=0.30;else if(vr==="ELEVATED")b*=0.65;else if(vr==="VOL CRUSH")b*=0.85;
    return clamp(b*clamp(0.4+cf*0.8,0.30,1.0),0.10,1.0);
  }
  function compute(probs,conf,vr){
    if(!probs||probs.length!==8)return null;
    let t=0,r=0,d=0,u=0;
    probs.forEach((p,i)=>{t+=p*SC[i][0];r+=p*SC[i][1];d+=p*SC[i][2];u+=p*SC[i][3];});
    const tot=t+r+d+u||1;t/=tot;r/=tot;d/=tot;u/=tot;
    const blend={trend:t,revert:r,disloc:d,uncert:u};
    const buckets=[{name:"TRENDING",val:t,col:"rgba(43,108,255,.90)"},{name:"MEAN-REVERT",val:r,col:"rgba(255,138,64,.90)"},{name:"DISLOCATION",val:d,col:"rgba(255,77,77,.90)"},{name:"UNCERTAIN",val:u,col:"rgba(180,220,255,.65)"}];
    const dom=buckets.reduce((a,b)=>b.val>a.val?b:a);
    const thr=throttle(blend,vr||"NORMAL",conf||0.3);
    const stateVec=SC.map((c,i)=>{const idx=c.indexOf(Math.max(...c));return{state:i+1,prob:probs[i],primary:["Trend","Revert","Disloc","Uncert"][idx]};});
    const condSharpe=BS.TRENDING*t+BS.MEAN_REVERT*r+BS.DISLOCATION*d+BS.UNCERTAIN*u;
    const guidance=dom.name==="TRENDING"?"Follow momentum. Trail stops.":dom.name==="MEAN-REVERT"?"Fade extremes. Tight targets.":dom.name==="DISLOCATION"?"De-risk. Stand aside.":"No clear edge. Reduce size.";
    return{blend,dom,throttle:thr,stateVec,condSharpe,guidance,bucketPcts:{trend:Math.round(t*100),revert:Math.round(r*100),disloc:Math.round(d*100),uncert:Math.round(u*100)}};
  }
  return{compute,BS};
})();

// == QUANT ENGINE (Renaissance / Medallion inspired) ========================
const QuantEngine=(()=>{
  let PH=[],RH=[];
  function push(price){
    const p=Number(price);if(!Number.isFinite(p)||p<=0)return;
    const prev=PH.at(-1);
    PH.push(p);if(PH.length>120)PH.shift();
    if(prev!=null)RH.push((p-prev)*10000);
    if(RH.length>120)RH.shift();
  }
  function hurstRS(){
    const arr=PH.slice(-Math.min(60,PH.length));const n=arr.length;if(n<20)return null;
    const r=[];for(let i=1;i<n;i++)r.push(arr[i]-arr[i-1]);
    const rm=r.reduce((a,b)=>a+b,0)/r.length;
    const X=[];let cum=0;for(const v of r){cum+=v-rm;X.push(cum);}
    const R=Math.max(...X)-Math.min(...X);
    const S=Math.sqrt(r.reduce((a,v)=>a+(v-rm)**2,0)/r.length)||1e-10;
    return clamp(Math.log(R/S)/Math.log(n),0.01,0.99);
  }
  function ac(k){
    const r=RH;const n=r.length;if(n<k+10)return 0;
    const mean=r.reduce((a,b)=>a+b,0)/n;
    let num=0,den=0;
    for(let i=k;i<n;i++)num+=(r[i]-mean)*(r[i-k]-mean);
    for(let i=0;i<n;i++)den+=(r[i]-mean)**2;
    return den>0?clamp(num/den,-1,1):0;
  }
  function kelly(){
    const r=RH.slice(-30);if(r.length<10)return{f:0,pct:0};
    const mu=r.reduce((a,b)=>a+b,0)/r.length;
    const v=r.reduce((a,b)=>a+(b-mu)**2,0)/r.length;
    const f=v>0?clamp(mu/v,-1,1):0;
    return{f,pct:Math.round(Math.abs(f)*100)};
  }
  function volR(){
    const r=RH;if(r.length<10)return{ratio:1,regime:"NORMAL",short:0,long:0};
    const sv=Math.sqrt(r.slice(-5).reduce((a,b)=>a+b*b,0)/5);
    const lz=Math.min(20,r.length);
    const lv=Math.sqrt(r.slice(-lz).reduce((a,b)=>a+b*b,0)/lz)||1e-9;
    const ratio=sv/lv;
    const regime=ratio>2?"VOL SPIKE":ratio>1.4?"ELEVATED":ratio<0.5?"VOL CRUSH":"NORMAL";
    return{ratio:clamp(ratio,0,4),regime,short:sv,long:lv};
  }
  function retHist(){
    const r=RH.slice(-40);if(r.length<5)return{bins:[],min:0,max:0};
    const mn=Math.min(...r),mx=Math.max(...r),range=mx-mn||0.001;
    const bins=new Array(16).fill(0);
    r.forEach(v=>{const i=clamp(Math.floor((v-mn)/range*15.99),0,15);bins[i]++;});
    const peak=Math.max(...bins)||1;
    return{bins:bins.map(b=>b/peak),min:mn,max:mx};
  }
  function halfLife(){
    const a1=ac(1);if(a1>=0||Math.abs(a1)>=1)return null;
    const hl=Math.round(-1/Math.log(Math.abs(a1)));
    return hl>200?null:hl;
  }
  function compute(step,tx,pb3){
    const H=hurstRS();
    const ac1=ac(1),ac2=ac(2),ac3=ac(3),ac4=ac(4),ac5=ac(5);
    const kl=kelly(),vr=volR(),hist=retHist(),hl=halfLife();
    // Determine overall directional bias from strongest signal
    const txDir=(tx?.score??0)>=0.15?"LONG":(tx?.score??0)<=-0.15?"SHORT":null;
    const fxDir=(tx?.fxConf??0)>=0.15?"LONG":(tx?.fxConf??0)<=-0.15?"SHORT":null;
    const hmmBias=step?.policy?([4].includes(step.policy)?"LONG":[5,6,7,8].includes(step.policy)?"SHORT":null):null;
    const overallDir=txDir||fxDir||hmmBias||null;
    function sig(dir){if(!overallDir||!dir)return"off";return dir===overallDir?"on":"against";}
    const hurstDir=H!=null&&H>0.55?"TREND":null;
    const acDir=ac1>0.10?"MOM":ac1<-0.10?"FADE":null;
    const pb3Dom=pb3?.dominant||"NORMAL";
    const signals=[
      {label:"HMM Regime",state:sig(hmmBias)},
      {label:"Macro Tx",state:sig(txDir)},
      {label:"FX Confluence",state:sig(fxDir)},
      {label:"Hurst Edge",state:H!=null&&H>0.55?"on":H!=null&&H<0.45?"off":"off"},
      {label:"AC Momentum",state:acDir==="MOM"?"on":acDir==="FADE"?"against":"off"},
      {label:"Vol Gate",state:vr.regime==="NORMAL"||vr.regime==="VOL CRUSH"?"on":"against"},
      {label:"PB3 Pattern",state:(pb3Dom==="BOOM"||pb3Dom==="BUST")?"on":"off"},
    ];
    const on=signals.filter(s=>s.state==="on").length;
    const against=signals.filter(s=>s.state==="against").length;
    const conviction=clamp((on-against*0.6)/7,0,1);
    return{H,ac1,ac2,ac3,ac4,ac5,kelly:kl,volRegime:vr,hist,halfLife:hl,signals,conviction,onCount:on,againstCount:against};
  }
  return{push,compute,getPrices:()=>PH,getReturns:()=>RH};
})();


// == TRADING ECONOMICS FEED =================================================
const TEFeed=(()=>{
  let cache={},lastFetch=0,calCache=[],calLastFetch=0;
  const TTL=30*60*1000,CAL_TTL=10*60*1000;
  const PROXIES=[
    u=>"https://api.allorigins.win/raw?url="+encodeURIComponent(u),
    u=>"https://corsproxy.io/?"+encodeURIComponent(u),
  ];
  async function proxyFetch(url,ms=12000){
    for(const mkP of PROXIES){
      const prox=mkP(url);const c=new AbortController();const t=setTimeout(()=>c.abort(),ms);
      try{const res=await fetch(prox,{method:"GET",cache:"no-store",signal:c.signal});clearTimeout(t);if(!res.ok)continue;const txt=await res.text();if(!txt||txt.length<5)continue;try{return JSON.parse(txt);}catch{continue;}}catch{clearTimeout(t);}
    }return null;
  }
  const BASE="https://api.tradingeconomics.com/historical/country";
  const IND={
    usFed:   BASE+"/united-states/indicator/interest-rate?c=guest:guest&format=json",
    ecbRate: BASE+"/euro-area/indicator/interest-rate?c=guest:guest&format=json",
    usCpi:   BASE+"/united-states/indicator/inflation-cpi?c=guest:guest&format=json",
    euCpi:   BASE+"/euro-area/indicator/inflation-cpi?c=guest:guest&format=json",
    usMfg:   BASE+"/united-states/indicator/manufacturing-pmi?c=guest:guest&format=json",
    euMfg:   BASE+"/euro-area/indicator/manufacturing-pmi?c=guest:guest&format=json",
    usSvc:   BASE+"/united-states/indicator/services-pmi?c=guest:guest&format=json",
    euSvc:   BASE+"/euro-area/indicator/services-pmi?c=guest:guest&format=json",
    usUnemp: BASE+"/united-states/indicator/unemployment-rate?c=guest:guest&format=json",
    euUnemp: BASE+"/euro-area/indicator/unemployment-rate?c=guest:guest&format=json",
    usGdp:   BASE+"/united-states/indicator/gdp-growth-rate?c=guest:guest&format=json",
    euGdp:   BASE+"/euro-area/indicator/gdp-growth-rate?c=guest:guest&format=json",
    usNfp:   BASE+"/united-states/indicator/non-farm-payrolls?c=guest:guest&format=json",
  };
  // Hardcoded defaults - always populate card even if API unavailable
  const DEF={
    usFed:{v:4.50,p:4.50,d:"Jan 2025"},ecbRate:{v:3.00,p:3.25,d:"Jan 2025"},
    usCpi:{v:2.9,p:2.7,d:"Jan 2025"},euCpi:{v:2.4,p:2.2,d:"Jan 2025"},
    usMfg:{v:49.3,p:49.4,d:"Jan 2025"},euMfg:{v:45.8,p:45.1,d:"Jan 2025"},
    usSvc:{v:52.9,p:54.1,d:"Jan 2025"},euSvc:{v:51.6,p:51.6,d:"Jan 2025"},
    usUnemp:{v:4.1,p:4.1,d:"Jan 2025"},euUnemp:{v:6.3,p:6.3,d:"Jan 2025"},
    usGdp:{v:2.3,p:3.1,d:"Q4 2024"},euGdp:{v:0.2,p:0.4,d:"Q4 2024"},
    usNfp:{v:256,p:307,d:"Jan 2025"},
  };
  function extractLatest(json){
    if(!Array.isArray(json)||!json.length)return null;
    const last=json.at(-1),prev=json.length>1?json.at(-2):null;
    const v=parseFloat(last.Value??last.value??last.Close??0);
    const p=prev?parseFloat(prev.Value??prev.value??0):null;
    return Number.isFinite(v)&&v!==0?{v,p:Number.isFinite(p)&&p!==0?p:null,d:last.DateTime??last.date??""}:null;
  }
  async function fetchOne(key){
    const json=await proxyFetch(IND[key],11000);
    const r=extractLatest(json);
    return r||DEF[key]||null;
  }
  async function tick(){
    const now=Date.now();
    if(now-lastFetch<TTL&&Object.keys(cache).length>5)return;
    const badge=$("teBadge"),info=$("teLastFetch");
    if(badge){badge.className="liveBadge stale";badge.textContent="LOADING";}
    // Always seed with defaults first so card is never empty
    Object.entries(DEF).forEach(([k,d])=>{cache[k]=d;});
    renderTE();
    // Then try live fetch
    const results=await Promise.allSettled(Object.keys(IND).map(k=>fetchOne(k).then(r=>({k,r}))));
    let liveCount=0;
    results.forEach(res=>{if(res.status==="fulfilled"&&res.value?.r){cache[res.value.k]=res.value.r;liveCount++;}});
    lastFetch=now;
    if(badge){badge.className="liveBadge "+(liveCount>3?"live":"stale");badge.textContent=liveCount>3?"LIVE":"DEFAULTS";}
    if(info)info.textContent=liveCount>3?"Live data updated "+fmtTime(now):"Default values shown (API proxies blocked). Data from Jan 2025.";
    renderTE();
    fetchTECal();
  }
  async function fetchTECal(){
    const now=Date.now();if(now-calLastFetch<CAL_TTL)return;
    const badge=$("teCalBadge");
    const CAL_URL="https://api.tradingeconomics.com/calendar/country/united-states,euro-area?c=guest:guest&format=json";
    const json=await proxyFetch(CAL_URL,12000);
    if(json&&Array.isArray(json)&&json.length){
      calCache=json.filter(e=>["High","Medium"].includes(e.Importance||e.importance||""))
        .map(e=>({date:e.Date||e.date||"",name:(e.Event||e.Category||"").trim(),country:e.Country||"",actual:e.Actual??null,forecast:e.Forecast||"",previous:e.Previous||"",impact:e.Importance||"Medium"}))
        .slice(0,20);
      calLastFetch=now;
      if(badge){badge.className="liveBadge live";badge.textContent="LIVE";}
    } else {
      calCache=EventsFeed.get().map(e=>({date:e.when,name:e.event,country:"",actual:null,forecast:e.forecast,previous:e.previous,impact:e.impact}));
      if(badge){badge.className="liveBadge stale";badge.textContent="FF DATA";}
    }
    renderTECal();
  }
  function calcBias(d){
    let s=0,n=0;
    if(d.usFed&&d.ecbRate){s+=clamp((d.usFed.v-d.ecbRate.v)/3,-1,1)*0.40;n++;}
    if(d.usCpi&&d.euCpi){s+=clamp((d.usCpi.v-d.euCpi.v)/2,-1,1)*0.20;n++;}
    const up=((d.usMfg?.v||50)+(d.usSvc?.v||50))/2,ep=((d.euMfg?.v||50)+(d.euSvc?.v||50))/2;
    s+=clamp((up-ep)/5,-1,1)*0.20;n++;
    if(d.usGdp&&d.euGdp){s+=clamp((d.usGdp.v-d.euGdp.v)/2,-1,1)*0.20;n++;}
    return n>0?clamp(s,-1,1):0;
  }
  function renderTE(){
    const d=cache;if(!Object.keys(d).length)return;
    const fN=v=>v!=null?Number(v).toFixed(1):"--";
    const fP=v=>v!=null?Number(v).toFixed(2)+"%":"--";
    const setT=(id,v)=>{const e=$(id);if(e)e.textContent=v;};
    const setH=(id,v)=>{const e=$(id);if(e)e.innerHTML=v;};
    const sigH=(a,b,pl,nl)=>a!=null&&b!=null?(a-b>0.1?"<span class='pos'>"+pl+"</span>":a-b<-0.1?"<span class='neg'>"+nl+"</span>":"<span style='color:rgba(255,255,255,.35)'>Neutral</span>"):"--";
    // Rates
    setT("teFedRate",fP(d.usFed?.v));setT("teFedMeta",d.usFed?"Last: "+d.usFed.d+(d.usFed.p!=null?" | Prev: "+fP(d.usFed.p):""):"");
    setT("teEcbRate",fP(d.ecbRate?.v));setT("teEcbMeta",d.ecbRate?"Last: "+d.ecbRate.d+(d.ecbRate.p!=null?" | Prev: "+fP(d.ecbRate.p):""):"");
    const sp=(d.usFed?.v||0)-(d.ecbRate?.v||0);
    const spEl=$("teSpread");if(spEl){spEl.textContent=(sp>=0?"+":"")+sp.toFixed(2)+"%";spEl.style.color=sp>0?"rgba(43,108,255,.95)":"rgba(255,138,64,.95)";}
    setH("teSpreadSig",sp>0.5?"<span class='neg'>USD hawkish &mdash; EUR/USD bearish</span>":sp<-0.5?"<span class='pos'>EUR hawkish &mdash; EUR/USD bullish</span>":"<span style='color:rgba(255,255,255,.38)'>Rates converging</span>");
    const divUS=$("teDivUS"),divEU=$("teDivEU");
    if(divUS)divUS.style.width=Math.min((d.usFed?.v||0)/8*50,50)+"%";
    if(divEU)divEU.style.width=Math.min((d.ecbRate?.v||0)/8*50,50)+"%";
    // CPI
    setT("teUsCpi",fN(d.usCpi?.v)+"%");setT("teUsCpiP",d.usCpi?.p!=null?fN(d.usCpi.p)+"%":"--");
    setT("teEuCpi",fN(d.euCpi?.v)+"%");setT("teEuCpiP",d.euCpi?.p!=null?fN(d.euCpi.p)+"%":"--");
    setH("teUsCpiS",sigH(d.usCpi?.v,d.euCpi?.v,"USD","EUR"));setH("teEuCpiS",sigH(d.euCpi?.v,d.usCpi?.v,"EUR","USD"));
    const cpiD=d.usCpi&&d.euCpi?(d.usCpi.v-d.euCpi.v).toFixed(1):null;
    setT("teCpiMeta",cpiD?"US-EU CPI spread: "+cpiD+"% → "+(parseFloat(cpiD)>0?"Fed stays hawkish = USD bid":"ECB stays hawkish = EUR bid"):"Loading...");
    // PMI
    setT("teUsMfg",fN(d.usMfg?.v));setT("teUsSvc",fN(d.usSvc?.v));
    setT("teEuMfg",fN(d.euMfg?.v));setT("teEuSvc",fN(d.euSvc?.v));
    const up2=((d.usMfg?.v||50)+(d.usSvc?.v||50))/2,ep2=((d.euMfg?.v||50)+(d.euSvc?.v||50))/2;
    setH("teUsPmiS",up2>50?"<span class='pos'>Expansion</span>":"<span class='neg'>Contraction</span>");
    setH("teEuPmiS",ep2>50?"<span class='pos'>Expansion</span>":"<span class='neg'>Contraction</span>");
    setT("tePmiMeta","US "+up2.toFixed(1)+" vs EU "+ep2.toFixed(1)+" \u2192 "+(up2>ep2?"US leads = USD tailwind":"EU leads = EUR tailwind"));
    // Labor
    setT("teUsUnemp",fN(d.usUnemp?.v)+"%");setT("teUsUnempP",d.usUnemp?.p!=null?fN(d.usUnemp.p)+"%":"--");
    setT("teEuUnemp",fN(d.euUnemp?.v)+"%");setT("teEuUnempP",d.euUnemp?.p!=null?fN(d.euUnemp.p)+"%":"--");
    setT("teUsNfp",d.usNfp?d.usNfp.v+"k":"--");setT("teUsNfpP",d.usNfp?.p!=null?d.usNfp.p+"k":"--");
    setT("teLaborMeta",d.usUnemp&&d.euUnemp?"US "+fN(d.usUnemp.v)+"% vs EU "+fN(d.euUnemp.v)+"% \u2192 "+(d.usUnemp.v<d.euUnemp.v?"US labor tighter = Fed patience = USD bid":"EU labor tighter = EUR supported"):"Loading...");
    // GDP
    setT("teUsGdp",fN(d.usGdp?.v)+"%");setT("teUsGdpP",d.usGdp?.p!=null?fN(d.usGdp.p)+"%":"--");
    setT("teEuGdp",fN(d.euGdp?.v)+"%");setT("teEuGdpP",d.euGdp?.p!=null?fN(d.euGdp.p)+"%":"--");
    setH("teUsGdpS",sigH(d.usGdp?.v,d.euGdp?.v,"USD","EUR"));setH("teEuGdpS",sigH(d.euGdp?.v,d.usGdp?.v,"EUR","USD"));
    const gdpD=d.usGdp&&d.euGdp?(d.usGdp.v-d.euGdp.v).toFixed(1):null;
    setT("teGdpMeta",gdpD?"GDP gap: "+gdpD+"% \u2192 "+(parseFloat(gdpD)>0?"US outperforms = USD support":"EU outperforms = EUR support"):"Loading...");
    // Structural Bias
    const bias=calcBias(d);window._teBias=bias;window._teData=d;
    const pct=Math.round((bias+1)/2*100);
    const bb=$("teBiasBar"),bl=$("teBiasLabel"),bd=$("teBiasDetail"),bm=$("teBiasMeta");
    if(bb){bb.style.width=pct+"%";bb.style.background=bias<-0.15?"rgba(255,77,77,.82)":bias>0.15?"rgba(24,209,138,.82)":"rgba(180,220,255,.38)";}
    if(bl){bl.textContent=bias<-0.25?"USD STRONG":bias<-0.10?"USD LEADS":bias>0.25?"EUR STRONG":bias>0.10?"EUR LEADS":"NEUTRAL";bl.style.color=bias<-0.15?"rgba(255,77,77,.90)":bias>0.15?"rgba(24,209,138,.90)":"rgba(180,220,255,.75)";}
    if(bd)bd.textContent="Score "+(bias>=0?"+":"")+bias.toFixed(3)+" | Spread "+(sp>=0?"+":"")+sp.toFixed(2)+"% | CPI diff "+(d.usCpi&&d.euCpi?(d.usCpi.v-d.euCpi.v).toFixed(1)+"%":"--");
    if(bm)bm.textContent="Rate spread 40% + CPI diff 20% + PMI gap 20% + GDP gap 20%";
    // Inject into Transmission structural overlay
    const txS=$("txStructural");
    if(txS)txS.textContent="TE Structural: "+(bias<-0.15?"USD STRUCTURAL LEAD":bias>0.15?"EUR STRUCTURAL LEAD":"NEUTRAL MACRO")+" ("+(bias>=0?"+":"")+bias.toFixed(2)+")";
  }
  function renderTECal(){
    const el=$("teCalBody");if(!el||!calCache.length){if(el)el.innerHTML="<div style='color:rgba(255,255,255,.35);font-size:11px;padding:8px'>No high-impact events this week.</div>";return;}
    const now=Date.now();
    el.innerHTML=calCache.map(ev=>{
      const dt=new Date(ev.date);const dtStr=Number.isNaN(dt.getTime())?"TBA":dt.toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",timeZone:"UTC"})+" UTC";
      const ms=dt.getTime()-now;const cd=ms>0?(ms>172800000?Math.floor(ms/86400000)+"d":ms>3600000?Math.floor(ms/3600000)+"h"+Math.floor((ms%3600000)/60000)+"m":Math.floor(ms/60000)+"m"):"Past";
      const imp=ev.impact==="High"||ev.impact==="HIGH"?"H":"M";
      const hasA=ev.actual!=null&&ev.actual!=="";
      return "<div class='teCalItem'>"
        +"<div style='display:flex;gap:6px;align-items:center;flex-wrap:wrap'>"
        +"<span class='teCalTime'>"+dtStr+"</span>"
        +"<span class='teImp "+imp+"'>"+ev.impact+"</span>"
        +(ev.country?"<span style='font-size:9px;color:rgba(255,255,255,.32)'>"+ev.country+"</span>":"")
        +"</div>"
        +"<div class='teCalName'>"+ev.name+"</div>"
        +"<div class='teCalVals'>"+(hasA?"<span style='color:rgba(24,209,138,.85)'>A:"+ev.actual+" </span>":"")+(ev.forecast?"F:"+ev.forecast+" ":"")+(ev.previous?"P:"+ev.previous+" ":"")+"<span style='color:rgba(255,176,32,.65)'>"+cd+"</span></div>"
        +"</div>";
    }).join("");
  }
  return{tick,get:()=>cache,getCal:()=>calCache,renderTE,renderTECal};
})();

// ── FIREBASE: writes/reads the COMPLETE state so READERs are pixel-identical ──
const FirebaseSync=(()=>{
  let dbUrl=null,role="MASTER",instanceId=Math.random().toString(36).slice(2,11);
  function init(url,r){
    dbUrl=url?(url.replace(/\/$/,"").replace(/\.json$/,"")):null;
    role=r||"AUTO";
    const el=$("fbStatus");
    if(el)el.textContent=dbUrl?"Firebase: "+dbUrl.split("/").pop()+" | Role: "+role+" | ID: "+instanceId:"Firebase: not configured (running standalone - fully functional)";
    updateBadge();
  }
  async function api(method,path,data){if(!dbUrl)return null;try{const opts={method,headers:{"Content-Type":"application/json"},cache:"no-store"};if(data)opts.body=JSON.stringify(data);const r=await fetch(dbUrl+"/qx5/"+path+".json",opts);if(!r.ok)return null;return method==="GET"?r.json():true;}catch{return null;}}
  async function writeFullState(payload){
    // MASTER and AUTO both write state
    if(!dbUrl||role==="READER")return;
    await api("PUT","state",{...payload,masterId:instanceId,ts:Date.now()});
  }
  async function pullState(){
    // Only READER pulls blindly. AUTO reads but also computes locally.
    if(!dbUrl||role==="AUTO"||role==="MASTER")return null;
    const s=await api("GET","state",null);if(!s||!s.ts)return null;
    if(Date.now()-s.ts>90000)return null;
    return s;
  }
  // AUTO: try to read state but fallback to local compute gracefully
  async function peekState(){
    if(!dbUrl)return null;
    const s=await api("GET","state",null);
    if(!s||!s.ts||Date.now()-s.ts>60000)return null;
    return s;
  }
  function updateBadge(){
    const sb=$("syncBadge");if(!sb)return;
    if(!dbUrl){sb.className="syncBadge synced";sb.innerHTML='<span class="dot"></span><span>STANDALONE</span>';return;}
    if(role==="MASTER"){sb.className="syncBadge fbmaster";sb.innerHTML='<span class="dot"></span><span>FB MASTER</span>';}
    else if(role==="READER"){sb.className="syncBadge fbreader";sb.innerHTML='<span class="dot"></span><span>FB READER</span>';}
    else{sb.className="syncBadge fbmaster";sb.innerHTML='<span class="dot"></span><span>AUTO SYNC</span>';}
  }
  return{init,writeFullState,pullState,peekState,updateBadge,get role(){return role;},get configured(){return!!dbUrl;},get isReader(){return role==="READER";}};
})();

// ── CANVAS ────────────────────────────────────────────────────────────────
function setupCanvas(canvas){const dpr=window.devicePixelRatio||1;const rect=canvas.getBoundingClientRect();const w=Math.max(rect.width,1),h=Math.max(rect.height,1);canvas.width=Math.round(w*dpr);canvas.height=Math.round(h*dpr);const ctx=canvas.getContext("2d");ctx.scale(dpr,dpr);return{ctx,w,h};}
function drawSparkline(canvas,closes,changePct){if(!canvas||!closes?.length)return;const{ctx,w,h}=setupCanvas(canvas);const mn=Math.min(...closes),mx=Math.max(...closes),range=mx-mn||.0001;const isPos=changePct>=0;ctx.clearRect(0,0,w,h);ctx.beginPath();closes.forEach((c,i)=>{const x=(i/(closes.length-1))*w,y=h-((c-mn)/range)*(h-4)-2;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.strokeStyle=isPos?"rgba(24,209,138,.82)":"rgba(255,77,77,.72)";ctx.lineWidth=1.5;ctx.stroke();ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();ctx.fillStyle=isPos?"rgba(24,209,138,.10)":"rgba(255,77,77,.08)";ctx.fill();}
function drawTimeline(canvas,states){if(!canvas||!states.length)return;const{ctx,w,h}=setupCanvas(canvas);const n=states.length,sw=w/n;ctx.clearRect(0,0,w,h);states.forEach((s,i)=>{const st=STATES[s-1];ctx.fillStyle=st?st.color:"rgba(255,255,255,.15)";ctx.fillRect(Math.floor(i*sw),0,Math.ceil(sw)+1,h);});}
function drawCone(spot,r1,r4,bias,calibMult){const canvas=$("coneCanvas");if(!canvas)return;const{ctx,w,h}=setupCanvas(canvas);ctx.clearRect(0,0,w,h);ctx.strokeStyle="rgba(232,239,255,.06)";ctx.lineWidth=1;for(let i=0;i<=14;i++){const x=i*(w/14);ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}for(let j=0;j<=8;j++){const y=j*(h/8);ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}const cm=calibMult||1,cr1=r1*cm,cr4=r4*cm;const cx=Math.round(w*.44),cy=Math.round(h*.52),x1=Math.round(w*.60),x4=Math.round(w*.88);const maxP=Math.max(10,cr4*1.15),ppp=(h*.33)/maxP,y1=cr1*ppp,y4=cr4*ppp;const bu=bias==="LONG",bd=bias==="SHORT",base=bu?[24,209,138]:bd?[255,77,77]:[100,160,255];const rad=ctx.createRadialGradient(cx,cy,0,cx,cy,Math.sqrt((x4-cx)**2+y4**2));rad.addColorStop(0,"rgba("+base.join(",")+",0.42)");rad.addColorStop(.5,"rgba("+base.join(",")+",0.18)");rad.addColorStop(1,"rgba("+base.join(",")+",0.00)");ctx.fillStyle=rad;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(x1,cy-y1);ctx.lineTo(x4,cy-y4);ctx.lineTo(x4,cy+y4);ctx.lineTo(x1,cy+y1);ctx.closePath();ctx.fill();ctx.strokeStyle="rgba(232,239,255,.28)";ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(x4,cy-y4);ctx.stroke();ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(x4,cy+y4);ctx.stroke();ctx.setLineDash([3,4]);ctx.strokeStyle="rgba(232,239,255,.18)";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(x1,cy-y1);ctx.lineTo(x1,cy+y1);ctx.stroke();ctx.setLineDash([]);ctx.strokeStyle="rgba(232,239,255,.25)";ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(0,cy);ctx.lineTo(w,cy);ctx.stroke();ctx.fillStyle="rgba(232,239,255,.90)";ctx.beginPath();ctx.arc(cx,cy,3.5,0,Math.PI*2);ctx.fill();ctx.font="12px ui-monospace,monospace";ctx.fillStyle="rgba(232,239,255,.60)";ctx.fillText("Spot "+spot.toFixed(5),cx+10,cy-6);ctx.fillText("1h \xb1"+Math.round(cr1)+"p",x1-50,18);ctx.fillText("4h \xb1"+Math.round(cr4)+"p",x4-50,18);ctx.font="bold 14px ui-sans-serif,sans-serif";ctx.fillStyle=bu?"rgba(24,209,138,.95)":bd?"rgba(255,77,77,.95)":"rgba(232,239,255,.75)";ctx.fillText(bias,18,24);if(Math.abs(cm-1)>0.01){ctx.font="11px ui-monospace,monospace";ctx.fillStyle="rgba(255,176,32,.80)";ctx.fillText("calib x"+cm.toFixed(2),18,42);}}
function drawEquity(arr){const canvas=$("equityCanvas");if(!canvas||arr.length<2)return;const{ctx,w,h}=setupCanvas(canvas);const mn=Math.min(...arr),mx=Math.max(...arr),range=mx-mn||.0001;const isPos=arr.at(-1)>=0;ctx.clearRect(0,0,w,h);ctx.beginPath();arr.forEach((v,i)=>{const x=(i/(arr.length-1))*w,y=h-((v-mn)/range)*(h-4)-2;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.strokeStyle=isPos?"rgba(24,209,138,.85)":"rgba(255,77,77,.75)";ctx.lineWidth=2;ctx.stroke();ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();ctx.fillStyle=isPos?"rgba(24,209,138,.10)":"rgba(255,77,77,.08)";ctx.fill();if(mn<0&&mx>0){const zy=h-((0-mn)/range)*(h-4)-2;ctx.strokeStyle="rgba(232,239,255,.22)";ctx.lineWidth=1;ctx.setLineDash([3,3]);ctx.beginPath();ctx.moveTo(0,zy);ctx.lineTo(w,zy);ctx.stroke();ctx.setLineDash([]);}}
function drawTM(matrix){const body=$("tmBody");if(!body)return;const rows=[];for(let i=0;i<8;i++){const row=matrix[i],total=row.reduce((a,b)=>a+b,0),norm=total>0?row.map(v=>v/total):new Array(8).fill(0);const cells=norm.map((v,j)=>{const alpha=clamp(v*4,0,.85);const col=v>.3?STATES[j].color.replace(/[\d.]+\)$/,alpha+")"):"rgba(255,255,255,"+(alpha*.5)+")";const txt=v>.01?Math.round(v*100)+"%":"";return"<td style='background:"+col+";color:rgba(255,255,255,"+Math.max(v*3,.6)+");font-size:9px'>"+txt+"</td>";}).join("");rows.push("<tr><td class='rl'>S"+(i+1)+"</td>"+cells+"</tr>");}body.innerHTML=rows.join("");}

function drawTickChart(prices){
  const canvas=$("tickChart");if(!canvas||prices.length<2)return;
  const{ctx,w,h}=setupCanvas(canvas);
  const n=prices.length,mn=Math.min(...prices),mx=Math.max(...prices),range=mx-mn||0.0001;
  ctx.clearRect(0,0,w,h);
  const isUp=prices.at(-1)>=prices[0];
  const col=isUp?"24,209,138":"255,77,77";
  // Grid
  ctx.strokeStyle="rgba(180,220,255,.05)";ctx.lineWidth=1;
  for(let i=1;i<4;i++){const y=h*i/4;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
  // Area fill
  ctx.beginPath();
  prices.forEach((p,i)=>{const x=(i/(n-1))*w,y=h-((p-mn)/range)*(h-10)-5;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();
  const grad=ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,"rgba("+col+",.12)");grad.addColorStop(1,"rgba("+col+",.01)");
  ctx.fillStyle=grad;ctx.fill();
  // Line
  ctx.beginPath();
  prices.forEach((p,i)=>{const x=(i/(n-1))*w,y=h-((p-mn)/range)*(h-10)-5;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.shadowBlur=5;ctx.shadowColor="rgba("+col+",.5)";
  ctx.strokeStyle="rgba("+col+",.88)";ctx.lineWidth=1.5;ctx.stroke();ctx.shadowBlur=0;
  // Current dot
  const ly=h-((prices.at(-1)-mn)/range)*(h-10)-5;
  ctx.beginPath();ctx.arc(w-3,ly,3.5,0,Math.PI*2);
  ctx.fillStyle="rgba("+col+",.95)";ctx.fill();
  // Labels
  ctx.font="10px ui-monospace,monospace";ctx.fillStyle="rgba(232,239,255,.50)";
  ctx.fillText(prices.at(-1).toFixed(5),5,13);
  ctx.fillText(n+"t",w-22,13);
}
let resizeTimer;
window.addEventListener("resize",()=>{clearTimeout(resizeTimer);resizeTimer=setTimeout(()=>{if(lastFullState)applyFullStateToUI(lastFullState);drawTickChart(QuantEngine.getPrices());},200);});

// ── RENDER HELPERS ────────────────────────────────────────────────────────
const impactPill=i=>{const v=(i||"").toUpperCase();if(v==="HIGH")return'<span class="impact"><span class="folder"></span>HIGH</span>';if(v==="MED")return'<span class="impact"><span class="folder med"></span>MED</span>';return'<span class="impact"><span class="folder low"></span>LOW</span>';};
function countdownText(iso){const t=new Date(iso).getTime();if(!Number.isFinite(t))return"--";const d=t-Date.now();if(d<=0)return"Past";const mins=Math.floor(d/60000),days=Math.floor(mins/1440),hrs=Math.floor((mins-days*1440)/60),rem=mins-days*1440-hrs*60;if(days>0)return days+"d "+hrs+"h";if(hrs>0)return hrs+"h "+rem+"m";return rem+"m";}
function renderEvents(){const sorted=EventsFeed.get().map(e=>({...e,t:new Date(e.when).getTime()})).filter(e=>Number.isFinite(e.t)&&e.t>=Date.now()-3600000).sort((a,b)=>a.t-b.t).slice(0,10);const tb=$("eventsBody");if(!tb)return;if(!sorted.length){tb.innerHTML="<tr><td colspan='6' style='color:rgba(255,255,255,.5)'>No upcoming HIGH/MED impact events.</td></tr>";return;}tb.innerHTML=sorted.map(e=>{const w=new Date(e.when),ws=isNaN(w)?"--":w.toLocaleDateString()+" "+w.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return"<tr><td>"+ws+"</td><td><a class='link' href='https://www.forexfactory.com/calendar' target='_blank' rel='noopener noreferrer'>"+escH(e.event||"")+"</a></td><td>"+impactPill(e.impact)+"</td><td style='font-family:var(--mono);color:rgba(255,255,255,.6)'>"+escH(e.forecast||"--")+"</td><td style='font-family:var(--mono);color:rgba(255,255,255,.6)'>"+escH(e.previous||"--")+"</td><td>"+countdownText(e.when)+"</td></tr>";}).join("");}
function renderHeadlines(){const h=HeadlinesFeed.get();const tb=$("headlinesBody");if(!tb)return;if(!h.length){tb.innerHTML="<tr><td colspan='3' style='color:rgba(255,255,255,.5)'>Fetching live headlines...</td></tr>";return;}tb.innerHTML=h.map(hl=>"<tr><td style='white-space:nowrap;font-size:10.5px'>"+escH(hl.time||"")+"</td><td style='font-size:10.5px;white-space:nowrap'>"+escH(hl.source||"")+"</td><td><a class='link' href='"+escA(hl.url||"#")+"' target='_blank' rel='noopener noreferrer'>"+escH(hl.title||"")+"</a></td></tr>").join("");}

// ── TRANSMISSION & PROJECTION ─────────────────────────────────────────────
const normAbsPct=(x,cap)=>!Number.isFinite(x)?0:clamp(Math.abs(x)/cap,0,1);
function computeEventRisk(){const now=Date.now(),wt={HIGH:1.0,MED:0.6,LOW:.25};const up=EventsFeed.get().map(e=>({...e,t:new Date(e.when).getTime()})).filter(e=>Number.isFinite(e.t)&&e.t>=now);let best=0;for(const e of up){const w=wt[(e.impact||"LOW").toUpperCase()]??.25,mins=(e.t-now)/60000;const prox=mins<=60?1:mins<=360?(1-(mins-60)/300)*.85:mins<=1440?(1-(mins-360)/1080)*.35:0;best=Math.max(best,w*prox);}return clamp(best,0,1);}
function computeTx(){
  const oil=MacroFeed.get("OIL"),gold=MacroFeed.get("GOLD"),silv=MacroFeed.get("SILV"),usd=MacroFeed.get("USD"),eRisk=computeEventRisk();
  const gbp=MacroFeed.get("GBP"),aud=MacroFeed.get("AUD"),nzd=MacroFeed.get("NZD");
  const oilInt=normAbsPct(oil?.changePct,3.0),usdInt=normAbsPct(usd?.changePct,0.8),fearInt=normAbsPct(gold?.changePct,1.5),silvInt=normAbsPct(silv?.changePct,2.5);
  const oilDir=(oil?.changePct??0)>=0?-oilInt:oilInt*.4,usdDir=(usd?.changePct??0)>=0?-usdInt:usdInt*.5,fearDir=(gold?.changePct??0)>=0?-fearInt:fearInt*.2,silvDir=(silv?.changePct??0)>=0?silvInt*.25:-silvInt*.15;
  // Correlated pair confluence: GBP+AUD+NZD all moving same direction = strong confirmation
  const fxPairs=[gbp,aud,nzd];const fxDirs=fxPairs.map(p=>p?.changePct!=null?(p.changePct>0.02?1:p.changePct<-0.02?-1:0):null).filter(v=>v!==null);
  const fxConf=fxDirs.length>0?fxDirs.reduce((a,b)=>a+b,0)/fxDirs.length:0; // -1 to +1
  const fxInt=Math.abs(fxConf)*clamp(fxDirs.length/3,0,1); // strength 0-1
  // fxConf>0 = risk currencies up = EUR/USD bullish confirmation; <0 = bearish
  const fxScore=fxConf*fxInt*.30; // max 0.30 contribution
  const baseScore=clamp(.36*oilDir+.44*usdDir+.26*fearDir+.10*silvDir+.22*(-eRisk),-1,1);
  const score=clamp(baseScore+fxScore,-1,1);
  const intensity=clamp(.28*oilInt+.28*usdInt+.18*fearInt+.08*silvInt+.22*eRisk+.12*fxInt,0,1);
  const bias=score<=-.18?"USD+RISK OFF":score>=.18?"USD WEAK/RISK ON":"NEUTRAL";
  const gbpChg=gbp?.changePct??null,audChg=aud?.changePct??null,nzdChg=nzd?.changePct??null;
  return{score,intensity,bias,fxConf,fxInt,gbpChg,audChg,nzdChg,components:{oilInt,usdInt,fearInt,silvInt,eventInt:eRisk,fxInt}};}
function leverPaint(barEl,pctEl,val,dir){const pct=Math.round(val*100);if(pctEl)pctEl.textContent=pct+"%";if(barEl){barEl.style.width=clamp(pct,0,100)+"%";barEl.style.background=dir==="bad"?"rgba(255,77,77,.82)":dir==="good"?"rgba(24,209,138,.82)":"rgba(100,160,255,.78)";}}
function computeProj(step,tx,cm,ba){const base1h={1:6,2:10,3:7,4:12,5:18,6:16,7:14,8:26};const pol=step?.policy||1,volx=step?.features?.volx??1,momBp=bp(step?.features?.mom??0),conf=(step?.conf??.25)*(ba||1);const volMult=clamp(.75+.18*volx,.65,1.85),txMult=clamp(1.0+.55*tx.intensity,1.0,1.6),eRisk=tx.components.eventInt;const r1Raw=Math.round((base1h[pol]??8)*volMult*txMult*clamp(1.0+.65*eRisk,1,1.7));const r4Raw=Math.round(r1Raw*2.6*clamp(1.0+.35*eRisk,1,1.35));const momDir=Math.tanh(momBp/18),score=clamp(.55*momDir+.75*tx.score,-1,1);const bias=score>=.20?"LONG":score<=-.20?"SHORT":"NEUTRAL";const agree=1-Math.abs(momDir-tx.score)/2,dec=clamp(.35*conf+.45*agree+.20*(1-eRisk*.6),0,1);return{bias,r1:clamp(r1Raw,3,80),r4:clamp(r4Raw,6,160),decPct:Math.round(dec*100),volMult,txMult,eRisk};}

// ── BUILD FULL STATE (MASTER packs everything, READERs unpack and render) ──
function buildFullState(step,tx,proj,pb3,arch,spot,recentSts,cm,ba){
  return{
    spotPrice:spot?.price,spotDelta:spot?.lastDelta,spotSource:spot?.source,spotTs:spot?.ts,
    policy:step.policy,detector:step.detector,conf:step.conf,hold:step.hold,
    regimeAge:step.regimeAge,momScore:step.momScore,tickN:step.tickN,warmed:step.warmed,
    probs:step.probs,predictedNext:step.predictedNext,
    stateName:STATES[step.policy-1]?.name,stateDesc:STATES[step.policy-1]?.desc,
    recentStates:recentSts,TM:step.TM,
    bias:proj.bias,r1:proj.r1,r4:proj.r4,decPct:proj.decPct,volMult:proj.volMult,txMult:proj.txMult,eRisk:proj.eRisk,
    calibMult:cm,biasConfAdj:ba,
    pb3Panic:pb3.panic,pb3Bubble:pb3.bubble,pb3Boom:pb3.boom,pb3Bust:pb3.bust,
    pb3Dominant:pb3.dominant,pb3Note:pb3.note,
    archetype:arch.archetype,archConf:arch.confidence,archBias:arch.eurusdBias,archNote:arch.note,archAnalog:arch.analog,
    txScore:tx.score,txIntensity:tx.intensity,txBias:tx.bias,
    oilInt:tx.components.oilInt,usdInt:tx.components.usdInt,fearInt:tx.components.fearInt,eventInt:tx.components.eventInt,
    oilChg:MacroFeed.get("OIL")?.changePct,goldChg:MacroFeed.get("GOLD")?.changePct,usdChg:MacroFeed.get("USD")?.changePct,
    gbpChg:tx.gbpChg,audChg:tx.audChg,nzdChg:tx.nzdChg,fxConf:tx.fxConf,fxInt:tx.fxInt,
    ts:Date.now(),
    teBias:window._teBias??null,teRates:{fed:window._teData?.usFed?.v??null,ecb:window._teData?.ecbRate?.v??null},
    qH:typeof _q!=='undefined'?_q?.H:null,
    qAC1:typeof _q!=='undefined'?_q?.ac1:null,
    qVR:typeof _q!=='undefined'?_q?.volRegime?.regime:null,
    qVRratio:typeof _q!=='undefined'?_q?.volRegime?.ratio:null,
    qKelly:typeof _q!=='undefined'?_q?.kelly?.f:null,
    qConviction:typeof _q!=='undefined'?_q?.conviction:null,
    qOnCount:typeof _q!=='undefined'?_q?.onCount:null,
    qAgainstCount:typeof _q!=='undefined'?_q?.againstCount:null,
    qSignals:typeof _q!=='undefined'?_q?.signals:null,
  };
}
// Inject signal stats + projection data into state for READER rendering
function injectSignalStats(state,sigStats){
  state.sigSharpe=sigStats.sharpe;state.sigWinRate=sigStats.winRate;state.sigOpenPL=sigStats.openPL;
  state.sigTotalPips=sigStats.totalPips;state.sigOpenBias=sigStats.openBias;state.sigTotalSignals=sigStats.totalSignals;
  // Only send last 60 equity points to keep payload small
  state.sigEquity=sigStats.equity.slice(-60);
  // Also inject projection tracker data so READERs see accuracy
  const projS=ProjTracker.getStats();
  state.projDir1h=projS.dir1hRate;state.projRng1h=projS.rng1hRate;
  state.projDir4h=projS.dir4hRate;state.projRng4h=projS.rng4hRate;
  state.projN1h=projS.n1h;state.projN4h=projS.n4h;
  state.projTotal=projS.total;state.projPending=projS.pending;
  state.projCalibMult=ProjTracker.getCalibMult();
  state.projBiasAdj=ProjTracker.getBiasConfAdj();
  return state;
}

// ── APPLY FULL STATE TO UI: works for MASTER (local) and READER (from Firebase) ──
function applyFullStateToUI(st){
  if(!st)return;
  // Regime
  $("policyStateTitle").textContent="Policy State: S"+st.policy+" "+st.stateName;
  $("policyStateDesc").textContent=st.stateDesc+(FirebaseSync.role==="READER"&&st.masterId?" [FB MASTER "+st.masterId.slice(0,6)+"]":"");
  $("detectorChip").textContent="S"+st.detector;$("policyChip").textContent="S"+st.policy;
  $("confChip").textContent=(st.conf*100).toFixed(1)+"%";$("hystChip").textContent=st.detector===st.policy?"stable":"holding";
  $("ageChip").textContent=String(st.regimeAge);$("tickChip").textContent=st.tickN+"/"+Engine.WARMUP;
  $("momChip").textContent=Math.round(st.momScore*100)+"%";
  $("nextStateChip").textContent="S"+st.predictedNext.state+" ("+Math.round(st.predictedNext.prob*100)+"%)";
  if(probEls.length===8&&st.probs?.length===8)
    st.probs.forEach((p,i)=>{probEls[i].bar.style.width=clamp(p*100,0,100)+"%";probEls[i].bar.style.background=STATES[i].color;probEls[i].val.textContent=(p*100).toFixed(1)+"%";});
  if(st.recentStates?.length){drawTimeline($("timelineCanvas"),st.recentStates);const td=$("timelineDepth");if(td)td.textContent=st.recentStates.length;}
  if(st.TM)drawTM(st.TM);
  // Spot
  if(st.spotPrice){
    $("fxSpotPrice").textContent=st.spotPrice.toFixed(5);
    $("fxSpotDelta").textContent=(st.spotDelta||0).toFixed(5);
    $("fxSpotMeta").textContent="Source: "+st.spotSource;
    $("fxLastTag").textContent="Last: "+fmtTime(st.spotTs||Date.now());
    const dw=clamp(Math.abs(st.spotDelta||0)/.0012,0,1)*100;
    const mb=$("miniBar");if(mb){mb.style.width=Math.max(10,dw)+"%";mb.style.background=(st.spotDelta||0)>=0?"rgba(24,209,138,.85)":"rgba(255,77,77,.85)";}
  }
  setRisk(st.policy,st.conf);
  // PB3 - full color-coded rendering
  const pbData={PANIC:st.pb3Panic,BUBBLE:st.pb3Bubble,BOOM:st.pb3Boom,BUST:st.pb3Bust};
  const pbLabels={PANIC:"pb3Panic",BUBBLE:"pb3Bubble",BOOM:"pb3Boom",BUST:"pb3Bust"};
  for(const[k,v]of Object.entries(pbData)){const pct=Math.round((v||0)*100);const pe=$(pbLabels[k]+"Pct"),pb=$(pbLabels[k]+"Bar");if(pe)pe.textContent=pct+"%";if(pb)pb.style.width=clamp(pct,0,100)+"%";}
  const pbColors={PANIC:"rgba(255,77,77,.18),rgba(255,77,77,.08)",BUBBLE:"rgba(255,176,32,.18),rgba(255,176,32,.08)",BOOM:"rgba(24,209,138,.18),rgba(24,209,138,.08)",BUST:"rgba(255,138,64,.18),rgba(255,138,64,.08)",NORMAL:"rgba(8,20,52,.28),rgba(8,20,52,.28)"};
  const pbBorders={PANIC:"rgba(255,77,77,.35)",BUBBLE:"rgba(255,176,32,.35)",BOOM:"rgba(24,209,138,.35)",BUST:"rgba(255,138,64,.35)",NORMAL:"rgba(180,220,255,.10)"};
  const pbTxtColors={PANIC:"rgba(255,100,100,.95)",BUBBLE:"rgba(255,176,32,.95)",BOOM:"rgba(24,209,138,.95)",BUST:"rgba(255,138,64,.95)",NORMAL:"rgba(232,239,255,.65)"};
  const dom=st.pb3Dominant||"NORMAL",pbRow=$("pb3Dom");
  if(pbRow){const[bg1,bg2]=(pbColors[dom]||pbColors.NORMAL).split(",");pbRow.style.background="linear-gradient(135deg,"+bg1.trim()+","+bg2.trim()+")";pbRow.style.borderColor=pbBorders[dom]||pbBorders.NORMAL;}
  const pds=$("pb3DomState"),pdn=$("pb3DomNote");
  if(pds){pds.textContent=dom;pds.style.color=pbTxtColors[dom]||pbTxtColors.NORMAL;}
  if(pdn)pdn.textContent=st.pb3Note||"";
  // Archetype - full color-coded rendering
  const arcBg={"COMBINED SHOCK":"rgba(255,58,165,.15)","SUPPLY SHOCK":"rgba(255,77,77,.15)","RISK-OFF PANIC":"rgba(255,176,32,.15)","LOCALIZED EVENT":"rgba(120,170,255,.12)","RATE / DOLLAR PLAY":"rgba(43,108,255,.15)","QUIET TAPE":"rgba(8,20,52,.28)","MIXED SIGNALS":"rgba(100,80,200,.12)","--":"rgba(8,20,52,.28)"};
  const arcBorder={"COMBINED SHOCK":"rgba(255,58,165,.35)","SUPPLY SHOCK":"rgba(255,77,77,.30)","RISK-OFF PANIC":"rgba(255,176,32,.30)","LOCALIZED EVENT":"rgba(120,170,255,.25)","RATE / DOLLAR PLAY":"rgba(43,108,255,.30)","QUIET TAPE":"rgba(180,220,255,.10)","MIXED SIGNALS":"rgba(140,100,220,.25)","--":"rgba(180,220,255,.10)"};
  const am=$("archMain");if(am){am.style.background=arcBg[st.archetype]||arcBg["--"];am.style.border="1px solid "+(arcBorder[st.archetype]||arcBorder["--"]);}
  const at=$("archType"),ac=$("archConf"),ab=$("archBias"),an=$("archNote"),aa=$("archAnalog");
  if(at)at.textContent=st.archetype;
  if(ac)ac.textContent="Confidence: "+Math.round((st.archConf||0)*100)+"%";
  if(ab)ab.innerHTML="EUR/USD Bias: <b class='"+(st.archBias==="BEARISH"?"neg":st.archBias==="BULLISH"?"pos":"")+"'>"+st.archBias+"</b>";
  if(an)an.textContent=st.archNote||"";if(aa)aa.textContent=st.archAnalog||"";
  // Projection
  const tb=$("tradeBias");if(tb){tb.textContent=st.bias;tb.classList.remove("pos","neg");if(st.bias==="LONG")tb.classList.add("pos");if(st.bias==="SHORT")tb.classList.add("neg");}
  const tbm=$("tradeBiasMeta");if(tbm)tbm.textContent=st.txBias+" | Event "+Math.round(st.eRisk*100)+"%";
  const r1el=$("rng1h"),r1m=$("rng1hMeta"),r4el=$("rng4h"),r4m=$("rng4hMeta");
  if(r1el)r1el.textContent="\xb1"+st.r1+" pips";if(r1m)r1m.textContent="Vol x"+st.volMult.toFixed(2)+" Macro x"+st.txMult.toFixed(2);
  if(r4el)r4el.textContent="\xb1"+st.r4+" pips";if(r4m)r4m.textContent="4h scaled | Tx "+st.txScore.toFixed(2);
  const dc=$("decConf"),dcm=$("decConfMeta");if(dc){dc.textContent=st.decPct+"%";dc.classList.remove("pos","neg");if(st.decPct>=55)dc.classList.add("pos");if(st.decPct<=30)dc.classList.add("neg");}
  if(dcm)dcm.textContent=st.decPct>=55?"Higher agreement":st.decPct>=40?"Mixed signals":"Caution";
  const cm=$("calibMult");if(cm)cm.textContent=(st.calibMult||1).toFixed(2);
  drawCone(st.spotPrice||1.05,st.r1,st.r4,st.bias,st.calibMult||1);
  // Transmission
  const mbc=$("macroBiasChip"),tsc=$("txScoreChip"),erc=$("eventRiskChip");
  if(mbc)mbc.textContent=st.txBias;if(tsc)tsc.textContent=st.txScore.toFixed(2);
  if(erc)erc.textContent=st.eventInt>=.70?"HIGH":st.eventInt>=.35?"MED":"LOW";
  const tb2=$("txBig"),tm=$("txMeta");
  if(tb2)tb2.textContent=st.txScore<=-.18?"BEAR EURUSD":st.txScore>=.18?"BULL EURUSD":"NEUTRAL";
  if(tm)tm.textContent="Score "+st.txScore.toFixed(2)+" | "+st.txBias+" | Intensity "+Math.round(st.txIntensity*100)+"%";
  leverPaint($("oilLeverBar"),$("oilLeverPct"),st.oilInt,(st.oilChg??0)>=0?"bad":"good");
  leverPaint($("usdLeverBar"),$("usdLeverPct"),st.usdInt,(st.usdChg??0)>=0?"bad":"good");
  leverPaint($("fearLeverBar"),$("fearLeverPct"),st.fearInt,(st.goldChg??0)>=0?"bad":"good");
  leverPaint($("eventLeverBar"),$("eventLeverPct"),st.eventInt,st.eventInt>=.35?"bad":"neutral");
  {const fxc=st.fxConf||0,fxi=st.fxInt||0,fxlv=Math.abs(fxc)*clamp(fxi*1.5,0,1);
   leverPaint($("fxLeverBar"),$("fxLeverPct"),fxlv,fxc>0.15?"good":fxc<-0.15?"bad":"neutral");
   const fxlm=$("fxLeverMeta");if(fxlm)fxlm.textContent=fxc>0.15?"Bullish confluence — "+Math.round(fxlv*100)+"% confirm":fxc<-0.15?"Bearish confluence — "+Math.round(fxlv*100)+"% confirm":"Mixed/neutral";
   const fxcEl=$("fxConfChip"),fxiEl=$("fxIntChip"),fxbEl=$("fxConfBig"),fxmEl=$("fxConfMeta");
   if(fxcEl)fxcEl.textContent=fxc>0.15?"▲ BULL CONFIRM":fxc<-0.15?"▼ BEAR CONFIRM":"MIXED";
   if(fxiEl)fxiEl.textContent=Math.round(fxi*100)+"%";
   if(fxbEl)fxbEl.textContent="GBP+AUD+NZD confluence";
   if(fxmEl)fxmEl.textContent="From MASTER state";}
  // Footer
  const fp=$("footPolicy"),fd=$("footDetector"),fa=$("footAge");
  if(fp)fp.textContent="S"+st.policy;if(fd)fd.textContent="S"+st.detector;if(fa)fa.textContent=String(st.regimeAge);
  updateWarmupBadge(st.tickN,st.warmed);
  // Projection Accuracy for READER: render from MASTER's computed stats
  if(FirebaseSync.isReader&&st.projTotal!=null){
    const fmt=r=>r!=null?Math.round(r*100)+"%":"--";
    const setV=(id,v,ok,bad)=>{const el=$(id);if(!el)return;el.textContent=v;el.classList.remove("pos","neg");if(ok)el.classList.add("pos");else if(bad)el.classList.add("neg");};
    setV("pa1hDir",fmt(st.projDir1h),st.projDir1h>=0.55,st.projDir1h!=null&&st.projDir1h<0.45);
    setV("pa1hRng",fmt(st.projRng1h),st.projRng1h>=0.60&&st.projRng1h<=0.82,false);
    setV("pa4hDir",fmt(st.projDir4h),st.projDir4h>=0.55,st.projDir4h!=null&&st.projDir4h<0.45);
    setV("pa4hRng",fmt(st.projRng4h),st.projRng4h>=0.60&&st.projRng4h<=0.82,false);
    setV("paCalibMult",(st.projCalibMult||1).toFixed(3)+"x",Math.abs((st.projCalibMult||1)-1)<0.05,false);
    const ptn=$("paTotalN"),ptm=$("paTotalMeta");
    if(ptn)ptn.textContent=String(st.projTotal||0);
    if(ptm)ptm.textContent=((st.projTotal||0)-(st.projPending||0))+" resolved, "+(st.projPending||0)+" pending";
    const p1dm=$("pa1hDirMeta");if(p1dm)p1dm.textContent="n="+(st.projN1h||0)+" scored";
    const p4dm=$("pa4hDirMeta");if(p4dm)p4dm.textContent="n="+(st.projN4h||0)+" scored";
    const ready=Math.min(st.projN1h||0,st.projN4h||0)>=5;
    const ps=$("paStatus");if(ps)ps.textContent=ready?"Active from MASTER":"Collecting on MASTER ("+Math.min(st.projN1h||0,st.projN4h||0)+"/5)";
    const pca=$("paConeAdj"),cm=st.projCalibMult||1;
    if(pca)pca.textContent=cm>1.05?"Widening":cm<0.95?"Tightening":"Neutral";
  }
  if(st.teBias!=null){window._teBias=st.teBias;const txS=$('txStructural');if(txS)txS.textContent='TE Structural: '+(st.teBias<-0.15?'USD STRUCTURAL LEAD':st.teBias>0.15?'EUR STRUCTURAL LEAD':'NEUTRAL MACRO')+' ('+(st.teBias>=0?'+':'')+st.teBias.toFixed(2)+')';}  // Deja Vu for READER
  if(st.probs&&st.probs.length===8){const dvR=DejaVuEngine.compute(st.probs,st.conf||0.3,st.qVR||'NORMAL');if(dvR)updateDejaVuUI(dvR);}
  // Quant Engine for READER: render from state fields
  if(st.qH!=null){updateQuantUI({H:st.qH,ac1:st.qAC1||0,ac2:0,ac3:0,ac4:0,ac5:0,kelly:{f:st.qKelly||0,pct:Math.round(Math.abs(st.qKelly||0)*100)},volRegime:{ratio:st.qVRratio||1,regime:st.qVR||'NORMAL'},hist:{bins:[],min:0,max:0},halfLife:null,signals:st.qSignals||[],conviction:st.qConviction||0,onCount:st.qOnCount||0,againstCount:st.qAgainstCount||0});}
  // Signal Performance: if state has signal stats (from MASTER), render them
  // This gives READER identical signal display to MASTER
  if(st.sigEquity!=null){
    updateSharpeUI({sharpe:st.sigSharpe,winRate:st.sigWinRate,openPL:st.sigOpenPL,
      totalPips:st.sigTotalPips||0,openBias:st.sigOpenBias,totalSignals:st.sigTotalSignals||0,equity:st.sigEquity||[0]});
  }
  // FX pair confluence chips in transmission
  const fxcEl=$("fxConfChip"),fxiEl=$("fxIntChip");
  if(fxcEl)fxcEl.textContent=st.fxConf!=null?(st.fxConf>0.15?"BULL CONFIRM":st.fxConf<-0.15?"BEAR CONFIRM":"MIXED"):"--";
  if(fxiEl)fxiEl.textContent=st.fxInt!=null?Math.round(st.fxInt*100)+"%":"--";
  // FX pair macro display
  paintFxPair("GBP","gbpPx","gbpMeta","gbpTag","gbpSpark",st.gbpChg);
  paintFxPair("AUD","audPx","audMeta","audTag","audSpark",st.audChg);
  paintFxPair("NZD","nzdPx","nzdMeta","nzdTag","nzdSpark",st.nzdChg);
}

// ── PROJECTION ACCURACY UI ────────────────────────────────────────────────


function updateDejaVuUI(dv){
  if(!dv)return;
  const{blend,dom,throttle:thr,stateVec,condSharpe,guidance,bucketPcts}=dv;
  // Blend bar
  const dislocPct=bucketPcts.disloc;
  const nonTrend=bucketPcts.revert+dislocPct;
  const setEl=(id,v)=>{const e=$(id);if(e)e.textContent=v;};
  const setW=(id,w)=>{const e=$(id);if(e)e.style.width=w+"%";};
  setW("dvTrendBar",bucketPcts.trend);setEl("dvTrendPct",bucketPcts.trend+"%");
  setW("dvRevertBar",nonTrend);setEl("dvRevertPct",nonTrend+"%");
  setW("dvUncertBar",bucketPcts.uncert);setEl("dvUncertPct",bucketPcts.uncert+"%");
  const bm=$("dvBlendMeta");if(bm)bm.textContent=guidance;
  // Bucket label
  const bk=$("dvBucket"),bkm=$("dvBucketMeta");
  if(bk){bk.textContent=dom.name;bk.style.color=dom.col;}
  if(bkm)bkm.textContent="Cond. Sharpe "+(condSharpe>=0?"+":"")+condSharpe.toFixed(2)+" | "+guidance.split(".")[0];
  // Throttle
  const tPct=Math.round(thr*100);
  setW("dvThrottleFill",tPct);
  const tf=$("dvThrottleFill");if(tf)tf.style.background=thr>=0.75?"rgba(24,209,138,.82)":thr>=0.45?"rgba(255,176,32,.82)":"rgba(255,77,77,.82)";
  setEl("dvThrottlePct",tPct+"%");
  setEl("dvThrottleLabel",thr>=0.75?"Full risk":thr>=0.45?"Reduced risk":thr>=0.25?"Minimum size":"Stand aside");
  // Conditional Sharpe bars
  [{id:"cse1",val:dv.dom?DejaVuEngine.BS.TRENDING:2.4,col:"rgba(43,108,255,.80)"},
   {id:"cse2",val:DejaVuEngine.BS.MEAN_REVERT,col:"rgba(255,138,64,.80)"},
   {id:"cse3",val:DejaVuEngine.BS.DISLOCATION,col:"rgba(255,77,77,.80)"},
   {id:"cse4",val:DejaVuEngine.BS.UNCERTAIN,col:"rgba(180,220,255,.45)"},
  ].forEach(b=>{
    const f=$(b.id+"f"),v=$(b.id+"v");
    const pct=Math.max(0,(b.val+1)/4*100);
    if(f){f.style.width=pct+"%";f.style.background=b.col;}
    if(v){v.textContent=(b.val>=0?"+":"")+b.val.toFixed(1);v.style.color=b.col;}
  });
  // State vector
  const sv=$("dvStateVec");
  if(sv){
    const cols={Trend:"rgba(43,108,255,.85)",Revert:"rgba(255,138,64,.85)",Disloc:"rgba(255,77,77,.85)",Uncert:"rgba(180,220,255,.55)"};
    const bgs={Trend:"rgba(43,108,255,.10)",Revert:"rgba(255,138,64,.10)",Disloc:"rgba(255,77,77,.10)",Uncert:"rgba(8,20,52,.22)"};
    sv.innerHTML=stateVec.map(s=>{
      const c=cols[s.primary]||cols.Uncert,bg=bgs[s.primary]||bgs.Uncert;
      return "<div class='svBox' style='background:"+bg+";border-color:"+c+"'><div class='sl'>S"+s.state+"</div><div class='sp' style='color:"+c+"'>"+Math.round(s.prob*100)+"%</div><div class='st'>"+s.primary+"</div></div>";
    }).join("");
  }
  // Quadrant pcts
  [["dqTrendPct",bucketPcts.trend],["dqRevertPct",bucketPcts.revert],["dqDislocPct",bucketPcts.disloc],["dqUncertPct",bucketPcts.uncert]].forEach(([id,pct])=>setEl(id,pct+"%"));
  // Highlight dominant quadrant
  [["dqTrend","TRENDING"],["dqRevert","MEAN-REVERT"],["dqDisloc","DISLOCATION"],["dqUncert","UNCERTAIN"]].forEach(([id,name])=>{
    const el=$(id);if(!el)return;el.style.transform=dom.name===name?"scale(1.02)":"scale(1)";el.style.boxShadow=dom.name===name?"0 0 18px rgba(255,255,255,.04)":"none";
  });
}

function updateQuantUI(q){
  if(!q)return;
  // Hurst
  {const hv=$("hurstVal"),hl=$("hurstLabel"),hf=$("hurstFill"),hm=$("hurstMeta");
   if(q.H!=null){
     if(hv)hv.textContent=q.H.toFixed(3);
     const lbl=q.H>0.62?"STRONG TREND":q.H>0.55?"Mild Trend":q.H<0.38?"MEAN-REVERT":q.H<0.45?"Mild Revert":"RANDOM";
     const clr=q.H>0.55?"rgba(24,209,138,.90)":q.H<0.45?"rgba(255,138,64,.90)":"rgba(180,220,255,.60)";
     if(hl){hl.textContent=lbl;hl.style.color=clr;}
     if(hf){hf.style.width=(q.H*100)+"%";hf.style.background=clr;}
     if(hm)hm.textContent=q.H>0.55?"Momentum persists. Trend-follow confirmed.":q.H<0.45?"Mean-revert active. Fade spikes, buy dips.":"No persistent edge. Size down.";
   }}
  // ACs
  [1,2,3,4,5].forEach(i=>{
    const b=$("ac"+i+"b");if(!b)return;
    const v=q["ac"+i]||0,abs=Math.abs(v);
    const isPos=v>=0;
    b.style.height=Math.max(4,abs*200)+"%";
    b.style.background=isPos?"rgba(24,209,138,"+clamp(abs*2.5,.25,.95)+")":"rgba(255,77,77,"+clamp(abs*2.5,.25,.95)+")";
  });
  const a1v=$("ac1Val"),am=$("acMeta");
  if(a1v)a1v.textContent=(q.ac1>=0?"+":"")+q.ac1.toFixed(3);
  if(am)am.textContent=q.ac1>0.10?"Positive: momentum persists -> follow":q.ac1<-0.10?"Negative: reversals likely -> fade":"No strong serial structure";
  // Vol ring
  {const vr=q.volRegime,ve=$("volRegimeLbl"),vm=$("volMeta"),va=$("volArc"),vrl=$("volRatioLbl");
   const clr=vr.regime==="VOL SPIKE"?"rgba(255,77,77,.90)":vr.regime==="ELEVATED"?"rgba(255,138,64,.85)":vr.regime==="VOL CRUSH"?"rgba(43,108,255,.80)":"rgba(24,209,138,.80)";
   if(ve){ve.textContent=vr.regime;ve.style.color=clr;}
   if(vm)vm.textContent="Ratio "+vr.ratio.toFixed(2)+"x"+(vr.regime==="VOL SPIKE"?" -- size DOWN now!":vr.regime==="ELEVATED"?" -- reduce size":"");
   if(vrl)vrl.textContent=vr.ratio.toFixed(1)+"x";
   if(va){const pct=clamp(vr.ratio/3,0,1);va.style.strokeDashoffset=(138*(1-pct));va.style.stroke=clr;}}
  // Kelly
  {const kv=$("kellyVal"),kf=$("kellyFill"),km=$("kellyMeta");
   if(kv){kv.textContent=(q.kelly.f>=0?"+":"")+q.kelly.f.toFixed(3);kv.classList.remove("pos","neg");if(q.kelly.f>0.05)kv.classList.add("pos");if(q.kelly.f<-0.05)kv.classList.add("neg");}
   if(kf){kf.style.width=q.kelly.pct+"%";kf.style.background=q.kelly.f>=0?"rgba(24,209,138,.82)":"rgba(255,77,77,.82)";}
   if(km)km.textContent=q.kelly.pct+"%"+( q.kelly.pct>50?" -- high conviction":q.kelly.pct>20?" -- moderate edge":" -- thin edge: size minimum");}
  // Histogram
  {const hw=$("retHistWrap"),hm=$("retHistMeta");
   if(hw&&q.hist?.bins?.length){
     hw.innerHTML=q.hist.bins.map((b,i)=>{
       const mid=q.hist.min+(q.hist.max-q.hist.min)*(i+.5)/16;
       const isPos=mid>=0,ht=Math.max(4,Math.round(b*50));
       return "<div class='histBar' style='height:"+ht+"px;background:"+(isPos?"rgba(24,209,138,"+clamp(b*.55+.18,.18,.78)+")":"rgba(255,77,77,"+clamp(b*.55+.18,.18,.78)+")")+"' title='"+(mid>=0?"+":"")+mid.toFixed(1)+"p'></div>";
     }).join("");
     if(hm)hm.textContent="Range "+q.hist.min.toFixed(1)+"p to +"+q.hist.max.toFixed(1)+"p | Fat tails indicate dislocation risk";
   }}
  // Half-life
  {const hlv=$("halfLifeVal"),hlm=$("halfLifeMeta");
   if(hlv)hlv.textContent=q.halfLife!=null?q.halfLife+" ticks":"--";
   if(hlm)hlm.textContent=q.halfLife!=null?"Edge decays ~"+q.halfLife+" ticks (mean-revert)":"N/A in trending/random regime";}
  // Signal stack
  {const ss=$("sigStack");
   if(ss)ss.innerHTML=q.signals.map(s=>"<div class='sigPill "+s.state+"'><span class='sdot'></span>"+s.label+"</div>").join("");}
  // Conviction arc
  {const ca=$("convicArc"),cp=$("convicPct"),cl=$("convicLabel"),cd=$("convicDesc"),sf=$("stkFill"),cr=$("convicRow");
   const pct=Math.round(q.conviction*100),circ=176;
   const clr=q.conviction>=0.60?"rgba(24,209,138,.90)":q.conviction>=0.35?"rgba(255,176,32,.90)":"rgba(180,220,255,.60)";
   if(ca){ca.style.strokeDashoffset=(circ*(1-q.conviction));ca.style.stroke=clr;}
   if(cp)cp.textContent=pct+"%";
   if(cl){cl.textContent=q.conviction>=0.65?"HIGH CONVICTION":q.conviction>=0.45?"MODERATE":q.conviction>=0.25?"BUILDING":"NEUTRAL";cl.style.color=clr;}
   if(cd)cd.textContent=q.onCount+" of 7 signals aligned, "+q.againstCount+" against";
   if(sf){sf.style.width=pct+"%";sf.style.background=clr;}
   if(cr)cr.style.borderColor=q.conviction>=0.6?"rgba(24,209,138,.25)":q.conviction>=0.35?"rgba(255,176,32,.20)":"rgba(180,220,255,.10)";}
}

function updateProjAccuracyUI(){
  const s=ProjTracker.getStats(),cm=ProjTracker.getCalibMult(),ba=ProjTracker.getBiasConfAdj();
  const fmt=r=>r!=null?Math.round(r*100)+"%":"--";
  const setV=(id,v,ok,bad)=>{const el=$(id);if(!el)return;el.textContent=v;el.classList.remove("pos","neg");if(ok)el.classList.add("pos");else if(bad)el.classList.add("neg");};
  setV("pa1hDir",fmt(s.dir1hRate),s.dir1hRate>=0.55,s.dir1hRate!=null&&s.dir1hRate<0.45);
  const p1dm=$("pa1hDirMeta");if(p1dm)p1dm.textContent="n="+s.n1h+" scored";
  setV("pa1hRng",fmt(s.rng1hRate),s.rng1hRate>=0.60&&s.rng1hRate<=0.82,s.rng1hRate!=null&&(s.rng1hRate<0.45||s.rng1hRate>0.88));
  setV("pa4hDir",fmt(s.dir4hRate),s.dir4hRate>=0.55,s.dir4hRate!=null&&s.dir4hRate<0.45);
  const p4dm=$("pa4hDirMeta");if(p4dm)p4dm.textContent="n="+s.n4h+" scored";
  setV("pa4hRng",fmt(s.rng4hRate),s.rng4hRate>=0.60&&s.rng4hRate<=0.82,s.rng4hRate!=null&&(s.rng4hRate<0.45||s.rng4hRate>0.88));
  setV("paCalibMult",cm.toFixed(3)+"x",Math.abs(cm-1)<0.05,false);
  const pcm=$("paCalibMeta");if(pcm)pcm.textContent=cm>1.05?"Widening cone":cm<0.95?"Tightening cone":"Well-calibrated";
  const ptn=$("paTotalN"),ptm=$("paTotalMeta");if(ptn)ptn.textContent=String(s.total);if(ptm)ptm.textContent=(s.total-s.pending)+" resolved, "+s.pending+" pending";
  const ready=Math.min(s.n1h,s.n4h)>=10;
  const ps=$("paStatus"),pca=$("paConeAdj"),pba=$("paBiasAdj");
  if(ps)ps.textContent=ready?"Active ("+Math.min(s.n1h,s.n4h)+"+ scored)":"Collecting data (need 10, have "+Math.min(s.n1h,s.n4h)+")";
  if(pca)pca.textContent=cm>1.05?"Widening (+"+Math.round((cm-1)*100)+"%)":cm<0.95?"Tightening (-"+Math.round((1-cm)*100)+"%)":"Neutral";
  if(pba)pba.textContent=ba<0.95?"Reducing weight (-"+Math.round((1-ba)*100)+"%)":ba>1.05?"Increasing weight (+"+Math.round((ba-1)*100)+"%)":"Neutral";
  // Mini chips in projection header
  const cmc=$("calibMult"),c1d=$("calib1hDir"),c1r=$("calib1hRng"),c4d=$("calib4hDir"),c4r=$("calib4hRng"),cn=$("calibN");
  if(cmc)cmc.textContent=cm.toFixed(2);if(c1d)c1d.textContent=fmt(s.dir1hRate);if(c1r)c1r.textContent=fmt(s.rng1hRate);if(c4d)c4d.textContent=fmt(s.dir4hRate);if(c4r)c4r.textContent=fmt(s.rng4hRate);if(cn)cn.textContent=s.total;
  // Log table
  const plb=$("paLogBody");if(!plb)return;
  const log=ProjTracker.getLog();
  if(!log.length){plb.innerHTML="<tr><td colspan='8' class='pending'>No projections logged yet. First entry scores after 1 hour.</td></tr>";return;}
  plb.innerHTML=log.map(p=>{
    const d1=p.outcome1h,d4=p.outcome4h;
    const cls=v=>v===null?"pending":v?"hit":"miss";
    const dtxt=o=>o===null?"...":o.dirHit?"Y("+o.movePips.toFixed(1)+"p)":"N("+o.movePips.toFixed(1)+"p)";
    const rtxt=o=>o===null?"...":o.rngHit?"IN":"OUT";
    return"<tr><td>"+fmtTS(p.ts)+"</td>"
      +"<td class='"+(p.bias==="LONG"?"pos":"neg")+"'>"+p.bias+"</td>"
      +"<td style='font-family:var(--mono)'>\xb1"+p.r1+"p</td>"
      +"<td style='font-family:var(--mono)'>\xb1"+p.r4+"p</td>"
      +"<td class='"+cls(d1?.dirHit??null)+"'>"+dtxt(d1)+"</td>"
      +"<td class='"+cls(d1?.rngHit??null)+"'>"+rtxt(d1)+"</td>"
      +"<td class='"+cls(d4?.dirHit??null)+"'>"+dtxt(d4)+"</td>"
      +"<td class='"+cls(d4?.rngHit??null)+"'>"+rtxt(d4)+"</td>"
      +"</tr>";
  }).join("");
}

// ── FX PAIR DISPLAY HELPER ───────────────────────────────────────────────
function paintFxPair(key,pxId,metaId,tagId,sparkId,changePct){
  const rec=MacroFeed.get(key);
  const pEl=$(pxId),mEl=$(metaId),tEl=$(tagId),sEl=$(sparkId);
  // If we have live data from MacroFeed use it, else use changePct from state
  const src=rec||null;
  if(!src&&changePct==null){if(pEl)pEl.textContent="--";if(tEl){tEl.textContent=key;tEl.className="liveBadge error";}return;}
  const chg=src?.changePct??changePct??0;
  const close=src?.close;
  const fmtPx=x=>!Number.isFinite(x)?"--":x.toFixed(5);
  const fmtPct=x=>(x>=0?"+":"")+x.toFixed(3)+"%";
  if(pEl){pEl.textContent=close?fmtPx(close):"--";pEl.classList.remove("pos","neg");if(chg>0.02)pEl.classList.add("pos");if(chg<-0.02)pEl.classList.add("neg");}
  if(mEl)mEl.textContent=fmtPct(chg)+(src?" Prev "+fmtPx(src.prevClose):"");
  if(tEl){tEl.textContent=key;const ma=src?minsAgo(src.ts):null;tEl.className="liveBadge "+(ma!=null&&ma<120?"live":"stale");}
  if(sEl&&src?.closes?.length>1)drawSparkline(sEl,src.closes,chg);
}

// ── MISC UI ───────────────────────────────────────────────────────────────
function setRisk(pol,cf){const MAP={1:["NORMAL","Range logic. Fade extremes."],2:["ELEVATED","Thin liquidity. Reduce size."],3:["NORMAL","Drift regime. Small edges."],4:["HIGH","Trend regime. Bias with trend."],5:["HIGH","Stop cascade. De-risk."],6:["HIGH","News shock. Consider standing down."],7:["ELEVATED","Unwind risk. Protect capital."],8:["CRITICAL","Risk off. Protect capital first."]};let[level,rule]=MAP[pol]||["--","State-aware sizing"];if(cf!=null){if(cf<.35&&level==="NORMAL")level="ELEVATED";if(cf<.25&&level==="ELEVATED")level="HIGH";}const rb=$("riskBig"),rr=$("riskRule");if(rb){rb.textContent=level;rb.classList.remove("pos","neg");if(level==="NORMAL")rb.classList.add("pos");if(["CRITICAL","HIGH"].includes(level))rb.classList.add("neg");}if(rr)rr.textContent=rule;}
function setFxStatus(st){const fs=$("fxSpotStatus"),fd=$("fxStatusDot");if(fs)fs.textContent=st;if(fd){fd.classList.remove("live","err");if(st==="LIVE")fd.classList.add("live");else if(st==="ERROR"||st==="STALE")fd.classList.add("err");}}
function updateSessionUI(){const{openSessions,primary,isOverlap,dayInfo,minsLeft}=SessionEngine.compute();SessionEngine.SESS.forEach(s=>{const box=$("sb_"+s.id),st=$("ss_"+s.id);if(!box||!st)return;const isOpen=openSessions.includes(s.id),isOL=isOverlap&&(s.id==="LONDON"||s.id==="NEW_YORK");box.style.borderColor=isOpen?s.color.replace(/[\d.]+\)$/,"0.40)"):"rgba(180,220,255,.10)";box.style.background=isOpen?s.color.replace(/[\d.]+\)$/,"0.07)"):"rgba(8,20,52,.22)";st.textContent=isOL?"Overlap":isOpen?"Open":"Closed";st.className="sStat "+(isOL?"overlap":isOpen?"open":"closed");});const cdn=$("currentDayName"),csl=$("currentSessionLabel"),den=$("dayEffectNote"),sob=$("sessionOverlapBadge"),sml=$("sessionMinsLeft");if(cdn)cdn.textContent=dayInfo.name;if(csl)csl.textContent=primary?"Session: "+primary.label:"Session: Closed";if(den)den.textContent=dayInfo.effect;if(sob){sob.textContent=isOverlap?"LDN/NY OVERLAP - Highest Vol":openSessions.length?openSessions.join("+")+" Open":"All sessions closed";sob.style.color=isOverlap?"rgba(100,180,255,.92)":"rgba(255,255,255,.58)";}if(sml)sml.textContent=minsLeft!=null?"~"+minsLeft+"m left":"";}
function updateWarmupBadge(tickN,warmed){if(FirebaseSync.isReader)return;const sb=$("syncBadge");if(!sb)return;if(!warmed){sb.className="syncBadge warming";sb.innerHTML='<span class="dot amber"></span><span>Warming '+tickN+"/"+Engine.WARMUP+"</span>";}else{sb.className="syncBadge synced";sb.innerHTML='<span class="dot"></span><span>SYNCED (det)</span>';}}
function updateSharpeUI(stats){const sv=$("sharpeVal"),sm=$("sharpeMeta");if(sv&&sm){if(stats.sharpe!=null&&Number.isFinite(stats.sharpe)){sv.textContent=stats.sharpe.toFixed(2);sv.classList.remove("pos","neg");if(stats.sharpe>=2.5)sv.classList.add("pos");else if(stats.sharpe<0)sv.classList.add("neg");sm.textContent=stats.sharpe>=2.5?"Target met":"Below target 2.5";}else{sv.textContent="--";sm.textContent="Need >=20 signals ("+stats.totalSignals+")";}}const wr=$("winRateVal"),wrm=$("winRateMeta");if(wr&&wrm){if(stats.winRate!=null){wr.textContent=Math.round(stats.winRate*100)+"%";wr.classList.remove("pos","neg");if(stats.winRate>=.55)wr.classList.add("pos");else if(stats.winRate<.40)wr.classList.add("neg");wrm.textContent=stats.totalSignals+" closed signals";}else{wr.textContent="--";wrm.textContent="No closed signals";}}const pl=$("openPLVal"),plm=$("openPLMeta");if(pl&&plm){if(stats.openPL!=null){pl.textContent=(stats.openPL>=0?"+":"")+stats.openPL.toFixed(1)+" p";pl.classList.remove("pos","neg");if(stats.openPL>0)pl.classList.add("pos");else if(stats.openPL<0)pl.classList.add("neg");plm.textContent=stats.openBias?"Open "+stats.openBias:"--";}else{pl.textContent="--";plm.textContent="No open signal";}}const cp=$("cumPipsVal");if(cp){cp.textContent=(stats.totalPips>=0?"+":"")+stats.totalPips.toFixed(1)+" p";cp.classList.remove("pos","neg");if(stats.totalPips>0)cp.classList.add("pos");else if(stats.totalPips<0)cp.classList.add("neg");}const fs=$("footSharpe");if(fs)fs.textContent=stats.sharpe!=null?stats.sharpe.toFixed(2):"--";drawEquity(stats.equity.length>=2?stats.equity:[0,0]);}
function updateCorrUI(corrs){const assets=[{key:"OIL",label:"Brent (BZ=F)",dir:"Negative"},{key:"GOLD",label:"Gold COMEX (GC=F)",dir:"Positive"},{key:"SILV",label:"Silver COMEX (SI=F)",dir:"Positive"},{key:"USD",label:"DXY (DX-Y.NYB)",dir:"Negative"},{key:"GBP",label:"GBP/USD",dir:"Positive (r≈80-95%)"},{key:"AUD",label:"AUD/USD",dir:"Positive (r≈70-90%)"},{key:"NZD",label:"NZD/USD",dir:"Positive (r≈65-85%)"}];const cb=$("corrBody");if(!cb)return;cb.innerHTML=assets.map(a=>{const c=corrs[a.key]||{r:0,tStat:0,n:0,sig:"ns"};const rStr=c.n>=5?c.r.toFixed(3):"--",tStr=c.n>=5?c.tStat.toFixed(2):"--";const sigClass=c.sig==="**"?"sig2":c.sig==="*"?"sig1":"sigNS";const rClass=c.r>.05?"corrPos":c.r<-.05?"corrNeg":"";return"<tr><td>"+a.label+"</td><td class='"+rClass+"'>"+rStr+"</td><td>"+tStr+"</td><td class='"+sigClass+"'>"+c.sig+"</td><td>"+c.n+"</td><td style='color:rgba(255,255,255,.45);font-size:10px'>"+a.dir+"</td></tr>";}).join("");}

let lastAlertAt=0;
function checkAlerts(r1,bias){const thresh=Number(settings.alertThreshPips)||0;if(thresh>0&&r1>=thresh){if(Date.now()-lastAlertAt<300000)return;lastAlertAt=Date.now();const ab=$("alertBadge"),at=$("alertBadgeText");if(ab)ab.classList.add("show");if(at)at.textContent="1h range "+r1+"p >= "+thresh+"p";setTimeout(()=>{const ab2=$("alertBadge");if(ab2)ab2.classList.remove("show");},30000);if("Notification"in window&&Notification.permission==="granted"){try{new Notification("QuadraX Alert",{body:"1h range "+r1+"p. Bias: "+bias,tag:"qx-alert"});}catch{}}}}
let nightMode=false;
function toggleNight(){nightMode=!nightMode;document.body.classList.toggle("night",nightMode);const nb=$("nightBtn");if(nb){nb.classList.toggle("night-active",nightMode);nb.textContent=nightMode?"Day":"Night";}}
function exportSnapshot(){const url=URL.createObjectURL(new Blob([JSON.stringify({timestamp:new Date().toISOString(),version:"v5",state:lastFullState,projAccuracy:ProjTracker.getStats(),calibMult:ProjTracker.getCalibMult()},null,2)],{type:"application/json"}));const a=document.createElement("a");a.href=url;a.download="quadrax-v5-snap-"+Date.now()+".json";a.click();URL.revokeObjectURL(url);}

let lastSpot=null,lastFullState=null,paused=false,syncing=false;

// ── MASTER COMPUTE TICK ───────────────────────────────────────────────────
async function onSpotUpdate(s){
  // READER: never compute locally - all state comes from Firebase
  if(FirebaseSync.isReader)return;
  const now=Date.now();const lu=$("lastUpdate");if(lu)lu.textContent=fmtTime(now);
  if(!s.ok){setFxStatus("ERROR");return;}
  lastSpot=s;
  const fl=$("fxLatencyTag");if(fl)fl.textContent=(s.latencyMs??"--")+"ms";
  const qp=$("quoteProvider");if(qp)qp.textContent="Provider: "+(s.provider||s.source||"--");
  const mt=$("modeTag");if(mt)mt.textContent=settings.twelvedataKey?"Mode: LIVE":"Mode: FREE";
  setFxStatus(s.status);
  CorrEngine.pushEur(s.lastDelta);
  QuantEngine.push(s.price);
  if(paused)return;
  const step=Engine.step(s.price);if(!step)return;
  pushState(step.policy);
  ProjTracker.scoreOutcomes(s.price);
  const tx=computeTx();
  const cm=ProjTracker.getCalibMult(),ba=ProjTracker.getBiasConfAdj();
  const proj=computeProj(step,tx,cm,ba);
  const pb3=PB3.compute(step,tx);
  const arch=Classifier.classify(tx);
  ProjTracker.logProjection({spot:s.price,bias:proj.bias,r1:proj.r1,r4:proj.r4,policy:step.policy});
  const _q=QuantEngine.compute(step,tx,pb3);
  const _dv=DejaVuEngine.compute(step.probs,step.conf,_q?.volRegime?.regime);
  updateDejaVuUI(_dv);
  updateQuantUI(_q);
  drawTickChart(QuantEngine.getPrices());
  {const fp=$('fxSpotPrice');if(fp){fp.classList.remove('pricePulse');void fp.offsetWidth;fp.classList.add('pricePulse');}}
  const fullState=buildFullState(step,tx,proj,pb3,arch,s,recentStates,cm,ba);
  if(typeof _dv!=='undefined'&&_dv){fullState.dvBlend=_dv.bucketPcts;fullState.dvThrottle=_dv.throttle;fullState.dvDomBucket=_dv.dom?.name;fullState.dvCondSharpe=_dv.condSharpe;}
  lastFullState=fullState;
  applyFullStateToUI(fullState);
  if(!paused){SignalTracker.update(s.price,proj.bias);}
  updateSharpeUI(SignalTracker.getStats(s.price));
  CorrEngine.onMacroUpdate();updateCorrUI(CorrEngine.getCorrelations());
  updateSessionUI();updateProjAccuracyUI();checkAlerts(proj.r1,proj.bias);
  MacroFeed.hydrate();
  paintFxPair("GBP","gbpPx","gbpMeta","gbpTag","gbpSpark",tx.gbpChg);
  paintFxPair("AUD","audPx","audMeta","audTag","audSpark",tx.audChg);
  paintFxPair("NZD","nzdPx","nzdMeta","nzdTag","nzdSpark",tx.nzdChg);
  {const fxc=tx.fxConf||0,fxi=tx.fxInt||0;
   const fxcEl=$("fxConfChip"),fxbEl=$("fxConfBig"),fxmEl=$("fxConfMeta"),fxiEl=$("fxIntChip");
   if(fxcEl)fxcEl.textContent=fxc>0.15?"▲ BULL CONFIRM":fxc<-0.15?"▼ BEAR CONFIRM":"MIXED";
   if(fxiEl)fxiEl.textContent=Math.round(fxi*100)+"%";
   const pairs=[{k:"GBP",d:tx.gbpChg},{k:"AUD",d:tx.audChg},{k:"NZD",d:tx.nzdChg}];
   const labels=pairs.filter(p=>p.d!=null&&Math.abs(p.d)>0.02).map(p=>p.d>0?p.k+"↑":p.k+"↓").join(" ");
   if(fxbEl)fxbEl.textContent=labels||"Waiting for data";
   const n=pairs.filter(p=>p.d!=null).length;
   if(fxmEl)fxmEl.textContent=n+"/3 pairs active"+(fxc>0.15?" — BULLISH":fxc<-0.15?" — BEARISH":" — mixed");
   const fxlv=Math.abs(fxc)*clamp(fxi*1.5,0,1);
   leverPaint($("fxLeverBar"),$("fxLeverPct"),fxlv,fxc>0.15?"good":fxc<-0.15?"bad":"neutral");
   const fxlm=$("fxLeverMeta");if(fxlm)fxlm.textContent=fxc>0.15?"Bullish confluence — "+Math.round(fxlv*100)+"% confirm":fxc<-0.15?"Bearish confluence — "+Math.round(fxlv*100)+"% confirm":"Mixed/neutral — no clear alignment";}
  // Inject signal stats so READER can render Signal Performance identically
  const sigStats=SignalTracker.getStats(s.price);
  injectSignalStats(fullState,sigStats);
  if(FirebaseSync.configured&&FirebaseSync.role==="MASTER")FirebaseSync.writeFullState(fullState);
}

// ── READER POLL ───────────────────────────────────────────────────────────
async function readerPoll(){
  if(FirebaseSync.role!=="READER"||!FirebaseSync.configured)return;
  const st=await FirebaseSync.pullState();
  if(!st){
    // No fresh state yet - show waiting message but don't render stale local compute
    const pst=$("policyStateTitle");if(pst)pst.textContent="Waiting for MASTER data...";
    const psd=$("policyStateDesc");if(psd)psd.textContent="FB READER connected. MASTER must be running and writing state.";
    const lu=$("lastUpdate");if(lu)lu.textContent=fmtTime(Date.now());
    setFxStatus("CHECKING");
    return;
  }
  lastFullState=st;
  applyFullStateToUI(st);
  updateSessionUI();updateProjAccuracyUI();
  // Show MASTER's timestamp so team can see data freshness
  const lu=$("lastUpdate");if(lu)lu.textContent=fmtTime(st.ts||Date.now())+" (M)";
  setFxStatus("LIVE");
}

// ── SETTINGS ──────────────────────────────────────────────────────────────
async function validateTDKey(key){if(!key)return null;try{const r=await fetch("https://api.twelvedata.com/price?symbol=EUR/USD&apikey="+encodeURIComponent(key),{cache:"no-store"});if(!r.ok)return false;const j=await r.json();return Number.isFinite(Number(j?.price))&&Number(j.price)>0;}catch{return false;}}
function openSettings(){const ti=$("tdKeyInput"),pi=$("pollInput"),ai=$("alertThreshInput"),hi=$("histDepthInput"),fi=$("fbUrlInput"),fri=$("fbRoleInput");if(ti)ti.value=settings.twelvedataKey||"";if(pi)pi.value=String(settings.pollMs||12000);if(ai)ai.value=String(settings.alertThreshPips||"");if(hi)hi.value=String(settings.histDepth||60);if(fi)fi.value=settings.fbUrl||"";if(fri)fri.value=settings.fbRole||"MASTER";const tv=$("tdKeyValidTag");if(tv)tv.textContent="";const sb=$("settingsBack");if(sb)sb.style.display="flex";}
function closeSettings(){const sb=$("settingsBack");if(sb)sb.style.display="none";}
const sBtn=$("settingsBtn"),cBtn=$("closeSettingsBtn"),sBack=$("settingsBack"),rBtn=$("resetSettingsBtn"),rpBtn=$("resetProjBtn"),saveBtn=$("saveSettingsBtn");
if(sBtn)sBtn.addEventListener("click",openSettings);
if(cBtn)cBtn.addEventListener("click",closeSettings);
if(sBack)sBack.addEventListener("click",e=>{if(e.target===sBack)closeSettings();});
if(rBtn)rBtn.addEventListener("click",()=>{settings={twelvedataKey:"",pollMs:12000,alertThreshPips:0,histDepth:60,fbUrl:"",fbRole:"MASTER",calibMult:1.0,biasConfAdj:1.0};save(KEY.s,settings);openSettings();});
if(rpBtn)rpBtn.addEventListener("click",()=>{if(confirm("Reset all projection logs and calibration multiplier to 1.00?"))ProjTracker.reset();});
if(saveBtn)saveBtn.addEventListener("click",async()=>{
  const key=String($("tdKeyInput")?.value||"").trim(),poll=Number($("pollInput")?.value||12000),thresh=Number($("alertThreshInput")?.value||0),depth=Number($("histDepthInput")?.value||60),fbUrl=String($("fbUrlInput")?.value||"").trim(),fbRole=$("fbRoleInput")?.value||"MASTER";
  if(key){const tv=$("tdKeyValidTag");if(tv){tv.textContent=" Checking...";tv.className="vTag";}const valid=await validateTDKey(key);if(tv){tv.textContent=valid?" Valid":" Invalid";tv.className="vTag "+(valid?"ok":"fail");}if(valid===false&&!confirm("API key appears invalid. Save anyway?"))return;}
  settings.twelvedataKey=key;settings.pollMs=Number.isFinite(poll)&&poll>=6000?Math.round(poll):12000;settings.alertThreshPips=Number.isFinite(thresh)&&thresh>0?Math.round(thresh):0;settings.histDepth=clamp(Number.isFinite(depth)?Math.round(depth):60,10,120);settings.fbUrl=fbUrl;settings.fbRole=fbRole||'AUTO';
  save(KEY.s,settings);FirebaseSync.init(fbUrl,fbRole);
  if(settings.alertThreshPips>0&&"Notification"in window&&Notification.permission==="default")Notification.requestPermission();
  closeSettings();alert("Saved. MASTER/READER role applied immediately.");
});
const pBtn=$("pauseBtn"),nBtn=$("nightBtn"),eBtn=$("exportBtn"),syncBtn=$("syncBtn");
if(pBtn)pBtn.addEventListener("click",()=>{paused=!paused;pBtn.textContent=paused?"Resume":"Pause";const ss=$("sysStatus");if(ss)ss.textContent=paused?"PAUSED":"LIVE";const ld=$("liveDot");if(ld)ld.classList.toggle("amber",paused);});
if(nBtn)nBtn.addEventListener("click",toggleNight);
if(eBtn)eBtn.addEventListener("click",exportSnapshot);
if(syncBtn)syncBtn.addEventListener("click",async()=>{if(syncing)return;syncing=true;syncBtn.textContent="Syncing...";syncBtn.classList.add("syncing");try{await Promise.allSettled([SpotFeed.tick(onSpotUpdate),MacroFeed.tick(),EventsFeed.tick(),HeadlinesFeed.tick()]);}finally{syncing=false;syncBtn.textContent="Sync";syncBtn.classList.remove("syncing");}});
window.addEventListener("keydown",e=>{if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;const k=e.key.toLowerCase();if(k==="p"&&pBtn)pBtn.click();else if(k==="s"&&syncBtn)syncBtn.click();else if(k==="n")toggleNight();else if(k==="x")exportSnapshot();else if(k==="?"){const kh=$("kbHint");if(kh)kh.classList.toggle("show");}});
const tvf=$("tvFrame");if(tvf){let tvLoaded=false;tvf.addEventListener("load",()=>{tvLoaded=true;});setTimeout(()=>{if(!tvLoaded){const fb=$("tvFallback");if(fb)fb.classList.add("show");}},9000);}

// ── START ─────────────────────────────────────────────────────────────────
async function start(){
  initProbUI();
  MacroFeed.hydrate();
  drawTimeline($("timelineCanvas"),recentStates);
  drawTM(Engine.getTM());
  updateSessionUI();
  updateProjAccuracyUI();
  updateCorrUI(CorrEngine.getCorrelations());
  updateSharpeUI({sharpe:null,winRate:null,openPL:null,totalSignals:0,totalPips:0,openBias:null,equity:[0]});
  FirebaseSync.init(settings.fbUrl,settings.fbRole);
  // READER skips spot feed entirely - spot price arrives via Firebase state
  const initFeeds=FirebaseSync.isReader
    ?[MacroFeed.tick(),EventsFeed.tick(),HeadlinesFeed.tick()]
    :[SpotFeed.tick(onSpotUpdate),MacroFeed.tick(),EventsFeed.tick(),HeadlinesFeed.tick()];
  await Promise.allSettled(initFeeds);
  // Retry macro once after 3s if first fetch missed some pairs
  setTimeout(async()=>{await MacroFeed.tick();MacroFeed.hydrate();},3000);
  renderEvents();renderHeadlines();
  const poll=Math.max(Number(settings.pollMs)||12000,6000);
  if(FirebaseSync.isReader){
    // READER mode: ONLY pull Firebase state. No spot feed. No local Engine calls.
    // Firebase state already contains spotPrice from MASTER.
    readerPoll();
    setInterval(readerPoll,5000);
    // READERs still fetch macro/events/headlines for their own display panels
    setInterval(async()=>{await MacroFeed.tick();MacroFeed.hydrate();},90000);
  TEFeed.tick();
  setInterval(()=>TEFeed.tick(),30*60*1000);
  setInterval(()=>TEFeed.renderTECal(),60*1000);
    setInterval(async()=>{await EventsFeed.tick();renderEvents();},5*60*1000);
    setInterval(async()=>{await HeadlinesFeed.tick();renderHeadlines();},5*60*1000);
    setInterval(updateSessionUI,30000);
    setInterval(updateProjAccuracyUI,60000);
    // Countdown timer for events still needs updating
    setInterval(renderEvents,30000);
  }else{
    // MASTER mode: full compute loop
    setInterval(()=>SpotFeed.tick(onSpotUpdate),poll);
    setInterval(async()=>{await MacroFeed.tick();MacroFeed.hydrate();},90000);
    setInterval(async()=>{await EventsFeed.tick();renderEvents();},5*60*1000);
    setInterval(async()=>{await HeadlinesFeed.tick();renderHeadlines();},5*60*1000);
    setInterval(()=>{updateSessionUI();updateProjAccuracyUI();},30000);
  }
}
start();
})();
</script>
</body>
</html>
