<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QuadraX Risk Dashboard</title>
  <style>
    :root{
      --bg:#070b1f;
      --panel: rgba(18, 28, 66, 0.38);
      --panel2: rgba(11, 18, 48, 0.55);
      --border: rgba(94, 140, 255, 0.25);
      --border2: rgba(94, 140, 255, 0.35);
      --text: rgba(235, 240, 255, 0.92);
      --muted: rgba(180, 198, 255, 0.72);
      --muted2: rgba(180, 198, 255, 0.55);
      --brand1:#1e3a8a;
      --brand2:#2563eb;
      --good:#10b981;
      --warn:#f59e0b;
      --high:#f97316;
      --bad:#ef4444;
      --crit:#dc2626;
      --chip: rgba(255,255,255,0.06);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 650px at 20% 15%, rgba(37,99,235,0.18), transparent 65%),
                  radial-gradient(1000px 600px at 80% 25%, rgba(16,185,129,0.12), transparent 60%),
                  radial-gradient(900px 700px at 60% 85%, rgba(245,158,11,0.08), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: var(--sans);
      padding: 18px;
    }

    .container{max-width: 1700px; margin: 0 auto;}
    .topbar{
      background: linear-gradient(135deg, rgba(30,58,138,0.95) 0%, rgba(37,99,235,0.85) 100%);
      border: 1px solid rgba(191,219,254,0.35);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 320px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.20);
      font-weight: 900;
      letter-spacing: .5px;
    }
    .titlewrap h1{margin:0;font-size:18px;line-height:1.15}
    .titlewrap .sub{margin-top:3px;font-size:12px;color:rgba(219,234,254,0.9)}
    .topmeta{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:flex;align-items:center;gap:8px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
    }
    .dot{width:10px;height:10px;border-radius:999px;background: var(--good);box-shadow: 0 0 0 3px rgba(16,185,129,0.12)}
    .btn{
      border:none;cursor:pointer;
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 12px;
      color: rgba(255,255,255,0.95);
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.18);
    }
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background: rgba(14,165,233,0.20); border-color: rgba(14,165,233,0.30)}
    .btn.warn{background: rgba(245,158,11,0.22); border-color: rgba(245,158,11,0.35)}
    .btn.good{background: rgba(16,185,129,0.20); border-color: rgba(16,185,129,0.32)}
    .btn.bad{background: rgba(239,68,68,0.20); border-color: rgba(239,68,68,0.32)}
    .btn:disabled{opacity:0.55;cursor:not-allowed}

    .grid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }

    .col{display:flex;flex-direction:column;gap:16px}
    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), transparent 55%);
      pointer-events:none;
    }
    .card > *{position:relative}

    .card-title{
      display:flex;align-items:baseline;justify-content:space-between;gap:10px;
      margin-bottom: 10px;
    }
    h2{margin:0;font-size:14px;letter-spacing:0.6px;text-transform:uppercase;color: rgba(191,219,254,0.95)}
    h3{margin:0;font-size:13px;letter-spacing:0.6px;text-transform:uppercase;color: rgba(191,219,254,0.9)}
    .muted{color: var(--muted); font-size: 12px}
    .muted2{color: var(--muted2); font-size: 12px}

    .stateCard{
      background: linear-gradient(180deg, rgba(16,185,129,0.10), rgba(11,18,48,0.22));
      border: 1px solid rgba(16,185,129,0.18);
    }
    .stateTop{
      display:flex;justify-content:space-between;gap:14px;align-items:center;
    }
    .stateBig{
      font-size: 34px;
      letter-spacing: 0.4px;
      margin: 2px 0 4px 0;
      font-weight: 950;
    }
    .stateName{
      font-size: 30px;
      margin: 0;
      font-weight: 950;
    }
    .stateMeta{margin-top:6px;color: rgba(212, 255, 233, 0.85);font-size: 13px}
    .bubble{
      width:72px;height:72px;border-radius:999px;
      display:grid;place-items:center;
      font-weight: 950;
      font-size: 26px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
    }

    .divider{height:1px;background: rgba(191,219,254,0.18);margin:12px 0}

    .history{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{
      width:36px;height:36px;border-radius:12px;
      display:grid;place-items:center;
      font-weight: 950;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.95);
      opacity: 0.9;
    }

    .bars{display:flex;flex-direction:column;gap:10px}
    .barRow{display:flex;justify-content:space-between;align-items:center;gap:10px;font-size: 12px}
    .barName{color: rgba(235,240,255,0.88)}
    .barPct{font-weight: 900}
    .barTrack{height:8px;border-radius:999px;background: rgba(0,0,0,0.35);overflow:hidden;border:1px solid rgba(255,255,255,0.06)}
    .barFill{height:100%;border-radius:999px;transition:width .25s ease}

    .miniGrid{
      display:grid;grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .mini{
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 10px;
    }
    .mini .k{font-size: 11px;color: var(--muted)}
    .mini .v{margin-top:6px;font-size: 18px;font-weight: 950}
    .mini .v.good{color: var(--good)}
    .mini .v.bad{color: var(--bad)}
    .mini .v.blue{color: rgba(96,165,250,0.95)}

    .table-wrap{
      background: rgba(0,0,0,0.20);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      overflow:hidden;
    }
    table{width:100%;border-collapse:collapse;font-size: 12px}
    th, td{padding: 10px 10px;border-bottom: 1px solid rgba(255,255,255,0.06);vertical-align:top}
    th{color: rgba(191,219,254,0.85);text-transform:uppercase;font-size: 11px;letter-spacing:.6px}
    tr:last-child td{border-bottom:none}
    .scroll{max-height: 240px; overflow:auto}
    .scroll::-webkit-scrollbar{height:10px;width:10px}
    .scroll::-webkit-scrollbar-thumb{background: rgba(255,255,255,0.10); border-radius: 999px}
    .mono{font-family: var(--mono)}
    .rightStack{display:flex;flex-direction:column;gap:12px}

    .riskBig{
      font-size: 36px;
      font-weight: 950;
      margin: 0;
    }
    .riskBox{
      text-align:center;
      padding: 18px 16px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.20);
    }

    .statusRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-top: 6px;
    }
    .statusBadge{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      font-size: 12px;
      font-weight: 900;
      display:inline-flex;align-items:center;gap:8px;
    }
    .spinner{
      width:10px;height:10px;border-radius:999px;
      border: 2px solid rgba(255,255,255,0.25);
      border-top-color: rgba(255,255,255,0.85);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .badgeHigh{color:#fecaca;background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.25)}
    .badgeMed{color:#ffedd5;background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.25)}
    .badgeLow{color:#fef9c3;background: rgba(234,179,8,0.10); border-color: rgba(234,179,8,0.20)}
    .badgeOk{color:#bbf7d0;background: rgba(16,185,129,0.12); border-color: rgba(16,185,129,0.25)}
    .badgeStale{color:#fde68a;background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.25)}
    .badgeDown{color:#fecaca;background: rgba(239,68,68,0.14); border-color: rgba(239,68,68,0.30)}

    .footer{
      margin-top: 16px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding: 12px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(10,14,39,0.45);
      box-shadow: var(--shadow);
      font-size: 12px;
      color: var(--muted);
    }

    @media(max-width: 1100px){
      .grid{grid-template-columns: 1fr}
      .brand{min-width: 0}
      .miniGrid{grid-template-columns: repeat(2, 1fr)}
    }
  </style>
</head>
<body>
  <div class="container">

    <div class="topbar">
      <div class="brand">
        <div class="logo">QX</div>
        <div class="titlewrap">
          <h1>QuadraX Risk Dashboard</h1>
          <div class="sub">Executive View: 8-State Monitoring and Control System (Live EUR/USD)</div>
        </div>
      </div>

      <div class="topmeta">
        <div class="pill" title="Frontend demo status">
          <span class="dot" id="liveDot"></span>
          <b id="liveLabel">LIVE</b>
        </div>
        <div class="pill">
          Last Update <b id="lastUpdate">--</b>
        </div>
        <button class="btn warn" id="pauseBtn">Pause</button>
        <button class="btn primary" id="syncBtn">Sync</button>
      </div>
    </div>

    <div class="grid">
      <div class="col">
        <div class="card stateCard" id="stateCard">
          <div class="card-title">
            <h2>Current Market State</h2>
            <div class="muted2" id="stateNote">Live EUR/USD feed driving regime (portfolio tiles still demo)</div>
          </div>

          <div class="stateTop">
            <div>
              <div class="stateName" id="stateTitle">STATE 1: Mean-Reverting</div>
              <div class="stateMeta">Confidence: <b id="stateConf">--</b></div>

              <div class="muted" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px;">
                <span>Hysteresis: <b id="hystStatus">stable</b></span>
                <span>Hold ticks: <b id="holdTicks">0</b></span>
                <span>Tick: <b id="tickCount">0</b></span>
                <span>Last calc: <b id="lastCalc">--</b></span>
                <span>Raw: <b id="rawStateLabel">S1</b></span>
                <span>Prob hash: <b id="probHash">----</b></span>
              </div>
            </div>
            <div class="bubble" id="stateBubble">1</div>
          </div>

          <div class="divider"></div>

          <div class="muted" style="margin-bottom:8px;">Recent State History (Last 12 Updates)</div>
          <div class="history" id="historyRow"></div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>State Probability Distribution</h2>
            <div class="muted2">Conditional regime likelihoods</div>
          </div>
          <div class="bars" id="probBars"></div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>Portfolio Snapshot</h2>
            <div class="muted2">Demo placeholders until MT4 integration</div>
          </div>

          <div class="miniGrid">
            <div class="mini">
              <div class="k">Account Balance</div>
              <div class="v blue" id="acctBal">$1,000,000</div>
            </div>
            <div class="mini">
              <div class="k">Daily PnL</div>
              <div class="v good" id="dailyPnl">+$13,160</div>
            </div>
            <div class="mini">
              <div class="k">Total Exposure</div>
              <div class="v blue" id="exposure">$650,000</div>
            </div>
            <div class="mini">
              <div class="k">Max Drawdown</div>
              <div class="v bad" id="mdd">-3.2%</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>Regime Log</h2>
            <div class="muted2">CSV-style telemetry (latest on top)</div>
          </div>
          <div class="table-wrap">
            <div class="scroll" style="max-height: 240px;">
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>EURUSD</th>
                    <th>Raw</th>
                    <th>State</th>
                    <th>Conf</th>
                    <th>Vol x</th>
                    <th>Mom</th>
                    <th>Feed</th>
                  </tr>
                </thead>
                <tbody id="logBody"></tbody>
              </table>
            </div>
          </div>
          <div class="muted" style="margin-top:10px;">Tip: copy table contents, paste into Excel. It will split nicely.</div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <div class="riskBox" id="riskBox">
            <div class="muted" style="letter-spacing:.6px;text-transform:uppercase;">Risk Level</div>
            <p class="riskBig" id="riskLevel">NORMAL</p>
            <div class="muted2" id="riskPolicy">Policy: state-aware sizing and entry gating</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>Feed Health</h2>
            <div class="muted2">Proof the market data is live</div>
          </div>

          <div class="rightStack">
            <div class="table-wrap" style="padding:12px;">
              <div class="muted">EUR/USD Spot</div>
              <div style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-top:8px;">
                <div style="font-size:26px;font-weight:950;" class="mono" id="eurusdSpot">--</div>
                <div class="statusBadge" id="feedStatusBadge">
                  <span class="spinner" id="feedSpinner"></span>
                  <span id="feedStatusText">CHECKING</span>
                </div>
              </div>
              <div class="statusRow muted2">
                <span>Last good sample: <b id="lastGood">--</b></span>
                <span>Source: <b id="feedSource">--</b></span>
                <span>Latency: <b id="feedLatency">--</b></span>
              </div>
              <div class="muted2" style="margin-top:6px;">If spot stays blank, your browser cannot reach the price endpoints (CORS, outage, or network filtering).</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>World Events Calendar</h2>
            <div class="muted2" id="calMeta">Demo list (swap to backend later)</div>
          </div>
          <div class="table-wrap">
            <div class="scroll">
              <table>
                <thead>
                  <tr>
                    <th>When</th>
                    <th>Event</th>
                    <th>Impact</th>
                    <th>Countdown</th>
                  </tr>
                </thead>
                <tbody id="eventsBody"></tbody>
              </table>
            </div>
          </div>
          <div class="muted" style="margin-top:10px;">Red folder style: High impact events are ðŸŸ¥.</div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>Headlines</h2>
            <div class="muted2" id="newsMeta">Demo list (swap to backend later)</div>
          </div>
          <div class="table-wrap">
            <div class="scroll" style="max-height: 220px;">
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Source</th>
                    <th>Headline</th>
                  </tr>
                </thead>
                <tbody id="headlinesBody"></tbody>
              </table>
            </div>
          </div>
          <div class="muted" style="margin-top:10px;">Click a headline to open the source.</div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>Risk Metrics</h2>
            <div class="muted2">Placeholders until MT4 integration</div>
          </div>

          <div class="miniGrid" style="grid-template-columns: 1fr 1fr;">
            <div class="mini">
              <div class="k">Value at Risk (95%)</div>
              <div class="v bad" id="var95">$28,500</div>
              <div class="muted2" id="varPct">2.85% of account</div>
            </div>
            <div class="mini">
              <div class="k">Conditional VaR (95%)</div>
              <div class="v bad" id="cvar95">$42,300</div>
              <div class="muted2">Expected loss if VaR exceeded</div>
            </div>
            <div class="mini">
              <div class="k">Portfolio Correlation</div>
              <div class="v good" id="corr">32.0%</div>
              <div class="muted2">Max allowed: 50.0%</div>
            </div>
            <div class="mini">
              <div class="k">Beta to Market</div>
              <div class="v blue" id="beta">0.15</div>
              <div class="muted2">Low market correlation (good)</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="footer">
      <div>System Status: <b id="sysStatus">LIVE</b></div>
      <div>Smoothed State: <b id="smoothedState">S1</b></div>
      <div>Raw State: <b id="rawState">S1</b></div>
      <div>Hysteresis Hold: <b id="holdFooter">0</b></div>
    </div>

  </div>

<script>
/* =========================================================
   QuadraX Single-File Demo Dashboard
   - Live EURUSD spot from multi-source free endpoints
   - 8-state regime engine with hysteresis smoothing
   - Regime log panel (CSV-like)
   - Events and headlines demo lists, backend-ready
   ========================================================= */

// Optional backend base (leave blank for demo lists)
// Example later: const BACKEND_BASE = "https://your-service.example.com";
const BACKEND_BASE = "";

// UI helpers
const $ = (id) => document.getElementById(id);

const STATE_NAMES = {
  1: "Mean-Reverting",
  2: "Liquidity Vacuum",
  3: "Slow Drift",
  4: "Strong Trend",
  5: "Stop Cascade",
  6: "News Shock",
  7: "Dealer Unwind",
  8: "Panic/Forced"
};

const STATE_COLORS = {
  1: { fill:"#10b981", glow:"rgba(16,185,129,0.18)" },
  2: { fill:"#f59e0b", glow:"rgba(245,158,11,0.18)" },
  3: { fill:"#60a5fa", glow:"rgba(96,165,250,0.18)" },
  4: { fill:"#3b82f6", glow:"rgba(59,130,246,0.18)" },
  5: { fill:"#f97316", glow:"rgba(249,115,22,0.18)" },
  6: { fill:"#ef4444", glow:"rgba(239,68,68,0.18)" },
  7: { fill:"#a855f7", glow:"rgba(168,85,247,0.18)" },
  8: { fill:"#dc2626", glow:"rgba(220,38,38,0.18)" }
};

const RISK_LEVELS = ["NORMAL","MODERATE","ELEVATED","HIGH","CRITICAL"];

// Engine state
let isLive = true;
let tickCounter = 0;

// Price + features
let eurusd = null;
let lastGoodTs = 0;
let lastSource = "--";
let lastLatencyMs = null;
let priceSeries = []; // latest N prices
let retSeries = [];   // latest N returns

// Regime state
let rawState = 1;
let rawConf = 0.80;
let smoothedState = 1;
let smoothedConf = 0.80;

let stateProbs = {1:82,2:8,3:5,4:3,5:1,6:0.5,7:0.3,8:0.2};
let stateHistory = [1,1,1,2,1,1,1,1,3,3,3,1];

// Hysteresis
const HOLD_TICKS_MIN = 8;     // minimum hold time before switching
const SWITCH_MARGIN = 0.10;   // how much better new state must be
let holdTicks = 0;

// Poll
const POLL_MS = 5000;

// Demo lists
const DEMO_EVENTS = [
  { tsUtc: addMinutesUTC(60*6), title:"Eurozone CPI (flash)", impact:"High", url:"https://www.forexfactory.com/" },
  { tsUtc: addMinutesUTC(60*28), title:"US Initial Jobless Claims", impact:"Med", url:"https://www.forexfactory.com/" },
  { tsUtc: addMinutesUTC(60*52), title:"US GDP (advance)", impact:"High", url:"https://www.forexfactory.com/" },
  { tsUtc: addMinutesUTC(60*160), title:"US Non-Farm Payrolls", impact:"High", url:"https://www.forexfactory.com/" }
];

const DEMO_HEADLINES = [
  { tsUtc: new Date().toISOString(), source:"FinancialJuice", title:"Dollar firming ahead of major data window", url:"https://www.financialjuice.com/" },
  { tsUtc: new Date(Date.now()-18*60000).toISOString(), source:"FinancialJuice", title:"Rates repricing drives short-term USD bid", url:"https://www.financialjuice.com/" },
  { tsUtc: new Date(Date.now()-41*60000).toISOString(), source:"Market", title:"Risk tone mixed as equities stabilize", url:"https://www.financialjuice.com/" }
];

// Price sources (no keys). These are not tick feeds. They are good enough for demo regime motion.
const PRICE_SOURCES = [
  {
    name: "open.er-api.com",
    url: "https://open.er-api.com/v6/latest/EUR",
    parse: (json) => {
      const usd = json?.rates?.USD;
      if (!usd) return null;
      return Number(usd);
    }
  },
  {
    name: "exchangerate-api.com (v4)",
    url: "https://api.exchangerate-api.com/v4/latest/EUR",
    parse: (json) => {
      const usd = json?.rates?.USD;
      if (!usd) return null;
      return Number(usd);
    }
  }
];

// ============ Utility ============
function fmt(n, d=5){
  if (!Number.isFinite(n)) return "--";
  return n.toFixed(d);
}
function nowTime(){
  return new Date().toLocaleTimeString();
}
function addMinutesUTC(mins){
  return new Date(Date.now() + mins*60000).toISOString();
}
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function countdownTo(tsUtc){
  const ts = Date.parse(tsUtc);
  if (!Number.isFinite(ts)) return "";
  const ms = ts - Date.now();
  if (ms <= 0) return "started";
  const mins = Math.floor(ms / 60000);
  const hrs = Math.floor(mins / 60);
  const days = Math.floor(hrs / 24);
  const remH = hrs % 24;
  const remM = mins % 60;
  if (days > 0) return `${days}d ${remH}h`;
  if (hrs > 0) return `${hrs}h ${remM}m`;
  return `${remM}m`;
}
function probHashFrom(probs){
  const parts = [];
  for (let k=1; k<=8; k++) parts.push(String(probs?.[k] ?? 0));
  const s = parts.join("|");
  let h = 2166136261;
  for (let i=0; i<s.length; i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0).toString(16).slice(0,6).toUpperCase();
}

// ============ Feed Health UI ============
function setFeedStatus(kind, text){
  const badge = $("feedStatusBadge");
  const spinner = $("feedSpinner");
  const label = $("feedStatusText");

  badge.classList.remove("badgeOk","badgeStale","badgeDown");
  if (kind === "OK") badge.classList.add("badgeOk");
  if (kind === "STALE") badge.classList.add("badgeStale");
  if (kind === "DOWN") badge.classList.add("badgeDown");

  spinner.style.display = (kind === "CHECKING") ? "inline-block" : "none";
  label.textContent = text;
}
function updateFeedHealthUI(){
  $("lastUpdate").textContent = nowTime();

  if (!lastGoodTs){
    $("eurusdSpot").textContent = "--";
    $("lastGood").textContent = "--";
    $("feedSource").textContent = "--";
    $("feedLatency").textContent = "--";
    setFeedStatus("CHECKING","CHECKING");
    return;
  }

  $("eurusdSpot").textContent = fmt(eurusd, 5);
  $("lastGood").textContent = new Date(lastGoodTs).toLocaleTimeString();
  $("feedSource").textContent = lastSource;
  $("feedLatency").textContent = (lastLatencyMs != null) ? `${Math.round(lastLatencyMs)}ms` : "--";

  const ageMs = Date.now() - lastGoodTs;
  if (ageMs < 30_000) setFeedStatus("OK","LIVE");
  else if (ageMs < 5*60_000) setFeedStatus("STALE","STALE");
  else setFeedStatus("DOWN","DOWN");
}

// ============ Fetch with fallback ============
async function fetchJsonWithTimeout(url, ms=4500){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), ms);
  const start = performance.now();
  try{
    const r = await fetch(url, { signal: controller.signal, cache:"no-store" });
    const latency = performance.now() - start;
    clearTimeout(t);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const json = await r.json();
    return { json, latency };
  } finally {
    clearTimeout(t);
  }
}

async function fetchEURUSD(){
  for (const s of PRICE_SOURCES){
    try{
      const { json, latency } = await fetchJsonWithTimeout(s.url, 4500);
      const px = s.parse(json);
      if (Number.isFinite(px) && px > 0.5 && px < 2.5){
        return { px, src: s.name, latency };
      }
    } catch(e){
      // try next
    }
  }
  return null;
}

// ============ Regime model (demo) ============
function pushSeries(px){
  priceSeries.push(px);
  if (priceSeries.length > 240) priceSeries.shift();

  if (priceSeries.length >= 2){
    const a = priceSeries[priceSeries.length-2];
    const b = priceSeries[priceSeries.length-1];
    const r = (b - a) / a;
    retSeries.push(r);
    if (retSeries.length > 240) retSeries.shift();
  }
}

function stddev(arr){
  if (arr.length < 2) return 0;
  const m = arr.reduce((s,x)=>s+x,0) / arr.length;
  const v = arr.reduce((s,x)=>s+(x-m)*(x-m),0) / (arr.length-1);
  return Math.sqrt(v);
}

function momentum(arr, k){
  if (arr.length < k+1) return 0;
  const a = arr[arr.length-1-k];
  const b = arr[arr.length-1];
  return (b - a) / a;
}

function sigmoid(x){
  return 1 / (1 + Math.exp(-x));
}

// This is a demo classifier, not Medallion. Your team wants â€œcorrect via testingâ€ later.
// It uses volatility expansion, momentum, and jump intensity to produce a probabilistic mix.
function classifyRegime(){
  const rets = retSeries.slice(-60);
  const vol = stddev(rets);                       // short vol proxy
  const volLong = stddev(retSeries.slice(-180));  // longer vol proxy
  const volX = (volLong > 0) ? (vol / volLong) : 1.0;

  const mom = momentum(priceSeries, 12);          // ~1 minute if 5s poll, rough
  const mom2 = momentum(priceSeries, 36);         // longer drift
  const absJump = Math.max(...rets.map(x=>Math.abs(x)), 0);

  // Normalize into intuitive 0..1-ish scores
  const vScore = sigmoid((volX - 1.0) * 4.0);
  const mScore = sigmoid(Math.abs(mom) * 500);     // FX returns are small, scale up
  const driftScore = sigmoid(Math.abs(mom2) * 250);
  const jumpScore = sigmoid((absJump - 0.00012) * 2500);

  // Construct unnormalized weights for each state (conceptual mapping)
  // 1 mean reverting: low vol, low momentum
  const w1 = (1 - vScore) * (1 - mScore) * 1.3;

  // 2 liquidity vacuum: rising vol but no direction
  const w2 = vScore * (1 - mScore) * 1.0;

  // 3 slow drift: low-moderate vol, persistent drift
  const w3 = (1 - vScore*0.7) * driftScore * 1.1;

  // 4 strong trend: directional with vol and momentum
  const w4 = vScore * mScore * 1.2;

  // 5 stop cascade: jumpy, one-sided bursts
  const w5 = jumpScore * mScore * 1.4;

  // 6 news shock: jumpy plus whipsaw, proxy by high jump and mixed momentum
  const w6 = jumpScore * (1 - sigmoid((Math.abs(mom) - 0.00025) * 6000)) * 1.1;

  // 7 dealer unwind: biased push with moderate-high vol and sustained drift
  const w7 = vScore * driftScore * 0.9;

  // 8 panic/forced: extreme jump behavior
  const w8 = sigmoid((absJump - 0.00025) * 5000) * 2.0;

  const weights = [0,w1,w2,w3,w4,w5,w6,w7,w8];
  const sum = weights.reduce((s,x)=>s+x,0) || 1;

  const probs = {};
  for (let i=1;i<=8;i++){
    probs[i] = +(weights[i] / sum * 100).toFixed(1);
  }

  // Find top state + confidence
  let best = 1, bestP = probs[1];
  for (let i=2;i<=8;i++){
    if (probs[i] > bestP){ best=i; bestP=probs[i]; }
  }
  const conf = Math.min(0.99, Math.max(0.50, bestP/100));

  return { best, conf, probs, volX, mom };
}

// Hysteresis: do not flip unless better by margin and hold time satisfied
function applyHysteresis(rawBest, rawConfidence){
  let status = "stable";

  if (rawBest === smoothedState){
    holdTicks = 0;
    status = "stable";
    smoothedConf = rawConfidence;
    return { status };
  }

  holdTicks += 1;
  status = "holding";

  const curP = (stateProbs[smoothedState] ?? 0) / 100;
  const newP = (stateProbs[rawBest] ?? 0) / 100;

  const marginOk = (newP - curP) >= SWITCH_MARGIN;
  const holdOk = holdTicks >= HOLD_TICKS_MIN;

  if (holdOk && marginOk){
    smoothedState = rawBest;
    smoothedConf = rawConfidence;
    holdTicks = 0;
    status = "switch";
  }

  return { status };
}

// ============ Rendering ============
function renderHistory(){
  const row = $("historyRow");
  row.innerHTML = "";
  stateHistory.slice(-12).forEach((s, idx) => {
    const el = document.createElement("div");
    el.className = "chip";
    el.textContent = String(s);
    el.style.background = `rgba(255,255,255,0.06)`;
    el.style.borderColor = `rgba(255,255,255,0.14)`;
    el.style.boxShadow = `0 0 0 6px ${STATE_COLORS[s].glow}`;
    el.style.opacity = idx === stateHistory.length-1 ? 1 : (0.35 + idx/12*0.55);
    row.appendChild(el);
  });
}

function renderStateCard(hystStatus){
  const s = smoothedState;
  const color = STATE_COLORS[s].fill;

  $("stateTitle").textContent = `STATE ${s}: ${STATE_NAMES[s]}`;
  $("stateBubble").textContent = String(s);
  $("stateConf").textContent = `${(smoothedConf*100).toFixed(1)}%`;
  $("hystStatus").textContent = hystStatus;
  $("holdTicks").textContent = String(holdTicks);

  $("smoothedState").textContent = `S${smoothedState}`;
  $("rawState").textContent = `S${rawState}`;
  $("holdFooter").textContent = String(holdTicks);

  // Set visual accent
  $("stateBubble").style.background = color;
  $("stateBubble").style.boxShadow = `0 0 0 10px ${STATE_COLORS[s].glow}`;

  $("stateCard").style.borderColor = `rgba(255,255,255,0.10)`;
  $("stateCard").style.boxShadow = `0 0 0 1px rgba(255,255,255,0.08), 0 0 0 10px ${STATE_COLORS[s].glow}, var(--shadow)`;

  // Proof fields
  $("tickCount").textContent = String(tickCounter);
  $("lastCalc").textContent = new Date(lastCalcTs).toLocaleTimeString();
  $("rawStateLabel").textContent = `S${rawState}`;
  $("probHash").textContent = probHashFrom(stateProbs);
}

function renderProbBars(){
  const wrap = $("probBars");
  wrap.innerHTML = "";

  for (let i=1;i<=8;i++){
    const prob = stateProbs[i] ?? 0;
    const row = document.createElement("div");
    row.innerHTML = `
      <div class="barRow">
        <div class="barName">State ${i}: ${STATE_NAMES[i]}</div>
        <div class="barPct" style="color:${STATE_COLORS[i].fill}">${prob}%</div>
      </div>
      <div class="barTrack"><div class="barFill" style="width:${Math.max(0,Math.min(100,prob))}%; background:${STATE_COLORS[i].fill}"></div></div>
    `;
    wrap.appendChild(row);
  }
}

function computeRiskLevel(){
  // Demo rule set: states 7-8 are critical, 5-6 high, 2 elevated, 3-4 moderate, else normal
  if (smoothedState >= 8) return "CRITICAL";
  if (smoothedState >= 7) return "CRITICAL";
  if (smoothedState >= 5) return "HIGH";
  if (smoothedState === 2) return "ELEVATED";
  if (smoothedState === 4 || smoothedState === 3) return "MODERATE";
  return "NORMAL";
}

function renderRisk(){
  const level = computeRiskLevel();
  $("riskLevel").textContent = level;

  // Colorize box subtly
  const box = $("riskBox");
  let c = "rgba(16,185,129,0.15)";
  if (level === "MODERATE") c = "rgba(59,130,246,0.18)";
  if (level === "ELEVATED") c = "rgba(245,158,11,0.18)";
  if (level === "HIGH") c = "rgba(249,115,22,0.18)";
  if (level === "CRITICAL") c = "rgba(239,68,68,0.20)";
  box.style.background = `linear-gradient(180deg, ${c}, rgba(0,0,0,0.18))`;
  box.style.borderColor = "rgba(255,255,255,0.12)";
}

function impactBadgeHtml(impact){
  const x = String(impact||"").toLowerCase();
  if (x.includes("high")) return `<span class="statusBadge badgeHigh">ðŸŸ¥ HIGH</span>`;
  if (x.includes("med")) return `<span class="statusBadge badgeMed">ðŸŸ§ MED</span>`;
  if (x.includes("low")) return `<span class="statusBadge badgeLow">ðŸŸ¨ LOW</span>`;
  return `<span class="statusBadge">${escapeHtml(impact||"")}</span>`;
}

function renderDemoEvents(){
  $("calMeta").textContent = "Demo list (Forex Factory-style impact)";
  const body = $("eventsBody");
  body.innerHTML = "";
  DEMO_EVENTS.forEach(ev => {
    const whenLocal = new Date(ev.tsUtc).toLocaleString();
    const cd = countdownTo(ev.tsUtc);
    const titleCell = ev.url
      ? `<a href="${ev.url}" target="_blank" rel="noopener noreferrer" style="color:rgba(96,165,250,0.95); text-decoration:none;">${escapeHtml(ev.title)}</a>`
      : escapeHtml(ev.title);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(whenLocal)}</td>
      <td>${titleCell}</td>
      <td>${impactBadgeHtml(ev.impact)}</td>
      <td class="mono">${escapeHtml(cd)}</td>
    `;
    body.appendChild(tr);
  });
}

function renderDemoHeadlines(){
  $("newsMeta").textContent = "Demo list (swap to FinancialJuice backend later)";
  const body = $("headlinesBody");
  body.innerHTML = "";
  DEMO_HEADLINES.forEach(h => {
    const t = new Date(h.tsUtc).toLocaleTimeString();
    const titleCell = h.url
      ? `<a href="${h.url}" target="_blank" rel="noopener noreferrer" style="color:rgba(230,234,242,0.92); text-decoration:none;">${escapeHtml(h.title)}</a>`
      : escapeHtml(h.title);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(t)}</td>
      <td>${escapeHtml(h.source)}</td>
      <td>${titleCell}</td>
    `;
    body.appendChild(tr);
  });
}

function appendLogRow({px, rawS, smoothS, conf, volx, mom, feed}){
  const body = $("logBody");
  const tr = document.createElement("tr");
  const t = new Date().toLocaleTimeString();

  tr.innerHTML = `
    <td class="mono">${escapeHtml(t)}</td>
    <td class="mono">${escapeHtml(fmt(px,5))}</td>
    <td class="mono">S${escapeHtml(rawS)}</td>
    <td class="mono">S${escapeHtml(smoothS)}</td>
    <td class="mono">${escapeHtml((conf*100).toFixed(1))}%</td>
    <td class="mono">${escapeHtml(volx.toFixed(2))}</td>
    <td class="mono">${escapeHtml((mom*10000).toFixed(2))}bp</td>
    <td class="mono">${escapeHtml(feed)}</td>
  `;
  body.insertBefore(tr, body.firstChild);

  // keep small
  while (body.children.length > 80) body.removeChild(body.lastChild);
}

// ============ Backend-ready hooks (optional) ============
async function fetchCalendarFromBackend(){
  if (!BACKEND_BASE) return null;
  const r = await fetch(`${BACKEND_BASE}/api/calendar?days=7`, { cache:"no-store" });
  if (!r.ok) throw new Error("calendar backend failed");
  return r.json();
}
async function fetchHeadlinesFromBackend(){
  if (!BACKEND_BASE) return null;
  const r = await fetch(`${BACKEND_BASE}/api/headlines?limit=20`, { cache:"no-store" });
  if (!r.ok) throw new Error("headlines backend failed");
  return r.json();
}

// ============ Main tick ============
let lastCalcTs = 0;

async function tick(){
  if (!isLive) return;

  $("sysStatus").textContent = "LIVE";
  $("liveLabel").textContent = "LIVE";
  $("liveDot").style.background = "var(--good)";

  setFeedStatus("CHECKING","CHECKING");

  const res = await fetchEURUSD();
  if (!res){
    // feed failed
    updateFeedHealthUI();
    setFeedStatus("DOWN","DOWN");
    return;
  }

  eurusd = res.px;
  lastSource = res.src;
  lastLatencyMs = res.latency;
  lastGoodTs = Date.now();

  // store series and compute regime
  pushSeries(eurusd);

  const out = classifyRegime();
  rawState = out.best;
  rawConf = out.conf;
  stateProbs = out.probs;

  // hysteresis smoothing
  const hyst = applyHysteresis(rawState, rawConf);

  // history
  if (stateHistory[stateHistory.length-1] !== smoothedState){
    stateHistory.push(smoothedState);
    if (stateHistory.length > 12) stateHistory = stateHistory.slice(-12);
  } else {
    // still push last state occasionally so history has motion
    if (stateHistory.length < 12) stateHistory.push(smoothedState);
  }

  tickCounter += 1;
  lastCalcTs = Date.now();

  // render UI
  updateFeedHealthUI();
  renderHistory();
  renderProbBars();
  renderStateCard(hyst.status);
  renderRisk();

  // log row
  appendLogRow({
    px: eurusd,
    rawS: rawState,
    smoothS: smoothedState,
    conf: smoothedConf,
    volx: out.volX,
    mom: out.mom,
    feed: lastSource
  });
}

// ============ Controls ============
$("pauseBtn").addEventListener("click", () => {
  isLive = !isLive;
  if (isLive){
    $("pauseBtn").textContent = "Pause";
    $("pauseBtn").classList.remove("good");
    $("pauseBtn").classList.add("warn");
    tick();
  } else {
    $("pauseBtn").textContent = "Resume";
    $("pauseBtn").classList.remove("warn");
    $("pauseBtn").classList.add("good");
    $("sysStatus").textContent = "PAUSED";
    $("liveLabel").textContent = "PAUSED";
    $("liveDot").style.background = "rgba(160,174,192,0.9)";
    setFeedStatus("STALE","PAUSED");
  }
});

$("syncBtn").addEventListener("click", () => {
  tick();
});

// ============ Init ============
function init(){
  // baseline UI fill
  renderHistory();
  renderProbBars();
  renderRisk();
  renderDemoEvents();
  renderDemoHeadlines();
  updateFeedHealthUI();

  // initial tick
  tick();

  setInterval(() => {
    if (isLive) tick();
  }, POLL_MS);

  // update countdowns visually
  setInterval(() => {
    renderDemoEvents();
  }, 60_000);
}

init();
</script>
</body>
</html>
