<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuadraX Risk Dashboard</title>
  <style>
    :root{
      --bg0:#060b1a;
      --bg1:#07122a;
      --card: rgba(12, 22, 54, 0.72);
      --card2: rgba(8, 16, 40, 0.72);
      --stroke: rgba(120, 160, 255, 0.25);
      --stroke2: rgba(120, 160, 255, 0.14);
      --glow: rgba(80, 150, 255, 0.22);
      --text:#e9f0ff;
      --muted: rgba(233,240,255,0.70);
      --muted2: rgba(233,240,255,0.55);

      --green:#39d98a;
      --amber:#f6c945;
      --red:#ff4d6d;
      --blue:#59a7ff;
      --purple:#b47cff;
      --pink:#ff5bd6;
      --orange:#ff9a4d;

      --radius: 22px;
      --shadow: 0 20px 70px rgba(0,0,0,0.55);
      --shadow2: 0 10px 30px rgba(0,0,0,0.35);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 15% 15%, rgba(40,90,200,0.35), transparent 55%),
                  radial-gradient(900px 700px at 85% 25%, rgba(80,30,140,0.25), transparent 60%),
                  radial-gradient(1200px 900px at 50% 90%, rgba(0,255,200,0.08), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      padding: 18px;
    }

    .shell{
      max-width: 1500px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 16px 18px;
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(30,80,180,0.7), rgba(20,50,120,0.55));
      border: 1px solid rgba(170, 210, 255, 0.26);
      box-shadow: var(--shadow);
    }

    .brand{
      display:flex;
      gap: 14px;
      align-items:center;
    }

    .qx-badge{
      width:42px;height:42px;
      border-radius: 14px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.16);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;
      letter-spacing:0.5px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.35);
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .title h1{
      margin:0;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .title .sub{
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 0.2px;
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--text);
      font-size: 12px;
      box-shadow: var(--shadow2);
      white-space:nowrap;
    }

    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--green);
      box-shadow: 0 0 0 4px rgba(57,217,138,0.15);
    }

    button{
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      padding: 9px 14px;
      border-radius: 999px;
      font-weight: 700;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    button:hover{ filter: brightness(1.05); }
    button.primary{
      background: linear-gradient(180deg, rgba(60,140,255,0.65), rgba(40,90,200,0.55));
      border-color: rgba(170,210,255,0.26);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.55fr 1fr;
      gap: 16px;
      align-items:start;
    }

    .card{
      background: linear-gradient(180deg, rgba(15,30,70,0.72), rgba(7,16,40,0.72));
      border: 1px solid rgba(140, 190, 255, 0.18);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(900px 420px at 15% 0%, rgba(80,150,255,0.20), transparent 55%);
      pointer-events:none;
    }

    .card h2{
      margin:0 0 10px 0;
      font-size: 12px;
      letter-spacing: 0.9px;
      text-transform: uppercase;
      color: rgba(233,240,255,0.78);
    }

    .big{
      font-size: 44px;
      font-weight: 900;
      letter-spacing: 0.2px;
      margin: 0;
    }

    .muted{
      color: var(--muted);
      font-size: 12px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items:start;
    }

    .stateBadge{
      width:64px;height:64px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 22px;
      font-weight: 900;
      background: rgba(57,217,138,0.14);
      border: 1px solid rgba(57,217,138,0.35);
      box-shadow: 0 0 0 6px rgba(57,217,138,0.08);
      margin-top: 6px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 10px;
    }
    .chip{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      font-size: 12px;
      color: rgba(233,240,255,0.86);
      white-space:nowrap;
    }
    .chip b{ color: var(--text); }
    .chip.green{ border-color: rgba(57,217,138,0.35); }
    .chip.amber{ border-color: rgba(246,201,69,0.35); }
    .chip.red{ border-color: rgba(255,77,109,0.35); }

    .miniHistory{
      margin-top: 12px;
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .mini{
      width:34px;height:34px;border-radius: 10px;
      display:flex;align-items:center;justify-content:center;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      font-weight: 800;
      color: rgba(233,240,255,0.88);
    }

    .probWrap{ margin-top: 10px; }
    .probRow{
      display:grid;
      grid-template-columns: 220px 1fr 60px;
      align-items:center;
      gap: 10px;
      padding: 7px 0;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.12);
      overflow:hidden;
      position:relative;
    }
    .bar > i{
      display:block;
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: var(--blue);
      box-shadow: 0 0 0 6px rgba(89,167,255,0.09);
    }
    .pct{
      text-align:right;
      color: rgba(233,240,255,0.85);
      font-weight: 800;
      font-size: 12px;
    }

    .rightStack{
      display:grid;
      gap: 16px;
    }

    .riskLevel{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding: 20px 16px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(0,0,0,0.20), rgba(0,0,0,0.08));
      border: 1px solid rgba(255,255,255,0.14);
      min-height: 140px;
    }
    .riskLevel .label{
      text-transform:uppercase;
      font-size: 11px;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .riskLevel .value{
      font-size: 46px;
      font-weight: 1000;
      letter-spacing: 0.6px;
      margin: 0;
    }
    .riskLevel .rule{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      text-align:center;
      max-width: 520px;
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .feedBox{
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      min-height: 120px;
    }
    .feedBox .k{
      font-size: 11px;
      letter-spacing: 0.9px;
      text-transform: uppercase;
      color: rgba(233,240,255,0.70);
      margin-bottom: 6px;
    }
    .feedBox .v{
      font-size: 34px;
      font-weight: 950;
      margin: 0;
    }
    .feedBox .small{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
    }
    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.22);
      font-weight: 900;
      font-size: 12px;
      white-space:nowrap;
    }
    .statusPill i{
      width:10px;height:10px;border-radius:50%;
      display:inline-block;
      background: var(--amber);
      box-shadow: 0 0 0 4px rgba(246,201,69,0.12);
    }
    .statusPill.live i{ background: var(--green); box-shadow: 0 0 0 4px rgba(57,217,138,0.12); }
    .statusPill.stale i{ background: var(--amber); box-shadow: 0 0 0 4px rgba(246,201,69,0.12); }
    .statusPill.error i{ background: var(--red); box-shadow: 0 0 0 4px rgba(255,77,109,0.12); }

    .note{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(233,240,255,0.62);
      line-height: 1.35;
    }

    .lowerGrid{
      display:grid;
      grid-template-columns: 1.55fr 1fr;
      gap: 16px;
      align-items:start;
    }

    .logTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .logBtns{
      display:flex; gap:10px; flex-wrap:wrap;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing: 0;
      margin-top: 12px;
      overflow:hidden;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
    }
    thead th{
      text-align:left;
      font-size: 11px;
      letter-spacing: 0.9px;
      text-transform: uppercase;
      color: rgba(233,240,255,0.70);
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding: 11px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      color: rgba(233,240,255,0.86);
      font-size: 12px;
      white-space:nowrap;
    }
    tbody tr:hover td{
      background: rgba(89,167,255,0.06);
    }
    .scroll{
      max-height: 320px;
      overflow:auto;
      margin-top: 10px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
    }
    .scroll table{ margin:0; border:none; border-radius:0; }

    .eventsHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .impact{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      font-weight: 900;
      font-size: 12px;
    }
    .impact .sq{
      width:10px;height:10px;border-radius: 3px; background: var(--amber);
      box-shadow: 0 0 0 4px rgba(246,201,69,0.10);
    }
    .impact.high{ border-color: rgba(255,77,109,0.35); }
    .impact.high .sq{ background: var(--red); box-shadow: 0 0 0 4px rgba(255,77,109,0.10); }
    .impact.med{ border-color: rgba(246,201,69,0.35); }
    .impact.med .sq{ background: var(--amber); }
    .impact.low{ border-color: rgba(57,217,138,0.35); }
    .impact.low .sq{ background: var(--green); }

    .headlineRow a{
      color: rgba(120,190,255,0.95);
      text-decoration:none;
      font-weight: 800;
    }
    .headlineRow a:hover{ text-decoration:underline; }

    .tvWrap{
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      min-height: 360px;
    }

    .footerLine{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color: rgba(233,240,255,0.60);
      font-size: 12px;
    }

    @media (max-width: 1100px){
      .grid, .lowerGrid{ grid-template-columns: 1fr; }
      .probRow{ grid-template-columns: 1fr; gap:6px; }
      .twoCol{ grid-template-columns: 1fr; }
      .big{ font-size: 38px; }
      .riskLevel .value{ font-size: 40px; }
    }

    /* Modal */
    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width:min(760px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.16);
      background: linear-gradient(180deg, rgba(15,30,70,0.92), rgba(7,16,40,0.92));
      box-shadow: 0 30px 120px rgba(0,0,0,0.65);
      padding: 16px;
    }
    .modal h3{ margin: 4px 0 6px 0; }
    .modal p{ margin:0 0 10px 0; color: var(--muted); font-size: 13px; line-height:1.35; }
    .modal textarea{
      width:100%;
      min-height: 220px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      outline:none;
    }
    .modal .actions{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .hint{
      font-size: 12px;
      color: rgba(233,240,255,0.60);
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <div class="qx-badge">QX</div>
        <div class="title">
          <h1>QuadraX Risk Dashboard</h1>
          <div class="sub">Executive View: 8-State Monitoring and Control System (Live EUR/USD Spot)</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill"><span class="dot" id="liveDot"></span><span id="sysLabel">LIVE</span></div>
        <div class="pill">Last Update <b id="lastUpdate">--:--:--</b></div>
        <button id="btnPause">Pause</button>
        <button class="primary" id="btnSync">Sync</button>
        <button id="btnEdit">Edit Events + Headlines</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Current Market State</h2>
        <div class="row">
          <div>
            <p class="big" id="policyTitle">Policy State: --</p>
            <div class="muted" id="policyDesc">--</div>

            <div class="chips">
              <div class="chip"><b>Detector</b> <span id="detectorChip">--</span></div>
              <div class="chip"><b>Policy</b> <span id="policyChip">--</span></div>
              <div class="chip"><b>Confidence</b> <span id="confChip">--</span></div>
              <div class="chip"><b>Hysteresis</b> <span id="hystChip">--</span></div>
              <div class="chip"><b>Tick</b> <span id="tickChip">--</span></div>
              <div class="chip"><b>Stale</b> <span id="staleChip">--</span></div>
            </div>

            <div class="miniHistory" id="histWrap"></div>
          </div>

          <div class="stateBadge" id="stateBadge">--</div>
        </div>
      </div>

      <div class="card">
        <h2>Risk Level <span class="muted" style="float:right; text-transform:none; letter-spacing:0;">Policy: state-aware sizing and entry gating</span></h2>
        <div class="riskLevel">
          <div class="label">Risk Level</div>
          <p class="value" id="riskValue">--</p>
          <div class="rule" id="riskRule">--</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>State Probability Distribution <span class="muted" style="float:right; text-transform:none; letter-spacing:0;">Conditional regime likelihoods P(state | features)</span></h2>
        <div class="muted">Note: probabilities are computed from EUR/USD-derived features (returns, momentum, volatility, mean-reversion pressure). They are not a “vote count” of ticks.</div>
        <div class="probWrap" id="probWrap"></div>
        <div class="note" id="probNote"></div>
      </div>

      <div class="rightStack">
        <div class="card">
          <h2>Feed Health <span class="muted" style="float:right; text-transform:none; letter-spacing:0;">Proof the market data is updating</span></h2>
          <div class="twoCol">
            <div class="feedBox">
              <div class="k">EUR/USD Spot (model feed)</div>
              <p class="v" id="spotVal">--</p>
              <div class="small">Last good sample: <span id="spotTs">--</span></div>
              <div class="small">Source: <span id="spotSrc">--</span></div>
            </div>
            <div class="feedBox">
              <div class="k">Status</div>
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <span class="statusPill" id="statusPill"><i></i><span id="statusText">CHECKING</span></span>
                <span class="muted">Latency: <b id="latency">--</b></span>
              </div>
              <div class="small">Delta (last): <b id="delta">--</b></div>
              <div class="small">Poll interval: <b id="pollInt">--</b></div>
            </div>
          </div>
          <div class="note">
            <b>Important:</b> We cannot extract live price from the TradingView chart via JavaScript (browser security). So we show TradingView live visually below, and we drive the regime engine from the best-available spot API feed with throttling and fallbacks.
          </div>
        </div>

        <div class="card">
          <div class="eventsHead">
            <h2 style="margin:0;">World Events Calendar <span class="muted" style="text-transform:none; letter-spacing:0; float:none;">Fastest reliable mode tonight: curated list (saved locally)</span></h2>
            <span class="muted">Red folder style: High impact events are <span style="color:var(--red); font-weight:900;">HIGH</span>.</span>
          </div>
          <div class="scroll" style="max-height: 220px;">
            <table>
              <thead>
                <tr><th>When</th><th>Event</th><th>Impact</th><th>Countdown</th></tr>
              </thead>
              <tbody id="eventsBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="eventsHead">
            <h2 style="margin:0;">Headlines <span class="muted" style="text-transform:none; letter-spacing:0; float:none;">Fastest reliable mode tonight: curated list (saved locally)</span></h2>
          </div>
          <div class="scroll" style="max-height: 220px;">
            <table>
              <thead>
                <tr><th>Time</th><th>Source</th><th>Headline</th></tr>
              </thead>
              <tbody id="newsBody"></tbody>
            </table>
          </div>
          <div class="note">Click opens source in a new tab.</div>
        </div>
      </div>
    </div>

    <div class="lowerGrid">
      <div class="card">
        <div class="logTop">
          <h2 style="margin:0;">Regime Log <span class="muted" style="text-transform:none; letter-spacing:0; float:none;">CSV-style telemetry (latest on top)</span></h2>
          <div class="logBtns">
            <button id="btnCopy">Copy as CSV</button>
            <button id="btnClear">Clear</button>
            <button id="btnSetKey">Set Quote API Key (optional)</button>
          </div>
        </div>

        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>EURUSD</th>
                <th>DET</th>
                <th>POL</th>
                <th>CONF</th>
                <th>VOL X</th>
                <th>MOM (bp)</th>
                <th>STALE</th>
                <th>SRC</th>
              </tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
        <div class="note">Tip: Copy CSV and paste into Excel. It splits cleanly.</div>
      </div>

      <div class="card">
        <div class="eventsHead">
          <h2 style="margin:0;">Daily EUR/USD Trend <span class="muted" style="text-transform:none; letter-spacing:0; float:none;">Embedded TradingView chart (live visual)</span></h2>
        </div>
        <div class="tvWrap">
          <!-- TradingView Symbol Overview Widget -->
          <div class="tradingview-widget-container" style="height:100%; width:100%;">
            <div class="tradingview-widget-container__widget" style="height:100%; width:100%;"></div>
          </div>
        </div>

        <div class="card" style="margin-top: 16px;">
          <h2>Risk Metrics <span class="muted" style="float:right; text-transform:none; letter-spacing:0;">Placeholders until execution integration</span></h2>
          <div class="twoCol">
            <div class="feedBox">
              <div class="k">Value at Risk (95%)</div>
              <p class="v" style="color:var(--red)">$28,500</p>
              <div class="small">2.85% of account</div>
            </div>
            <div class="feedBox">
              <div class="k">Conditional VaR (95%)</div>
              <p class="v" style="color:var(--red)">$42,300</p>
              <div class="small">Expected loss if VaR exceeded</div>
            </div>
          </div>
          <div class="twoCol" style="margin-top:12px;">
            <div class="feedBox">
              <div class="k">Portfolio Correlation</div>
              <p class="v" style="color:var(--green)">32.0%</p>
              <div class="small">Max allowed: 50.0%</div>
            </div>
            <div class="feedBox">
              <div class="k">Beta to Market</div>
              <p class="v" style="color:var(--blue)">0.15</p>
              <div class="small">Low market correlation (good)</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="footerLine">
      <div>System Status: <b id="sysStatus">LIVE</b></div>
      <div>Smoothed Policy: <b id="footPolicy">--</b></div>
      <div>Detector: <b id="footDet">--</b></div>
      <div>Hysteresis Hold: <b id="footHold">--</b></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBg" id="modalBg" aria-hidden="true">
    <div class="modal">
      <h3>Edit Events + Headlines</h3>
      <p>This is the “fastest reliable mode tonight”. Paste JSON here. It saves to your browser (localStorage).</p>
      <textarea id="modalText"></textarea>
      <div class="hint">
        Format:
        <br/>{"events":[{"when":"2026-02-19T13:30:00Z","event":"US Initial Jobless Claims","impact":"HIGH"}], "headlines":[{"time":"17:01","source":"FinancialJuice","title":"...","url":"https://..."}]}
      </div>
      <div class="actions">
        <button id="btnClose">Close</button>
        <button class="primary" id="btnSave">Save</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * 0) Constants / State
     ***********************/
    const STATES = [
      { id: 1, name: "Mean-Reverting",     color: "var(--green)",  risk: "NORMAL",   rule: "Range-bound. Fade extremes and keep size disciplined." },
      { id: 2, name: "Liquidity Vacuum",   color: "var(--amber)",  risk: "ELEVATED", rule: "Thin liquidity. Reduce size, widen filters, avoid chasing." },
      { id: 3, name: "Slow Drift",         color: "var(--blue)",   risk: "NORMAL",   rule: "Slow directional bias. Prefer patience over aggression." },
      { id: 4, name: "Strong Trend",       color: "var(--blue)",   risk: "ELEVATED", rule: "Trend regime. Trade with structure, avoid mean-revert traps." },
      { id: 5, name: "Stop Cascade",       color: "var(--orange)", risk: "CRITICAL", rule: "Stops firing. Cut size hard. Protect downside." },
      { id: 6, name: "News Shock",         color: "var(--red)",    risk: "CRITICAL", rule: "News-driven volatility. Wait for stabilization and confirmation." },
      { id: 7, name: "Dealer Unwind",      color: "var(--purple)", risk: "ELEVATED", rule: "Unwind conditions. Avoid oversized entries. Respect whipsaw." },
      { id: 8, name: "Panic/Forced",       color: "var(--pink)",   risk: "CRITICAL", rule: "Forced flows. Defensive posture. Only A+ setups." },
    ];

    const LS_KEY = "quadrax_curated_v1";
    const LS_APIKEY = "quadrax_twelvedata_key_v1";

    let paused = false;
    let tick = 0;

    // Quote polling behavior: starts fast, backs off when rate-limited or stale
    let pollMs = 6000;             // 6s baseline
    const POLL_MIN = 6000;
    const POLL_MAX = 60000;

    // Regime hysteresis: don’t flip unless candidate wins consistently
    const HOLD_TICKS_REQUIRED = 4;

    // Quote history for features
    const priceSeries = [];        // {t, p}
    const MAX_SERIES = 240;        // ~ 24 min at 6s
    const logRows = [];            // CSV log buffer
    const MAX_LOG = 120;

    // Policy state memory
    let detectorState = 1;
    let policyState = 1;
    let holdTicks = 0;
    let lastPolicy = 1;

    // Feed health
    let lastPrice = null;
    let lastGoodTs = null;
    let staleCount = 0;
    let lastLatency = null;
    let lastSrc = "--";
    let lastDelta = 0;

    /***********************
     * 1) DOM helpers
     ***********************/
    const $ = (id) => document.getElementById(id);

    function nowClock(){
      const d = new Date();
      let h = d.getHours(), m = d.getMinutes(), s = d.getSeconds();
      const am = h >= 12 ? "PM" : "AM";
      h = h % 12; if (h === 0) h = 12;
      const pad = (x)=> String(x).padStart(2,"0");
      return `${pad(h)}:${pad(m)}:${pad(s)} ${am}`;
    }

    function fmtPrice(x){
      if (x === null || x === undefined || Number.isNaN(x)) return "--";
      return Number(x).toFixed(5);
    }

    function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

    /***********************
     * 2) Curated events/headlines (local)
     ***********************/
    const DEFAULT_CURATED = {
      events: [
        { when: "2026-02-19T13:30:00Z", event: "US Initial Jobless Claims", impact: "MED" },
        { when: "2026-02-20T12:00:00Z", event: "Eurozone CPI (flash)", impact: "HIGH" },
        { when: "2026-02-26T13:30:00Z", event: "US GDP (advance)", impact: "HIGH" },
        { when: "2026-03-06T13:30:00Z", event: "US Non-Farm Payrolls", impact: "HIGH" }
      ],
      headlines: [
        { time: "03:00 PM", source: "FinancialJuice", title: "Dollar firming ahead of major data window", url: "https://financialjuice.com/" },
        { time: "02:26 PM", source: "FinancialJuice", title: "Rates repricing drives short-term USD bid", url: "https://financialjuice.com/" },
        { time: "01:06 PM", source: "Market", title: "Risk tone mixed as equities stabilize", url: "https://www.investing.com/" }
      ]
    };

    function loadCurated(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return DEFAULT_CURATED;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object") return DEFAULT_CURATED;
        return {
          events: Array.isArray(parsed.events) ? parsed.events : DEFAULT_CURATED.events,
          headlines: Array.isArray(parsed.headlines) ? parsed.headlines : DEFAULT_CURATED.headlines
        };
      }catch{
        return DEFAULT_CURATED;
      }
    }

    function saveCurated(obj){
      localStorage.setItem(LS_KEY, JSON.stringify(obj));
    }

    function countdown(iso){
      const t = new Date(iso).getTime();
      const now = Date.now();
      const diff = t - now;
      if (Number.isNaN(t)) return "--";
      if (diff <= 0) return "Now";
      const mins = Math.floor(diff / 60000);
      const hrs = Math.floor(mins / 60);
      const days = Math.floor(hrs / 24);
      const h = hrs % 24;
      const m = mins % 60;
      if (days > 0) return `${days}d ${h}h`;
      if (hrs > 0) return `${hrs}h ${m}m`;
      return `${m}m`;
    }

    function renderEvents(){
      const curated = loadCurated();
      const body = $("eventsBody");
      body.innerHTML = "";
      const rows = [...curated.events].sort((a,b)=> new Date(a.when) - new Date(b.when));
      for (const ev of rows){
        const d = new Date(ev.when);
        const when = d.toLocaleString(undefined, { month:"numeric", day:"numeric", year:"numeric", hour:"numeric", minute:"2-digit" });
        const impact = (ev.impact || "MED").toUpperCase();
        const cls = impact === "HIGH" ? "high" : (impact === "LOW" ? "low" : "med");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${when}</td>
          <td style="font-weight:800; color: rgba(120,190,255,0.95);">${ev.event || ""}</td>
          <td><span class="impact ${cls}"><span class="sq"></span>${impact}</span></td>
          <td>${countdown(ev.when)}</td>
        `;
        body.appendChild(tr);
      }
    }

    function renderHeadlines(){
      const curated = loadCurated();
      const body = $("newsBody");
      body.innerHTML = "";
      for (const h of curated.headlines){
        const tr = document.createElement("tr");
        tr.className = "headlineRow";
        const safeUrl = h.url || "#";
        tr.innerHTML = `
          <td>${h.time || ""}</td>
          <td>${h.source || ""}</td>
          <td><a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${h.title || ""}</a></td>
        `;
        body.appendChild(tr);
      }
    }

    function refreshCountdowns(){
      // update countdown column without re-rendering everything
      const curated = loadCurated();
      const rows = [...curated.events].sort((a,b)=> new Date(a.when) - new Date(b.when));
      const tds = $("eventsBody").querySelectorAll("tr td:last-child");
      tds.forEach((td, i) => {
        if (rows[i]) td.textContent = countdown(rows[i].when);
      });
    }

    /***********************
     * 3) Quote fetch (no backend, multi-source, throttled)
     ***********************/
    function getTwelveKey(){
      return (localStorage.getItem(LS_APIKEY) || "").trim();
    }

    async function tryFetch(url, timeoutMs = 6500){
      const ctrl = new AbortController();
      const t = setTimeout(()=> ctrl.abort(), timeoutMs);
      const start = performance.now();
      try{
        const res = await fetch(url, {
          method: "GET",
          cache: "no-store",
          headers: { "Accept":"application/json" },
          signal: ctrl.signal
        });
        const latency = Math.round(performance.now() - start);
        clearTimeout(t);
        return { ok: res.ok, status: res.status, latency, json: await res.json() };
      }catch(e){
        clearTimeout(t);
        return { ok: false, status: 0, latency: null, json: { error: String(e) } };
      }
    }

    async function fetchEURUSD(){
      // Returns: { ok, price, src, latency, note, rateLimited }
      const cacheBust = `&_=${Date.now()}`;

      // A) TwelveData (optional key, can rate limit hard)
      const key = getTwelveKey();
      if (key){
        const tdUrl = `https://api.twelvedata.com/price?symbol=EUR/USD&apikey=${encodeURIComponent(key)}${cacheBust}`;
        const r = await tryFetch(tdUrl);
        if (r.ok && r.json && r.json.price){
          const p = Number(r.json.price);
          if (Number.isFinite(p)) return { ok:true, price:p, src:"twelvedata", latency:r.latency, note:"spot-sampled", rateLimited:false };
        }
        // Detect rate limit / credits
        if (r.json && r.json.code && String(r.json.code) === "429") return { ok:false, price:null, src:"twelvedata", latency:r.latency, note:"rate-limited", rateLimited:true };
        if (r.json && r.json.message && String(r.json.message).toLowerCase().includes("api credits")) return { ok:false, price:null, src:"twelvedata", latency:r.latency, note:"credits/rate-limit", rateLimited:true };
      }

      // B) open.er-api (EUR base -> USD rate)
      {
        const url = `https://open.er-api.com/v6/latest/EUR?${cacheBust}`;
        const r = await tryFetch(url);
        if (r.ok && r.json && r.json.rates && r.json.rates.USD){
          const p = Number(r.json.rates.USD);
          if (Number.isFinite(p)) return { ok:true, price:p, src:"open.er-api.com", latency:r.latency, note:"spot-sampled", rateLimited:false };
        }
      }

      // C) exchangerate.host (can be good, sometimes cached)
      {
        const url = `https://api.exchangerate.host/latest?base=EUR&symbols=USD${cacheBust}`;
        const r = await tryFetch(url);
        if (r.ok && r.json && r.json.rates && r.json.rates.USD){
          const p = Number(r.json.rates.USD);
          if (Number.isFinite(p)) return { ok:true, price:p, src:"exchangerate.host", latency:r.latency, note:"spot-sampled", rateLimited:false };
        }
      }

      // D) frankfurter (ECB daily, last resort, will lag)
      {
        const url = `https://api.frankfurter.app/latest?from=EUR&to=USD${cacheBust}`;
        const r = await tryFetch(url);
        if (r.ok && r.json && r.json.rates && r.json.rates.USD){
          const p = Number(r.json.rates.USD);
          if (Number.isFinite(p)) return { ok:true, price:p, src:"frankfurter.app (ECB daily)", latency:r.latency, note:"DAILY (lag)", rateLimited:false };
        }
      }

      return { ok:false, price:null, src:"--", latency:null, note:"unreachable", rateLimited:false };
    }

    function updatePollInterval({rateLimited, stale}){
      if (rateLimited){
        pollMs = clamp(pollMs * 2, POLL_MIN, POLL_MAX);   // back off aggressively
        return;
      }
      if (stale){
        pollMs = clamp(Math.round(pollMs * 1.25), POLL_MIN, POLL_MAX); // back off gently
        return;
      }
      // healthy: slowly drift toward baseline
      pollMs = clamp(Math.round(pollMs * 0.92), POLL_MIN, 20000);
    }

    /***********************
     * 4) Feature extraction + probability distribution
     ***********************/
    function bp(x){ return x * 10000; }

    function mean(arr){
      if (arr.length === 0) return 0;
      return arr.reduce((a,b)=>a+b,0)/arr.length;
    }

    function stdev(arr){
      if (arr.length < 2) return 0;
      const m = mean(arr);
      const v = mean(arr.map(x => (x-m)*(x-m)));
      return Math.sqrt(v);
    }

    function softmax(scores){
      const mx = Math.max(...scores);
      const exps = scores.map(s => Math.exp(s - mx));
      const sum = exps.reduce((a,b)=>a+b,0) || 1;
      return exps.map(e => e / sum);
    }

    function computeFeatures(){
      // Uses last N points of priceSeries
      const n = priceSeries.length;
      if (n < 6) return { ready:false, ret:0, mom:0, vol:0, z:0, mr:0 };

      const last = priceSeries[n-1].p;
      const prev = priceSeries[n-2].p;

      const rets = [];
      for (let i=1; i<n; i++){
        const r = (priceSeries[i].p - priceSeries[i-1].p) / priceSeries[i-1].p;
        rets.push(r);
      }

      const w = rets.slice(-30); // last ~3 minutes at 6s
      const vol = stdev(w);      // short-term realized vol proxy
      const mom = (last - priceSeries[Math.max(0, n-10)].p); // ~1 minute momentum
      const ret = last - prev;

      // mean reversion pressure: deviation from rolling mean
      const pxWin = priceSeries.slice(-40).map(x=>x.p);
      const m = mean(pxWin);
      const sd = stdev(pxWin) || 1e-9;
      const z = (last - m)/sd;
      const mr = -Math.abs(z); // closer to mean => higher mr score

      return { ready:true, ret, mom, vol, z, mr };
    }

    function computeStateScores(feat){
      // Heuristic scoring model: maps features to 8 regime archetypes
      // Important: this is a *demo* regime classifier. It is driven by EURUSD spot feed (sampled), not events.
      const v = feat.vol;
      const mom = feat.mom;
      const z = feat.z;
      const absZ = Math.abs(z);

      // Normalize-ish
      const vN = clamp(v * 10000, 0, 5);       // vol in bp-ish scale
      const mN = clamp(bp(mom), -50, 50)/50;   // momentum in [-1,1]
      const zN = clamp(z, -3, 3)/3;            // zscore in [-1,1]
      const absZN = clamp(absZ, 0, 3)/3;       // [0,1]

      const scores = new Array(8).fill(0);

      // S1 Mean-Reverting: low vol + high absZ tends to revert (fade extremes)
      scores[0] = (1.2 - vN) + (absZN * 1.4) - Math.abs(mN) * 0.4;

      // S2 Liquidity Vacuum: medium vol spikes without clean direction (chop risk)
      scores[1] = (vN * 0.8) - Math.abs(mN) * 0.5 + 0.2;

      // S3 Slow Drift: low-to-medium vol + small but persistent momentum
      scores[2] = (1.0 - vN*0.6) + Math.abs(mN) * 0.7 - absZN * 0.2;

      // S4 Strong Trend: higher momentum + controlled vol
      scores[3] = Math.abs(mN) * 1.3 + (vN * 0.3) - absZN * 0.2;

      // S5 Stop Cascade: high vol + momentum + big z excursion
      scores[4] = (vN * 1.2) + Math.abs(mN) * 0.8 + absZN * 0.8;

      // S6 News Shock: sharp vol jump (proxy: high vN) and unstable move (absZ moderate)
      scores[5] = (vN * 1.4) + (1.0 - absZN) * 0.2;

      // S7 Dealer Unwind: high vol but mean reversion tug (absZ high, momentum decaying)
      scores[6] = (vN * 1.0) + (absZN * 1.0) - Math.abs(mN) * 0.2;

      // S8 Panic/Forced: extreme vol + extreme z + directional push
      scores[7] = (vN * 1.6) + (absZN * 1.2) + Math.abs(mN) * 0.6;

      return scores;
    }

    function pickDetectorAndPolicy(prob){
      const topIdx = prob.indexOf(Math.max(...prob)); // 0-based
      const det = topIdx + 1;

      // Hysteresis: policy changes only if a new detector wins for HOLD_TICKS_REQUIRED consecutive updates
      if (det === policyState){
        holdTicks = 0;
        return { det, pol: policyState, holdTicks, stable:true };
      }

      // candidate differs
      if (det !== lastPolicy){
        lastPolicy = det;
        holdTicks = 1;
        return { det, pol: policyState, holdTicks, stable:false };
      } else {
        holdTicks += 1;
        if (holdTicks >= HOLD_TICKS_REQUIRED){
          policyState = det;
          holdTicks = 0;
          return { det, pol: policyState, holdTicks, stable:true };
        }
        return { det, pol: policyState, holdTicks, stable:false };
      }
    }

    /***********************
     * 5) UI render
     ***********************/
    function renderProb(prob){
      const wrap = $("probWrap");
      wrap.innerHTML = "";
      for (let i=0; i<8; i++){
        const st = STATES[i];
        const pct = prob[i] * 100;
        const row = document.createElement("div");
        row.className = "probRow";
        row.innerHTML = `
          <div style="font-weight:900; color: rgba(233,240,255,0.86);">${"State " + st.id + ": " + st.name}</div>
          <div class="bar"><i style="background:${st.color}; width:${pct.toFixed(1)}%"></i></div>
          <div class="pct">${pct.toFixed(1)}%</div>
        `;
        wrap.appendChild(row);
      }
    }

    function renderHeader(policyId, detectorId, conf, hystText){
      const st = STATES[policyId-1];
      $("policyTitle").textContent = `Policy State: S${st.id} ${st.name}`;
      $("policyDesc").textContent = st.rule;

      $("detectorChip").textContent = `S${detectorId}`;
      $("policyChip").textContent = `S${policyId}`;
      $("confChip").textContent = `${(conf*100).toFixed(1)}%`;
      $("hystChip").textContent = hystText;

      // No EURUSD rate displayed here (you asked to remove it)
      $("tickChip").textContent = `${tick}`;
      $("staleChip").textContent = `${staleCount}`;

      $("stateBadge").textContent = String(st.id);
      $("stateBadge").style.background = `color-mix(in oklab, ${st.color} 22%, rgba(0,0,0,0.18))`;
      $("stateBadge").style.borderColor = `color-mix(in oklab, ${st.color} 55%, rgba(255,255,255,0.08))`;
      $("stateBadge").style.boxShadow = `0 0 0 6px color-mix(in oklab, ${st.color} 20%, rgba(0,0,0,0.0))`;

      $("riskValue").textContent = st.risk;
      $("riskRule").textContent = st.rule;

      $("footPolicy").textContent = `S${policyId}`;
      $("footDet").textContent = `S${detectorId}`;
      $("footHold").textContent = String(holdTicks);

      // History pills
      const hist = JSON.parse(localStorage.getItem("quadrax_hist_v1") || "[]");
      const wrap = $("histWrap");
      wrap.innerHTML = "";
      hist.slice(-12).forEach(x=>{
        const d = document.createElement("div");
        d.className = "mini";
        d.textContent = String(x);
        wrap.appendChild(d);
      });
    }

    function pushHistory(pol){
      const key = "quadrax_hist_v1";
      const hist = JSON.parse(localStorage.getItem(key) || "[]");
      hist.push(pol);
      localStorage.setItem(key, JSON.stringify(hist.slice(-48)));
    }

    function renderFeed(price, src, latency, status){
      $("spotVal").textContent = fmtPrice(price);
      $("spotTs").textContent = lastGoodTs ? lastGoodTs : "--";
      $("spotSrc").textContent = src || "--";
      $("latency").textContent = latency ? `${latency}ms` : "--";
      $("delta").textContent = (lastDelta !== null && lastDelta !== undefined) ? fmtPrice(lastDelta) : "--";
      $("pollInt").textContent = `${Math.round(pollMs/1000)}s`;

      const pill = $("statusPill");
      const txt = $("statusText");

      pill.classList.remove("live","stale","error");
      if (status === "LIVE"){
        pill.classList.add("live");
        txt.textContent = "LIVE";
      } else if (status === "STALE"){
        pill.classList.add("stale");
        txt.textContent = "STALE";
      } else {
        pill.classList.add("error");
        txt.textContent = "ERROR";
      }
    }

    function addLogRow({time, price, det, pol, conf, volx, momBp, stale, src}){
      logRows.unshift({time, price, det, pol, conf, volx, momBp, stale, src});
      if (logRows.length > MAX_LOG) logRows.pop();

      const body = $("logBody");
      body.innerHTML = "";
      for (const r of logRows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.time}</td>
          <td>${fmtPrice(r.price)}</td>
          <td>${r.det}</td>
          <td>${r.pol}</td>
          <td>${(r.conf*100).toFixed(1)}%</td>
          <td>${r.volx.toFixed(2)}</td>
          <td>${r.momBp.toFixed(2)}</td>
          <td>${r.stale ? "Y" : "N"}</td>
          <td>${r.src}</td>
        `;
        body.appendChild(tr);
      }
    }

    /***********************
     * 6) Main loop
     ***********************/
    async function step(){
      if (paused){
        scheduleNext();
        return;
      }

      tick += 1;

      const t0 = performance.now();
      const q = await fetchEURUSD();
      lastLatency = q.latency;
      lastSrc = q.src || "--";

      // If no price, mark error and backoff
      if (!q.ok || !Number.isFinite(q.price)){
        staleCount += 1;
        updatePollInterval({ rateLimited: q.rateLimited, stale: true });
        renderFeed(lastPrice, lastSrc, lastLatency, "ERROR");
        $("probNote").textContent = "Quote unavailable. Probabilities may freeze until a valid sample arrives.";
        scheduleNext();
        return;
      }

      // Detect staleness: exact repeats too many times
      const newPrice = q.price;
      const isRepeat = (lastPrice !== null && Math.abs(newPrice - lastPrice) < 1e-9);
      if (isRepeat) staleCount += 1; else staleCount = 0;

      lastDelta = (lastPrice === null) ? 0 : (newPrice - lastPrice);
      lastPrice = newPrice;
      lastGoodTs = nowClock();
      $("lastUpdate").textContent = lastGoodTs;

      // Store price series
      priceSeries.push({ t: Date.now(), p: newPrice });
      while (priceSeries.length > MAX_SERIES) priceSeries.shift();

      const stale = staleCount >= 6;
      renderFeed(newPrice, lastSrc, lastLatency, stale ? "STALE" : "LIVE");

      // Update polling interval adaptively
      updatePollInterval({ rateLimited: q.rateLimited, stale });

      // If stale, we still compute features, but warn
      if (stale){
        $("probNote").textContent = "Feed looks stale (repeating price). Probabilities may flatten and policy changes will be conservative.";
      } else {
        $("probNote").textContent = "Probabilities are computed from recent EUR/USD spot changes (sampled). Policy state uses hysteresis to prevent flip-flopping.";
      }

      // Features + probabilities
      const feat = computeFeatures();
      if (!feat.ready){
        // not enough data yet
        renderHeader(policyState, detectorState, 0.10, "warming up");
        renderProb(new Array(8).fill(1/8));
        pushHistory(policyState);
        addLogRow({
          time: nowClock(), price: newPrice,
          det: "S--", pol: `S${policyState}`,
          conf: 0.10, volx: 0, momBp: 0,
          stale, src: lastSrc
        });
        scheduleNext();
        return;
      }

      const scores = computeStateScores(feat);
      const prob = softmax(scores);

      const top = Math.max(...prob);
      const { det, pol, stable } = pickDetectorAndPolicy(prob);
      detectorState = det;

      const hystText = stable ? "stable" : `holding (${holdTicks}/${HOLD_TICKS_REQUIRED})`;

      renderProb(prob);
      renderHeader(pol, det, top, hystText);
      pushHistory(pol);

      // Log row
      addLogRow({
        time: nowClock(),
        price: newPrice,
        det: `S${det}`,
        pol: `S${pol}`,
        conf: top,
        volx: clamp(feat.vol * 10000, 0, 9), // vol proxy in bp-ish
        momBp: bp(feat.mom),
        stale,
        src: lastSrc
      });

      scheduleNext();
    }

    function scheduleNext(){
      setTimeout(step, pollMs);
    }

    /***********************
     * 7) Buttons / modal
     ***********************/
    $("btnPause").addEventListener("click", ()=>{
      paused = !paused;
      $("btnPause").textContent = paused ? "Resume" : "Pause";
      $("sysStatus").textContent = paused ? "PAUSED" : "LIVE";
      $("sysLabel").textContent = paused ? "PAUSED" : "LIVE";
      $("liveDot").style.background = paused ? "var(--amber)" : "var(--green)";
      $("liveDot").style.boxShadow = paused
        ? "0 0 0 4px rgba(246,201,69,0.15)"
        : "0 0 0 4px rgba(57,217,138,0.15)";
    });

    $("btnSync").addEventListener("click", ()=>{
      // “Sync” in a static site means: clear local rate-limit backoff + do an immediate step
      pollMs = POLL_MIN;
      staleCount = 0;
      step();
    });

    $("btnCopy").addEventListener("click", async ()=>{
      const lines = [];
      lines.push(["time","eurusd","det","pol","conf","vol_x","mom_bp","stale","src"].join(","));
      for (const r of logRows){
        lines.push([
          `"${r.time}"`,
          fmtPrice(r.price),
          r.det,
          r.pol,
          (r.conf*100).toFixed(1),
          r.volx.toFixed(2),
          r.momBp.toFixed(2),
          r.stale ? "Y" : "N",
          `"${r.src}"`
        ].join(","));
      }
      await navigator.clipboard.writeText(lines.join("\n"));
    });

    $("btnClear").addEventListener("click", ()=>{
      logRows.length = 0;
      $("logBody").innerHTML = "";
      localStorage.removeItem("quadrax_hist_v1");
      $("histWrap").innerHTML = "";
    });

    $("btnEdit").addEventListener("click", ()=>{
      const curated = loadCurated();
      $("modalText").value = JSON.stringify(curated, null, 2);
      $("modalBg").style.display = "flex";
      $("modalBg").setAttribute("aria-hidden", "false");
    });

    $("btnClose").addEventListener("click", ()=>{
      $("modalBg").style.display = "none";
      $("modalBg").setAttribute("aria-hidden", "true");
    });

    $("btnSave").addEventListener("click", ()=>{
      try{
        const obj = JSON.parse($("modalText").value);
        saveCurated(obj);
        renderEvents();
        renderHeadlines();
        $("modalBg").style.display = "none";
        $("modalBg").setAttribute("aria-hidden", "true");
      }catch{
        alert("Invalid JSON. Fix the format and try again.");
      }
    });

    $("btnSetKey").addEventListener("click", ()=>{
      const cur = getTwelveKey();
      const v = prompt("Optional: paste TwelveData API key (will be stored in this browser only). Leave blank to clear.", cur || "");
      if (v === null) return;
      const trimmed = String(v).trim();
      if (!trimmed){
        localStorage.removeItem(LS_APIKEY);
        alert("Cleared TwelveData key. Using free public sources only.");
      } else {
        localStorage.setItem(LS_APIKEY, trimmed);
        alert("Saved key. Note: TwelveData free tier rate-limits hard. The dashboard will back off automatically.");
      }
      pollMs = POLL_MIN;
      staleCount = 0;
      step();
    });

    /***********************
     * 8) TradingView widget embed
     * We show live visually, but cannot read it in JS.
     ***********************/
    (function loadTradingView(){
      const script = document.createElement("script");
      script.src = "https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js";
      script.async = true;
      script.innerHTML = JSON.stringify({
        "symbols": [
          ["FX:EURUSD|1D"]
        ],
        "chartOnly": false,
        "width": "100%",
        "height": "360",
        "locale": "en",
        "colorTheme": "dark",
        "autosize": true,
        "showVolume": true,
        "showMA": false,
        "hideDateRanges": false,
        "hideMarketStatus": false,
        "hideSymbolLogo": false,
        "scalePosition": "right",
        "scaleMode": "Normal",
        "fontFamily": "-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial, sans-serif",
        "fontSize": "12",
        "noTimeScale": false,
        "valuesTracking": "1",
        "changeMode": "price-and-percent",
        "chartType": "candlesticks",
        "maLineColor": "#2962FF",
        "maLineWidth": 1,
        "maLength": 9,
        "backgroundColor": "rgba(0, 0, 0, 0)",
        "gridLineColor": "rgba(255, 255, 255, 0.08)",
        "lineWidth": 2,
        "lineType": 0,
        "dateRanges": ["1D","5D","1M","3M","6M","YTD","1Y","5Y","ALL"]
      });
      document.querySelector(".tradingview-widget-container__widget").appendChild(script);
    })();

    /***********************
     * 9) Init
     ***********************/
    function init(){
      renderEvents();
      renderHeadlines();
      setInterval(refreshCountdowns, 30_000);

      $("lastUpdate").textContent = nowClock();
      $("sysStatus").textContent = "LIVE";
      $("sysLabel").textContent = "LIVE";

      // Seed history placeholders
      $("histWrap").innerHTML = "";

      // Start loop
      step();
    }

    init();
  </script>
</body>
</html>
