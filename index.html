<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QuadraX Risk Dashboard</title>
  <style>
    :root{
      --bg:#070b1b;
      --panel: rgba(30,58,138,.22);
      --panel2: rgba(0,0,0,.28);
      --stroke: rgba(59,130,246,.55);
      --stroke2: rgba(96,165,250,.25);
      --text:#e6eefc;
      --muted:#a9b6d3;
      --muted2:#7f90b8;
      --good:#10b981;
      --warn:#f59e0b;
      --bad:#dc2626;
      --blue:#60a5fa;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% 15%, rgba(59,130,246,.20), transparent 60%),
        radial-gradient(1200px 600px at 80% 70%, rgba(16,185,129,.10), transparent 60%),
        radial-gradient(900px 500px at 50% 120%, rgba(220,38,38,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family: Segoe UI, system-ui, -apple-system, Arial, sans-serif;
      padding:18px;
    }
    .container{max-width:1800px;margin:0 auto}
    .header{
      display:flex;justify-content:space-between;align-items:center;
      padding:18px 20px;border-radius:18px;
      background: linear-gradient(135deg, rgba(30,58,138,.92), rgba(59,130,246,.82));
      border:1px solid rgba(96,165,250,.65);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      position:sticky; top:12px; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:14px}
    .qx{
      width:44px;height:44px;border-radius:14px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;letter-spacing:.5px;
    }
    .title h1{margin:0;font-size:20px}
    .title div{margin-top:2px;color:#d5e4ff;font-size:12px}
    .controls{display:flex;align-items:center;gap:10px}
    .pill{
      display:flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.14);
      font-size:12px;color:#d7e6ff;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .btn{
      border:none;cursor:pointer;
      padding:9px 12px;border-radius:12px;
      font-weight:700;color:#fff;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.18);
    }
    .btn.primary{background: rgba(16,185,129,.25); border-color: rgba(16,185,129,.55)}
    .btn.warn{background: rgba(245,158,11,.25); border-color: rgba(245,158,11,.55)}
    .btn.blue{background: rgba(59,130,246,.25); border-color: rgba(59,130,246,.55)}
    .grid{
      margin-top:18px;
      display:grid;grid-template-columns: 2fr 1fr; gap:16px;
    }
    .col{display:flex;flex-direction:column;gap:16px}
    .card{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius:18px;
      padding:18px;
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .card h2{
      margin:0 0 12px 0;
      color: #b8d2ff;
      font-size:14px;
      letter-spacing:.6px;
      text-transform:uppercase;
      display:flex;justify-content:space-between;align-items:center;
    }
    .subnote{color:var(--muted2); font-size:12px}
    .bigrow{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .bigtitle{font-size:36px;font-weight:900;margin:0;line-height:1.05}
    .muted{color:var(--muted);font-size:13px}
    .divider{height:1px;background: rgba(96,165,250,.22); margin:14px 0}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:800;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
    }
    .ring{
      width:74px;height:74px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:28px;font-weight:900;color:#fff;
      box-shadow: inset 0 0 0 10px rgba(255,255,255,.06);
    }
    .history{display:flex;gap:8px;flex-wrap:wrap}
    .hbox{
      width:38px;height:38px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff;
      border:1px solid rgba(255,255,255,.12);
    }
    .bars{display:flex;flex-direction:column;gap:10px}
    .barline{display:flex;justify-content:space-between;gap:10px;font-size:13px}
    .bar{
      height:10px;border-radius:999px;background: rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .fill{height:100%}
    .kpis{display:grid;grid-template-columns: repeat(4, 1fr); gap:12px}
    .kpi{
      background: var(--panel2);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
    }
    .kpi .label{color:var(--muted2);font-size:12px}
    .kpi .val{font-size:18px;font-weight:900;margin-top:6px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(96,165,250,.12);font-size:12px}
    th{color:#b7c9ef;text-transform:uppercase;letter-spacing:.6px;font-size:11px}
    td{color:#e8f1ff}
    .scroll{max-height:240px;overflow:auto;border-radius:14px;border:1px solid rgba(255,255,255,.10)}
    .scroll::-webkit-scrollbar{height:10px;width:10px}
    .scroll::-webkit-scrollbar-thumb{background: rgba(96,165,250,.25); border-radius:999px}
    .impact{display:inline-flex;align-items:center;gap:8px;font-weight:900}
    .folder{
      width:10px;height:10px;border-radius:3px;background: var(--warn);
      box-shadow:0 0 0 4px rgba(245,158,11,.18);
    }
    .folder.red{background: var(--bad); box-shadow:0 0 0 4px rgba(220,38,38,.20)}
    .status{
      display:flex;justify-content:space-between;align-items:center;
      margin-top:16px;padding:12px 16px;border-radius:16px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(96,165,250,.20);
      color: #cfe2ff;
      font-size:12px;
    }
    .rightStack{display:flex;flex-direction:column;gap:12px}
    .risk{
      display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;
      text-align:center;
      padding:18px;border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
    }
    .risk .lvl{font-size:36px;font-weight:1000}
    .risk small{color:var(--muted)}
    .health{
      display:grid;grid-template-columns: 1fr 1fr; gap:12px;
    }
    .health .box{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;padding:12px;
      min-height:86px;
    }
    .health .box .label{color:var(--muted2);font-size:12px}
    .health .box .spot{font-size:28px;font-weight:1000;margin-top:8px}
    .health .box .meta{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.25}
    .warnText{color:#ffd7a6}
    .badText{color:#ffb1b1}
    .goodText{color:#b9ffe9}
    @media (max-width: 1180px){
      .grid{grid-template-columns:1fr}
      .kpis{grid-template-columns:1fr 1fr}
    }
    @media (max-width: 680px){
      .header{flex-direction:column;align-items:flex-start;gap:12px}
      .controls{flex-wrap:wrap}
      .kpis{grid-template-columns:1fr}
      .bigtitle{font-size:30px}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="qx">QX</div>
      <div class="title">
        <h1>QuadraX Risk Dashboard</h1>
        <div>Executive View: 8-State Monitoring and Control System (Live EUR/USD)</div>
      </div>
    </div>
    <div class="controls">
      <div class="pill" id="livePill"><span class="dot" id="liveDot"></span><span id="liveLabel">LIVE</span></div>
      <div class="pill">Last Update&nbsp;<b id="lastUpdate">--</b></div>
      <button class="btn warn" id="pauseBtn">Pause</button>
      <button class="btn blue" id="syncBtn">Sync</button>
    </div>
  </div>

  <div class="grid">
    <div class="col">
      <div class="card" id="stateCard">
        <h2>
          <span>Current Market State</span>
          <span class="subnote" id="stateCardNote">Backend-driven live feeds (no simulation)</span>
        </h2>

        <div class="bigrow">
          <div>
            <div class="bigtitle" id="policyTitle">Policy State: --</div>
            <div class="muted" style="margin-top:6px">
              Detector (raw): <b id="rawState">--</b> &nbsp;|&nbsp;
              Policy Confidence: <b id="policyConf">--</b>
            </div>
            <div class="muted" style="margin-top:6px">
              Hysteresis: <b id="hystStatus">--</b> &nbsp;|&nbsp;
              Hold ticks: <b id="holdTicks">--</b> &nbsp;|&nbsp;
              Tick: <b id="tickCount">--</b> &nbsp;|&nbsp;
              Last calc: <b id="lastCalc">--</b>
            </div>
          </div>
          <div class="ring" id="stateRing">--</div>
        </div>

        <div class="divider"></div>
        <div class="muted">Recent Policy State History (Last 12 Updates)</div>
        <div class="history" id="stateHistory"></div>
      </div>

      <div class="card">
        <h2>
          <span>State Probability Distribution</span>
          <span class="subnote">Conditional regime likelihoods P(State | features)</span>
        </h2>
        <div class="bars" id="probBars"></div>
        <div class="subnote" style="margin-top:10px">
          Note: probabilities can flatten if the quote feed is stale or the backend marks the sample low quality.
        </div>
      </div>

      <div class="card">
        <h2>
          <span>Portfolio Snapshot</span>
          <span class="subnote">Demo placeholders until execution and risk feeds are connected</span>
        </h2>
        <div class="kpis">
          <div class="kpi">
            <div class="label">Account Balance</div>
            <div class="val">$1,000,000</div>
          </div>
          <div class="kpi">
            <div class="label">Daily PnL</div>
            <div class="val" style="color:var(--good)">+$13,160</div>
          </div>
          <div class="kpi">
            <div class="label">Total Exposure</div>
            <div class="val">$650,000</div>
          </div>
          <div class="kpi">
            <div class="label">Max Drawdown</div>
            <div class="val" style="color:var(--bad)">-3.2%</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>
          <span>Regime Log</span>
          <span class="subnote">CSV-style telemetry (latest on top)</span>
        </h2>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>EURUSD</th>
                <th>Detector</th>
                <th>Policy</th>
                <th>Conf</th>
                <th>Vol X</th>
                <th>Mom</th>
                <th>Feed</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
        <div class="subnote" style="margin-top:10px">Tip: copy table contents into Excel. It will split nicely.</div>
      </div>
    </div>

    <div class="col rightStack">
      <div class="risk" id="riskCard">
        <div class="subnote">Risk Level</div>
        <div class="lvl" id="riskLevel">--</div>
        <small id="riskPolicy">Policy: state-aware sizing and entry gating</small>
      </div>

      <div class="card">
        <h2>
          <span>Feed Health</span>
          <span class="subnote">Proof the market data is updating</span>
        </h2>
        <div class="health">
          <div class="box">
            <div class="label">EUR/USD Spot (reference)</div>
            <div class="spot" id="spotPx">--</div>
            <div class="meta" id="spotMeta">Last good sample: --</div>
          </div>
          <div class="box">
            <div class="label">Status</div>
            <div class="badge" id="feedBadge"><span class="dot" id="feedDot"></span><span id="feedText">CHECKING</span></div>
            <div class="meta" id="feedMeta">Source: -- • Latency: --</div>
            <div class="meta" id="feedHelp" style="margin-top:8px">
              If the provider repeats or stalls, the backend should mark STALE and freeze regime updates safely.
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>
          <span>World Events Calendar</span>
          <span class="subnote">Live API feed (Forex Factory style impact)</span>
        </h2>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>When</th>
                <th>Event</th>
                <th>Impact</th>
                <th>Countdown</th>
              </tr>
            </thead>
            <tbody id="calBody"></tbody>
          </table>
        </div>
        <div class="subnote" style="margin-top:10px">
          Red folder style: High impact events are <span class="impact"><span class="folder red"></span>HIGH</span>.
        </div>
      </div>

      <div class="card">
        <h2>
          <span>Headlines</span>
          <span class="subnote">Live feed (no demo list)</span>
        </h2>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Source</th>
                <th>Headline</th>
              </tr>
            </thead>
            <tbody id="newsBody"></tbody>
          </table>
        </div>
        <div class="subnote" style="margin-top:10px">Click opens source in a new tab.</div>
      </div>

      <div class="card">
        <h2><span>Risk Metrics</span><span class="subnote">Placeholders until execution integration</span></h2>
        <div class="kpis" style="grid-template-columns:1fr 1fr">
          <div class="kpi">
            <div class="label">Value at Risk (95%)</div>
            <div class="val" style="color:var(--bad)">$28,500</div>
            <div class="subnote">2.85% of account</div>
          </div>
          <div class="kpi">
            <div class="label">Conditional VaR (95%)</div>
            <div class="val" style="color:var(--bad)">$42,300</div>
            <div class="subnote">Expected loss if VaR exceeded</div>
          </div>
          <div class="kpi">
            <div class="label">Portfolio Correlation</div>
            <div class="val" style="color:var(--good)">32.0%</div>
            <div class="subnote">Max allowed: 50%</div>
          </div>
          <div class="kpi">
            <div class="label">Beta to Market</div>
            <div class="val" style="color:var(--blue)">0.15</div>
            <div class="subnote">Low market correlation (good)</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="status">
    <div>System Status: <b id="sysStatus">LIVE</b></div>
    <div>Smoothed State: <b id="smoothedState">--</b></div>
    <div>Raw State: <b id="rawStateFooter">--</b></div>
    <div>Hysteresis Hold: <b id="hystHoldFooter">--</b></div>
  </div>
</div>

<script>
/**
 * IMPORTANT:
 * This dashboard is static (GitHub Pages).
 * To achieve:
 *  - real live EUR/USD spot (not cached reference),
 *  - live calendar + headlines,
 *  - shared state across the team on refresh,
 * you MUST point this UI at a backend API that fetches/streams data + caches latest state.
 *
 * Set BACKEND_BASE_URL below to your deployed backend.
 * Example: https://quadrax-api.vercel.app
 */
const BACKEND_BASE_URL = "https://poetic-bombolone-b5b12a.netlify.app"; // <-- SET THIS. Leave "" to see obvious errors instead of fake data.

const ENDPOINTS = {
  quote:  () => `${BACKEND_BASE_URL}/api/quote?symbol=EURUSD`,
  calendar: () => `${BACKEND_BASE_URL}/api/calendar?ccy=USD,EUR`,
  headlines: () => `${BACKEND_BASE_URL}/api/headlines`,
  state: () => `${BACKEND_BASE_URL}/api/state?symbol=EURUSD`, // optional: if backend returns full regime state
};

const STATE_NAMES = {
  1: "Mean-Reverting",
  2: "Liquidity Vacuum",
  3: "Slow Drift",
  4: "Strong Trend",
  5: "Stop Cascade",
  6: "News Shock",
  7: "Dealer Unwind",
  8: "Panic/Forced",
};

const STATE_COLORS = {
  1: {bg:"#10b981"},
  2: {bg:"#f59e0b"},
  3: {bg:"#60a5fa"},
  4: {bg:"#3b82f6"},
  5: {bg:"#f97316"},
  6: {bg:"#ef4444"},
  7: {bg:"#a855f7"},
  8: {bg:"#dc2626"},
};

let isLive = true;
let tick = 0;

// persisted view (so refresh doesn’t feel like “reset to nothing”)
const STORE_KEY = "quadrax_live_view_v1";
function loadStored(){
  try { return JSON.parse(localStorage.getItem(STORE_KEY) || "null"); } catch { return null; }
}
function saveStored(payload){
  try { localStorage.setItem(STORE_KEY, JSON.stringify(payload)); } catch {}
}

const ui = {
  lastUpdate: document.getElementById("lastUpdate"),
  pauseBtn: document.getElementById("pauseBtn"),
  syncBtn: document.getElementById("syncBtn"),
  liveDot: document.getElementById("liveDot"),
  liveLabel: document.getElementById("liveLabel"),
  sysStatus: document.getElementById("sysStatus"),

  policyTitle: document.getElementById("policyTitle"),
  rawState: document.getElementById("rawState"),
  policyConf: document.getElementById("policyConf"),
  hystStatus: document.getElementById("hystStatus"),
  holdTicks: document.getElementById("holdTicks"),
  tickCount: document.getElementById("tickCount"),
  lastCalc: document.getElementById("lastCalc"),
  stateRing: document.getElementById("stateRing"),
  stateHistory: document.getElementById("stateHistory"),

  probBars: document.getElementById("probBars"),
  riskLevel: document.getElementById("riskLevel"),
  riskCard: document.getElementById("riskCard"),

  spotPx: document.getElementById("spotPx"),
  spotMeta: document.getElementById("spotMeta"),
  feedBadge: document.getElementById("feedBadge"),
  feedDot: document.getElementById("feedDot"),
  feedText: document.getElementById("feedText"),
  feedMeta: document.getElementById("feedMeta"),
  feedHelp: document.getElementById("feedHelp"),

  calBody: document.getElementById("calBody"),
  newsBody: document.getElementById("newsBody"),

  logBody: document.getElementById("logBody"),

  smoothedState: document.getElementById("smoothedState"),
  rawStateFooter: document.getElementById("rawStateFooter"),
  hystHoldFooter: document.getElementById("hystHoldFooter"),
};

function fmtTime(d){
  return d.toLocaleTimeString([], {hour:"numeric", minute:"2-digit", second:"2-digit"});
}
function fmtDateTime(d){
  return d.toLocaleString([], {month:"numeric", day:"numeric", year:"numeric", hour:"numeric", minute:"2-digit"});
}
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function setLiveUI(){
  ui.liveDot.style.background = isLive ? "var(--good)" : "rgba(160,160,160,.8)";
  ui.liveLabel.textContent = isLive ? "LIVE" : "PAUSED";
  ui.sysStatus.textContent = isLive ? "LIVE" : "PAUSED";
  ui.pauseBtn.textContent = isLive ? "Pause" : "Resume";
  ui.pauseBtn.className = isLive ? "btn warn" : "btn primary";
}

ui.pauseBtn.onclick = () => { isLive = !isLive; setLiveUI(); };
ui.syncBtn.onclick = () => { hardSync(); };

function riskFromPolicyState(s){
  if (s >= 8) return {lvl:"CRITICAL", bg:"rgba(220,38,38,.25)", border:"rgba(220,38,38,.55)"};
  if (s >= 7) return {lvl:"HIGH", bg:"rgba(249,115,22,.25)", border:"rgba(249,115,22,.55)"};
  if (s >= 5) return {lvl:"ELEVATED", bg:"rgba(245,158,11,.22)", border:"rgba(245,158,11,.55)"};
  if (s >= 3) return {lvl:"MODERATE", bg:"rgba(59,130,246,.22)", border:"rgba(59,130,246,.55)"};
  return {lvl:"NORMAL", bg:"rgba(16,185,129,.20)", border:"rgba(16,185,129,.55)"};
}

function setFeedBadge(status){
  // status: LIVE | STALE | CHECKING | ERROR
  ui.feedText.textContent = status;
  const map = {
    LIVE: {dot:"var(--good)"},
    STALE:{dot:"var(--warn)"},
    CHECKING:{dot:"rgba(180,190,220,.8)"},
    ERROR:{dot:"var(--bad)"},
  };
  ui.feedDot.style.background = (map[status]||map.CHECKING).dot;
}

function renderHistory(arr){
  ui.stateHistory.innerHTML = "";
  arr.slice(-12).forEach((s, i, a) => {
    const el = document.createElement("div");
    el.className = "hbox";
    el.textContent = s;
    el.style.background = STATE_COLORS[s].bg;
    const alpha = 0.28 + (i / Math.max(1,(a.length-1))) * 0.72;
    el.style.opacity = alpha.toFixed(2);
    ui.stateHistory.appendChild(el);
  });
}

function renderProbs(probs){
  // probs: {1:xx,2:xx,...} sum ~= 100
  ui.probBars.innerHTML = "";
  for (let s=1;s<=8;s++){
    const p = probs[s] ?? 0;
    const row = document.createElement("div");
    row.innerHTML = `
      <div class="barline">
        <span style="color:#dbeafe">State ${s}: ${STATE_NAMES[s]}</span>
        <span style="color:${STATE_COLORS[s].bg}; font-weight:900">${p.toFixed(1)}%</span>
      </div>
      <div class="bar"><div class="fill" style="width:${clamp(p,0,100)}%; background:${STATE_COLORS[s].bg}"></div></div>
    `;
    ui.probBars.appendChild(row);
  }
}

function addLogRow(row){
  // newest on top
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${row.time}</td>
    <td>${row.px}</td>
    <td>${row.detector}</td>
    <td>${row.policy}</td>
    <td>${row.conf}</td>
    <td>${row.volx}</td>
    <td>${row.mom}</td>
    <td>${row.feed}</td>
    <td>${row.status}</td>
  `;
  ui.logBody.prepend(tr);
  while (ui.logBody.children.length > 80) ui.logBody.removeChild(ui.logBody.lastChild);
}

function setPolicyUI(state){
  const s = state.policyState;
  const raw = state.rawState;
  ui.policyTitle.textContent = `Policy State: S${s} ${STATE_NAMES[s]}`;
  ui.rawState.textContent = `S${raw} ${STATE_NAMES[raw]}`;
  ui.policyConf.textContent = `${(state.confidence*100).toFixed(1)}%`;
  ui.hystStatus.textContent = state.hysteresisStatus;
  ui.holdTicks.textContent = state.holdTicks;
  ui.tickCount.textContent = tick;
  ui.lastCalc.textContent = state.lastCalc;

  ui.stateRing.textContent = s;
  ui.stateRing.style.background = STATE_COLORS[s].bg;

  renderHistory(state.history);
  renderProbs(state.probabilities);

  const r = riskFromPolicyState(s);
  ui.riskLevel.textContent = r.lvl;
  ui.riskCard.style.background = r.bg;
  ui.riskCard.style.borderColor = r.border;

  ui.smoothedState.textContent = `S${s}`;
  ui.rawStateFooter.textContent = `S${raw}`;
  ui.hystHoldFooter.textContent = String(state.holdTicks);
}

function countdown(ts){
  const now = Date.now();
  const d = ts - now;
  if (d <= 0) return "Now";
  const mins = Math.floor(d/60000);
  const h = Math.floor(mins/60);
  const m = mins % 60;
  const days = Math.floor(h/24);
  const hh = h % 24;
  if (days > 0) return `${days}d ${hh}h`;
  return `${hh}h ${m}m`;
}

function renderCalendar(items){
  ui.calBody.innerHTML = "";
  items.slice(0,30).forEach(ev => {
    const tr = document.createElement("tr");
    const impact = (ev.impact || "").toUpperCase();
    const isHigh = impact === "HIGH" || impact === "RED";
    const tag = isHigh
      ? `<span class="impact"><span class="folder red"></span>HIGH</span>`
      : (impact === "MED" || impact === "MEDIUM")
        ? `<span class="impact"><span class="folder"></span>MED</span>`
        : `<span class="impact"><span class="folder" style="background:rgba(96,165,250,.8)"></span>LOW</span>`;
    tr.innerHTML = `
      <td>${fmtDateTime(new Date(ev.time))}</td>
      <td>${ev.title || ""}</td>
      <td>${tag}</td>
      <td>${countdown(new Date(ev.time).getTime())}</td>
    `;
    ui.calBody.appendChild(tr);
  });
}

function renderHeadlines(items){
  ui.newsBody.innerHTML = "";
  items.slice(0,40).forEach(n => {
    const tr = document.createElement("tr");
    const url = n.url || "#";
    tr.innerHTML = `
      <td>${fmtTime(new Date(n.time))}</td>
      <td>${n.source || ""}</td>
      <td><a href="${url}" target="_blank" rel="noopener noreferrer" style="color:#93c5fd; text-decoration:none">${(n.title||"").replaceAll("<","&lt;")}</a></td>
    `;
    ui.newsBody.appendChild(tr);
  });
}

async function fetchJSON(url){
  const t0 = performance.now();
  const res = await fetch(url, {cache:"no-store"});
  const ms = Math.round(performance.now() - t0);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  return {data, ms};
}

/**
 * HARD RULES:
 * - No simulation.
 * - If the quote feed is stale, mark it and do not advance the regime engine.
 */
let lastPx = null;
let lastGoodTs = null;
let stalePolls = 0;

function isStale(newPx){
  if (lastPx === null) return false;
  const delta = Math.abs(newPx - lastPx);
  // if the exact same px repeats too many times, assume provider is stalled
  if (delta < 0.0000001) stalePolls++;
  else stalePolls = 0;
  return stalePolls >= 8; // ~8 seconds if polling at 1s
}

// Local fallback view if backend does NOT provide /api/state.
// This is NOT a quant model. It is a demo policy controller based on simple features.
// You will replace it with the real regime engine backend later.
function naiveRegimeFromFeatures(f){
  // f: {volx, mom}
  // low vol and low mom => S1
  if (f.volx < 0.7 && Math.abs(f.mom) < 0.06) return 1;
  if (f.volx < 0.9 && Math.abs(f.mom) < 0.10) return 2;
  if (f.volx < 1.1 && Math.abs(f.mom) < 0.18) return 3;
  if (f.volx < 1.4 && Math.abs(f.mom) < 0.30) return 4;
  if (f.volx < 1.8 && Math.abs(f.mom) < 0.45) return 5;
  if (f.volx < 2.3) return 6;
  if (f.volx < 3.2) return 7;
  return 8;
}

// hysteresis: requires N consecutive ticks to switch policy state
let policyState = 1;
let rawState = 1;
let holdTicks = 0;
const HOLD_N = 10;
let history = [1,1,1,2,1,1,1,3,3,3,1,1];

function probsFromState(s){
  // a simple “soft” distribution centered on s
  const out = {};
  let sum = 0;
  for (let i=1;i<=8;i++){
    const d = Math.abs(i-s);
    const w = Math.exp(-0.9*d);
    out[i] = w; sum += w;
  }
  for (let i=1;i<=8;i++) out[i] = (out[i]/sum)*100;
  return out;
}

function computeFeatures(pxSeries){
  // pxSeries: array of recent prices
  if (pxSeries.length < 10) return {volx:1.0, mom:0.0};
  const rets = [];
  for (let i=1;i<pxSeries.length;i++){
    rets.push((pxSeries[i]-pxSeries[i-1]) * 10000); // pips-ish
  }
  const mean = rets.reduce((a,b)=>a+b,0)/rets.length;
  const varr = rets.reduce((a,b)=>a+(b-mean)*(b-mean),0)/Math.max(1,rets.length-1);
  const stdev = Math.sqrt(varr);
  const mom = rets.slice(-5).reduce((a,b)=>a+b,0); // last 5 steps
  // normalize "volx" relative to a small baseline
  const volx = clamp(stdev / 0.8, 0.2, 6.0);
  return {volx, mom};
}

const pxWindow = [];
const PX_WIN = 120; // 2 minutes at 1s

function updateLocalEngine(px, nowStr, feedSource, feedStatus){
  pxWindow.push(px);
  while (pxWindow.length > PX_WIN) pxWindow.shift();

  const f = computeFeatures(pxWindow);
  rawState = naiveRegimeFromFeatures(f);

  if (rawState !== policyState) holdTicks++;
  else holdTicks = 0;

  let hystStatus = "stable";
  if (rawState !== policyState) hystStatus = "holding";
  if (holdTicks >= HOLD_N){
    policyState = rawState;
    holdTicks = 0;
    history.push(policyState);
    history = history.slice(-12);
    hystStatus = "switch";
  }

  const probs = probsFromState(rawState);
  const conf = clamp((probs[policyState] / 100), 0.5, 0.92);

  setPolicyUI({
    policyState,
    rawState,
    confidence: conf,
    hysteresisStatus: hystStatus,
    holdTicks,
    lastCalc: nowStr,
    history,
    probabilities: probs,
  });

  addLogRow({
    time: nowStr,
    px: px.toFixed(5),
    detector: `S${rawState}`,
    policy: `S${policyState}`,
    conf: `${(conf*100).toFixed(1)}%`,
    volx: f.volx.toFixed(2),
    mom: `${f.mom.toFixed(2)}bp`,
    feed: feedSource,
    status: feedStatus,
  });

  saveStored({
    policyState, rawState, holdTicks, history, probs, conf, lastPx: px, lastGoodTs
  });
}

async function pollQuote(){
  if (!isLive) return;

  if (!BACKEND_BASE_URL){
    setFeedBadge("ERROR");
    ui.feedMeta.textContent = "Source: -- • Latency: --";
    ui.feedHelp.innerHTML = `<span class="badText"><b>BACKEND_BASE_URL is not set.</b></span> This UI refuses to simulate. Set your backend URL.`;
    return;
  }

  try{
    const {data, ms} = await fetchJSON(ENDPOINTS.quote());
    // expected: { price: number, ts: epochMs, source: "provider", status: "LIVE|STALE", bid, ask }
    const px = Number(data.price);
    const ts = Number(data.ts || Date.now());
    const src = data.source || "backend";
    const providerStatus = (data.status || "LIVE").toUpperCase();

    ui.lastUpdate.textContent = fmtTime(new Date());
    const nowStr = fmtTime(new Date(ts));

    ui.spotPx.textContent = isFinite(px) ? px.toFixed(5) : "--";
    ui.spotMeta.textContent = `Last good sample: ${nowStr}`;
    ui.feedMeta.textContent = `Source: ${src} • Latency: ${ms}ms`;

    if (!isFinite(px)){
      setFeedBadge("ERROR");
      ui.feedHelp.innerHTML = `<span class="badText"><b>Bad quote payload.</b></span> Backend returned no numeric price.`;
      return;
    }

    const stale = isStale(px) || providerStatus === "STALE";
    if (stale){
      setFeedBadge("STALE");
      ui.feedHelp.innerHTML = `<span class="warnText"><b>STALE feed.</b></span> Regime engine paused to avoid fake flips. Fix quote source or rate limits.`;
      // do not update engine
      return;
    }

    setFeedBadge("LIVE");
    lastPx = px;
    lastGoodTs = ts;

    tick++;
    updateLocalEngine(px, nowStr, src, "LIVE");
  }catch(err){
    setFeedBadge("ERROR");
    ui.feedHelp.innerHTML = `<span class="badText"><b>Quote fetch failed.</b></span> ${String(err.message || err)}`;
  }
}

async function pollCalendar(){
  if (!BACKEND_BASE_URL) return;
  try{
    const {data} = await fetchJSON(ENDPOINTS.calendar());
    // expected: { items: [{time, title, impact, ccy}] }
    renderCalendar(data.items || []);
  }catch(err){
    ui.calBody.innerHTML = `<tr><td colspan="4" class="badText">Calendar fetch failed: ${String(err.message || err)}</td></tr>`;
  }
}

async function pollHeadlines(){
  if (!BACKEND_BASE_URL) return;
  try{
    const {data} = await fetchJSON(ENDPOINTS.headlines());
    // expected: { items: [{time, source, title, url}] }
    renderHeadlines(data.items || []);
  }catch(err){
    ui.newsBody.innerHTML = `<tr><td colspan="3" class="badText">Headlines fetch failed: ${String(err.message || err)}</td></tr>`;
  }
}

async function hardSync(){
  // pulls everything now and restores view from storage immediately
  const stored = loadStored();
  if (stored){
    policyState = stored.policyState ?? policyState;
    rawState = stored.rawState ?? rawState;
    holdTicks = stored.holdTicks ?? holdTicks;
    history = stored.history ?? history;
    lastPx = stored.lastPx ?? lastPx;
    lastGoodTs = stored.lastGoodTs ?? lastGoodTs;
    renderHistory(history);
    renderProbs(stored.probs || probsFromState(rawState));
    setPolicyUI({
      policyState,
      rawState,
      confidence: stored.conf ?? 0.8,
      hysteresisStatus: "restored",
      holdTicks,
      lastCalc: fmtTime(new Date()),
      history,
      probabilities: stored.probs || probsFromState(rawState),
    });
  }
  await Promise.all([pollQuote(), pollCalendar(), pollHeadlines()]);
}

(function init(){
  setLiveUI();
  setFeedBadge("CHECKING");

  const stored = loadStored();
  if (stored){
    policyState = stored.policyState ?? policyState;
    rawState = stored.rawState ?? rawState;
    holdTicks = stored.holdTicks ?? holdTicks;
    history = stored.history ?? history;
    renderHistory(history);
    renderProbs(stored.probs || probsFromState(rawState));
    setPolicyUI({
      policyState,
      rawState,
      confidence: stored.conf ?? 0.8,
      hysteresisStatus: "restored",
      holdTicks,
      lastCalc: fmtTime(new Date()),
      history,
      probabilities: stored.probs || probsFromState(rawState),
    });
    if (stored.lastPx) ui.spotPx.textContent = Number(stored.lastPx).toFixed(5);
    if (stored.lastGoodTs) ui.spotMeta.textContent = `Last good sample: ${fmtTime(new Date(stored.lastGoodTs))}`;
  }

  // Quote poll every 1s (still not "ticks" unless backend streams ticks and caches latest tick)
  setInterval(pollQuote, 1000);

  // Calendar and headlines can be slower
  pollCalendar(); pollHeadlines();
  setInterval(pollCalendar, 60_000);
  setInterval(pollHeadlines, 15_000);

  hardSync();
})();
</script>
</body>
</html>

