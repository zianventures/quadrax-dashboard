<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>QuadraX Risk Dashboard</title>

  <style>
    :root{
      --bg0:#040816;
      --bg1:#07122f;
      --bg2:#0b1a42;

      --card: rgba(10, 25, 60, 0.55);
      --card2: rgba(12, 34, 84, 0.42);

      --stroke: rgba(140, 185, 255, 0.22);
      --stroke2: rgba(140, 185, 255, 0.12);

      --text:#e9f0ff;
      --muted: rgba(233,240,255,0.72);
      --muted2: rgba(233,240,255,0.55);

      --blue:#2b6cff;
      --green:#18d18a;
      --amber:#ffb020;
      --red:#ff4d4d;
      --pink:#ff3aa5;
      --violet:#a078ff;

      --shadow: 0 18px 55px rgba(0,0,0,0.55);
      --shadow2: 0 10px 30px rgba(0,0,0,0.45);

      --radius: 22px;
      --radius2: 16px;
      --pad: 18px;
      --pad2: 14px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 18% 18%, rgba(80,140,255,0.24), transparent 55%),
        radial-gradient(900px 600px at 72% 30%, rgba(22,210,170,0.16), transparent 55%),
        radial-gradient(900px 700px at 40% 86%, rgba(255,80,180,0.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1440px;
      margin: 22px auto 44px;
      padding: 0 16px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding: 18px 18px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(50,115,255,0.55), rgba(35,85,200,0.42));
      border: 1px solid rgba(210,230,255,0.18);
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 14px;
      min-width: 300px;
    }

    .qxlogo{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      font-weight: 1000;
      letter-spacing: 0.4px;
      background: rgba(10,25,60,0.45);
      border: 1px solid rgba(210,230,255,0.18);
      box-shadow: var(--shadow2);
    }

    .brand h1{
      margin:0;
      font-size: 18px;
      line-height: 1.1;
      letter-spacing: 0.2px;
    }
    .brand .sub{
      margin-top: 3px;
      font-size: 12px;
      color: rgba(255,255,255,0.8);
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(10,25,60,0.35);
      border:1px solid rgba(210,230,255,0.16);
      color: rgba(255,255,255,0.92);
      font-size: 12px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.25);
      white-space:nowrap;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--green);
      box-shadow: 0 0 0 4px rgba(24,209,138,0.18);
    }

    .btn{
      cursor:pointer;
      border: 1px solid rgba(210,230,255,0.18);
      background: rgba(10,25,60,0.35);
      color: rgba(255,255,255,0.92);
      border-radius: 999px;
      padding: 9px 14px;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: 0.2px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.25);
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.06); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: rgba(35,120,255,0.35);
      border-color: rgba(120,170,255,0.26);
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 2.2fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
    }

    .stack{ display:grid; gap: 16px; }

    .card{
      background: linear-gradient(180deg, rgba(10,25,60,0.58), rgba(7,12,30,0.36));
      border:1px solid rgba(210,230,255,0.16);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
    }
    .card .inner{ padding: var(--pad); }

    .card-title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }
    .card-title h2{
      margin:0;
      font-size: 13px;
      color: rgba(255,255,255,0.82);
      letter-spacing: 0.9px;
      text-transform: uppercase;
    }
    .card-title .hint{
      font-size: 12px;
      color: rgba(255,255,255,0.55);
      text-align:right;
      max-width: 420px;
    }

    /* HERO Current Market State */
    .hero{
      position:relative;
      padding: 18px;
      border-radius: var(--radius);
      background:
        radial-gradient(900px 420px at 30% 20%, rgba(120,170,255,0.20), transparent 60%),
        radial-gradient(780px 420px at 80% 65%, rgba(24,209,138,0.10), transparent 60%),
        linear-gradient(180deg, rgba(8,18,42,0.60), rgba(5,10,24,0.28));
      border: 1px solid rgba(210,230,255,0.14);
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(420px 240px at 18% 30%, rgba(255,58,165,0.06), transparent 60%),
        radial-gradient(520px 260px at 70% 10%, rgba(255,176,32,0.05), transparent 60%);
      pointer-events:none;
    }
    .heroGrid{
      display:grid;
      grid-template-columns: 1.7fr 0.9fr;
      gap: 14px;
      align-items: stretch;
      position:relative;
      z-index:1;
    }
    @media (max-width: 900px){
      .heroGrid{ grid-template-columns: 1fr; }
    }

    .heroTitle{
      font-size: 42px;
      font-weight: 1100;
      letter-spacing: 0.2px;
      margin: 4px 0 6px;
      line-height: 1.08;
      text-shadow: 0 12px 42px rgba(0,0,0,0.45);
    }
    .heroSub{ color: var(--muted); font-size: 13px; max-width: 740px; }

    .chips{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 12px;
      align-items:center;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,0.9);
      background: rgba(10,25,60,0.30);
      border: 1px solid rgba(210,230,255,0.14);
      white-space:nowrap;
    }
    .chip b{ font-weight: 950; font-variant-numeric: tabular-nums; }
    .chip.kpi{
      background: rgba(10,25,60,0.40);
      border-color: rgba(120,170,255,0.22);
    }

    /* Quote box (fixed readability) */
    .quoteCard{
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(10,25,60,0.40), rgba(6,10,24,0.20));
      border:1px solid rgba(210,230,255,0.14);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      padding: 14px 14px 12px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height: 172px;
    }
    .quoteTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .quotePair{
      font-size: 12px;
      color: rgba(255,255,255,0.82);
      letter-spacing: 0.6px;
      text-transform: uppercase;
      font-weight: 900;
    }
    .quoteSrc{
      font-size: 11px;
      color: rgba(255,255,255,0.55);
      text-align:right;
    }
    .quotePx{
      margin-top: 10px;
      font-size: 34px;
      font-weight: 1100;
      letter-spacing: 0.2px;
      font-variant-numeric: tabular-nums;
      line-height: 1;
    }
    .quoteDeltaRow{
      margin-top: 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color: rgba(255,255,255,0.65);
      font-size: 12px;
      font-variant-numeric: tabular-nums;
    }
    .quoteBar{
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
      margin-top: 10px;
    }
    .quoteBar > i{
      display:block;
      height:100%;
      width: 18%;
      background: rgba(24,209,138,0.85);
      border-radius: 999px;
    }
    .quoteBadge{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(210,230,255,0.14);
      background: rgba(10,25,60,0.26);
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,0.9);
      white-space:nowrap;
    }
    .sdot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--amber);
      box-shadow: 0 0 0 4px rgba(255,176,32,0.18);
    }
    .sdot.live{ background: var(--green); box-shadow: 0 0 0 4px rgba(24,209,138,0.18); }
    .sdot.err{ background: var(--red); box-shadow: 0 0 0 4px rgba(255,77,77,0.18); }

    /* Risk level card */
    .riskLevel{
      text-align:center;
      padding: 22px 16px 14px;
    }
    .riskLevel .label{
      font-size: 12px;
      letter-spacing: 0.9px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.72);
    }
    .riskLevel .big{
      font-size: 42px;
      font-weight: 1100;
      margin: 6px 0 2px;
      letter-spacing: 0.2px;
    }
    .riskLevel .rule{
      font-size: 12px;
      color: rgba(255,255,255,0.68);
      max-width: 320px;
      margin: 0 auto;
    }

    /* Probabilities compact inside hero */
    .probCompact{
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid rgba(210,230,255,0.10);
    }
    .probRow{
      display:grid;
      grid-template-columns: 210px 1fr 68px;
      gap: 10px;
      align-items:center;
      padding: 8px 0;
      border-top: 1px solid rgba(210,230,255,0.06);
    }
    .probRow:first-child{ border-top:none; }
    .probName{
      font-size: 12px;
      color: rgba(255,255,255,0.88);
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .pdot{
      width: 14px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      flex: 0 0 auto;
    }
    .pbar{
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
      position:relative;
    }
    .pbar > i{
      display:block;
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: rgba(120,170,255,0.8);
    }
    .probVal{
      font-size: 12px;
      color: rgba(255,255,255,0.78);
      text-align:right;
      font-variant-numeric: tabular-nums;
    }

    /* Macro drivers */
    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 540px){
      .kpiGrid{ grid-template-columns: 1fr; }
    }
    .kpi{
      border-radius: 18px;
      background: rgba(10,25,60,0.25);
      border:1px solid rgba(210,230,255,0.12);
      padding: 14px;
      min-height: 112px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .kpi .k{ font-size: 12px; color: rgba(255,255,255,0.70); }
    .kpi .v{
      margin-top: 8px;
      font-size: 26px;
      font-weight: 1100;
      letter-spacing: 0.2px;
      font-variant-numeric: tabular-nums;
    }
    .kpi .m{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(255,255,255,0.62);
      line-height: 1.35;
      font-variant-numeric: tabular-nums;
    }
    .pos{ color: rgba(24,209,138,0.95); }
    .neg{ color: rgba(255,77,77,0.95); }

    /* Forward projection */
    .projTop{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    @media (max-width: 900px){
      .projTop{ grid-template-columns: 1fr 1fr; }
    }
    .projBox{
      border-radius: 18px;
      background: rgba(10,25,60,0.25);
      border:1px solid rgba(210,230,255,0.12);
      padding: 14px;
      min-height: 88px;
    }
    .projBox .k{ font-size: 12px; color: rgba(255,255,255,0.66); }
    .projBox .v{
      margin-top: 8px;
      font-size: 22px;
      font-weight: 1100;
      letter-spacing: 0.2px;
      font-variant-numeric: tabular-nums;
    }
    .projBox .m{ margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.60); }

    .canvasWrap{
      border-radius: 18px;
      background: rgba(10,25,60,0.20);
      border:1px solid rgba(210,230,255,0.12);
      overflow:hidden;
      position:relative;
    }
    canvas{ display:block; width:100%; height: 280px; }
    .canvasNote{
      padding: 10px 2px 0;
      color: rgba(255,255,255,0.58);
      font-size: 12px;
    }

    /* Tables */
    .tableWrap{
      border-radius: 18px;
      background: rgba(10,25,60,0.20);
      border:1px solid rgba(210,230,255,0.12);
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size: 12px;
    }
    thead th{
      text-align:left;
      padding: 12px 12px;
      color: rgba(255,255,255,0.78);
      border-bottom: 1px solid rgba(210,230,255,0.10);
      background: rgba(10,25,60,0.22);
      font-weight: 950;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      font-size: 11px;
    }
    tbody td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(210,230,255,0.06);
      color: rgba(255,255,255,0.82);
      vertical-align:top;
      font-variant-numeric: tabular-nums;
    }
    tbody tr:hover{ background: rgba(255,255,255,0.04); }
    .scroll{
      max-height: 300px;
      overflow:auto;
    }
    .link{
      color: rgba(120,170,255,0.95);
      text-decoration:none;
      font-weight: 850;
    }
    .link:hover{ text-decoration:underline; }

    /* Impact pills */
    .impact{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(210,230,255,0.14);
      background: rgba(10,25,60,0.22);
      font-weight: 950;
      color: rgba(255,255,255,0.88);
      white-space:nowrap;
    }
    .folder{
      width: 10px;
      height: 10px;
      border-radius: 3px;
      background: var(--pink);
      box-shadow: 0 0 0 4px rgba(255,58,165,0.14);
    }
    .folder.med{ background: var(--amber); box-shadow: 0 0 0 4px rgba(255,176,32,0.14); }
    .folder.low{ background: rgba(255,255,255,0.30); box-shadow: none; }

    /* TradingView card */
    .tvWrap{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(210,230,255,0.12);
      background: rgba(10,25,60,0.20);
    }
    .tvWrap iframe{
      width:100%;
      height: 380px;
      border:0;
      display:block;
    }

    /* Footer */
    .foot{
      margin-top: 14px;
      display:flex;
      justify-content:space-between;
      color: rgba(255,255,255,0.5);
      font-size: 12px;
      padding: 0 6px;
      gap:12px;
      flex-wrap:wrap;
    }

    /* Modal */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 999;
      padding: 18px;
    }
    .modal{
      width:min(920px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(12,34,84,0.94), rgba(6,10,24,0.90));
      border: 1px solid rgba(210,230,255,0.18);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(210,230,255,0.12);
    }
    .modalHead h3{
      margin:0;
      font-size: 14px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.86);
    }
    .modalBody{
      padding: 16px 18px 18px;
      display:grid;
      gap: 14px;
    }
    textarea, input[type="text"]{
      width:100%;
      resize: vertical;
      border-radius: 16px;
      border: 1px solid rgba(210,230,255,0.18);
      background: rgba(10,25,60,0.35);
      color: rgba(255,255,255,0.9);
      padding: 12px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      outline:none;
      box-sizing: border-box;
    }
    textarea{ min-height: 160px; }
    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 800px){
      .row2{ grid-template-columns: 1fr; }
    }
    .help{
      font-size: 12px;
      color: rgba(255,255,255,0.62);
      line-height: 1.35;
    }
    .danger{
      color: rgba(255,77,77,0.90);
      font-weight: 900;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="qxlogo">QX</div>
        <div>
          <h1>QuadraX Risk Dashboard</h1>
          <div class="sub">Executive View: 8-State Monitoring and Control System (EUR/USD + Macro Transmission)</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill"><span class="dot" id="liveDot"></span><span id="liveText">LIVE</span></div>
        <div class="pill">Last Update <b id="lastUpdate">--:--:--</b></div>
        <button class="btn" id="pauseBtn">Pause</button>
        <button class="btn primary" id="syncBtn">Sync</button>
        <button class="btn" id="settingsBtn">Settings</button>
        <button class="btn" id="editBtn">Edit Events + Headlines</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="stack">

        <!-- HERO: Current market state -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Current Market State</h2>
              <div class="hint">This demo never fabricates price. For true live FX, set a quote API key in Settings.</div>
            </div>

            <div class="hero">
              <div class="heroGrid">
                <div>
                  <div class="heroTitle" id="policyStateTitle">Policy State: --</div>
                  <div class="heroSub" id="policyStateDesc">Waiting for market data sample.</div>

                  <div class="chips">
                    <div class="chip">Detector <b id="detectorChip">--</b></div>
                    <div class="chip">Policy <b id="policyChip">--</b></div>
                    <div class="chip kpi">Confidence <b id="confChip">--</b></div>
                    <div class="chip">Hysteresis <b id="hystChip">--</b></div>
                    <div class="chip">Tick <b id="tickChip">0</b></div>
                    <div class="chip">Stale <b id="staleChip">0</b></div>
                    <div class="chip kpi">Macro Bias <b id="macroBiasChip">--</b></div>
                    <div class="chip kpi">Event Risk <b id="eventRiskChip">--</b></div>
                  </div>

                  <div class="probCompact" id="probList"></div>

                  <div class="canvasNote" id="heroNote">
                    Premium look, yes. Premium data, only if you feed it premium data. Humans hate that part.
                  </div>
                </div>

                <div class="quoteCard">
                  <div>
                    <div class="quoteTop">
                      <div>
                        <div class="quotePair">EURUSD</div>
                        <div class="quoteSrc" id="miniSrc">Provider: --</div>
                      </div>
                      <div class="tag" title="Quote health"><span class="sdot" id="fxStatusDot"></span><span id="fxSpotStatus">CHECKING</span></div>
                    </div>

                    <div class="quotePx" id="miniPrice">--</div>

                    <div class="quoteDeltaRow">
                      <div>Δ</div>
                      <div id="miniDelta">0.00000</div>
                    </div>

                    <div class="quoteBar"><i id="miniBar"></i></div>

                    <div class="quoteBadge">
                      <div class="tag" title="Latency"><span style="opacity:.7">⏱</span><span id="miniLatency">--</span></div>
                      <div class="tag" title="Mode"><span style="opacity:.7">⚙</span><span id="miniMode">--</span></div>
                    </div>
                  </div>

                  <div class="help" id="quoteDisclaimer" style="margin-top:10px;">
                    If you see “REFERENCE”, your provider is not streaming. Set TwelveData key to get real intraday updates.
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>

        <!-- Forward Projection -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Forward Projection</h2>
              <div class="hint">Projection cone based on regime volatility + macro transmission + event proximity.</div>
            </div>

            <div class="projTop">
              <div class="projBox">
                <div class="k">Trade Bias</div>
                <div class="v" id="tradeBias">--</div>
                <div class="m" id="tradeBiasMeta">Macro + regime blend</div>
              </div>
              <div class="projBox">
                <div class="k">Move Range (1h)</div>
                <div class="v" id="range1h">--</div>
                <div class="m" id="range1hMeta">Regime scaled</div>
              </div>
              <div class="projBox">
                <div class="k">Move Range (4h)</div>
                <div class="v" id="range4h">--</div>
                <div class="m" id="range4hMeta">Event and macro weighted</div>
              </div>
              <div class="projBox">
                <div class="k">Decision Confidence</div>
                <div class="v" id="decisionConf">--</div>
                <div class="m" id="decisionConfMeta">Agreement between signals</div>
              </div>
            </div>

            <div class="canvasWrap">
              <canvas id="cone"></canvas>
            </div>
            <div class="canvasNote" id="coneNote">
              Cone reflects a probabilistic range, not a promise. If anyone confuses this for certainty, remove their trading permissions.
            </div>
          </div>
        </div>

        <!-- Regime Log -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Regime Log</h2>
              <div class="hint">CSV-style telemetry (latest on top)</div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
              <button class="btn" id="copyCsvBtn">Copy as CSV</button>
              <button class="btn" id="clearLogBtn">Clear</button>
            </div>

            <div class="tableWrap">
              <div class="scroll" style="max-height: 320px;">
                <table>
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>EURUSD</th>
                      <th>DET</th>
                      <th>POL</th>
                      <th>CONF</th>
                      <th>VOL X</th>
                      <th>MOM (bp)</th>
                      <th>MACRO</th>
                      <th>EVENT</th>
                      <th>SRC</th>
                    </tr>
                  </thead>
                  <tbody id="logBody"></tbody>
                </table>
              </div>
            </div>

            <div class="help" style="margin-top:10px;">
              Tip: Copy CSV and paste into Excel. It splits cleanly. Your coworkers will be impressed by basic clipboard functionality.
            </div>
          </div>
        </div>

        <div class="foot">
          <div>System Status: <b id="sysStatus">LIVE</b></div>
          <div>Smoothed Policy: <b id="footPolicy">--</b></div>
          <div>Detector: <b id="footDetector">--</b></div>
          <div>Transmission: <b id="footTx">--</b></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="stack">

        <!-- Risk -->
        <div class="card">
          <div class="inner riskLevel">
            <div class="label">Risk Level</div>
            <div class="big" id="riskBig">--</div>
            <div class="rule" id="riskRule">Policy: state-aware sizing and entry gating</div>
          </div>
        </div>

        <!-- Macro Drivers -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Macro Drivers</h2>
              <div class="hint">Oil, metals, DXY proxies. Daily data via Stooq. Works on GitHub Pages without keys.</div>
            </div>

            <div class="kpiGrid">
              <div class="kpi">
                <div class="k">Brent (proxy)</div>
                <div class="v" id="brentV">--</div>
                <div class="m" id="brentM">--</div>
              </div>
              <div class="kpi">
                <div class="k">WTI (proxy)</div>
                <div class="v" id="wtiV">--</div>
                <div class="m" id="wtiM">--</div>
              </div>
              <div class="kpi">
                <div class="k">Gold (proxy)</div>
                <div class="v" id="goldV">--</div>
                <div class="m" id="goldM">--</div>
              </div>
              <div class="kpi">
                <div class="k">Silver (proxy)</div>
                <div class="v" id="silverV">--</div>
                <div class="m" id="silverM">--</div>
              </div>
              <div class="kpi">
                <div class="k">USD Index (DXY proxy)</div>
                <div class="v" id="dxyV">--</div>
                <div class="m" id="dxyM">--</div>
              </div>
              <div class="kpi">
                <div class="k">Transmission Score</div>
                <div class="v" id="txV">--</div>
                <div class="m" id="txM">--</div>
              </div>
            </div>

            <div class="help" style="margin-top:10px;">
              In production: replace proxies with broker feed + learned mapping from macro to expected pip distribution.
            </div>
          </div>
        </div>

        <!-- Transmission Mechanism -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Transmission Mechanism</h2>
              <div class="hint">Three levers that typically move EURUSD around conflict and commodity shocks.</div>
            </div>

            <div class="kpiGrid">
              <div class="kpi">
                <div class="k">Oil Lever (EU terms of trade)</div>
                <div class="v" id="oilLeverV">0%</div>
                <div class="m" id="oilLeverM">Derived from Brent and WTI moves</div>
              </div>
              <div class="kpi">
                <div class="k">Dollar Lever (DXY pressure)</div>
                <div class="v" id="dollarLeverV">0%</div>
                <div class="m" id="dollarLeverM">Derived from USD index proxy</div>
              </div>
              <div class="kpi">
                <div class="k">Fear Lever (gold risk-off)</div>
                <div class="v" id="fearLeverV">0%</div>
                <div class="m" id="fearLeverM">Derived from gold and silver tone</div>
              </div>
              <div class="kpi">
                <div class="k">Event Risk (calendar proximity)</div>
                <div class="v" id="eventLeverV">0%</div>
                <div class="m" id="eventLeverM">Higher when high-impact events are near</div>
              </div>
            </div>

            <div class="help" style="margin-top:10px;">
              This is a demo mapping. The production version should learn weights from history and update per regime.
            </div>
          </div>
        </div>

        <!-- World events -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>World Events Calendar</h2>
              <div class="hint">Curated list saved locally for demo. Countdown updates automatically.</div>
            </div>
            <div class="tableWrap">
              <div class="scroll" style="max-height: 260px;">
                <table>
                  <thead>
                    <tr>
                      <th>When</th>
                      <th>Event</th>
                      <th>Impact</th>
                      <th>Countdown</th>
                    </tr>
                  </thead>
                  <tbody id="eventsBody"></tbody>
                </table>
              </div>
            </div>
            <div class="help" style="margin-top:10px;">
              High impact events are <span class="impact"><span class="folder"></span>HIGH</span>.
            </div>
          </div>
        </div>

        <!-- Headlines -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Headlines</h2>
              <div class="hint">Curated list saved locally. You can swap to a live news API later.</div>
            </div>

            <div class="tableWrap">
              <div class="scroll" style="max-height: 240px;">
                <table>
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>Source</th>
                      <th>Headline</th>
                    </tr>
                  </thead>
                  <tbody id="headlinesBody"></tbody>
                </table>
              </div>
            </div>

            <div class="help" style="margin-top:10px;">
              Click opens source in a new tab. Humans love clicking things.
            </div>
          </div>
        </div>

        <!-- TradingView chart -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>EUR/USD Live Chart</h2>
              <div class="hint">TradingView embed is live visually. We do not scrape it.</div>
            </div>

            <div class="tvWrap">
              <iframe
                title="TradingView EURUSD"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                src="https://s.tradingview.com/widgetembed/?frameElementId=tvchart&symbol=FX%3AEURUSD&interval=15&hidesidetoolbar=1&symboledit=0&saveimage=0&toolbarbg=0b1028&studies=%5B%5D&hideideas=1&theme=dark&style=1&locale=en&withdateranges=1&hidevolume=0&allow_symbol_change=0&details=0&hotlist=0&calendar=0"
              ></iframe>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal: edit events + headlines -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <h3>Edit World Events + Headlines</h3>
        <button class="btn" id="closeModalBtn">Close</button>
      </div>
      <div class="modalBody">
        <div class="help">
          Curated demo mode: save lists locally so each viewer has consistent content.
          Production mode: swap to a backend feed and stop trusting humans to type JSON.
        </div>

        <div class="row2">
          <div>
            <div class="help" style="margin-bottom:8px;"><b>Events JSON</b> (array of objects: when, event, impact: HIGH|MED|LOW)</div>
            <textarea id="eventsEditor"></textarea>
          </div>
          <div>
            <div class="help" style="margin-bottom:8px;"><b>Headlines JSON</b> (array of objects: time, source, title, url)</div>
            <textarea id="headlinesEditor"></textarea>
          </div>
        </div>

        <div class="modalActions">
          <button class="btn" id="resetCuratedBtn">Reset defaults</button>
          <button class="btn primary" id="saveCuratedBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Settings -->
  <div class="modalBack" id="settingsBack">
    <div class="modal">
      <div class="modalHead">
        <h3>Settings</h3>
        <button class="btn" id="closeSettingsBtn">Close</button>
      </div>
      <div class="modalBody">
        <div class="help">
          Your EURUSD is stuck because most free endpoints update slowly. If you want intraday updates without building a backend, set a quote API key.
          Recommended for demo: <b>TwelveData</b>.
        </div>

        <div class="row2">
          <div>
            <div class="help" style="margin-bottom:8px;"><b>TwelveData API Key</b> (optional)</div>
            <input type="text" id="twelveKey" placeholder="Paste key here (stored locally in your browser)" />
            <div class="help" style="margin-top:8px;">
              If empty, dashboard falls back to slow “reference” providers. That is why it looks frozen.
            </div>
          </div>
          <div>
            <div class="help" style="margin-bottom:8px;"><b>Quote Update Interval</b> (seconds)</div>
            <input type="text" id="pollSeconds" placeholder="12" />
            <div class="help" style="margin-top:8px;">
              Lower is not always better. Free APIs throttle. Your patience is also a rate limit.
            </div>
          </div>
        </div>

        <div class="help">
          <span class="danger">Reality check:</span> If you want tick-grade pricing, you need a broker feed. This demo proves UI, logic, and integration points.
        </div>

        <div class="modalActions">
          <button class="btn" id="resetSettingsBtn">Reset</button>
          <button class="btn primary" id="saveSettingsBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  /* ============================================================
     QuadraX Risk Dashboard (Demo-Grade, Production-Ready Structure)
     - Quote Provider chain with real intraday option (TwelveData)
     - Macro proxies (Oil, Metals, DXY) via Stooq daily data
     - Transmission score => pip range projection cone
     - Regime engine drives probabilities and risk mapping
     - Curated Events + Headlines editable and persisted
  ============================================================ */

  // ---------- Utilities ----------
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const fmtTime = (ms) => new Date(ms).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
  const safeNum = (x, fallback=null) => (Number.isFinite(Number(x)) ? Number(x) : fallback);
  const bp = (x)=> x * 10000; // price diff to basis points

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function escapeAttr(s){ return String(s).replace(/"/g, "&quot;"); }

  // ---------- Keys ----------
  const KEY = {
    dashboard: "qx_dashboard_state_v2",
    events: "qx_events_v1",
    headlines: "qx_headlines_v1",
    log: "qx_regime_log_v2",
    settings: "qx_settings_v1"
  };

  // ---------- Settings ----------
  const defaultSettings = {
    twelveKey: "",
    pollSeconds: 12
  };
  function loadObj(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      const o = JSON.parse(raw);
      return (o && typeof o === "object") ? {...fallback, ...o} : fallback;
    }catch(e){ return fallback; }
  }
  let settings = loadObj(KEY.settings, defaultSettings);

  // ---------- DOM ----------
  const els = {
    liveDot: document.getElementById("liveDot"),
    liveText: document.getElementById("liveText"),
    lastUpdate: document.getElementById("lastUpdate"),
    pauseBtn: document.getElementById("pauseBtn"),
    syncBtn: document.getElementById("syncBtn"),
    editBtn: document.getElementById("editBtn"),
    settingsBtn: document.getElementById("settingsBtn"),

    policyStateTitle: document.getElementById("policyStateTitle"),
    policyStateDesc: document.getElementById("policyStateDesc"),
    detectorChip: document.getElementById("detectorChip"),
    policyChip: document.getElementById("policyChip"),
    confChip: document.getElementById("confChip"),
    hystChip: document.getElementById("hystChip"),
    tickChip: document.getElementById("tickChip"),
    staleChip: document.getElementById("staleChip"),
    macroBiasChip: document.getElementById("macroBiasChip"),
    eventRiskChip: document.getElementById("eventRiskChip"),
    probList: document.getElementById("probList"),

    miniSrc: document.getElementById("miniSrc"),
    miniPrice: document.getElementById("miniPrice"),
    miniDelta: document.getElementById("miniDelta"),
    miniBar: document.getElementById("miniBar"),
    miniLatency: document.getElementById("miniLatency"),
    miniMode: document.getElementById("miniMode"),
    fxSpotStatus: document.getElementById("fxSpotStatus"),
    fxStatusDot: document.getElementById("fxStatusDot"),
    quoteDisclaimer: document.getElementById("quoteDisclaimer"),

    riskBig: document.getElementById("riskBig"),
    riskRule: document.getElementById("riskRule"),

    // Projection
    tradeBias: document.getElementById("tradeBias"),
    tradeBiasMeta: document.getElementById("tradeBiasMeta"),
    range1h: document.getElementById("range1h"),
    range1hMeta: document.getElementById("range1hMeta"),
    range4h: document.getElementById("range4h"),
    range4hMeta: document.getElementById("range4hMeta"),
    decisionConf: document.getElementById("decisionConf"),
    decisionConfMeta: document.getElementById("decisionConfMeta"),
    cone: document.getElementById("cone"),
    coneNote: document.getElementById("coneNote"),

    // Macro KPIs
    brentV: document.getElementById("brentV"),
    brentM: document.getElementById("brentM"),
    wtiV: document.getElementById("wtiV"),
    wtiM: document.getElementById("wtiM"),
    goldV: document.getElementById("goldV"),
    goldM: document.getElementById("goldM"),
    silverV: document.getElementById("silverV"),
    silverM: document.getElementById("silverM"),
    dxyV: document.getElementById("dxyV"),
    dxyM: document.getElementById("dxyM"),
    txV: document.getElementById("txV"),
    txM: document.getElementById("txM"),

    oilLeverV: document.getElementById("oilLeverV"),
    oilLeverM: document.getElementById("oilLeverM"),
    dollarLeverV: document.getElementById("dollarLeverV"),
    dollarLeverM: document.getElementById("dollarLeverM"),
    fearLeverV: document.getElementById("fearLeverV"),
    fearLeverM: document.getElementById("fearLeverM"),
    eventLeverV: document.getElementById("eventLeverV"),
    eventLeverM: document.getElementById("eventLeverM"),

    // Events + headlines
    eventsBody: document.getElementById("eventsBody"),
    headlinesBody: document.getElementById("headlinesBody"),
    modalBack: document.getElementById("modalBack"),
    closeModalBtn: document.getElementById("closeModalBtn"),
    saveCuratedBtn: document.getElementById("saveCuratedBtn"),
    resetCuratedBtn: document.getElementById("resetCuratedBtn"),
    eventsEditor: document.getElementById("eventsEditor"),
    headlinesEditor: document.getElementById("headlinesEditor"),

    // Settings modal
    settingsBack: document.getElementById("settingsBack"),
    closeSettingsBtn: document.getElementById("closeSettingsBtn"),
    twelveKey: document.getElementById("twelveKey"),
    pollSeconds: document.getElementById("pollSeconds"),
    resetSettingsBtn: document.getElementById("resetSettingsBtn"),
    saveSettingsBtn: document.getElementById("saveSettingsBtn"),

    // Log
    logBody: document.getElementById("logBody"),
    copyCsvBtn: document.getElementById("copyCsvBtn"),
    clearLogBtn: document.getElementById("clearLogBtn"),

    // Footer
    sysStatus: document.getElementById("sysStatus"),
    footPolicy: document.getElementById("footPolicy"),
    footDetector: document.getElementById("footDetector"),
    footTx: document.getElementById("footTx"),
  };

  // ---------- States ----------
  const STATES = [
    { id:1, name:"Mean-Reverting", desc:"Range-bound. Fade extremes and keep size disciplined.", color:"rgba(24,209,138,0.85)" },
    { id:2, name:"Liquidity Vacuum", desc:"Thin market, jumpy moves. Tighten risk and be selective.", color:"rgba(255,176,32,0.85)" },
    { id:3, name:"Slow Drift", desc:"Steady grind. Small edges, avoid forcing entries.", color:"rgba(120,170,255,0.85)" },
    { id:4, name:"Strong Trend", desc:"Directional. Trend-follow bias, avoid countertrend heroics.", color:"rgba(60,145,255,0.9)" },
    { id:5, name:"Stop Cascade", desc:"Fast continuation on stops. Reduce leverage, widen filters.", color:"rgba(255,138,64,0.9)" },
    { id:6, name:"News Shock", desc:"Event-driven. Consider standing down around releases.", color:"rgba(255,77,77,0.9)" },
    { id:7, name:"Dealer Unwind", desc:"Choppy reversal risk. Focus on protection and confirmation.", color:"rgba(160,120,255,0.9)" },
    { id:8, name:"Panic/Forced", desc:"Dislocation. Risk off. Protect capital first.", color:"rgba(255,58,165,0.9)" }
  ];

  // ---------- Curated defaults ----------
  const curatedEventsDefault = [
    { when: "2026-02-17T21:18:47Z", event: "Eurozone CPI (flash)", impact: "HIGH" },
    { when: "2026-02-18T17:18:47Z", event: "US Initial Jobless Claims", impact: "MED" },
    { when: "2026-02-19T21:18:47Z", event: "US GDP (advance)", impact: "HIGH" },
    { when: "2026-02-22T15:18:47Z", event: "US Non-Farm Payrolls", impact: "HIGH" }
  ];
  const curatedHeadlinesDefault = [
    { time: "03:00 PM", source: "FinancialJuice", title: "Dollar firming ahead of major data window", url: "https://financialjuice.com/" },
    { time: "02:26 PM", source: "FinancialJuice", title: "Rates repricing drives short-term USD bid", url: "https://financialjuice.com/" },
    { time: "01:06 PM", source: "Market", title: "Risk tone mixed as equities stabilize", url: "https://www.investing.com/" }
  ];

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : fallback;
    }catch(e){ return fallback; }
  }

  let curatedEvents = loadJSON(KEY.events, curatedEventsDefault);
  let curatedHeadlines = loadJSON(KEY.headlines, curatedHeadlinesDefault);

  // ---------- Events render ----------
  function impactPill(impact){
    const imp = (impact || "").toUpperCase();
    if (imp === "HIGH") return `<span class="impact"><span class="folder"></span>HIGH</span>`;
    if (imp === "MED") return `<span class="impact"><span class="folder med"></span>MED</span>`;
    return `<span class="impact"><span class="folder low"></span>LOW</span>`;
  }

  function countdownText(iso){
    const t = new Date(iso).getTime();
    const now = Date.now();
    if (!Number.isFinite(t)) return "--";
    const d = t - now;
    if (d <= 0) return "Now";
    const mins = Math.floor(d/60000);
    const days = Math.floor(mins / (60*24));
    const hrs = Math.floor((mins - days*60*24)/60);
    const rem = mins - days*60*24 - hrs*60;
    if (days > 0) return `${days}d ${hrs}h`;
    if (hrs > 0) return `${hrs}h ${rem}m`;
    return `${rem}m`;
  }

  function renderEvents(){
    const rows = curatedEvents
      .slice()
      .sort((a,b)=> new Date(a.when)-new Date(b.when))
      .map(e=>{
        const when = new Date(e.when);
        const whenStr = isNaN(when.getTime()) ? String(e.when) : `${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}`;
        return `
          <tr>
            <td>${whenStr}</td>
            <td><a class="link" href="https://www.forexfactory.com/" target="_blank" rel="noopener noreferrer">${escapeHtml(e.event || "")}</a></td>
            <td>${impactPill(e.impact)}</td>
            <td>${countdownText(e.when)}</td>
          </tr>
        `;
      }).join("");

    els.eventsBody.innerHTML = rows || `<tr><td colspan="4" style="color:rgba(255,255,255,0.6)">No events set.</td></tr>`;
  }

  function renderHeadlines(){
    const rows = curatedHeadlines.map(h=>{
      const url = h.url || "#";
      return `
        <tr>
          <td>${escapeHtml(h.time || "")}</td>
          <td>${escapeHtml(h.source || "")}</td>
          <td><a class="link" href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(h.title || "")}</a></td>
        </tr>
      `;
    }).join("");

    els.headlinesBody.innerHTML = rows || `<tr><td colspan="3" style="color:rgba(255,255,255,0.6)">No headlines set.</td></tr>`;
  }

  // ---------- Modal: edit events ----------
  function openModal(){
    els.eventsEditor.value = JSON.stringify(curatedEvents, null, 2);
    els.headlinesEditor.value = JSON.stringify(curatedHeadlines, null, 2);
    els.modalBack.style.display = "flex";
  }
  function closeModal(){ els.modalBack.style.display = "none"; }

  els.editBtn.addEventListener("click", openModal);
  els.closeModalBtn.addEventListener("click", closeModal);
  els.modalBack.addEventListener("click", (e)=>{ if (e.target === els.modalBack) closeModal(); });

  els.resetCuratedBtn.addEventListener("click", ()=>{
    curatedEvents = structuredClone(curatedEventsDefault);
    curatedHeadlines = structuredClone(curatedHeadlinesDefault);
    els.eventsEditor.value = JSON.stringify(curatedEvents, null, 2);
    els.headlinesEditor.value = JSON.stringify(curatedHeadlines, null, 2);
  });

  els.saveCuratedBtn.addEventListener("click", ()=>{
    try{
      const ev = JSON.parse(els.eventsEditor.value);
      const hd = JSON.parse(els.headlinesEditor.value);
      if (!Array.isArray(ev) || !Array.isArray(hd)) throw new Error("Not arrays");
      curatedEvents = ev;
      curatedHeadlines = hd;
      localStorage.setItem(KEY.events, JSON.stringify(curatedEvents));
      localStorage.setItem(KEY.headlines, JSON.stringify(curatedHeadlines));
      renderEvents();
      renderHeadlines();
      closeModal();
    }catch(err){
      alert("Invalid JSON. Fix formatting before saving.");
    }
  });

  // ---------- Modal: Settings ----------
  function openSettings(){
    els.twelveKey.value = settings.twelveKey || "";
    els.pollSeconds.value = String(settings.pollSeconds || 12);
    els.settingsBack.style.display = "flex";
  }
  function closeSettings(){ els.settingsBack.style.display = "none"; }

  els.settingsBtn.addEventListener("click", openSettings);
  els.closeSettingsBtn.addEventListener("click", closeSettings);
  els.settingsBack.addEventListener("click", (e)=>{ if (e.target === els.settingsBack) closeSettings(); });

  els.resetSettingsBtn.addEventListener("click", ()=>{
    settings = {...defaultSettings};
    localStorage.setItem(KEY.settings, JSON.stringify(settings));
    els.twelveKey.value = "";
    els.pollSeconds.value = String(defaultSettings.pollSeconds);
  });

  els.saveSettingsBtn.addEventListener("click", ()=>{
    const key = (els.twelveKey.value || "").trim();
    const sec = Math.max(6, Math.min(60, Number(els.pollSeconds.value || 12)));
    settings = { twelveKey: key, pollSeconds: sec };
    localStorage.setItem(KEY.settings, JSON.stringify(settings));
    closeSettings();
    hardResync("Settings saved. Syncing.");
  });

  // ---------- Quote Provider Chain ----------
  // Goal: give you real intraday if you have a key, otherwise be honest and label as REFERENCE.
  const Quote = (() => {
    const MIN_MOVE = 0.000001;
    const STALE_MS = 60_000;

    let last = {
      price: null,
      ts: 0,
      mode: "REFERENCE",
      source: null,
      latencyMs: null,
      lastChangeTs: 0,
      lastDelta: 0
    };

    function status(now = Date.now()){
      if (!last.price) return { status: "CHECKING", stale: false };
      const stale = (now - last.lastChangeTs) > STALE_MS;
      return { status: stale ? "STALE" : "LIVE", stale };
    }

    async function fetchWithTimeout(url, timeoutMs = 6500){
      const controller = new AbortController();
      const timer = setTimeout(()=> controller.abort(), timeoutMs);
      const t0 = performance.now();
      const res = await fetch(url, { method:"GET", cache:"no-store", signal: controller.signal });
      clearTimeout(timer);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const latencyMs = Math.round(performance.now() - t0);
      return { data, latencyMs };
    }

    async function fetchTwelveData(){
      const key = (settings.twelveKey || "").trim();
      if (!key) return { ok:false };

      // TwelveData: https://twelvedata.com/docs#price
      const url = `https://api.twelvedata.com/price?symbol=EUR/USD&apikey=${encodeURIComponent(key)}&dp=6&_=${Date.now()}`;
      try{
        const { data, latencyMs } = await fetchWithTimeout(url, 6500);
        const px = Number(data?.price);
        if (!Number.isFinite(px) || px <= 0) throw new Error("Bad parse");
        return { ok:true, price:px, source:"TwelveData", mode:"LIVE", latencyMs };
      }catch(e){
        return { ok:false, err:String(e) };
      }
    }

    async function fetchReference(){
      // These are not live. They are here as a fallback when no key is set.
      const providers = [
        {
          name: "exchangerate.host",
          url: () => `https://api.exchangerate.host/latest?base=EUR&symbols=USD&_=${Date.now()}`,
          parse: (j) => j?.rates?.USD
        },
        {
          name: "open.er-api.com",
          url: () => `https://open.er-api.com/v6/latest/EUR?_=${Date.now()}`,
          parse: (j) => j?.rates?.USD
        }
      ];

      for (const p of providers){
        try{
          const { data, latencyMs } = await fetchWithTimeout(p.url(), 6500);
          const px = Number(p.parse(data));
          if (!Number.isFinite(px) || px <= 0) throw new Error("Bad parse");
          return { ok:true, price:px, source:p.name, mode:"REFERENCE", latencyMs };
        }catch(e){}
      }
      return { ok:false };
    }

    async function tick(updateCb){
      const now = Date.now();

      // Prefer TwelveData if key present
      let r = await fetchTwelveData();
      if (!r.ok) r = await fetchReference();
      if (!r.ok){
        updateCb?.({ ok:false, ...last, ...status(now) });
        return;
      }

      const prev = last.price;
      const moved = (prev == null) ? true : Math.abs(r.price - prev) > MIN_MOVE;
      const delta = (prev == null) ? 0 : (r.price - prev);

      last.price = r.price;
      last.ts = now;
      last.mode = r.mode;
      last.source = r.source;
      last.latencyMs = r.latencyMs;
      last.lastDelta = delta;

      if (moved) last.lastChangeTs = now;
      if (!last.lastChangeTs) last.lastChangeTs = now;

      updateCb?.({ ok:true, ...last, ...status(now) });
    }

    return { tick, getLast: ()=> ({...last}) };
  })();

  // ---------- Macro Proxies via Stooq (daily) ----------
  // Stooq supports CSV with headers: Date,Open,High,Low,Close,Volume
  // Note: symbols can be imperfect. This is demo-grade.
  const Macro = (() => {
    const series = {
      brent: { label:"Brent (proxy)", symbol:"co1.f" },     // crude oil (generic)
      wti:   { label:"WTI (proxy)",   symbol:"cl1.f" },     // crude oil WTI (generic)
      gold:  { label:"Gold (proxy)",  symbol:"gc1.f" },     // gold futures continuous
      silver:{ label:"Silver (proxy)",symbol:"si1.f" },     // silver futures continuous
      dxy:   { label:"DXY (proxy)",   symbol:"dx1.f" }      // dollar index futures
    };

    let last = {
      brent: null, wti:null, gold:null, silver:null, dxy:null,
      tx: { score: 0, bias: "NEUTRAL" }
    };

    async function fetchStooq(sym){
      const url = `https://stooq.com/q/d/l/?s=${encodeURIComponent(sym)}&i=d&_=${Date.now()}`;
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("stooq fetch failed");
      const txt = await res.text();
      const lines = txt.trim().split(/\r?\n/);
      if (lines.length < 3) throw new Error("not enough data");
      // last line and previous line (ignore header)
      const lastLine = lines[lines.length-1].split(",");
      const prevLine = lines[lines.length-2].split(",");
      const close = Number(lastLine[4]);
      const prevClose = Number(prevLine[4]);
      const date = lastLine[0];
      if (!Number.isFinite(close) || !Number.isFinite(prevClose)) throw new Error("bad close");
      const chg = close - prevClose;
      const pct = prevClose !== 0 ? (chg / prevClose) : 0;
      return { close, prevClose, chg, pct, date };
    }

    function fmtKpi(v, pct){
      if (v == null) return "--";
      const p = (pct * 100);
      const cls = p >= 0 ? "pos" : "neg";
      return `<span class="${cls}">${v.toFixed(2)}</span>`;
    }

    function fmtMeta(chg, pct, date){
      const p = (pct * 100);
      const cls = p >= 0 ? "pos" : "neg";
      const sign = p >= 0 ? "+" : "";
      return `<span class="${cls}">${sign}${p.toFixed(2)}%</span> (${sign}${chg.toFixed(2)}) · ${escapeHtml(date)}`;
    }

    function computeTransmission(){
      // Convert daily macro changes into lever intensities (0..100).
      // Oil up hurts EUR, DXY up hurts EUR, Gold up can mean risk-off (EUR down), but can decouple.
      const br = last.brent?.pct ?? 0;
      const wt = last.wti?.pct ?? 0;
      const gd = last.gold?.pct ?? 0;
      const sv = last.silver?.pct ?? 0;
      const dx = last.dxy?.pct ?? 0;

      // Levers (0..100), scaled for daily. These are demo scalings.
      const oilLever = clamp(Math.abs((br+wt)/2) / 0.02, 0, 1) * 100;
      const dollarLever = clamp(Math.abs(dx) / 0.01, 0, 1) * 100;
      const fearLever = clamp(Math.max(0, gd - (sv*0.3)) / 0.015, 0, 1) * 100;

      // Transmission score signed: negative means bearish EURUSD tendency (EUR down).
      // Heuristic sign:
      // - Oil up => EUR down (negative)
      // - DXY up => EUR down (negative)
      // - Gold up => risk-off => EUR down (negative), but smaller weight
      const signed = (-0.45*((br+wt)/2)) + (-0.45*dx) + (-0.20*gd);
      const score = clamp(signed / 0.02, -1, 1); // normalize
      let bias = "NEUTRAL";
      if (score <= -0.20) bias = "SHORT";
      if (score >= 0.20) bias = "LONG";

      last.tx = { score, bias, oilLever, dollarLever, fearLever };
      return last.tx;
    }

    async function tick(){
      const keys = Object.keys(series);
      for (const k of keys){
        try{
          last[k] = await fetchStooq(series[k].symbol);
        }catch(e){
          last[k] = null;
        }
      }
      return computeTransmission();
    }

    function render(){
      // Values
      els.brentV.innerHTML = last.brent ? fmtKpi(last.brent.close, last.brent.pct) : "--";
      els.brentM.innerHTML = last.brent ? fmtMeta(last.brent.chg, last.brent.pct, last.brent.date) : "No data";

      els.wtiV.innerHTML = last.wti ? fmtKpi(last.wti.close, last.wti.pct) : "--";
      els.wtiM.innerHTML = last.wti ? fmtMeta(last.wti.chg, last.wti.pct, last.wti.date) : "No data";

      els.goldV.innerHTML = last.gold ? fmtKpi(last.gold.close, last.gold.pct) : "--";
      els.goldM.innerHTML = last.gold ? fmtMeta(last.gold.chg, last.gold.pct, last.gold.date) : "No data";

      els.silverV.innerHTML = last.silver ? fmtKpi(last.silver.close, last.silver.pct) : "--";
      els.silverM.innerHTML = last.silver ? fmtMeta(last.silver.chg, last.silver.pct, last.silver.date) : "No data";

      els.dxyV.innerHTML = last.dxy ? fmtKpi(last.dxy.close, last.dxy.pct) : "--";
      els.dxyM.innerHTML = last.dxy ? fmtMeta(last.dxy.chg, last.dxy.pct, last.dxy.date) : "No data";

      // Transmission summary
      const tx = last.tx || { score:0, bias:"NEUTRAL", oilLever:0, dollarLever:0, fearLever:0 };
      const pct = Math.round(Math.abs(tx.score) * 100);
      const dir = tx.score < 0 ? "EUR Bearish" : (tx.score > 0 ? "EUR Bullish" : "Neutral");
      els.txV.textContent = `${tx.bias}`;
      els.txM.textContent = `Score ${(tx.score).toFixed(2)} · ${dir} · Intensity ${pct}%`;

      // Levers
      els.oilLeverV.textContent = `${Math.round(tx.oilLever)}%`;
      els.dollarLeverV.textContent = `${Math.round(tx.dollarLever)}%`;
      els.fearLeverV.textContent = `${Math.round(tx.fearLever)}%`;

      els.oilLeverM.textContent = "EU energy drag proxy";
      els.dollarLeverM.textContent = "USD strength pressure proxy";
      els.fearLeverM.textContent = "Risk-off tone proxy";
    }

    function get(){ return structuredClone(last); }

    return { tick, render, get };
  })();

  // ---------- Event Risk (proximity) ----------
  function computeEventRisk(){
    // Look for HIGH impact events in next 4 hours.
    const now = Date.now();
    const horizonMs = 4 * 60 * 60 * 1000;
    let risk = 0; // 0..100
    for (const e of curatedEvents){
      const imp = String(e.impact || "").toUpperCase();
      if (imp !== "HIGH") continue;
      const t = new Date(e.when).getTime();
      if (!Number.isFinite(t)) continue;
      const dt = t - now;
      if (dt < 0 || dt > horizonMs) continue;
      // closer => higher risk
      const x = 1 - (dt / horizonMs);
      risk = Math.max(risk, clamp(x, 0, 1) * 100);
    }
    return risk;
  }

  // ---------- Regime Engine ----------
  const Engine = (() => {
    const HISTORY_N = 80;
    const MOM_WINDOW = 10;
    const VOL_WINDOW = 20;
    const HOLD_TICKS = 4;
    const PROB_TEMP = 1.25;

    let tickN = 0;
    let prices = [];
    let returns = [];
    let detectorState = null;
    let policyState = null;
    let hold = 0;

    function softmax(logits){
      const m = Math.max(...logits);
      const exps = logits.map(v => Math.exp((v - m) / PROB_TEMP));
      const s = exps.reduce((a,b)=>a+b,0) || 1;
      return exps.map(v => v/s);
    }

    function computeFeatures(){
      if (prices.length < 3) return null;
      const p = prices[prices.length-1];
      const pPrev = prices[prices.length-2];
      const r = (pPrev ? (p - pPrev) : 0);
      const momBase = prices[Math.max(0, prices.length-1-MOM_WINDOW)];
      const mom = momBase ? (p - momBase) : 0;

      const recentR = returns.slice(-VOL_WINDOW);
      const absAvg = recentR.length ? recentR.reduce((a,b)=>a+Math.abs(b),0)/recentR.length : 0;
      const volx = clamp(absAvg / 0.00015, 0, 6);

      const shock = Math.abs(r) > 0.0007 ? 1 : 0;

      return { p, r, mom, volx, shock };
    }

    function scoreStates(f){
      const momBp = Math.abs(bp(f.mom));
      const rBp = Math.abs(bp(f.r));
      const vol = f.volx;

      const signChanges = (() => {
        const rr = returns.slice(-10);
        if (rr.length < 6) return 0;
        let changes = 0;
        for (let i=1;i<rr.length;i++){
          if (Math.sign(rr[i]) !== Math.sign(rr[i-1])) changes++;
        }
        return changes;
      })();

      const L = new Array(8).fill(0);

      L[0] = 2.6 - 0.75*vol - 0.045*momBp;                      // mean reversion
      L[1] = 1.2 + 0.60*vol - 0.035*momBp;                      // liquidity vacuum
      L[2] = 1.7 - 0.25*vol - 0.02*momBp;                       // slow drift
      L[3] = 0.9 + 0.28*vol + 0.05*momBp;                       // strong trend
      L[4] = -0.2 + 0.60*vol + 0.02*momBp + 0.05*rBp;           // stop cascade
      L[5] = -0.4 + (f.shock ? 3.0 : 0) + 0.25*vol;             // news shock
      L[6] = 0.3 + 0.18*vol + 0.40*clamp(signChanges/6,0,1) - 0.02*momBp; // unwind
      L[7] = -0.9 + 1.00*Math.max(0, vol-2.2) + 0.05*rBp + (f.shock ? 0.7 : 0); // panic

      return softmax(L);
    }

    function pickState(probs){
      let best = 0;
      for (let i=1;i<probs.length;i++) if (probs[i] > probs[best]) best = i;
      return best+1;
    }

    function confidence(probs, state){
      const s = state-1;
      const top = probs[s];
      const sorted = [...probs].sort((a,b)=>b-a);
      const gap = (sorted[0] - (sorted[1] || 0));
      return clamp((top*0.72 + gap*0.28), 0, 1);
    }

    function updatePolicy(det){
      if (policyState == null){
        policyState = det;
        hold = 0;
        return { policy: policyState, hold, changed:true };
      }
      if (det === policyState){
        hold = 0;
        return { policy: policyState, hold, changed:false };
      }
      hold += 1;
      if (hold >= HOLD_TICKS){
        policyState = det;
        hold = 0;
        return { policy: policyState, hold, changed:true };
      }
      return { policy: policyState, hold, changed:false };
    }

    function step(price){
      tickN += 1;
      const p = Number(price);
      if (!Number.isFinite(p) || p <= 0) return null;

      const prev = prices.length ? prices[prices.length-1] : null;
      prices.push(p);
      if (prices.length > HISTORY_N) prices.shift();

      if (prev != null){
        const r = p - prev;
        returns.push(r);
        if (returns.length > HISTORY_N) returns.shift();
      }

      const f = computeFeatures();
      if (!f) return null;

      const probs = scoreStates(f);
      const det = pickState(probs);
      detectorState = det;

      const polRes = updatePolicy(det);
      const conf = confidence(probs, polRes.policy);

      return {
        tickN,
        features: f,
        probs,
        detector: det,
        policy: polRes.policy,
        hold: polRes.hold,
        conf
      };
    }

    return { step };
  })();

  // ---------- Probabilities UI ----------
  const probEls = [];
  function initProbUI(){
    els.probList.innerHTML = "";
    STATES.forEach((s)=>{
      const row = document.createElement("div");
      row.className = "probRow";
      row.innerHTML = `
        <div class="probName"><span class="pdot" style="background:${s.color}"></span>State ${s.id}: ${s.name}</div>
        <div class="pbar"><i></i></div>
        <div class="probVal">--%</div>
      `;
      els.probList.appendChild(row);
      probEls.push({
        bar: row.querySelector(".pbar > i"),
        val: row.querySelector(".probVal")
      });
    });
  }

  // ---------- Risk mapping ----------
  function setRisk(policyState, conf){
    let level = "--";
    let rule = "Policy: state-aware sizing and entry gating";

    if (policyState){
      if (policyState === 1) { level = "NORMAL"; rule = "Rule: Range logic favored. Avoid forcing breakouts."; }
      if (policyState === 2) { level = "ELEVATED"; rule = "Rule: Thin liquidity risk. Reduce size and demand confirmation."; }
      if (policyState === 3) { level = "NORMAL"; rule = "Rule: Drift regime. Small edges, avoid impulsive entries."; }
      if (policyState === 4) { level = "ELEVATED"; rule = "Rule: Trend regime. Bias with trend. Avoid countertrend heroics."; }
      if (policyState === 5) { level = "HIGH"; rule = "Rule: Stop cascade risk. De-risk and widen filters."; }
      if (policyState === 6) { level = "HIGH"; rule = "Rule: News shock. Consider standing down around releases."; }
      if (policyState === 7) { level = "ELEVATED"; rule = "Rule: Unwind risk. Protect and demand confirmation."; }
      if (policyState === 8) { level = "CRITICAL"; rule = "Rule: Risk off. Protect capital first."; }

      if (conf != null && conf < 0.33 && (level === "NORMAL")) level = "ELEVATED";
      if (conf != null && conf < 0.25 && (level === "ELEVATED")) level = "HIGH";
    }

    els.riskBig.textContent = level;
    els.riskRule.textContent = rule;
  }

  // ---------- Log ----------
  let logRows = loadJSON(KEY.log, []);
  function persistLog(){ localStorage.setItem(KEY.log, JSON.stringify(logRows.slice(0, 250))); }
  function renderLog(){
    const html = logRows.slice(0, 80).map(r=>{
      return `
        <tr>
          <td>${escapeHtml(r.time)}</td>
          <td>${escapeHtml(r.price)}</td>
          <td>${escapeHtml(r.det)}</td>
          <td>${escapeHtml(r.pol)}</td>
          <td>${escapeHtml(r.conf)}</td>
          <td>${escapeHtml(r.volx)}</td>
          <td>${escapeHtml(r.mom)}</td>
          <td>${escapeHtml(r.macro)}</td>
          <td>${escapeHtml(r.event)}</td>
          <td>${escapeHtml(r.src)}</td>
        </tr>
      `;
    }).join("");
    els.logBody.innerHTML = html || `<tr><td colspan="10" style="color:rgba(255,255,255,0.6)">No samples yet.</td></tr>`;
  }
  function addLogSample(sample){
    logRows.unshift(sample);
    logRows = logRows.slice(0, 250);
    persistLog();
    renderLog();
  }

  function csvCell(v){
    const s = String(v ?? "");
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  els.copyCsvBtn.addEventListener("click", async ()=>{
    const header = ["time","eurusd","det","pol","conf","volx","mom_bp","macro_bias","event_risk","src"];
    const lines = [header.join(",")];
    for (const r of logRows.slice().reverse()){
      lines.push([r.time,r.price,r.det,r.pol,r.conf,r.volx,r.mom,r.macro,r.event,r.src].map(csvCell).join(","));
    }
    try{
      await navigator.clipboard.writeText(lines.join("\n"));
      els.copyCsvBtn.textContent = "Copied";
      setTimeout(()=> els.copyCsvBtn.textContent = "Copy as CSV", 900);
    }catch(e){
      alert("Clipboard copy failed. Browser says no.");
    }
  });

  els.clearLogBtn.addEventListener("click", ()=>{
    if (!confirm("Clear regime log?")) return;
    logRows = [];
    persistLog();
    renderLog();
  });

  // ---------- Pause + Sync ----------
  let paused = false;
  els.pauseBtn.addEventListener("click", ()=>{
    paused = !paused;
    els.pauseBtn.textContent = paused ? "Resume" : "Pause";
    els.sysStatus.textContent = paused ? "PAUSED" : "LIVE";
    if (paused){
      els.liveDot.style.background = "rgba(255,176,32,1)";
      els.liveDot.style.boxShadow = "0 0 0 4px rgba(255,176,32,0.18)";
    } else {
      els.liveDot.style.background = "rgba(24,209,138,1)";
      els.liveDot.style.boxShadow = "0 0 0 4px rgba(24,209,138,0.18)";
    }
  });

  els.syncBtn.addEventListener("click", ()=> hardResync("Syncing"));

  function hardResync(msg){
    els.syncBtn.textContent = msg;
    Promise.allSettled([Quote.tick(onQuoteUpdate), Macro.tick().then(()=>Macro.render())])
      .finally(()=> setTimeout(()=> els.syncBtn.textContent = "Sync", 650));
  }

  // ---------- Dash state ----------
  let dashState = loadObj(KEY.dashboard, {});
  function persistDashState(){
    try{ localStorage.setItem(KEY.dashboard, JSON.stringify(dashState)); }catch(e){}
  }

  // ---------- UI: Quote status ----------
  function setFxStatus(status){
    els.fxSpotStatus.textContent = status;
    els.fxStatusDot.classList.remove("live","err");
    if (status === "LIVE") els.fxStatusDot.classList.add("live");
    if (status === "ERROR") els.fxStatusDot.classList.add("err");
  }

  // ---------- Projection cone ----------
  function drawCone(spot, pips1h, pips4h, bias){
    const canvas = els.cone;
    const ctx = canvas.getContext("2d");
    const rect = canvas.getBoundingClientRect();

    // hi-dpi
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(280 * dpr);
    canvas.style.height = "280px";
    ctx.scale(dpr, dpr);

    const w = rect.width;
    const h = 280;

    // background
    ctx.clearRect(0,0,w,h);

    // grid
    ctx.globalAlpha = 0.12;
    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 1;
    const stepX = w / 12;
    const stepY = h / 8;
    for (let i=1;i<12;i++){
      ctx.beginPath();
      ctx.moveTo(i*stepX, 0);
      ctx.lineTo(i*stepX, h);
      ctx.stroke();
    }
    for (let j=1;j<8;j++){
      ctx.beginPath();
      ctx.moveTo(0, j*stepY);
      ctx.lineTo(w, j*stepY);
      ctx.stroke();
    }
    ctx.globalAlpha = 1;

    // center line
    const cx = w*0.52;
    const cy = h*0.52;

    // pip to px scaling
    const maxPips = Math.max(8, pips4h*1.2);
    const pxPerPip = (h*0.35) / maxPips;

    function yForPips(p){ return cy - (p * pxPerPip); }

    // cone polygon
    const x0 = w*0.12;
    const x1 = w*0.52;
    const x2 = w*0.88;

    const yTop1 = yForPips(pips1h);
    const yBot1 = yForPips(-pips1h);
    const yTop4 = yForPips(pips4h);
    const yBot4 = yForPips(-pips4h);

    // fill
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = (bias === "LONG") ? "rgba(24,209,138,0.9)" : (bias === "SHORT" ? "rgba(255,77,77,0.9)" : "rgba(120,170,255,0.9)");
    ctx.beginPath();
    ctx.moveTo(x1, cy);
    ctx.lineTo(x2, yTop4);
    ctx.lineTo(x2, yBot4);
    ctx.closePath();
    ctx.fill();

    ctx.globalAlpha = 0.12;
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.beginPath();
    ctx.moveTo(x0, cy);
    ctx.lineTo(x1, yTop1);
    ctx.lineTo(x1, yBot1);
    ctx.closePath();
    ctx.fill();

    // lines
    ctx.globalAlpha = 0.35;
    ctx.strokeStyle = "rgba(255,255,255,0.95)";
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    ctx.moveTo(x0, cy);
    ctx.lineTo(x2, yTop4);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x0, cy);
    ctx.lineTo(x2, yBot4);
    ctx.stroke();

    // spot marker
    ctx.globalAlpha = 1;
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.beginPath();
    ctx.arc(x1, cy, 3.2, 0, Math.PI*2);
    ctx.fill();

    // labels
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
    ctx.fillStyle = "rgba(255,255,255,0.70)";
    ctx.fillText(`Spot ${spot.toFixed(5)}`, x1 + 8, cy + 4);
    ctx.fillText(`1h ±${Math.round(pips1h)}p`, x1 + 8, yTop1 - 8);
    ctx.fillText(`4h ±${Math.round(pips4h)}p`, x2 - 92, yTop4 - 8);
  }

  // ---------- Core update loop ----------
  let stalePolls = 0;
  let lastMacro = Macro.get();

  function onQuoteUpdate(q){
    const now = Date.now();
    els.lastUpdate.textContent = fmtTime(now);

    if (!q.ok){
      setFxStatus("ERROR");
      els.miniSrc.textContent = "Provider: --";
      els.miniLatency.textContent = "--";
      els.miniMode.textContent = "--";
      stalePolls += 1;
      els.staleChip.textContent = String(stalePolls);
      return;
    }

    // Quote UI
    els.miniPrice.textContent = q.price.toFixed(5);
    els.miniDelta.textContent = q.lastDelta.toFixed(5);
    els.miniSrc.textContent = `Provider: ${q.source}`;
    els.miniLatency.textContent = `${q.latencyMs}ms`;
    els.miniMode.textContent = q.mode;

    setFxStatus(q.status);

    // Bar
    const w = clamp(Math.abs(q.lastDelta) / 0.0012, 0, 1) * 100;
    els.miniBar.style.width = `${Math.max(12, w)}%`;
    els.miniBar.style.background = (q.lastDelta >= 0) ? "rgba(24,209,138,0.85)" : "rgba(255,77,77,0.85)";

    // Stale tracking
    if (q.status === "STALE") stalePolls += 1;
    else stalePolls = 0;
    els.staleChip.textContent = String(stalePolls);

    // Mode disclaimer
    if (q.mode === "REFERENCE"){
      els.quoteDisclaimer.innerHTML = `Mode: <b>REFERENCE</b>. Not streaming. Set TwelveData key in Settings for intraday updates.`;
    } else {
      els.quoteDisclaimer.innerHTML = `Mode: <b>LIVE</b>. Intraday quote provider active.`;
    }

    if (paused) return;

    // Engine step
    const step = Engine.step(q.price);
    if (!step) return;

    const det = step.detector;
    const pol = step.policy;
    const confPct = (step.conf * 100).toFixed(1) + "%";

    els.tickChip.textContent = String(step.tickN);
    els.detectorChip.textContent = `S${det}`;
    els.policyChip.textContent = `S${pol}`;
    els.confChip.textContent = confPct;

    els.hystChip.textContent = (det === pol) ? "stable" : "holding";

    const polName = STATES[pol-1]?.name || "--";
    const polDesc = STATES[pol-1]?.desc || "Waiting for signal.";
    els.policyStateTitle.textContent = `Policy State: S${pol} ${polName}`;
    els.policyStateDesc.textContent = polDesc;

    // Prob bars
    step.probs.forEach((p, i)=>{
      const pct = (p*100);
      probEls[i].bar.style.width = `${clamp(pct, 0, 100)}%`;
      probEls[i].bar.style.background = STATES[i].color;
      probEls[i].val.textContent = `${pct.toFixed(1)}%`;
    });

    // Macro + events influence
    lastMacro = Macro.get();
    const tx = lastMacro.tx || { score:0, bias:"NEUTRAL", oilLever:0, dollarLever:0, fearLever:0 };

    const eventRisk = computeEventRisk(); // 0..100
    els.eventRiskChip.textContent = eventRisk >= 65 ? "HIGH" : (eventRisk >= 30 ? "MED" : "LOW");

    // Macro bias chip
    els.macroBiasChip.textContent = tx.bias;

    // Risk card
    setRisk(pol, step.conf);

    // Build projection
    // Base pip range from regime volatility proxy
    const base1h = 4 + (step.features.volx * 3.2); // 4.. ~23
    const macroBoost = 1 + (Math.min(1, Math.abs(tx.score)) * 0.65);
    const eventBoost = 1 + (eventRisk/100) * 0.55;

    const pips1h = clamp(base1h * macroBoost * (1 + (eventRisk/100)*0.20), 3, 60);
    const pips4h = clamp(pips1h * (2.8 * eventBoost), 8, 180);

    // Trade bias: blend macro bias and regime direction (momentum sign)
    const momBp = bp(step.features.mom);
    let bias = "NEUTRAL";
    if (tx.bias === "LONG" && momBp > -3) bias = "LONG";
    if (tx.bias === "SHORT" && momBp < 3) bias = "SHORT";
    if (bias === "NEUTRAL"){
      if (momBp > 6) bias = "LONG";
      if (momBp < -6) bias = "SHORT";
    }

    // Decision confidence: agreement between macro and regime
    let agree = 0.5;
    if ((bias === "LONG" && tx.bias === "LONG") || (bias === "SHORT" && tx.bias === "SHORT")) agree = 0.85;
    if ((bias === "LONG" && tx.bias === "SHORT") || (bias === "SHORT" && tx.bias === "LONG")) agree = 0.25;
    const decision = clamp((step.conf*0.65 + agree*0.35) * (1 - eventRisk/220), 0, 1);

    // UI projection
    els.tradeBias.textContent = bias;
    els.tradeBiasMeta.textContent = `Macro ${tx.bias} · Mom ${momBp.toFixed(1)}bp · Event ${Math.round(eventRisk)}%`;

    els.range1h.textContent = `±${Math.round(pips1h)} pips`;
    els.range1hMeta.textContent = `Vol x${step.features.volx.toFixed(2)} · Macro x${macroBoost.toFixed(2)}`;

    els.range4h.textContent = `±${Math.round(pips4h)} pips`;
    els.range4hMeta.textContent = `Event x${eventBoost.toFixed(2)} · Transmission ${(tx.score).toFixed(2)}`;

    els.decisionConf.textContent = `${Math.round(decision*100)}%`;
    els.decisionConfMeta.textContent = decision < 0.35 ? "Low agreement, caution" : (decision < 0.60 ? "Mixed signals" : "Good alignment");

    // Event lever display
    els.eventLeverV.textContent = `${Math.round(eventRisk)}%`;
    els.eventLeverM.textContent = "High impact proximity";

    // Transmission lever display derived
    els.oilLeverV.textContent = `${Math.round(tx.oilLever)}%`;
    els.dollarLeverV.textContent = `${Math.round(tx.dollarLever)}%`;
    els.fearLeverV.textContent = `${Math.round(tx.fearLever)}%`;

    // Cone
    drawCone(q.price, pips1h, pips4h, bias);

    // Footer
    els.footPolicy.textContent = `S${pol}`;
    els.footDetector.textContent = `S${det}`;
    els.footTx.textContent = `${tx.bias} (${tx.score.toFixed(2)})`;

    // Persist snapshot
    dashState = {
      lastPrice: q.price,
      lastTs: q.ts,
      lastSrc: q.source,
      lastMode: q.mode,
      lastPolicy: pol,
      lastDetector: det,
      lastConf: step.conf,
      lastProbs: step.probs,
      lastTick: step.tickN,
      lastTx: tx,
      lastEventRisk: eventRisk
    };
    persistDashState();

    // Log
    addLogSample({
      time: fmtTime(q.ts),
      price: q.price.toFixed(5),
      det: `S${det}`,
      pol: `S${pol}`,
      conf: confPct,
      volx: step.features.volx.toFixed(2),
      mom: momBp.toFixed(2),
      macro: tx.bias,
      event: `${Math.round(eventRisk)}%`,
      src: `${q.source} (${q.mode})`
    });
  }

  // ---------- Hydrate ----------
  function hydrate(){
    initProbUI();
    renderEvents();
    renderHeadlines();
    renderLog();

    // macro
    Macro.render();

    if (dashState && dashState.lastPrice){
      els.miniPrice.textContent = Number(dashState.lastPrice).toFixed(5);
      els.miniSrc.textContent = `Provider: ${dashState.lastSrc || "--"}`;
      els.miniMode.textContent = dashState.lastMode || "--";
      els.miniLatency.textContent = "--";
      els.miniDelta.textContent = "0.00000";
      setFxStatus("CHECKING");

      if (dashState.lastPolicy){
        const pol = dashState.lastPolicy;
        const polName = STATES[pol-1]?.name || "--";
        const polDesc = STATES[pol-1]?.desc || "--";
        els.policyStateTitle.textContent = `Policy State: S${pol} ${polName}`;
        els.policyStateDesc.textContent = polDesc;
        els.policyChip.textContent = `S${pol}`;
        els.footPolicy.textContent = `S${pol}`;
      }
      if (dashState.lastDetector){
        els.detectorChip.textContent = `S${dashState.lastDetector}`;
        els.footDetector.textContent = `S${dashState.lastDetector}`;
      }
      if (dashState.lastConf != null){
        els.confChip.textContent = (dashState.lastConf*100).toFixed(1) + "%";
        setRisk(dashState.lastPolicy, dashState.lastConf);
      }
      if (Array.isArray(dashState.lastProbs) && dashState.lastProbs.length === 8){
        dashState.lastProbs.forEach((p,i)=>{
          const pct = p*100;
          probEls[i].bar.style.width = `${clamp(pct,0,100)}%`;
          probEls[i].bar.style.background = STATES[i].color;
          probEls[i].val.textContent = `${pct.toFixed(1)}%`;
        });
      }
      if (dashState.lastTick){
        els.tickChip.textContent = String(dashState.lastTick);
      }
      if (dashState.lastTx){
        els.macroBiasChip.textContent = dashState.lastTx.bias || "--";
        els.footTx.textContent = `${dashState.lastTx.bias || "--"} (${Number(dashState.lastTx.score || 0).toFixed(2)})`;
      }
      if (dashState.lastEventRisk != null){
        const er = Number(dashState.lastEventRisk);
        els.eventRiskChip.textContent = er >= 65 ? "HIGH" : (er >= 30 ? "MED" : "LOW");
      }
    }
  }

  // ---------- Start loops ----------
  const macroPollMs = 10 * 60 * 1000; // macro daily, but refresh every 10 minutes for demo
  let quoteTimer = null;

  function startTimers(){
    const pollMs = Math.max(6000, Math.min(60000, Number(settings.pollSeconds || 12) * 1000));

    if (quoteTimer) clearInterval(quoteTimer);
    quoteTimer = setInterval(()=> Quote.tick(onQuoteUpdate), pollMs);

    // immediate
    Quote.tick(onQuoteUpdate);

    // macro
    Macro.tick().then(()=> Macro.render()).catch(()=>{});
    setInterval(()=> Macro.tick().then(()=> Macro.render()).catch(()=>{}), macroPollMs);

    // events countdown
    setInterval(()=> renderEvents(), 30_000);
  }

  // ---------- Initialize ----------
  hydrate();
  startTimers();

})();
</script>
</body>
</html>
