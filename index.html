<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QuadraX Risk Dashboard</title>
  <style>
    :root{
      --bg:#050B1A;
      --panel:#07122F;
      --border2: rgba(255,255,255,0.10);
      --text:#E6EAF2;
      --muted: rgba(230,234,242,0.70);
      --muted2: rgba(230,234,242,0.55);

      --green:#10B981;
      --amber:#F59E0B;
      --orange:#F97316;
      --red:#DC2626;
      --blue:#60A5FA;
      --violet:#A78BFA;

      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:24px;
      background: radial-gradient(1200px 600px at 15% 10%, rgba(96,165,250,0.14), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(16,185,129,0.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      letter-spacing: 0.2px;
    }

    .wrap{ max-width: 1620px; margin:0 auto; }
    .topbar{
      border: 1px solid rgba(96,165,250,0.45);
      background: linear-gradient(135deg, rgba(30,58,138,0.95), rgba(59,130,246,0.65));
      border-radius: 20px;
      padding: 18px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      box-shadow: var(--shadow);
    }

    .brand{ display:flex; align-items:center; gap:14px; min-width: 260px; }
    .logo{
      width: 44px; height: 44px; border-radius: 14px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      display:flex; align-items:center; justify-content:center;
      font-weight: 800; color: rgba(255,255,255,0.92);
      user-select:none;
    }
    .brand h1{ margin:0; font-size: 18px; font-weight: 800; line-height: 1.1; }
    .brand .sub{ margin-top: 2px; font-size: 12px; color: rgba(255,255,255,0.78); }

    .top-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius: 999px;
      background: rgba(2,6,23,0.40);
      border: 1px solid rgba(255,255,255,0.14);
      font-size: 12px; color: rgba(255,255,255,0.88);
      white-space: nowrap;
    }

    .dot{
      width: 9px; height: 9px; border-radius: 999px;
      background: var(--green);
      box-shadow: 0 0 0 4px rgba(16,185,129,0.18);
    }
    .dot.off{ background: rgba(148,163,184,0.9); box-shadow:none; }

    .btn{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(2,6,23,0.35);
      color: rgba(255,255,255,0.92);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 700;
      font-size: 12px;
      transition: transform 120ms ease, background 120ms ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(2,6,23,0.50); }
    .btn.primary{ background: rgba(16,185,129,0.18); border-color: rgba(16,185,129,0.35); }
    .btn.warn{ background: rgba(245,158,11,0.20); border-color: rgba(245,158,11,0.35); color: rgba(255,255,255,0.95); }
    .btn.danger{ background: rgba(220,38,38,0.18); border-color: rgba(220,38,38,0.35); color: rgba(255,255,255,0.95); }

    .grid{
      margin-top: 18px;
      display:grid;
      grid-template-columns: 2.1fr 1fr;
      gap: 18px;
    }

    .card{
      border-radius: var(--radius);
      background: rgba(7,18,47,0.85);
      border: 1px solid var(--border2);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .card-title{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom: 12px;
    }

    .card-title h2{
      margin:0;
      font-size: 14px;
      letter-spacing: 0.7px;
      text-transform: uppercase;
      color: rgba(230,234,242,0.85);
    }
    .muted{ color: var(--muted); font-size: 12px; }

    .state-card{
      background: linear-gradient(180deg, rgba(16,185,129,0.18), rgba(7,18,47,0.85) 70%);
      border: 1px solid rgba(16,185,129,0.25);
    }

    .state-main{ display:flex; align-items:flex-start; justify-content:space-between; gap: 14px; }
    .state-name{
      font-size: 34px; font-weight: 900; line-height: 1.1;
      margin: 6px 0 6px 0; color: rgba(255,255,255,0.95);
    }
    .confidence{ font-size: 13px; color: rgba(230,234,242,0.86); }

    .state-badge{
      width: 76px; height: 76px; border-radius: 999px;
      background: rgba(16,185,129,0.22);
      border: 1px solid rgba(16,185,129,0.35);
      display:flex; align-items:center; justify-content:center;
      font-weight: 900; font-size: 34px;
      color: rgba(255,255,255,0.95); flex: 0 0 auto;
    }

    .divider{ height:1px; background: rgba(255,255,255,0.10); margin: 14px 0; }

    .history{ display:flex; gap: 8px; flex-wrap:wrap; }
    .chip{
      width: 38px; height: 38px; border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      font-weight: 900; border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.92); background: rgba(255,255,255,0.06);
      user-select:none;
    }

    .probs{ display:flex; flex-direction:column; gap: 12px; }
    .prob-row{ display:flex; flex-direction:column; gap: 6px; }
    .prob-head{ display:flex; justify-content:space-between; gap: 10px; font-size: 13px; }
    .bar{
      height: 10px; background: rgba(0,0,0,0.35);
      border-radius: 999px; overflow:hidden;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .fill{ height:100%; width: 0%; border-radius: 999px; transition: width 260ms ease; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 10px;
    }
    .kpi{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(2,6,23,0.22);
      padding: 12px;
    }
    .kpi .label{ font-size: 12px; color: var(--muted); }
    .kpi .value{ margin-top: 6px; font-size: 18px; font-weight: 900; color: rgba(255,255,255,0.95); }

    .risk-tile{
      text-align:center;
      padding: 18px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(2,6,23,0.35);
    }
    .risk-tile .big{ font-size: 34px; font-weight: 1000; margin-top: 8px; }
    .risk-tile .label{ font-size: 12px; color: var(--muted); letter-spacing: 0.7px; text-transform: uppercase; }

    .metric{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(2,6,23,0.22);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .metric .m-title{ font-size: 12px; color: var(--muted); }
    .metric .m-value{ font-size: 18px; font-weight: 900; color: rgba(255,255,255,0.95); margin-top: 6px; }
    .metric .m-sub{ font-size: 11px; color: var(--muted2); margin-top: 4px; }

    .gauge{
      margin-top: 8px;
      height: 10px;
      background: rgba(0,0,0,0.35);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .gauge .gfill{ height:100%; width:0%; background: var(--green); transition: width 260ms ease; }

    .alerts{
      display:flex;
      flex-direction:column;
      gap: 10px;
      max-height: 220px;
      overflow:auto;
      padding-right: 4px;
    }
    .alert{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(2,6,23,0.22);
      padding: 12px;
    }
    .alert .sev{ font-size: 11px; font-weight: 900; letter-spacing: 0.7px; text-transform: uppercase; }
    .alert .msg{ margin-top: 6px; font-size: 13px; color: rgba(255,255,255,0.92); }
    .alert .time{ margin-top: 6px; font-size: 11px; color: var(--muted2); }

    .sev-info{ color: rgba(96,165,250,0.95); }
    .sev-warn{ color: rgba(245,158,11,0.95); }
    .sev-critical{ color: rgba(248,113,113,0.95); }

    .footer{
      margin-top: 18px;
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(7,18,47,0.70);
      box-shadow: var(--shadow);
    }
    .footer .item{ font-size: 12px; color: var(--muted); }
    .footer .item b{ color: rgba(255,255,255,0.95); }

    /* New panels */
    .mini-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .table-wrap{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(2,6,23,0.18);
      border-radius: 16px;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    thead{
      background: rgba(255,255,255,0.06);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.07);
      text-align:left;
      white-space: nowrap;
    }
    th{ color: rgba(230,234,242,0.75); font-weight: 900; text-transform: uppercase; font-size: 11px; letter-spacing: 0.6px; }
    td{ color: rgba(230,234,242,0.90); }
    .scroll{
      max-height: 220px;
      overflow:auto;
    }

    .status-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(2,6,23,0.25);
      font-size: 12px;
      font-weight: 800;
    }
    .ok{ color: rgba(52,211,153,0.95); }
    .bad{ color: rgba(248,113,113,0.95); }
    .warn{ color: rgba(245,158,11,0.95); }

    @media (max-width: 1120px){
      .grid{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: repeat(2, 1fr); }
      .mini-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" title="QuadraX">QX</div>
        <div>
          <h1>QuadraX Risk Dashboard</h1>
          <div class="sub">Executive View: 8-State Monitoring and Control System (Live EUR/USD)</div>
        </div>
      </div>

      <div class="top-right">
        <div class="pill" title="Data feed status">
          <span id="liveDot" class="dot"></span>
          <span id="liveText">LIVE</span>
        </div>
        <div class="pill">
          <span class="muted">Last Update</span>
          <b id="lastUpdate">--:--:--</b>
        </div>
        <button class="btn warn" id="pauseBtn">Pause</button>
        <button class="btn primary" id="syncBtn">Sync</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div style="display:flex; flex-direction:column; gap:18px;">
        <div class="card state-card">
          <div class="card-title">
            <h2>Current Market State</h2>
            <div class="muted">Live EUR/USD feed driving regime (portfolio tiles still demo)</div>
          </div>

          <div class="state-main">
            <div>
              <div class="state-name" id="stateName">STATE 1: Mean-Reverting</div>
              <div class="confidence">Confidence: <b id="confidence">82.0%</b></div>
              <div class="muted" style="margin-top:6px;">
                Hysteresis: <b id="hystStatus">stable</b> · Hold ticks: <b id="holdTicks">0</b>
              </div>
            </div>
            <div class="state-badge" id="stateBadge">1</div>
          </div>

          <div class="divider"></div>

          <div class="muted">Recent State History (Last 12 Updates)</div>
          <div class="history" id="stateHistory"></div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>State Probability Distribution</h2>
            <div class="muted">Conditional regime likelihoods</div>
          </div>

          <div class="probs" id="probList"></div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>Regime Log</h2>
            <div class="muted">CSV-style telemetry (latest on top)</div>
          </div>

          <div class="table-wrap">
            <div class="scroll">
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>EURUSD</th>
                    <th>State</th>
                    <th>Conf</th>
                    <th>Vol x</th>
                    <th>Feed</th>
                  </tr>
                </thead>
                <tbody id="logBody"></tbody>
              </table>
            </div>
          </div>

          <div class="muted" style="margin-top:10px;">
            Tip: copy table contents, paste into Excel, it will split nicely.
          </div>
        </div>
      </div>

      <!-- Right -->
      <div style="display:flex; flex-direction:column; gap:18px;">
        <div class="card">
          <div class="risk-tile" id="riskTile">
            <div class="label">Risk Level</div>
            <div class="big" id="riskLevel">NORMAL</div>
            <div class="muted" id="riskNote">Policy: state-aware sizing and entry gating</div>
          </div>
        </div>

        <!-- Feed Health + Events -->
        <div class="card">
          <div class="card-title">
            <h2>Feed Health</h2>
            <div class="muted">Proof the market data is live</div>
          </div>

          <div class="mini-grid">
            <div class="metric">
              <div>
                <div class="m-title">EUR/USD Spot</div>
                <div class="m-value" id="spotPx">--</div>
                <div class="m-sub">Last good sample: <b id="lastGood">--</b></div>
              </div>
            </div>

            <div class="metric">
              <div>
                <div class="m-title">Status</div>
                <div class="m-value">
                  <span class="status-badge" id="feedBadge">
                    <span id="feedDot">●</span>
                    <span id="feedText">CHECKING</span>
                  </span>
                </div>
                <div class="m-sub">Source: <b id="feedSource">--</b> · Latency: <b id="feedLatency">--</b></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>World Events Calendar</h2>
            <div class="muted">Manual list for demo, swap to API later</div>
          </div>

          <div class="table-wrap">
            <div class="scroll" style="max-height: 200px;">
              <table>
                <thead>
                  <tr>
                    <th>When</th>
                    <th>Event</th>
                    <th>Impact</th>
                    <th>Countdown</th>
                  </tr>
                </thead>
                <tbody id="eventsBody"></tbody>
              </table>
            </div>
          </div>

          <div class="muted" style="margin-top:10px;">
            We will later replace this with an authenticated backend pull (avoids CORS).
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>Risk Metrics</h2>
            <div class="muted">Placeholders until MT4 integration</div>
          </div>

          <div style="display:flex; flex-direction:column; gap:12px;">
            <div class="metric">
              <div>
                <div class="m-title">Value at Risk (95%)</div>
                <div class="m-value" style="color: rgba(248,113,113,0.95);" id="var95">$28,500</div>
                <div class="m-sub" id="varPct">2.85% of account</div>
              </div>
            </div>

            <div class="metric">
              <div>
                <div class="m-title">Conditional VaR (95%)</div>
                <div class="m-value" style="color: rgba(248,113,113,0.95);" id="cvar95">$42,300</div>
                <div class="m-sub">Expected loss if VaR exceeded</div>
              </div>
            </div>

            <div class="metric">
              <div style="width:100%;">
                <div style="display:flex; justify-content:space-between; gap:10px;">
                  <div class="m-title">Portfolio Correlation</div>
                  <div class="m-value" style="color: rgba(52,211,153,0.95);" id="corr">32.0%</div>
                </div>
                <div class="m-sub">Max allowed: <span id="corrMax">50%</span></div>
                <div class="gauge"><div class="gfill" id="corrFill"></div></div>
              </div>
            </div>

            <div class="metric">
              <div>
                <div class="m-title">Beta to Market</div>
                <div class="m-value" style="color: rgba(96,165,250,0.95);" id="beta">0.15</div>
                <div class="m-sub">Low market correlation (good)</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>Active Alerts</h2>
            <div class="muted" id="alertCount">2 items</div>
          </div>

          <div class="alerts" id="alerts"></div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px;">
            <button class="btn warn" id="reduceBtn" title="Demo action only">Reduce Risk</button>
            <button class="btn danger" id="flattenBtn" title="Demo action only">Emergency Flatten</button>
          </div>

          <div class="muted" style="margin-top:10px;">
            Demo artifact. Live market state is real. Portfolio and risk tiles will be wired to MT4 via backend.
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="item">System Status: <b id="sysStatus">LIVE</b></div>
      <div class="item">Current Regime: <b id="sysRegime">State 1</b></div>
      <div class="item">Positions: <b id="posCount">5</b></div>
      <div class="item">Data Source: <b id="feedSourceFooter">Public EUR/USD spot</b></div>
    </div>
  </div>

<script>
  // ----------------------------
  // Live EUR/USD feeds with fallback
  // ----------------------------
  const FEEDS = [
    { name: "exchangerate.host", url: "https://api.exchangerate.host/latest?base=EUR&symbols=USD", pick: (j) => j?.rates?.USD },
    { name: "open.er-api.com",   url: "https://open.er-api.com/v6/latest/EUR",                  pick: (j) => j?.rates?.USD },
    { name: "frankfurter.app",   url: "https://api.frankfurter.app/latest?from=EUR&to=USD",     pick: (j) => j?.rates?.USD }
  ];

  const POLL_MS = 5000;
  const WINDOW = 60;
  const MAX_BUF = WINDOW * 4;

  // Hysteresis controls
  const SWITCH_CONFIRM_TICKS = 3;  // new state must win N times in a row
  const MIN_HOLD_TICKS = 4;        // do not switch again until held current state N ticks

  const stateNames = {
    1:"Mean-Reverting",2:"Liquidity Vacuum",3:"Slow Drift",
    4:"Strong Trend",5:"Stop Cascade",6:"News Shock",
    7:"Dealer Unwind",8:"Panic/Forced"
  };

  let isLive = true;

  // Raw classifier output
  let rawState = 1;
  let rawConf = 0.82;
  let rawVolX = 1.0;

  // Smoothed state output
  let currentState = 1;
  let prevState = 1;
  let stateConfidence = 0.82;
  let stateHistory = [1,1,1,2,1,1,1,1,3,3,3,1];
  let stateProbabilities = { 1:82, 2:8, 3:5, 4:3, 5:1, 6:0.5, 7:0.3, 8:0.2 };

  // Hysteresis trackers
  let holdTicks = 0;
  let candidateState = null;
  let candidateCount = 0;

  // Demo portfolio placeholders
  let accountBalance = 1000000;
  let totalExposure = 650000;
  let dailyPnL = 12500;
  let maxDrawdown = -3.2;

  let var95 = 28500;
  let cvar95 = 42300;
  let correlation = 0.32;
  let corrMax = 0.5;
  let beta = 0.15;

  // Live buffers
  const prices = [];
  const rets = [];

  // Feed health
  let lastSpot = null;
  let lastGoodTs = 0;
  let lastFeedName = "--";
  let lastLatencyMs = null;
  let consecutiveFails = 0;

  // Log rows
  const logRows = [];
  const MAX_LOG_ROWS = 40;

  // World events (demo)
  // Use ISO datetime in UTC for deterministic countdowns
  const events = [
    { whenUtc: "2026-02-19T13:30:00Z", name: "US Initial Jobless Claims", impact: "Med" },
    { whenUtc: "2026-02-20T15:00:00Z", name: "Eurozone CPI (flash)", impact: "High" },
    { whenUtc: "2026-02-26T13:30:00Z", name: "US GDP (advance)", impact: "High" },
    { whenUtc: "2026-03-06T13:30:00Z", name: "US Non-Farm Payrolls", impact: "High" },
    { whenUtc: "2026-03-12T12:45:00Z", name: "ECB Rate Decision", impact: "High" },
    { whenUtc: "2026-03-18T18:00:00Z", name: "FOMC Rate Decision", impact: "High" }
  ];

  let alerts = [
    { severity:"info", message:"Hysteresis enabled. Regime will not flap every tick.", time:"Just now" },
    { severity:"warning", message:"Portfolio tiles are placeholders until MT4 integration.", time:"Just now" }
  ];

  function $(id){ return document.getElementById(id); }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function safeNum(x){ const n = Number(x); return Number.isFinite(n) ? n : null; }
  function nowTime(){ return new Date().toLocaleTimeString(); }
  function fmtUsd(x){ return x.toLocaleString(undefined,{style:"currency",currency:"USD"}); }
  function fmtPct(x){ return (x*100).toFixed(1) + "%"; }

  function calcStd(arr){
    if (arr.length < 2) return 0;
    const mean = arr.reduce((s,v)=>s+v,0) / arr.length;
    const v = arr.reduce((s,x)=>s + (x-mean)*(x-mean),0) / (arr.length - 1);
    return Math.sqrt(v);
  }

  function calcSlope(series){
    const n = series.length;
    if (n < 3) return 0;
    let sumX=0, sumY=0, sumXY=0, sumXX=0;
    for (let i=0; i<n; i++){
      const x = i, y = series[i];
      sumX += x; sumY += y; sumXY += x*y; sumXX += x*x;
    }
    const denom = (n * sumXX - sumX * sumX);
    if (denom === 0) return 0;
    return (n * sumXY - sumX * sumY) / denom;
  }

  function stateColor(s){
    if (s===1) return "rgba(52,211,153,0.95)";
    if (s===2) return "rgba(245,158,11,0.95)";
    if (s===3) return "rgba(96,165,250,0.95)";
    if (s===4) return "rgba(59,130,246,0.95)";
    if (s===5) return "rgba(251,146,60,0.95)";
    if (s===6) return "rgba(248,113,113,0.95)";
    if (s===7) return "rgba(167,139,250,0.95)";
    return "rgba(239,68,68,0.95)";
  }

  function sevClass(sev){
    if (sev === "critical") return "sev-critical";
    if (sev === "warning") return "sev-warn";
    return "sev-info";
  }

  function pushAlert(severity, message){
    alerts.unshift({ severity, message, time:"Just now" });
    alerts = alerts.slice(0, 8);
  }

  function riskLevel(){
    if (currentState >= 7) return "CRITICAL";
    if (currentState >= 5) return "HIGH";
    if (currentState === 2) return "ELEVATED";
    return "NORMAL";
  }

  function riskColor(level){
    if (level === "NORMAL") return "rgba(16,185,129,0.20)";
    if (level === "ELEVATED") return "rgba(245,158,11,0.22)";
    if (level === "HIGH") return "rgba(249,115,22,0.22)";
    return "rgba(220,38,38,0.22)";
  }

  function setLiveUI(){
    const dot = $("liveDot");
    const txt = $("liveText");
    const sys = $("sysStatus");
    const pauseBtn = $("pauseBtn");
    if (dot) dot.className = isLive ? "dot" : "dot off";
    if (txt) txt.textContent = isLive ? "LIVE" : "PAUSED";
    if (sys) sys.textContent = isLive ? "LIVE" : "PAUSED";
    if (pauseBtn) pauseBtn.textContent = isLive ? "Pause" : "Resume";
  }

  async function fetchEURUSD(){
    for (const feed of FEEDS){
      const t0 = performance.now();
      try{
        const res = await fetch(feed.url, { cache:"no-store" });
        const json = await res.json();
        const px = safeNum(feed.pick(json));
        if (px){
          const t1 = performance.now();
          lastLatencyMs = Math.round(t1 - t0);
          lastFeedName = feed.name;
          return px;
        }
      } catch(e){
        // keep trying other feeds
      }
    }
    throw new Error("All EURUSD feeds failed");
  }

  function classifyRegime(){
    const r = rets.slice(Math.max(0, rets.length - WINDOW));
    const p = prices.slice(Math.max(0, prices.length - WINDOW));

    const vol = calcStd(r);
    const slope = calcSlope(p);
    const absSlope = Math.abs(slope);

    const half = Math.max(6, Math.floor(r.length/2));
    const volEarly = calcStd(r.slice(0, half));
    const volLate  = calcStd(r.slice(half));
    const volChange = volEarly > 0 ? (volLate / volEarly) : 1;

    const lowVol = vol < 0.00006;
    const medVol = vol >= 0.00006 && vol < 0.00014;
    const hiVol  = vol >= 0.00014;

    const weakTrend = absSlope < 0.000005;
    const medTrend  = absSlope >= 0.000005 && absSlope < 0.00002;
    const strongTrend = absSlope >= 0.00002;

    let s = 1;

    if (lowVol && weakTrend) s = 1;
    else if (lowVol && volChange > 1.35) s = 2;
    else if (medVol && medTrend) s = 3;
    else if ((medVol || hiVol) && strongTrend) s = 4;
    else if (hiVol && volChange > 1.6 && strongTrend) s = 5;
    else if (hiVol && volChange > 1.6 && !strongTrend) s = 6;
    else if (hiVol && medTrend) s = 7;
    else if (hiVol && strongTrend && volChange > 2.0) s = 8;

    let conf = 0.62;
    conf += clamp((volChange - 1) * 0.10, 0, 0.20);
    conf += clamp(absSlope * 2500, 0, 0.13);
    conf = clamp(conf, 0.55, 0.95);

    const base = {1:2,2:2,3:2,4:2,5:1,6:1,7:1,8:1};
    base[s] = 70 + Math.round((conf - 0.55) * 60);

    if (s === 1) { base[2]+=6; base[3]+=4; }
    if (s === 2) { base[3]+=6; base[4]+=4; }
    if (s === 3) { base[1]+=6; base[4]+=6; }
    if (s === 4) { base[3]+=6; base[5]+=4; }
    if (s === 5) { base[4]+=6; base[8]+=6; }
    if (s === 6) { base[4]+=6; base[7]+=4; }
    if (s === 7) { base[4]+=6; base[5]+=4; }
    if (s === 8) { base[5]+=8; base[6]+=6; }

    let sum = 0;
    for (let k=1; k<=8; k++) sum += base[k];

    const probs = {};
    let running = 0;
    for (let k=1; k<=8; k++){
      probs[k] = Math.round((base[k] / sum) * 1000) / 10;
      running += probs[k];
    }
    const drift = Math.round((100 - running) * 10) / 10;
    probs[s] = Math.round((probs[s] + drift) * 10) / 10;

    return { state:s, conf, probs, volX: volChange };
  }

  function applyHysteresis(proposedState, proposedConf){
    // Hold counter always increases while we keep current state
    // We only switch after a candidate wins N consecutive times and we have held current state long enough

    if (proposedState === currentState){
      candidateState = null;
      candidateCount = 0;
      holdTicks += 1;
      return { changed:false, status:"stable" };
    }

    // If we have not held long enough, ignore switching
    if (holdTicks < MIN_HOLD_TICKS){
      candidateState = null;
      candidateCount = 0;
      holdTicks += 1;
      return { changed:false, status:"holding" };
    }

    // Build candidate streak
    if (candidateState !== proposedState){
      candidateState = proposedState;
      candidateCount = 1;
    } else {
      candidateCount += 1;
    }

    // Require consecutive confirmation plus a minimum confidence to switch
    const confGate = proposedConf >= 0.62;
    if (candidateCount >= SWITCH_CONFIRM_TICKS && confGate){
      prevState = currentState;
      currentState = proposedState;
      holdTicks = 0;
      candidateState = null;
      candidateCount = 0;
      return { changed:true, status:"switched" };
    }

    holdTicks += 1;
    return { changed:false, status:"candidate" };
  }

  function renderEvents(){
    const body = $("eventsBody");
    body.innerHTML = "";
    const now = Date.now();

    events.forEach(ev => {
      const ts = Date.parse(ev.whenUtc);
      const ms = ts - now;

      let countdown = "started";
      if (ms > 0){
        const mins = Math.floor(ms / 60000);
        const hrs = Math.floor(mins / 60);
        const days = Math.floor(hrs / 24);
        const remH = hrs % 24;
        const remM = mins % 60;

        countdown = (days > 0)
          ? `${days}d ${remH}h`
          : (hrs > 0)
            ? `${hrs}h ${remM}m`
            : `${remM}m`;
      }

      const d = new Date(ts);
      const whenLocal = d.toLocaleString();

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${whenLocal}</td>
        <td>${ev.name}</td>
        <td>${ev.impact}</td>
        <td>${countdown}</td>
      `;
      body.appendChild(tr);
    });
  }

  function updateFeedHealth(){
    const now = Date.now();
    const staleMs = now - lastGoodTs;

    let status = "CHECKING";
    let cls = "warn";

    if (lastGoodTs === 0){
      status = "CHECKING";
      cls = "warn";
    } else if (staleMs <= POLL_MS * 2){
      status = "OK";
      cls = "ok";
    } else if (staleMs <= POLL_MS * 5){
      status = "STALE";
      cls = "warn";
    } else {
      status = "DOWN";
      cls = "bad";
    }

    $("feedText").textContent = status;
    $("feedBadge").className = `status-badge ${cls}`;
    $("feedSource").textContent = lastFeedName;
    $("feedSourceFooter").textContent = lastFeedName;
    $("feedLatency").textContent = (lastLatencyMs != null) ? `${lastLatencyMs}ms` : "--";
    $("lastGood").textContent = lastGoodTs ? new Date(lastGoodTs).toLocaleTimeString() : "--";
    $("spotPx").textContent = (lastSpot != null) ? lastSpot.toFixed(5) : "--";
  }

  function render(){
    $("lastUpdate").textContent = nowTime();

    $("stateName").textContent = `STATE ${currentState}: ${stateNames[currentState]}`;
    $("confidence").textContent = fmtPct(stateConfidence);
    $("stateBadge").textContent = String(currentState);
    $("sysRegime").textContent = `State ${currentState}`;

    $("holdTicks").textContent = String(holdTicks);

    const hist = $("stateHistory");
    hist.innerHTML = "";
    stateHistory.forEach((s, idx) => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = String(s);
      chip.title = stateNames[s];
      chip.style.opacity = String(0.35 + (idx / Math.max(1, stateHistory.length-1)) * 0.65);
      chip.style.borderColor = stateColor(s).replace("0.95","0.35");
      hist.appendChild(chip);
    });

    const probList = $("probList");
    probList.innerHTML = "";
    const entries = Object.entries(stateProbabilities).map(([k,v]) => [Number(k), Number(v)]);
    entries.sort((a,b)=>b[1]-a[1]);
    entries.forEach(([s,p]) => {
      const row = document.createElement("div");
      row.className = "prob-row";

      const head = document.createElement("div");
      head.className = "prob-head";

      const left = document.createElement("div");
      left.textContent = `State ${s}: ${stateNames[s]}`;
      left.style.color = "rgba(230,234,242,0.88)";

      const right = document.createElement("div");
      right.textContent = `${p.toFixed(1)}%`;
      right.style.fontWeight = "900";
      right.style.color = stateColor(s);

      head.appendChild(left);
      head.appendChild(right);

      const bar = document.createElement("div");
      bar.className = "bar";
      const fill = document.createElement("div");
      fill.className = "fill";
      fill.style.width = `${clamp(p,0,100)}%`;
      fill.style.background = stateColor(s);

      bar.appendChild(fill);
      row.appendChild(head);
      row.appendChild(bar);
      probList.appendChild(row);
    });

    $("balance").textContent = fmtUsd(accountBalance);
    const pnlEl = $("dailyPnl");
    pnlEl.textContent = (dailyPnL >= 0 ? "+" : "") + fmtUsd(Math.round(dailyPnL));
    pnlEl.style.color = dailyPnL >= 0 ? "rgba(52,211,153,0.95)" : "rgba(248,113,113,0.95)";
    $("exposure").textContent = fmtUsd(totalExposure);
    $("drawdown").textContent = `${maxDrawdown.toFixed(1)}%`;

    const rl = riskLevel();
    $("riskLevel").textContent = rl;
    $("riskTile").style.background = riskColor(rl);

    $("var95").textContent = fmtUsd(var95);
    $("varPct").textContent = fmtPct(var95 / accountBalance);
    $("cvar95").textContent = fmtUsd(cvar95);
    $("corr").textContent = fmtPct(correlation);
    $("corrMax").textContent = fmtPct(corrMax);
    $("beta").textContent = beta.toFixed(2);

    const ratio = clamp(correlation / corrMax, 0, 1);
    $("corrFill").style.width = `${ratio * 100}%`;
    $("corrFill").style.background = (correlation > corrMax) ? "rgba(245,158,11,0.95)" : "rgba(52,211,153,0.95)";

    $("alertCount").textContent = `${alerts.length} items`;
    const aWrap = $("alerts");
    aWrap.innerHTML = "";
    alerts.forEach(a => {
      const el = document.createElement("div");
      el.className = "alert";

      const sev = document.createElement("div");
      sev.className = `sev ${sevClass(a.severity)}`;
      sev.textContent = a.severity.toUpperCase();

      const msg = document.createElement("div");
      msg.className = "msg";
      msg.textContent = a.message;

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = a.time;

      el.appendChild(sev);
      el.appendChild(msg);
      el.appendChild(time);
      aWrap.appendChild(el);
    });

    $("posCount").textContent = "5";
    setLiveUI();
    updateFeedHealth();
  }

  function renderLogRow(row){
    const body = $("logBody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.time}</td>
      <td>${row.px}</td>
      <td>${row.state}</td>
      <td>${row.conf}</td>
      <td>${row.volx}</td>
      <td>${row.feed}</td>
    `;
    body.prepend(tr);

    // trim
    while (body.children.length > MAX_LOG_ROWS){
      body.removeChild(body.lastChild);
    }
  }

  async function tick(){
    if (!isLive) return;

    try{
      const px = await fetchEURUSD();
      lastSpot = px;
      lastGoodTs = Date.now();
      consecutiveFails = 0;

      const last = prices.length ? prices[prices.length - 1] : px;

      prices.push(px);
      if (prices.length > MAX_BUF) prices.shift();

      const r = (px - last) / last;
      rets.push(r);
      if (rets.length > MAX_BUF) rets.shift();

      if (prices.length < 10){
        pushAlert("info", `Warming up buffers (${prices.length}/10)…`);
        render();
        return;
      }

      const res = classifyRegime();
      rawState = res.state;
      rawConf = res.conf;
      rawVolX = res.volX;
      stateProbabilities = res.probs;

      const hyst = applyHysteresis(rawState, rawConf);
      $("hystStatus").textContent = hyst.status;

      // After hysteresis application, we publish smoothed confidence
      stateConfidence = rawConf;

      // update history on the smoothed state only
      stateHistory = stateHistory.slice(1);
      stateHistory.push(currentState);

      // demo pnl reacts to vol
      const volScale = clamp(rawVolX, 0.6, 3.0);
      dailyPnL += (Math.random() - 0.5) * 900 * volScale;

      // alerts
      if (hyst.changed){
        pushAlert("info", `Regime switched: State ${prevState} → State ${currentState} (${stateNames[currentState]}).`);
      }
      if (rawVolX > 1.8){
        pushAlert("warning", `Volatility expansion detected (x${rawVolX.toFixed(2)}). Tighten risk and consider reducing size.`);
      }
      if (currentState >= 7){
        pushAlert("critical", `Critical regime detected: State ${currentState}. Consider pausing entries and cutting exposure.`);
      }

      // log row
      renderLogRow({
        time: new Date().toLocaleTimeString(),
        px: px.toFixed(5),
        state: `S${currentState}`,
        conf: (stateConfidence * 100).toFixed(1) + "%",
        volx: rawVolX.toFixed(2),
        feed: lastFeedName
      });

      render();
    } catch(e){
      consecutiveFails += 1;
      pushAlert("warning", `Live EUR/USD feed error (${consecutiveFails}). Feed may be blocked. Trying fallbacks.`);
      render();
    }
  }

  // Buttons
  $("pauseBtn").addEventListener("click", () => {
    isLive = !isLive;
    pushAlert("info", isLive ? "System resumed (live ticks active)." : "System paused (ticks halted).");
    render();
  });

  $("syncBtn").addEventListener("click", () => {
    prices.length = 0;
    rets.length = 0;

    rawState = 1;
    rawConf = 0.82;
    rawVolX = 1.0;

    currentState = 1;
    prevState = 1;
    stateConfidence = 0.82;
    stateHistory = [1,1,1,2,1,1,1,1,3,3,3,1];
    stateProbabilities = { 1:82, 2:8, 3:5, 4:3, 5:1, 6:0.5, 7:0.3, 8:0.2 };

    holdTicks = 0;
    candidateState = null;
    candidateCount = 0;

    dailyPnL = 12500;
    alerts = [
      { severity:"info", message:"Sync complete. Buffers reset. Waiting for live price samples.", time:"Just now" }
    ];

    // clear log
    $("logBody").innerHTML = "";

    isLive = true;
    render();
  });

  $("reduceBtn").addEventListener("click", () => {
    totalExposure = Math.round(totalExposure * 0.5);
    pushAlert("warning", "Exposure reduced 50% (demo control).");
    render();
  });

  $("flattenBtn").addEventListener("click", () => {
    totalExposure = 0;
    pushAlert("critical", "Emergency flatten executed (demo control).");
    render();
  });

  // Boot
  renderEvents();
  render();
  tick();
  setInterval(tick, POLL_MS);

  // refresh events countdowns every 30s
  setInterval(renderEvents, 30000);
</script>
</body>
</html>
