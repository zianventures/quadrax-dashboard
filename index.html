<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QuadraX Risk Dashboard</title>
  <style>
    :root{
      --bg:#070b1f;
      --panel: rgba(18, 28, 66, 0.38);
      --panel2: rgba(11, 18, 48, 0.55);
      --border: rgba(94, 140, 255, 0.25);
      --text: rgba(235, 240, 255, 0.92);
      --muted: rgba(180, 198, 255, 0.72);
      --muted2: rgba(180, 198, 255, 0.55);
      --good:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 650px at 20% 15%, rgba(37,99,235,0.18), transparent 65%),
        radial-gradient(1000px 600px at 80% 25%, rgba(16,185,129,0.12), transparent 60%),
        radial-gradient(900px 700px at 60% 85%, rgba(245,158,11,0.08), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family: var(--sans);
      padding: 18px;
    }
    .container{max-width: 1700px; margin: 0 auto;}
    .topbar{
      background: linear-gradient(135deg, rgba(30,58,138,0.95) 0%, rgba(37,99,235,0.85) 100%);
      border: 1px solid rgba(191,219,254,0.35);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width: 320px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.20);
      font-weight: 900;
      letter-spacing: .5px;
    }
    .titlewrap h1{margin:0;font-size:18px;line-height:1.15}
    .titlewrap .sub{margin-top:3px;font-size:12px;color:rgba(219,234,254,0.9)}
    .topmeta{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:flex;align-items:center;gap:8px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
    }
    .dot{width:10px;height:10px;border-radius:999px;background: var(--good);box-shadow: 0 0 0 3px rgba(16,185,129,0.12)}
    .btn{
      border:none;cursor:pointer;
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 12px;
      color: rgba(255,255,255,0.95);
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.18);
    }
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background: rgba(14,165,233,0.20); border-color: rgba(14,165,233,0.30)}
    .btn.warn{background: rgba(245,158,11,0.22); border-color: rgba(245,158,11,0.35)}
    .btn.good{background: rgba(16,185,129,0.20); border-color: rgba(16,185,129,0.32)}

    select{
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      color: rgba(255,255,255,0.92);
      border-radius: 12px;
      padding: 9px 10px;
      font-weight: 800;
      font-size: 12px;
      outline:none;
    }
    option{color:#0b102a}

    .grid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }
    .col{display:flex;flex-direction:column;gap:16px}
    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), transparent 55%);
      pointer-events:none;
    }
    .card > *{position:relative}
    .card-title{
      display:flex;align-items:baseline;justify-content:space-between;gap:10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    h2{margin:0;font-size:14px;letter-spacing:0.6px;text-transform:uppercase;color: rgba(191,219,254,0.95)}
    .muted{color: var(--muted); font-size: 12px}
    .muted2{color: var(--muted2); font-size: 12px}
    .divider{height:1px;background: rgba(191,219,254,0.18);margin:12px 0}

    .stateTop{display:flex;justify-content:space-between;gap:14px;align-items:flex-start;flex-wrap: wrap;}
    .stateTitleLine{font-size: 30px;margin: 0;font-weight: 950;line-height: 1.1;}
    .stateMeta{margin-top:8px;color: rgba(212, 255, 233, 0.85);font-size: 13px}
    .bubble{
      width:72px;height:72px;border-radius:999px;
      display:grid;place-items:center;
      font-weight: 950;
      font-size: 26px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
    }
    .history{display:flex; gap:8px; flex-wrap:wrap;}
    .chip{
      width:36px;height:36px;border-radius:12px;
      display:grid;place-items:center;
      font-weight: 950;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.95);
      opacity: 0.9;
    }
    .bars{display:flex;flex-direction:column;gap:10px}
    .barRow{display:flex;justify-content:space-between;align-items:center;gap:10px;font-size: 12px}
    .barTrack{height:8px;border-radius:999px;background: rgba(0,0,0,0.35);overflow:hidden;border:1px solid rgba(255,255,255,0.06)}
    .barFill{height:100%;border-radius:999px;transition:width .25s ease}

    .miniGrid{display:grid;grid-template-columns: repeat(4, 1fr);gap: 10px;margin-top: 12px;}
    .mini{
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 10px;
    }
    .mini .k{font-size: 11px;color: var(--muted)}
    .mini .v{margin-top:6px;font-size: 18px;font-weight: 950}
    .mini .v.good{color: var(--good)}
    .mini .v.bad{color: var(--bad)}
    .mini .v.blue{color: rgba(96,165,250,0.95)}

    .table-wrap{
      background: rgba(0,0,0,0.20);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      overflow:hidden;
    }
    table{width:100%;border-collapse:collapse;font-size: 12px}
    th, td{padding: 10px 10px;border-bottom: 1px solid rgba(255,255,255,0.06);vertical-align:top}
    th{color: rgba(191,219,254,0.85);text-transform:uppercase;font-size: 11px;letter-spacing:.6px}
    tr:last-child td{border-bottom:none}
    .scroll{max-height: 240px; overflow:auto}
    .scroll::-webkit-scrollbar{height:10px;width:10px}
    .scroll::-webkit-scrollbar-thumb{background: rgba(255,255,255,0.10); border-radius: 999px}
    .mono{font-family: var(--mono)}
    a{color: rgba(96,165,250,0.95); text-decoration:none}
    a:hover{text-decoration:underline}

    .riskBox{
      text-align:center;
      padding: 18px 16px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.20);
    }
    .riskBig{font-size: 36px;font-weight: 950;margin: 0;}
    .statusBadge{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      font-size: 12px;
      font-weight: 900;
      display:inline-flex;align-items:center;gap:8px;
      white-space: nowrap;
    }
    .spinner{
      width:10px;height:10px;border-radius:999px;
      border: 2px solid rgba(255,255,255,0.25);
      border-top-color: rgba(255,255,255,0.85);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .badgeOk{color:#bbf7d0;background: rgba(16,185,129,0.12); border-color: rgba(16,185,129,0.25)}
    .badgeStale{color:#fde68a;background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.25)}
    .badgeDown{color:#fecaca;background: rgba(239,68,68,0.14); border-color: rgba(239,68,68,0.30)}
    .badgeSim{color:#c7d2fe;background: rgba(99,102,241,0.14); border-color: rgba(99,102,241,0.30)}

    .footer{
      margin-top: 16px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding: 12px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(10,14,39,0.45);
      box-shadow: var(--shadow);
      font-size: 12px;
      color: var(--muted);
    }

    @media(max-width: 1100px){
      .grid{grid-template-columns: 1fr}
      .brand{min-width: 0}
      .miniGrid{grid-template-columns: repeat(2, 1fr)}
    }
  </style>
</head>
<body>
  <div class="container">

    <div class="topbar">
      <div class="brand">
        <div class="logo">QX</div>
        <div class="titlewrap">
          <h1>QuadraX Risk Dashboard</h1>
          <div class="sub">Executive View: 8-State Monitoring and Control System (Reference EUR/USD)</div>
        </div>
      </div>

      <div class="topmeta">
        <div class="pill" title="Frontend demo status">
          <span class="dot" id="liveDot"></span>
          <b id="liveLabel">LIVE</b>
        </div>
        <div class="pill">
          Last Update <b id="lastUpdate">--</b>
        </div>

        <select id="sourceSelect" title="Force a specific provider (or auto)">
          <option value="AUTO">Source: AUTO</option>
        </select>

        <div class="pill" title="When reference feeds go stale, enable simulated micro ticks so the demo keeps moving">
          <input type="checkbox" id="simToggle" checked />
          <label for="simToggle" style="cursor:pointer;">Simulated Micro-Ticks on STALE</label>
        </div>

        <button class="btn warn" id="pauseBtn">Pause</button>
        <button class="btn primary" id="syncBtn">Sync</button>
      </div>
    </div>

    <div class="grid">
      <div class="col">

        <div class="card" id="stateCard">
          <div class="card-title">
            <h2>Current Market State</h2>
            <div class="muted2" id="stateNote">Reference EUR/USD feed driving regime (not broker ticks)</div>
          </div>

          <div class="stateTop">
            <div style="min-width: 0;">
              <div class="stateTitleLine" id="policyTitle">Policy State: S1 Mean-Reverting</div>
              <div class="muted2" id="detectorTitle" style="margin-top:6px;">Detector State (raw): S1 Mean-Reverting</div>

              <div class="stateMeta">
                Policy Confidence: <b id="stateConf">--</b>
              </div>

              <div class="muted" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px;">
                <span>Hysteresis: <b id="hystStatus">stable</b></span>
                <span>Hold ticks: <b id="holdTicks">0</b></span>
                <span>Tick: <b id="tickCount">0</b></span>
                <span>Last calc: <b id="lastCalc">--</b></span>
                <span>Top prob: <b id="topProb">--</b></span>
                <span>Cur prob: <b id="curProb">--</b></span>
                <span>Prob hash: <b id="probHash">----</b></span>
              </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px; align-items:flex-end;">
              <div class="bubble" id="stateBubble">1</div>
              <div class="muted2 mono" id="engineNote">engine: running</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted" style="margin-bottom:8px;">Recent Policy State History (Last 12 Updates)</div>
          <div class="history" id="historyRow"></div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>State Probability Distribution</h2>
            <div class="muted2">Conditional regime likelihoods P(State | features)</div>
          </div>
          <div class="bars" id="probBars"></div>
          <div class="muted" style="margin-top:10px;">
            If the feed is stale, probabilities will not update (or will be low-quality).
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>Portfolio Snapshot</h2>
            <div class="muted2">Demo placeholders until execution and risk feeds are connected</div>
          </div>
          <div class="miniGrid">
            <div class="mini"><div class="k">Account Balance</div><div class="v blue">$1,000,000</div></div>
            <div class="mini"><div class="k">Daily PnL</div><div class="v good">+$13,160</div></div>
            <div class="mini"><div class="k">Total Exposure</div><div class="v blue">$650,000</div></div>
            <div class="mini"><div class="k">Max Drawdown</div><div class="v bad">-3.2%</div></div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>Regime Log</h2>
            <div class="muted2">CSV-style telemetry (latest on top)</div>
          </div>
          <div class="table-wrap">
            <div class="scroll" style="max-height: 240px;">
              <table>
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>EURUSD</th>
                    <th>Detector</th>
                    <th>Policy</th>
                    <th>Conf</th>
                    <th>VolX</th>
                    <th>Mom</th>
                    <th>Feed</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="logBody"></tbody>
              </table>
            </div>
          </div>
          <div class="muted" style="margin-top:10px;">Tip: copy table, paste into Excel.</div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <div class="riskBox" id="riskBox">
            <div class="muted" style="letter-spacing:.6px;text-transform:uppercase;">Risk Level</div>
            <p class="riskBig" id="riskLevel">NORMAL</p>
            <div class="muted2">Policy: state-aware sizing and entry gating</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>Feed Health</h2>
            <div class="muted2">Proof the market data is updating</div>
          </div>

          <div class="table-wrap" style="padding:12px;">
            <div class="muted">EUR/USD Spot (reference)</div>
            <div style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-top:8px;">
              <div style="font-size:26px;font-weight:950;" class="mono" id="eurusdSpot">--</div>
              <div class="statusBadge" id="feedStatusBadge">
                <span class="spinner" id="feedSpinner"></span>
                <span id="feedStatusText">CHECKING</span>
              </div>
            </div>
            <div class="muted2" style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap;">
              <span>Last good sample: <b id="lastGood">--</b></span>
              <span>Source: <b id="feedSource">--</b></span>
              <span>Latency: <b id="feedLatency">--</b></span>
            </div>
            <div class="muted2" style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap;">
              <span>Delta (last): <b class="mono" id="pxDelta">--</b></span>
              <span>Stale polls: <b id="stalePolls">0</b></span>
              <span>Min move: <b class="mono" id="minMove">0.00001</b></span>
            </div>
            <div class="muted2" style="margin-top:8px;">
              If the provider repeats, we either pause (safe) or simulate micro ticks (demo mode) depending on your toggle.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>World Events Calendar</h2>
            <div class="muted2">Demo list (Forex Factory-style impact)</div>
          </div>
          <div class="table-wrap">
            <div class="scroll">
              <table>
                <thead>
                  <tr><th>When</th><th>Event</th><th>Impact</th><th>Countdown</th></tr>
                </thead>
                <tbody id="eventsBody"></tbody>
              </table>
            </div>
          </div>
          <div class="muted" style="margin-top:10px;">Red folder style: High impact events are ðŸŸ¥.</div>
        </div>

        <div class="card">
          <div class="card-title">
            <h2>Headlines</h2>
            <div class="muted2">Demo list (swap to backend later)</div>
          </div>
          <div class="table-wrap">
            <div class="scroll" style="max-height: 220px;">
              <table>
                <thead>
                  <tr><th>Time</th><th>Source</th><th>Headline</th></tr>
                </thead>
                <tbody id="headlinesBody"></tbody>
              </table>
            </div>
          </div>
          <div class="muted" style="margin-top:10px;">Click a headline to open the source.</div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>System: <b id="sysStatus">LIVE</b></div>
      <div>Policy State: <b id="policyFooter">S1</b></div>
      <div>Detector State: <b id="detectorFooter">S1</b></div>
      <div>Hysteresis Hold: <b id="holdFooter">0</b></div>
      <div>Feed Status: <b id="feedFooter">CHECKING</b></div>
    </div>

  </div>

<script>
const $ = (id) => document.getElementById(id);

// Polling cadence
const POLL_MS = 5000;

// Stale detection
const MIN_PRICE_CHANGE = 0.00001;
const STALE_POLLS_LIMIT = 6;

// Hysteresis tuning
const HOLD_TICKS_MIN = 8;
const SWITCH_MARGIN = 0.06;

// Simulated micro ticks
const SIM_SPREAD = 0.00005;      // 0.5 pip amplitude
const SIM_MEAN_REVERT = 0.18;    // pull back to last real anchor
let simEnabledOnStale = true;
let simAnchor = null;
let simPx = null;

const STATE_NAMES = {
  1:"Mean-Reverting",2:"Liquidity Vacuum",3:"Slow Drift",4:"Strong Trend",
  5:"Stop Cascade",6:"News Shock",7:"Dealer Unwind",8:"Panic/Forced"
};
const STATE_COLORS = {
  1:{fill:"#10b981",glow:"rgba(16,185,129,0.18)"},
  2:{fill:"#f59e0b",glow:"rgba(245,158,11,0.18)"},
  3:{fill:"#60a5fa",glow:"rgba(96,165,250,0.18)"},
  4:{fill:"#3b82f6",glow:"rgba(59,130,246,0.18)"},
  5:{fill:"#f97316",glow:"rgba(249,115,22,0.18)"},
  6:{fill:"#ef4444",glow:"rgba(239,68,68,0.18)"},
  7:{fill:"#a855f7",glow:"rgba(168,85,247,0.18)"},
  8:{fill:"#dc2626",glow:"rgba(220,38,38,0.18)"}
};

// Demo lists
function addMinutesUTC(mins){ return new Date(Date.now() + mins*60000).toISOString(); }
const DEMO_EVENTS = [
  { tsUtc: addMinutesUTC(60*6), title:"Eurozone CPI (flash)", impact:"High", url:"https://www.forexfactory.com/" },
  { tsUtc: addMinutesUTC(60*28), title:"US Initial Jobless Claims", impact:"Med", url:"https://www.forexfactory.com/" },
  { tsUtc: addMinutesUTC(60*52), title:"US GDP (advance)", impact:"High", url:"https://www.forexfactory.com/" },
  { tsUtc: addMinutesUTC(60*160), title:"US Non-Farm Payrolls", impact:"High", url:"https://www.forexfactory.com/" }
];
const DEMO_HEADLINES = [
  { tsUtc: new Date().toISOString(), source:"FinancialJuice", title:"Dollar firming ahead of major data window", url:"https://www.financialjuice.com/" },
  { tsUtc: new Date(Date.now()-18*60000).toISOString(), source:"FinancialJuice", title:"Rates repricing drives short-term USD bid", url:"https://www.financialjuice.com/" },
  { tsUtc: new Date(Date.now()-41*60000).toISOString(), source:"Market", title:"Risk tone mixed as equities stabilize", url:"https://www.financialjuice.com/" }
];

// More sources + cache busting
const PRICE_SOURCES = [
  {
    key:"open_er_api",
    name:"open.er-api.com",
    url:"https://open.er-api.com/v6/latest/EUR",
    parse:(j)=>Number(j?.rates?.USD||0)||null
  },
  {
    key:"exchangerate_api",
    name:"exchangerate-api.com",
    url:"https://api.exchangerate-api.com/v4/latest/EUR",
    parse:(j)=>Number(j?.rates?.USD||0)||null
  },
  {
    key:"frankfurter",
    name:"frankfurter.app",
    url:"https://api.frankfurter.app/latest?from=EUR&to=USD",
    parse:(j)=>Number(j?.rates?.USD||0)||null
  },
  {
    key:"exchangerate_host",
    name:"exchangerate.host",
    url:"https://api.exchangerate.host/latest?base=EUR&symbols=USD",
    parse:(j)=>Number(j?.rates?.USD||0)||null
  }
];

let forcedSourceKey = "AUTO";

// Engine state
let isLive = true;
let tickCounter = 0;

let eurusd = null;
let lastGoodTs = 0;
let lastSource = "--";
let lastLatencyMs = null;

let lastPxForDelta = null;
let lastDelta = null;

let stalePolls = 0;
let lastPxForStale = null;

let feedStatus = "CHECKING"; // CHECKING | LIVE | STALE | DOWN | SIMULATED

let priceSeries = [];
let retSeries = [];

let rawState = 1;
let rawConf = 0.80;
let smoothedState = 1;
let smoothedConf = 0.80;

let stateProbs = {1:82,2:8,3:5,4:3,5:1,6:0.5,7:0.3,8:0.2};
let stateHistory = [1,1,1,2,1,1,1,1,3,3,3,1];

let holdTicks = 0;
let lastCalcTs = 0;

// Utils
function fmt(n,d=5){ return Number.isFinite(n)?n.toFixed(d):"--"; }
function nowTime(){ return new Date().toLocaleTimeString(); }
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function countdownTo(tsUtc){
  const ts = Date.parse(tsUtc);
  if (!Number.isFinite(ts)) return "";
  const ms = ts - Date.now();
  if (ms <= 0) return "started";
  const mins = Math.floor(ms / 60000);
  const hrs = Math.floor(mins / 60);
  const days = Math.floor(hrs / 24);
  const remH = hrs % 24;
  const remM = mins % 60;
  if (days > 0) return `${days}d ${remH}h`;
  if (hrs > 0) return `${hrs}h ${remM}m`;
  return `${remM}m`;
}
function probHashFrom(probs){
  const parts = [];
  for (let k=1;k<=8;k++) parts.push(String(probs?.[k] ?? 0));
  const s = parts.join("|");
  let h = 2166136261;
  for (let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0).toString(16).slice(0,6).toUpperCase();
}

function setFeedStatus(kind){
  feedStatus = kind;
  const badge = $("feedStatusBadge");
  const spinner = $("feedSpinner");
  const label = $("feedStatusText");

  badge.classList.remove("badgeOk","badgeStale","badgeDown","badgeSim");
  spinner.style.display = "none";

  if (kind === "CHECKING"){
    spinner.style.display = "inline-block";
    label.textContent = "CHECKING";
  } else if (kind === "LIVE"){
    badge.classList.add("badgeOk");
    label.textContent = "LIVE";
  } else if (kind === "STALE"){
    badge.classList.add("badgeStale");
    label.textContent = "STALE";
  } else if (kind === "DOWN"){
    badge.classList.add("badgeDown");
    label.textContent = "DOWN";
  } else if (kind === "SIMULATED"){
    badge.classList.add("badgeSim");
    label.textContent = "SIMULATED";
  }

  $("feedFooter").textContent = kind;
}

function updateFeedHealthUI(){
  $("lastUpdate").textContent = nowTime();
  $("minMove").textContent = MIN_PRICE_CHANGE.toFixed(5);
  $("stalePolls").textContent = String(stalePolls);
  $("pxDelta").textContent = (lastDelta == null) ? "--" : lastDelta.toFixed(5);

  if (!lastGoodTs){
    $("eurusdSpot").textContent = "--";
    $("lastGood").textContent = "--";
    $("feedSource").textContent = "--";
    $("feedLatency").textContent = "--";
    return;
  }
  $("eurusdSpot").textContent = fmt(eurusd, 5);
  $("lastGood").textContent = new Date(lastGoodTs).toLocaleTimeString();
  $("feedSource").textContent = lastSource;
  $("feedLatency").textContent = (lastLatencyMs != null) ? `${Math.round(lastLatencyMs)}ms` : "--";
}

// Fetch helpers
async function fetchJsonWithTimeout(url, ms=4500){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), ms);
  const start = performance.now();
  try{
    // cache buster so GitHub Pages and browsers stop recycling old JSON
    const cb = `cb=${Date.now()}_${Math.floor(Math.random()*1e9)}`;
    const u = url + (url.includes("?") ? "&" : "?") + cb;

    const r = await fetch(u, {
      signal: controller.signal,
      cache: "no-store",
      headers: { "Cache-Control": "no-cache" }
    });
    const latency = performance.now() - start;
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const json = await r.json();
    return { json, latency };
  } finally {
    clearTimeout(t);
  }
}

async function fetchEURUSD(){
  const sources = (forcedSourceKey === "AUTO")
    ? PRICE_SOURCES
    : PRICE_SOURCES.filter(s => s.key === forcedSourceKey);

  for (const s of sources){
    try{
      const { json, latency } = await fetchJsonWithTimeout(s.url, 4500);
      const px = s.parse(json);
      if (Number.isFinite(px) && px > 0.5 && px < 2.5){
        return { px, src: s.name, latency };
      }
    } catch(e){
      // try next
    }
  }
  return null;
}

// Simulated micro ticks (demo only)
function stepSimulatedPx(){
  if (simAnchor == null){
    simAnchor = eurusd ?? 1.10;
    simPx = simAnchor;
  }
  const noise = (Math.random() - 0.5) * SIM_SPREAD;
  const pull = (simAnchor - simPx) * SIM_MEAN_REVERT;
  simPx = simPx + noise + pull;
  return simPx;
}

// Features + classifier
function pushSeries(px){
  priceSeries.push(px);
  if (priceSeries.length > 240) priceSeries.shift();

  if (priceSeries.length >= 2){
    const a = priceSeries[priceSeries.length-2];
    const b = priceSeries[priceSeries.length-1];
    const r = (b - a) / a;
    retSeries.push(r);
    if (retSeries.length > 240) retSeries.shift();
  }
}
function stddev(arr){
  if (arr.length < 2) return 0;
  const m = arr.reduce((s,x)=>s+x,0) / arr.length;
  const v = arr.reduce((s,x)=>s+(x-m)*(x-m),0) / (arr.length-1);
  return Math.sqrt(v);
}
function momentum(arr, k){
  if (arr.length < k+1) return 0;
  const a = arr[arr.length-1-k];
  const b = arr[arr.length-1];
  return (b - a) / a;
}
function sigmoid(x){ return 1 / (1 + Math.exp(-x)); }

function classifyRegime(){
  const rets = retSeries.slice(-60);
  const vol = stddev(rets);
  const volLong = stddev(retSeries.slice(-180));
  const volX = (volLong > 0) ? (vol / volLong) : 1.0;

  const mom = momentum(priceSeries, 12);
  const mom2 = momentum(priceSeries, 36);
  const absJump = Math.max(...rets.map(x=>Math.abs(x)), 0);

  const vScore = sigmoid((volX - 1.0) * 4.0);
  const mScore = sigmoid(Math.abs(mom) * 500);
  const driftScore = sigmoid(Math.abs(mom2) * 250);
  const jumpScore = sigmoid((absJump - 0.00012) * 2500);

  const w1 = (1 - vScore) * (1 - mScore) * 1.3;
  const w2 = vScore * (1 - mScore) * 1.0;
  const w3 = (1 - vScore*0.7) * driftScore * 1.1;
  const w4 = vScore * mScore * 1.2;
  const w5 = jumpScore * mScore * 1.4;
  const w6 = jumpScore * (1 - sigmoid((Math.abs(mom) - 0.00025) * 6000)) * 1.1;
  const w7 = vScore * driftScore * 0.9;
  const w8 = sigmoid((absJump - 0.00025) * 5000) * 2.0;

  const weights = [0,w1,w2,w3,w4,w5,w6,w7,w8];
  const sum = weights.reduce((s,x)=>s+x,0) || 1;

  const probs = {};
  for (let i=1;i<=8;i++){
    probs[i] = +(weights[i] / sum * 100).toFixed(1);
  }
  let best = 1, bestP = probs[1];
  for (let i=2;i<=8;i++){
    if (probs[i] > bestP){ best=i; bestP=probs[i]; }
  }
  const conf = Math.min(0.99, Math.max(0.50, bestP/100));
  return { best, conf, probs, volX, mom };
}

function applyHysteresis(rawBest, rawConfidence, probs){
  if (rawBest === smoothedState){
    holdTicks = 0;
    smoothedConf = rawConfidence;
    return { status: "stable" };
  }

  holdTicks += 1;
  const curP = (probs?.[smoothedState] ?? 0) / 100;
  const newP = (probs?.[rawBest] ?? 0) / 100;

  const marginOk = (newP - curP) >= SWITCH_MARGIN;
  const holdOk = holdTicks >= HOLD_TICKS_MIN;

  if (holdOk && marginOk){
    smoothedState = rawBest;
    smoothedConf = rawConfidence;
    holdTicks = 0;
    return { status: "switch" };
  }
  return { status: marginOk ? "holding (waiting hold)" : "holding (margin too small)" };
}

// Rendering
function renderHistory(){
  const row = $("historyRow");
  row.innerHTML = "";
  stateHistory.slice(-12).forEach((s, idx) => {
    const el = document.createElement("div");
    el.className = "chip";
    el.textContent = String(s);
    el.style.boxShadow = `0 0 0 6px ${STATE_COLORS[s].glow}`;
    el.style.opacity = idx === stateHistory.length-1 ? 1 : (0.35 + idx/12*0.55);
    row.appendChild(el);
  });
}

function renderStateCard(hyst){
  const policy = smoothedState;
  const detector = rawState;

  const color = STATE_COLORS[policy].fill;
  $("stateBubble").textContent = String(policy);
  $("stateBubble").style.background = color;
  $("stateBubble").style.boxShadow = `0 0 0 10px ${STATE_COLORS[policy].glow}`;

  $("policyTitle").textContent = `Policy State: S${policy} ${STATE_NAMES[policy]}`;
  $("detectorTitle").textContent = `Detector State (raw): S${detector} ${STATE_NAMES[detector]}`;

  $("stateConf").textContent = `${(smoothedConf*100).toFixed(1)}%`;

  $("tickCount").textContent = String(tickCounter);
  $("lastCalc").textContent = new Date(lastCalcTs).toLocaleTimeString();
  $("hystStatus").textContent = hyst.status;
  $("holdTicks").textContent = String(holdTicks);

  $("topProb").textContent = `${(stateProbs?.[rawState] ?? 0).toFixed(1)}%`;
  $("curProb").textContent = `${(stateProbs?.[smoothedState] ?? 0).toFixed(1)}%`;
  $("probHash").textContent = probHashFrom(stateProbs);

  $("policyFooter").textContent = `S${smoothedState}`;
  $("detectorFooter").textContent = `S${rawState}`;
  $("holdFooter").textContent = String(holdTicks);

  const note = (feedStatus === "STALE" || feedStatus === "DOWN") ? "engine: paused" : "engine: running";
  $("engineNote").textContent = note;
}

function renderProbBars(){
  const wrap = $("probBars");
  wrap.innerHTML = "";
  for (let i=1;i<=8;i++){
    const prob = stateProbs[i] ?? 0;
    const row = document.createElement("div");
    row.innerHTML = `
      <div class="barRow">
        <div>State ${i}: ${STATE_NAMES[i]}</div>
        <div style="font-weight:950;color:${STATE_COLORS[i].fill}">${prob}%</div>
      </div>
      <div class="barTrack"><div class="barFill" style="width:${Math.max(0,Math.min(100,prob))}%; background:${STATE_COLORS[i].fill}"></div></div>
    `;
    wrap.appendChild(row);
  }
}

function computeRiskLevel(){
  if (smoothedState >= 7) return "CRITICAL";
  if (smoothedState >= 5) return "HIGH";
  if (smoothedState === 2) return "ELEVATED";
  if (smoothedState === 3 || smoothedState === 4) return "MODERATE";
  return "NORMAL";
}
function renderRisk(){
  $("riskLevel").textContent = computeRiskLevel();
}

function impactBadgeHtml(impact){
  const x = String(impact||"").toLowerCase();
  if (x.includes("high")) return `<span class="statusBadge" style="color:#fecaca;background:rgba(239,68,68,0.12);border-color:rgba(239,68,68,0.25)">ðŸŸ¥ HIGH</span>`;
  if (x.includes("med")) return `<span class="statusBadge" style="color:#ffedd5;background:rgba(245,158,11,0.12);border-color:rgba(245,158,11,0.25)">ðŸŸ§ MED</span>`;
  return `<span class="statusBadge" style="color:#fef9c3;background:rgba(234,179,8,0.10);border-color:rgba(234,179,8,0.20)">ðŸŸ¨ LOW</span>`;
}

function renderDemoEvents(){
  const body = $("eventsBody");
  body.innerHTML = "";
  DEMO_EVENTS.forEach(ev => {
    const whenLocal = new Date(ev.tsUtc).toLocaleString();
    const cd = countdownTo(ev.tsUtc);
    const titleCell = ev.url
      ? `<a href="${ev.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(ev.title)}</a>`
      : escapeHtml(ev.title);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(whenLocal)}</td>
      <td>${titleCell}</td>
      <td>${impactBadgeHtml(ev.impact)}</td>
      <td class="mono">${escapeHtml(cd)}</td>
    `;
    body.appendChild(tr);
  });
}

function renderDemoHeadlines(){
  const body = $("headlinesBody");
  body.innerHTML = "";
  DEMO_HEADLINES.forEach(h => {
    const t = new Date(h.tsUtc).toLocaleTimeString();
    const titleCell = h.url
      ? `<a href="${h.url}" target="_blank" rel="noopener noreferrer" style="color:rgba(230,234,242,0.92);">${escapeHtml(h.title)}</a>`
      : escapeHtml(h.title);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(t)}</td>
      <td>${escapeHtml(h.source)}</td>
      <td>${titleCell}</td>
    `;
    body.appendChild(tr);
  });
}

function appendLogRow({px, rawS, smoothS, conf, volx, mom, feed, status}){
  const body = $("logBody");
  const tr = document.createElement("tr");
  const t = new Date().toLocaleTimeString();
  tr.innerHTML = `
    <td class="mono">${escapeHtml(t)}</td>
    <td class="mono">${escapeHtml(fmt(px,5))}</td>
    <td class="mono">S${escapeHtml(rawS)}</td>
    <td class="mono">S${escapeHtml(smoothS)}</td>
    <td class="mono">${escapeHtml((conf*100).toFixed(1))}%</td>
    <td class="mono">${escapeHtml(volx.toFixed(2))}</td>
    <td class="mono">${escapeHtml((mom*10000).toFixed(2))}bp</td>
    <td class="mono">${escapeHtml(feed)}</td>
    <td class="mono">${escapeHtml(status)}</td>
  `;
  body.insertBefore(tr, body.firstChild);
  while (body.children.length > 80) body.removeChild(body.lastChild);
}

// Main tick
async function tick(){
  if (!isLive) return;

  $("sysStatus").textContent = "LIVE";
  $("liveLabel").textContent = "LIVE";
  $("liveDot").style.background = "var(--good)";

  setFeedStatus("CHECKING");
  $("stateNote").textContent = "Fetching reference EUR/USD feed...";
  updateFeedHealthUI();

  const res = await fetchEURUSD();

  if (!res){
    setFeedStatus("DOWN");
    $("stateNote").textContent = "Feed DOWN: endpoints unreachable. Engine paused.";
    lastCalcTs = Date.now();
    tickCounter += 1;
    updateFeedHealthUI();
    renderStateCard({status:"paused (down)"});
    return;
  }

  eurusd = res.px;
  lastSource = res.src;
  lastLatencyMs = res.latency;
  lastGoodTs = Date.now();

  // Delta
  if (lastPxForDelta == null) lastPxForDelta = eurusd;
  lastDelta = eurusd - lastPxForDelta;
  lastPxForDelta = eurusd;

  // Stale detection
  if (lastPxForStale == null) lastPxForStale = eurusd;
  if (Math.abs(eurusd - lastPxForStale) < MIN_PRICE_CHANGE){
    stalePolls += 1;
  } else {
    stalePolls = 0;
    lastPxForStale = eurusd;
    // when we get a real move, reset simulation anchor
    simAnchor = eurusd;
    simPx = eurusd;
  }

  const isStale = stalePolls >= STALE_POLLS_LIMIT;
  const allowSim = simEnabledOnStale;

  // If stale and sim is enabled, generate micro ticks for demo breathing
  if (isStale && allowSim){
    setFeedStatus("SIMULATED");
    $("stateNote").textContent = "Feed STALE: provider not updating. Using SIMULATED micro ticks for demo breathing.";
    eurusd = stepSimulatedPx();
    lastSource = (forcedSourceKey === "AUTO") ? "SIM (stale fallback)" : `SIM (${forcedSourceKey})`;
  } else if (isStale && !allowSim){
    setFeedStatus("STALE");
    $("stateNote").textContent = "Feed STALE: provider not updating. Engine paused (safe).";
    lastCalcTs = Date.now();
    tickCounter += 1;
    updateFeedHealthUI();
    appendLogRow({
      px: eurusd, rawS: rawState, smoothS: smoothedState,
      conf: smoothedConf, volx: 0, mom: 0, feed: lastSource, status:"STALE"
    });
    renderRisk();
    renderHistory();
    renderProbBars();
    renderStateCard({status:"paused (stale feed)"});
    return;
  } else {
    setFeedStatus("LIVE");
    $("stateNote").textContent = "Reference EUR/USD feed driving regime (not broker ticks).";
  }

  // Update model
  pushSeries(eurusd);
  const out = classifyRegime();

  rawState = out.best;
  rawConf = out.conf;
  stateProbs = out.probs;

  const hyst = applyHysteresis(rawState, rawConf, stateProbs);

  // history uses policy state
  if (stateHistory[stateHistory.length-1] !== smoothedState){
    stateHistory.push(smoothedState);
    if (stateHistory.length > 12) stateHistory = stateHistory.slice(-12);
  } else if (stateHistory.length < 12){
    stateHistory.push(smoothedState);
  }

  tickCounter += 1;
  lastCalcTs = Date.now();

  updateFeedHealthUI();
  renderHistory();
  renderProbBars();
  renderStateCard(hyst);
  renderRisk();

  appendLogRow({
    px: eurusd,
    rawS: rawState,
    smoothS: smoothedState,
    conf: smoothedConf,
    volx: out.volX,
    mom: out.mom,
    feed: lastSource,
    status: feedStatus
  });
}

// Controls
$("pauseBtn").addEventListener("click", () => {
  isLive = !isLive;
  if (isLive){
    $("pauseBtn").textContent = "Pause";
    $("pauseBtn").classList.remove("good");
    $("pauseBtn").classList.add("warn");
    tick();
  } else {
    $("pauseBtn").textContent = "Resume";
    $("pauseBtn").classList.remove("warn");
    $("pauseBtn").classList.add("good");
    $("sysStatus").textContent = "PAUSED";
    $("liveLabel").textContent = "PAUSED";
    $("liveDot").style.background = "rgba(160,174,192,0.9)";
    setFeedStatus("STALE");
    $("stateNote").textContent = "Paused by user.";
    updateFeedHealthUI();
    renderStateCard({status:"paused (user)"});
  }
});

$("syncBtn").addEventListener("click", () => tick());

$("simToggle").addEventListener("change", (e) => {
  simEnabledOnStale = !!e.target.checked;
});

$("sourceSelect").addEventListener("change", (e) => {
  forcedSourceKey = e.target.value;
  stalePolls = 0;
  lastPxForStale = null;
  tick();
});

// Init select
function initSourceDropdown(){
  const sel = $("sourceSelect");
  for (const s of PRICE_SOURCES){
    const opt = document.createElement("option");
    opt.value = s.key;
    opt.textContent = `Source: ${s.name}`;
    sel.appendChild(opt);
  }
}

// Init
function init(){
  initSourceDropdown();
  renderDemoEvents();
  renderDemoHeadlines();
  renderHistory();
  renderProbBars();
  renderRisk();
  updateFeedHealthUI();

  tick();
  setInterval(() => { if (isLive) tick(); }, POLL_MS);
  setInterval(() => { renderDemoEvents(); }, 60_000);
}
init();
</script>
</body>
</html>
