<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuadraX Risk Dashboard</title>
  <style>
    :root{
      --bg:#070b1f;
      --panel: rgba(17, 33, 74, 0.55);
      --panel2: rgba(9, 17, 45, 0.75);
      --stroke: rgba(96,165,250,0.28);
      --stroke2: rgba(96,165,250,0.18);
      --text:#e6eefc;
      --muted:#9db2d6;
      --blue:#60a5fa;
      --blue2:#3b82f6;
      --green:#10b981;
      --amber:#f59e0b;
      --orange:#f97316;
      --red:#ef4444;
      --violet:#a855f7;
      --shadow: 0 18px 60px rgba(0,0,0,0.55);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(59,130,246,0.22), transparent 55%),
        radial-gradient(1000px 650px at 80% 35%, rgba(16,185,129,0.18), transparent 55%),
        radial-gradient(900px 600px at 45% 90%, rgba(168,85,247,0.12), transparent 60%),
        linear-gradient(180deg, #05071a, #070b1f 30%, #05071a);
      overflow-x:hidden;
    }

    .wrap{max-width: 1500px; margin: 18px auto 26px; padding: 0 16px;}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding: 16px 18px;
      border-radius: 22px;
      background: linear-gradient(135deg, rgba(30,58,138,0.85), rgba(59,130,246,0.65));
      border: 1px solid rgba(191,219,254,0.35);
      box-shadow: var(--shadow);
      position: sticky; top: 10px; z-index: 5;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .qx{
      width:44px; height:44px; border-radius: 14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
      font-weight: 900;
      letter-spacing: 0.5px;
    }
    .brand h1{font-size: 18px; margin:0; line-height: 1.05}
    .brand .sub{margin-top: 4px; color: rgba(219,234,254,0.9); font-size: 12px}

    .controls{display:flex; gap:10px; align-items:center;}
    .pill{
      display:flex; gap:8px; align-items:center;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(2,6,23,0.35);
      border: 1px solid rgba(255,255,255,0.16);
      color: rgba(226,232,240,0.95);
      font-size: 12px;
      backdrop-filter: blur(8px);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--green);
      box-shadow: 0 0 0 3px rgba(16,185,129,0.18);
    }
    .btn{
      padding: 9px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(2,6,23,0.35);
      color: var(--text);
      cursor:pointer;
      font-weight: 700;
      font-size: 12px;
      display:flex; gap:8px; align-items:center;
      backdrop-filter: blur(10px);
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(191,219,254,0.38)}
    .btn.primary{background: rgba(16,185,129,0.20); border-color: rgba(16,185,129,0.30)}
    .btn.warn{background: rgba(245,158,11,0.22); border-color: rgba(245,158,11,0.30)}
    .btn.ghost{background: rgba(2,6,23,0.18)}

    .grid{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      margin-top: 16px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .grid{grid-template-columns: 1fr}
      .topbar{position:relative; top:0}
      .controls{flex-wrap: wrap; justify-content:flex-end}
    }

    .col{display:flex; flex-direction:column; gap:16px;}
    .card{
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(17,33,74,0.52), rgba(9,17,45,0.70));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex; justify-content:space-between; align-items:center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--stroke2);
      background: rgba(2,6,23,0.20);
    }
    .card .hd .t{font-weight: 900; letter-spacing: .7px; font-size: 13px; color: rgba(226,232,240,0.95)}
    .card .hd .s{font-size: 12px; color: var(--muted)}
    .card .bd{padding: 16px;}

    .stateBox{
      position:relative;
      border-radius: var(--radius);
      background:
        radial-gradient(900px 300px at 12% 20%, rgba(16,185,129,0.18), transparent 60%),
        radial-gradient(900px 300px at 60% 10%, rgba(59,130,246,0.18), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,0.18), rgba(2,6,23,0.40));
      border: 1px solid rgba(16,185,129,0.25);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
      padding: 18px;
      min-height: 190px;
    }
    .stateRow{display:flex; gap:18px; align-items:flex-start; justify-content:space-between;}
    .stateMeta{flex:1;}
    .kicker{font-size:12px; color: rgba(219,234,254,0.85); letter-spacing:.9px; font-weight:800}
    .big{font-size: 34px; font-weight: 950; margin: 8px 0 6px}
    .metaLine{display:flex; flex-wrap:wrap; gap:10px; color: var(--muted); font-size:12px}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      font-size: 12px;
      color: rgba(226,232,240,0.92);
    }
    .bubble{
      width: 78px; height: 78px; border-radius: 999px;
      display:grid; place-items:center;
      font-weight: 950;
      font-size: 30px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.22);
      box-shadow: inset 0 0 0 4px rgba(255,255,255,0.04);
    }

    .hist{display:flex; gap:8px; flex-wrap:wrap; margin-top: 14px;}
    .hist .h{
      width: 36px; height: 36px; border-radius: 11px;
      display:grid; place-items:center;
      font-weight: 900; font-size: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(2,6,23,0.26);
      color: rgba(226,232,240,0.92);
      opacity: 0.55;
    }
    .hist .h.last{opacity:1; box-shadow: 0 0 0 2px rgba(96,165,250,0.16)}

    .bars{display:grid; gap:12px;}
    .barRow{display:grid; grid-template-columns: 1.4fr 0.6fr; gap:10px; align-items:center;}
    .barLabel{display:flex; justify-content:space-between; align-items:baseline; gap:10px; font-size: 12px; color: rgba(226,232,240,0.92)}
    .barLabel small{color: var(--muted)}
    .bar{
      height: 8px; border-radius:999px;
      background: rgba(0,0,0,0.28);
      border: 1px solid rgba(255,255,255,0.06);
      overflow:hidden;
    }
    .bar > i{display:block; height:100%; width:0%; border-radius:999px; transition: width .35s ease;}
    .pct{font-family: var(--mono); font-size: 12px; text-align:right; color: rgba(226,232,240,0.92)}
    .note{margin-top: 10px; font-size: 12px; color: var(--muted)}

    .riskBox{
      text-align:center;
      padding: 18px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.14);
      background: linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.32));
    }
    .riskBox .lvl{font-weight: 950; font-size: 40px; margin: 6px 0 6px}
    .riskBox .pol{font-size: 12px; color: var(--muted)}

    .healthGrid{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .health{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      padding: 12px;
      min-height: 94px;
    }
    .health .k{font-size: 12px; color: var(--muted); margin-bottom: 6px}
    .health .v{font-size: 28px; font-weight: 950; font-family: var(--mono)}
    .health .sub{font-size: 12px; color: var(--muted); margin-top: 6px}
    .statusPill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(2,6,23,0.28);
    }
    .statusPill i{
      width:10px; height:10px; border-radius:999px; display:inline-block;
      background: var(--amber);
      box-shadow: 0 0 0 3px rgba(245,158,11,0.18);
    }

    .table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      font-size: 12px;
    }
    .table thead th{
      text-align:left;
      padding: 10px 10px;
      color: rgba(226,232,240,0.92);
      border-bottom: 1px solid rgba(255,255,255,0.10);
      font-weight: 900;
      letter-spacing: .5px;
      background: rgba(2,6,23,0.24);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .table tbody td{
      padding: 9px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      color: rgba(226,232,240,0.90);
      vertical-align: top;
    }
    .table tbody tr:last-child td{border-bottom:none}
    .scroll{max-height: 280px; overflow:auto; border-radius: 14px;}
    .muted{color: var(--muted)}
    .mono{font-family: var(--mono)}
    .impact{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 950;
      letter-spacing: .4px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(2,6,23,0.25);
      font-size: 12px;
    }
    .impact .sq{width: 10px; height: 10px; border-radius: 3px; background: var(--amber)}
    .impact.high .sq{background: #ff3b7a; box-shadow: 0 0 0 3px rgba(255,59,122,0.18)}
    .impact.med .sq{background: #ffb020; box-shadow: 0 0 0 3px rgba(255,176,32,0.18)}
    .impact.low .sq{background: #4ade80; box-shadow: 0 0 0 3px rgba(74,222,128,0.14)}

    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color: rgba(226,232,240,0.90);
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{border-color: rgba(191,219,254,0.30)}
    .chip small{color: var(--muted); font-weight: 800}

    .spark{
      height: 46px;
      width: 240px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.22);
      padding: 6px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    canvas{display:block}
    .spark .meta{display:flex; flex-direction:column; gap:2px}
    .spark .meta .a{font-family: var(--mono); font-size: 12px; font-weight: 900}
    .spark .meta .b{font-size: 11px; color: var(--muted)}

    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.65);
      display:none;
      align-items:center; justify-content:center;
      z-index: 50;
      padding: 18px;
    }
    .modal{
      width:min(860px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(191,219,254,0.25);
      background: linear-gradient(180deg, rgba(10,18,48,0.92), rgba(5,10,28,0.96));
      box-shadow: 0 30px 90px rgba(0,0,0,0.7);
      overflow:hidden;
    }
    .modal .mh{
      padding: 14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid rgba(191,219,254,0.18);
      background: rgba(2,6,23,0.25);
    }
    .modal .mh .t{font-weight: 950}
    .modal .mb{padding: 14px 16px}
    textarea{
      width:100%;
      min-height: 240px;
      border-radius: 14px;
      border: 1px solid rgba(191,219,254,0.22);
      background: rgba(0,0,0,0.28);
      color: rgba(226,232,240,0.92);
      padding: 12px;
      font-family: var(--mono);
      font-size: 12px;
      outline:none;
      line-height: 1.45;
    }
    .rowBtns{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top: 12px}
    .foot{
      margin-top: 14px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .ok{color: rgba(74,222,128,0.95)}
    .warnTxt{color: rgba(245,158,11,0.95)}
    .bad{color: rgba(239,68,68,0.95)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="qx">QX</div>
        <div>
          <h1>QuadraX Risk Dashboard</h1>
          <div class="sub">Executive View: 8-State Monitoring and Control System (Live EUR/USD Spot)</div>
        </div>
      </div>

      <div class="controls">
        <div class="pill" id="livePill">
          <span class="dot" id="liveDot"></span>
          <span id="liveLabel">LIVE</span>
        </div>
        <div class="pill">
          <span class="muted">Last Update</span>
          <span class="mono" id="lastUpdate">--</span>
        </div>
        <button class="btn warn" id="pauseBtn">Pause</button>
        <button class="btn primary" id="syncBtn">Sync</button>
        <button class="btn ghost" id="editFeedsBtn">Edit Events + Headlines</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left column -->
      <div class="col">
        <div class="stateBox card">
          <div class="stateRow">
            <div class="stateMeta">
              <div class="kicker">CURRENT MARKET STATE</div>
              <div class="big" id="policyTitle">Policy State: S1 Mean-Reverting</div>

              <div class="metaLine">
                <span class="badge"><b>Detector</b> <span class="mono" id="detectorState">S1</span></span>
                <span class="badge"><b>Policy</b> <span class="mono" id="policyState">S1</span></span>
                <span class="badge"><b>Confidence</b> <span class="mono" id="policyConf">--</span></span>
                <span class="badge"><b>Hysteresis</b> <span class="mono" id="hystLine">stable</span></span>
                <span class="badge"><b>Tick</b> <span class="mono" id="tickCount">0</span></span>
                <span class="badge"><b>Stale</b> <span class="mono" id="staleCount">0</span></span>
              </div>

              <div class="hist" id="stateHistory"></div>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px; align-items:flex-end;">
              <div class="spark">
                <div class="meta">
                  <div class="a" id="spotSmall">EURUSD: --</div>
                  <div class="b" id="spotDelta">Δ: --</div>
                </div>
                <canvas id="spark" width="120" height="34" aria-label="sparkline"></canvas>
              </div>

              <div class="bubble" id="stateBubble">1</div>

              <div class="badge" style="justify-content:flex-end;">
                <b>Feed</b> <span class="mono" id="feedName">--</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div class="t">STATE PROBABILITY DISTRIBUTION</div>
            <div class="s">Conditional regime likelihoods P(state | features)</div>
          </div>
          <div class="bd">
            <div class="bars" id="bars"></div>
            <div class="note">Note: With free endpoints, updates are spot-sampled (not broker ticks). This is still real price, just lower frequency.</div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div class="t">PORTFOLIO SNAPSHOT</div>
            <div class="s">Demo placeholders until execution and risk feeds are connected</div>
          </div>
          <div class="bd">
            <div class="chips">
              <div class="chip"><span class="muted">Account Balance</span> <b class="mono">$1,000,000</b></div>
              <div class="chip"><span class="muted">Daily PnL</span> <b class="mono ok">+$13,160</b></div>
              <div class="chip"><span class="muted">Total Exposure</span> <b class="mono">$650,000</b></div>
              <div class="chip"><span class="muted">Max Drawdown</span> <b class="mono bad">-3.2%</b></div>
            </div>
            <div class="foot">This section is intentionally demo. Tonight the goal is accurate regime visualization on real EUR/USD spot.</div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div class="t">REGIME LOG</div>
            <div class="s">CSV-style telemetry (latest on top)</div>
          </div>
          <div class="bd">
            <div class="rowBtns" style="justify-content:flex-start; margin:0 0 10px 0;">
              <button class="btn ghost" id="copyLogBtn">Copy as CSV</button>
              <button class="btn ghost" id="clearLogBtn">Clear</button>
            </div>
            <div class="scroll">
              <table class="table" id="logTable">
                <thead>
                  <tr>
                    <th>TIME</th>
                    <th>EURUSD</th>
                    <th>DET</th>
                    <th>POL</th>
                    <th>CONF</th>
                    <th>VOL X</th>
                    <th>MOM (bp)</th>
                    <th>STALE</th>
                    <th>SRC</th>
                  </tr>
                </thead>
                <tbody id="logBody"></tbody>
              </table>
            </div>
            <div class="foot">Tip: Copy CSV, paste into Excel. It splits cleanly.</div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div class="col">
        <div class="card">
          <div class="hd">
            <div class="t">RISK LEVEL</div>
            <div class="s">Policy: state-aware sizing and entry gating</div>
          </div>
          <div class="bd">
            <div class="riskBox" id="riskBox">
              <div class="muted">Risk Level</div>
              <div class="lvl" id="riskLevel">NORMAL</div>
              <div class="pol" id="riskPolicy">Rule: Lower exposure as states move toward 5-8</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div class="t">FEED HEALTH</div>
            <div class="s">Proof the market data is updating</div>
          </div>
          <div class="bd">
            <div class="healthGrid">
              <div class="health">
                <div class="k">EUR/USD Spot (reference)</div>
                <div class="v" id="spot">--</div>
                <div class="sub">Last good sample: <span class="mono" id="lastGood">--</span></div>
              </div>
              <div class="health">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <div class="k">Status</div>
                  <span class="statusPill" id="statusPill"><i></i><span id="statusTxt">CHECKING</span></span>
                </div>
                <div class="sub">Source: <span class="mono" id="source">--</span></div>
                <div class="sub">Latency: <span class="mono" id="latency">--</span></div>
                <div class="sub">Delta (last): <span class="mono" id="delta">--</span></div>
                <div class="sub">Stale polls: <span class="mono" id="stalePol">0</span></div>
              </div>
            </div>
            <div class="foot">
              If spot is not changing for a while, this might be normal (quiet market) or it might be endpoint throttling.
              This dashboard never invents price.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div class="t">WORLD EVENTS CALENDAR</div>
            <div class="s">Fastest reliable mode tonight: curated list (saved locally)</div>
          </div>
          <div class="bd">
            <div class="scroll" style="max-height: 250px;">
              <table class="table">
                <thead>
                  <tr>
                    <th>WHEN</th>
                    <th>EVENT</th>
                    <th>IMPACT</th>
                    <th>COUNTDOWN</th>
                  </tr>
                </thead>
                <tbody id="eventsBody"></tbody>
              </table>
            </div>
            <div class="foot">Red folder style: High impact events are <span class="impact high"><span class="sq"></span>HIGH</span></div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div class="t">HEADLINES</div>
            <div class="s">Fastest reliable mode tonight: curated list (saved locally)</div>
          </div>
          <div class="bd">
            <div class="scroll" style="max-height: 250px;">
              <table class="table">
                <thead>
                  <tr>
                    <th>TIME</th>
                    <th>SOURCE</th>
                    <th>HEADLINE</th>
                  </tr>
                </thead>
                <tbody id="headlinesBody"></tbody>
              </table>
            </div>
            <div class="foot">Click opens source in a new tab.</div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div class="t">DAILY EUR/USD TREND</div>
            <div class="s">Embedded TradingView chart (no backend needed)</div>
          </div>
          <div class="bd" style="padding:0;">
            <div style="height: 360px;">
              <!-- TradingView Widget BEGIN -->
              <div class="tradingview-widget-container" style="height:100%;width:100%;">
                <div id="tv_chart" style="height:100%;width:100%;"></div>
              </div>
              <!-- TradingView Widget END -->
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal for paste feeds -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="mh">
        <div class="t">Edit Events + Headlines (Saved Locally)</div>
        <button class="btn ghost" id="closeModal">Close</button>
      </div>
      <div class="mb">
        <div class="foot">
          Paste JSON here to update the calendar and headlines. This avoids unreliable browser scraping and works tonight.
          Data saves in your browser (localStorage).
        </div>

        <div style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div>
            <div class="kicker" style="margin-bottom:8px;">Events JSON</div>
            <textarea id="eventsJson" spellcheck="false"></textarea>
          </div>
          <div>
            <div class="kicker" style="margin-bottom:8px;">Headlines JSON</div>
            <textarea id="headsJson" spellcheck="false"></textarea>
          </div>
        </div>

        <div class="rowBtns">
          <button class="btn ghost" id="resetFeeds">Reset to Defaults</button>
          <button class="btn primary" id="saveFeeds">Save</button>
        </div>

        <div class="foot">
          Events format: [{ "ts":"2026-02-19T13:30:00Z", "title":"US GDP (advance)", "impact":"HIGH" }, ...]<br/>
          Headlines format: [{ "ts":"2026-02-18T15:10:00Z", "source":"FinancialJuice", "title":"Rates repricing drives short-term USD bid", "url":"https://..." }, ...]
        </div>
      </div>
    </div>
  </div>

  <!-- TradingView script -->
  <script src="https://s3.tradingview.com/tv.js"></script>

  <script>
    // --------------------------
    // 0) Constants and helpers
    // --------------------------
    const STATE_NAMES = {
      1: "Mean-Reverting",
      2: "Liquidity Vacuum",
      3: "Slow Drift",
      4: "Strong Trend",
      5: "Stop Cascade",
      6: "News Shock",
      7: "Dealer Unwind",
      8: "Panic/Forced"
    };

    const STATE_COLORS = {
      1: {bar:"#4ade80", bubble:"#10b981"},
      2: {bar:"#fbbf24", bubble:"#f59e0b"},
      3: {bar:"#60a5fa", bubble:"#3b82f6"},
      4: {bar:"#3b82f6", bubble:"#2563eb"},
      5: {bar:"#f97316", bubble:"#f97316"},
      6: {bar:"#ef4444", bubble:"#ef4444"},
      7: {bar:"#a855f7", bubble:"#a855f7"},
      8: {bar:"#dc2626", bubble:"#dc2626"}
    };

    const fmt = (n, d=5) => (typeof n === "number" ? n.toFixed(d) : "--");
    const nowStr = () => new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));

    function softmax(scores){
      const m = Math.max(...scores);
      const exps = scores.map(s => Math.exp(s - m));
      const sum = exps.reduce((a,b)=>a+b,0) || 1;
      return exps.map(e => e/sum);
    }

    function bp(x){ // decimal return to basis points
      return x * 10000;
    }

    function safeJsonParse(text, fallback){
      try { return JSON.parse(text); } catch { return fallback; }
    }

    // --------------------------
    // 1) DOM refs
    // --------------------------
    const el = {
      lastUpdate: document.getElementById("lastUpdate"),
      liveDot: document.getElementById("liveDot"),
      liveLabel: document.getElementById("liveLabel"),
      pauseBtn: document.getElementById("pauseBtn"),
      syncBtn: document.getElementById("syncBtn"),
      editFeedsBtn: document.getElementById("editFeedsBtn"),

      policyTitle: document.getElementById("policyTitle"),
      detectorState: document.getElementById("detectorState"),
      policyState: document.getElementById("policyState"),
      policyConf: document.getElementById("policyConf"),
      hystLine: document.getElementById("hystLine"),
      tickCount: document.getElementById("tickCount"),
      staleCount: document.getElementById("staleCount"),
      stateHistory: document.getElementById("stateHistory"),
      stateBubble: document.getElementById("stateBubble"),
      feedName: document.getElementById("feedName"),

      bars: document.getElementById("bars"),

      riskLevel: document.getElementById("riskLevel"),
      riskBox: document.getElementById("riskBox"),
      riskPolicy: document.getElementById("riskPolicy"),

      spot: document.getElementById("spot"),
      spotSmall: document.getElementById("spotSmall"),
      spotDelta: document.getElementById("spotDelta"),
      lastGood: document.getElementById("lastGood"),
      statusTxt: document.getElementById("statusTxt"),
      statusPill: document.getElementById("statusPill"),
      source: document.getElementById("source"),
      latency: document.getElementById("latency"),
      delta: document.getElementById("delta"),
      stalePol: document.getElementById("stalePol"),

      logBody: document.getElementById("logBody"),
      copyLogBtn: document.getElementById("copyLogBtn"),
      clearLogBtn: document.getElementById("clearLogBtn"),

      eventsBody: document.getElementById("eventsBody"),
      headlinesBody: document.getElementById("headlinesBody"),

      modalBack: document.getElementById("modalBack"),
      closeModal: document.getElementById("closeModal"),
      saveFeeds: document.getElementById("saveFeeds"),
      resetFeeds: document.getElementById("resetFeeds"),
      eventsJson: document.getElementById("eventsJson"),
      headsJson: document.getElementById("headsJson"),

      spark: document.getElementById("spark")
    };

    // --------------------------
    // 2) State
    // --------------------------
    let isLive = true;

    // Price sampling: real spot, low frequency by necessity
    const PRICE_POLL_MS = 25000;  // 25 seconds. Safe for free endpoints.
    const STALE_AFTER_POLLS = 6;  // if unchanged for 6 polls, mark stale

    let tick = 0;
    let stalePolls = 0;
    let lastPrice = null;
    let lastGoodTs = null;
    let lastLatency = null;
    let lastSource = "--";
    let recent = []; // [{ts, price, ret}]
    const MAX_RECENT = 240; // about 100 minutes with 25s sampling

    // Regime engine
    let detectorState = 1;
    let policyState = 1;
    let policyConfidence = 0.82;

    // Hysteresis control
    const HOLD_MIN_TICKS = 3;     // must lead for 3 detector updates to switch policy
    const LEAD_MARGIN = 0.035;    // top prob must exceed current prob by this margin to switch
    let holdTicks = 0;

    let stateHistory = JSON.parse(localStorage.getItem("qx_state_history") || "[]");
    if (!Array.isArray(stateHistory) || stateHistory.length === 0){
      stateHistory = [1,1,1,2,1,1,1,1,3,3,3,1];
    }
    stateHistory = stateHistory.slice(-12);

    // Regime log stored in browser so refresh does not reset
    let logRows = JSON.parse(localStorage.getItem("qx_regime_log") || "[]");
    if (!Array.isArray(logRows)) logRows = [];
    logRows = logRows.slice(0, 200);

    // Events + headlines stored locally for tonight
    const DEFAULT_EVENTS = [
      { ts: nextUtcHours(6),  title: "Eurozone CPI (flash)", impact: "HIGH" },
      { ts: nextUtcHours(18), title: "US Initial Jobless Claims", impact: "MED" },
      { ts: nextUtcHours(42), title: "US GDP (advance)", impact: "HIGH" },
      { ts: nextUtcHours(120), title: "US Non-Farm Payrolls", impact: "HIGH" }
    ];
    const DEFAULT_HEADLINES = [
      { ts: new Date(Date.now() - 18*60000).toISOString(), source:"FinancialJuice", title:"Dollar firming ahead of major data window", url:"https://www.financialjuice.com/" },
      { ts: new Date(Date.now() - 52*60000).toISOString(), source:"FinancialJuice", title:"Rates repricing drives short-term USD bid", url:"https://www.financialjuice.com/" },
      { ts: new Date(Date.now() - 2.2*3600000).toISOString(), source:"Market", title:"Risk tone mixed as equities stabilize", url:"https://www.investing.com/" }
    ];

    function nextUtcHours(h){
      return new Date(Date.now() + h*3600000).toISOString();
    }

    let events = safeJsonParse(localStorage.getItem("qx_events_json") || "null", null) || DEFAULT_EVENTS;
    let headlines = safeJsonParse(localStorage.getItem("qx_heads_json") || "null", null) || DEFAULT_HEADLINES;

    // --------------------------
    // 3) Quote endpoints (free, no keys)
    // --------------------------
    // Endpoint 1: exchangerate.host (often reliable)
    // Endpoint 2: open.er-api.com (fallback)
    async function fetchEurusd(){
      const t0 = performance.now();

      // Skip if tab hidden (free endpoints and your sanity)
      if (document.visibilityState !== "visible") {
        return { ok:false, skipped:true, reason:"hidden" };
      }

      // Try 1
      try{
        const u1 = "https://api.exchangerate.host/latest?base=EUR&symbols=USD";
        const r1 = await fetch(u1, { cache:"no-store" });
        if (r1.ok){
          const j1 = await r1.json();
          const p = j1 && j1.rates && typeof j1.rates.USD === "number" ? j1.rates.USD : null;
          if (p){
            return { ok:true, price:p, source:"exchangerate.host", latency: Math.round(performance.now()-t0) };
          }
        }
      }catch(e){}

      // Try 2
      try{
        const u2 = "https://open.er-api.com/v6/latest/EUR";
        const r2 = await fetch(u2, { cache:"no-store" });
        if (r2.ok){
          const j2 = await r2.json();
          const p = j2 && j2.rates && typeof j2.rates.USD === "number" ? j2.rates.USD : null;
          if (p){
            return { ok:true, price:p, source:"open.er-api.com", latency: Math.round(performance.now()-t0) };
          }
        }
      }catch(e){}

      return { ok:false, latency: Math.round(performance.now()-t0), source:"--" };
    }

    // --------------------------
    // 4) Feature extraction and regime scoring
    // --------------------------
    function computeFeatures(){
      // uses recent returns
      // returns: {vol, volX, mom, momBp, trendStrength, shockiness, liqVacuumProxy}
      if (recent.length < 6){
        return { vol: 0, volX: 1, mom: 0, momBp: 0, trendStrength: 0, shockiness: 0, liqVacuumProxy: 0 };
      }

      const rets = recent.slice(-20).map(x => x.ret).filter(x => typeof x === "number");
      const short = rets.slice(-6);
      const long = rets.slice(-20);

      const mean = arr => arr.reduce((a,b)=>a+b,0)/(arr.length||1);
      const std = arr => {
        const m = mean(arr);
        const v = mean(arr.map(x => (x-m)*(x-m)));
        return Math.sqrt(v);
      };

      const volS = std(short);
      const volL = std(long) || 1e-9;
      const volX = clamp(volS / volL, 0.2, 6.0);

      // Momentum as weighted sum of returns
      let mom = 0;
      for (let i=0;i<short.length;i++){
        const w = (i+1)/short.length;
        mom += short[i]*w;
      }
      const momBp = bp(mom);

      // Trend strength: how consistent sign is
      const signs = short.map(x => Math.sign(x));
      const sameSign = Math.abs(signs.reduce((a,b)=>a+b,0)) / (short.length||1);
      const trendStrength = clamp(sameSign, 0, 1);

      // Shockiness: tail ratio
      const abs = short.map(x => Math.abs(x));
      const maxAbs = Math.max(...abs);
      const avgAbs = mean(abs) || 1e-9;
      const shockiness = clamp(maxAbs / avgAbs, 0, 6);

      // Liquidity vacuum proxy for spot sampling:
      // If we see larger than usual jumps but low sample frequency, treat as vacuumish.
      const liqVacuumProxy = clamp((volX * shockiness) / 6, 0, 1);

      return { vol: volS, volX, mom, momBp, trendStrength, shockiness, liqVacuumProxy };
    }

    function scoreStates(f){
      // This is a conceptual scoring engine (not HMM) that behaves like a conditional classifier.
      // It produces probabilities that respond to volatility expansion, momentum, shockiness, and trend persistence.
      // Output: probs[1..8] sum to 1

      const absMom = Math.abs(f.momBp);
      const dir = Math.sign(f.mom);

      // Base bias toward calm conditions
      const s1 =  1.3 - 0.30*f.volX - 0.25*f.shockiness + 0.30*(1-f.trendStrength);
      const s2 =  0.2 + 0.60*f.liqVacuumProxy + 0.25*f.volX - 0.20*f.trendStrength;
      const s3 =  0.2 + 0.35*f.trendStrength + 0.22*clamp(absMom/1.5,0,2) - 0.10*f.shockiness;
      const s4 =  0.1 + 0.70*f.trendStrength + 0.35*clamp(absMom/2.0,0,2) + 0.10*f.volX;
      const s5 = -0.1 + 0.65*clamp(f.shockiness/3,0,2) + 0.25*clamp(f.volX/2,0,2) + 0.15*clamp(absMom/2.5,0,2);
      const s6 = -0.2 + 0.75*clamp(f.shockiness/3,0,2) + 0.30*clamp(f.volX/2,0,2) - 0.10*f.trendStrength;
      const s7 = -0.1 + 0.40*f.trendStrength + 0.35*clamp(f.volX/2,0,2) + 0.25*clamp(absMom/2.0,0,2);
      const s8 = -0.6 + 0.95*clamp(f.shockiness/3,0,2) + 0.55*clamp(f.volX/2.2,0,2);

      const probs = softmax([s1,s2,s3,s4,s5,s6,s7,s8]);
      // Convert to map 1..8
      const out = {};
      for (let i=1;i<=8;i++) out[i] = probs[i-1];
      return out;
    }

    // Hysteresis: policyState changes only after detector leads for N ticks and by a margin
    function updatePolicy(probs, det){
      const cur = policyState;
      const top = det;

      const curP = probs[cur] || 0;
      const topP = probs[top] || 0;

      // confidence defined as top prob
      policyConfidence = topP;

      if (top === cur){
        holdTicks = 0;
        return { changed:false, reason:"stable" };
      }

      const leadOk = (topP - curP) >= LEAD_MARGIN;

      if (leadOk){
        holdTicks += 1;
        if (holdTicks >= HOLD_MIN_TICKS){
          policyState = top;
          holdTicks = 0;
          return { changed:true, reason:"switched" };
        }
        return { changed:false, reason:"holding" };
      }

      holdTicks = 0;
      return { changed:false, reason:"not-leading" };
    }

    function riskFromPolicy(ps){
      if (ps >= 8) return "CRITICAL";
      if (ps >= 6) return "HIGH";
      if (ps === 5) return "ELEVATED";
      if (ps === 2 || ps === 4) return "MODERATE";
      return "NORMAL";
    }

    function setRiskUI(level){
      el.riskLevel.textContent = level;

      let bg;
      let pol;
      if (level === "NORMAL"){
        bg = "linear-gradient(180deg, rgba(16,185,129,0.10), rgba(0,0,0,0.28))";
        pol = "Rule: Trade normally. Avoid overfitting. Keep size disciplined.";
      } else if (level === "MODERATE"){
        bg = "linear-gradient(180deg, rgba(59,130,246,0.16), rgba(0,0,0,0.28))";
        pol = "Rule: Trend or vacuum possible. Reduce new entries if spread widens.";
      } else if (level === "ELEVATED"){
        bg = "linear-gradient(180deg, rgba(245,158,11,0.18), rgba(0,0,0,0.28))";
        pol = "Rule: Stop cascade risk. Tighten exposure, shorten holding.";
      } else if (level === "HIGH"){
        bg = "linear-gradient(180deg, rgba(249,115,22,0.20), rgba(0,0,0,0.28))";
        pol = "Rule: Shock regime. Gate entries. Prefer risk-off posture.";
      } else {
        bg = "linear-gradient(180deg, rgba(239,68,68,0.22), rgba(0,0,0,0.28))";
        pol = "Rule: Forced flow. Protect capital. No discretionary hero trades.";
      }

      el.riskBox.style.background = bg;
      el.riskPolicy.textContent = pol;
    }

    // --------------------------
    // 5) UI rendering
    // --------------------------
    function renderHistory(){
      el.stateHistory.innerHTML = "";
      stateHistory.slice(-12).forEach((s, idx) => {
        const d = document.createElement("div");
        d.className = "h" + (idx === stateHistory.length-1 ? " last" : "");
        d.textContent = s;
        d.style.borderColor = "rgba(255,255,255,0.10)";
        d.style.background = "rgba(2,6,23,0.26)";
        d.style.boxShadow = "none";
        el.stateHistory.appendChild(d);
      });
      localStorage.setItem("qx_state_history", JSON.stringify(stateHistory.slice(-12)));
    }

    function renderBars(probs){
      el.bars.innerHTML = "";
      for (let s=1;s<=8;s++){
        const p = probs[s] || 0;
        const row = document.createElement("div");
        row.className = "barRow";

        const left = document.createElement("div");
        const lab = document.createElement("div");
        lab.className = "barLabel";
        lab.innerHTML = `<span>State ${s}: <small>${STATE_NAMES[s]}</small></span>`;

        const bar = document.createElement("div");
        bar.className = "bar";
        const fill = document.createElement("i");
        fill.style.background = STATE_COLORS[s].bar;
        fill.style.width = `${Math.round(p*1000)/10}%`;
        bar.appendChild(fill);

        left.appendChild(lab);
        left.appendChild(bar);

        const right = document.createElement("div");
        right.className = "pct";
        right.style.color = STATE_COLORS[s].bar;
        right.textContent = `${(p*100).toFixed(1)}%`;

        row.appendChild(left);
        row.appendChild(right);
        el.bars.appendChild(row);
      }
    }

    function setStateBubble(s){
      el.stateBubble.textContent = s;
      el.stateBubble.style.background = `rgba(0,0,0,0.22)`;
      el.stateBubble.style.boxShadow = `inset 0 0 0 4px rgba(255,255,255,0.04), 0 0 0 3px rgba(0,0,0,0)`;
      el.stateBubble.style.borderColor = "rgba(255,255,255,0.18)";
      el.stateBubble.style.color = "rgba(226,232,240,0.95)";
      el.stateBubble.style.background = `radial-gradient(110px 90px at 20% 20%, ${STATE_COLORS[s].bubble}40, rgba(0,0,0,0.25))`;
      el.stateBubble.style.boxShadow = `0 0 0 5px ${STATE_COLORS[s].bubble}18, inset 0 0 0 4px rgba(255,255,255,0.04)`;
    }

    function setStatus(ok, stale){
      const txt = ok ? (stale ? "STALE" : "LIVE") : "ERROR";
      el.statusTxt.textContent = txt;
      const dot = el.statusPill.querySelector("i");
      if (!dot) return;

      if (!ok){
        dot.style.background = "var(--red)";
        dot.style.boxShadow = "0 0 0 3px rgba(239,68,68,0.18)";
      } else if (stale){
        dot.style.background = "var(--amber)";
        dot.style.boxShadow = "0 0 0 3px rgba(245,158,11,0.18)";
      } else {
        dot.style.background = "var(--green)";
        dot.style.boxShadow = "0 0 0 3px rgba(16,185,129,0.18)";
      }
    }

    function renderLog(){
      el.logBody.innerHTML = "";
      logRows.slice(0, 80).forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${r.time}</td>
          <td class="mono">${r.price}</td>
          <td class="mono">${r.det}</td>
          <td class="mono">${r.pol}</td>
          <td class="mono">${r.conf}</td>
          <td class="mono">${r.volx}</td>
          <td class="mono">${r.mom}</td>
          <td class="mono">${r.stale}</td>
          <td class="mono">${r.src}</td>
        `;
        el.logBody.appendChild(tr);
      });
    }

    function addLogRow({price, det, pol, conf, volx, momBp, stale, src}){
      const row = {
        time: nowStr(),
        price: typeof price === "number" ? price.toFixed(5) : "--",
        det: `S${det}`,
        pol: `S${pol}`,
        conf: `${(conf*100).toFixed(1)}%`,
        volx: volx.toFixed(2),
        mom: `${momBp.toFixed(2)}`,
        stale: stale ? "Y" : "N",
        src
      };
      logRows.unshift(row);
      logRows = logRows.slice(0, 200);
      localStorage.setItem("qx_regime_log", JSON.stringify(logRows));
      renderLog();
    }

    function renderEvents(){
      el.eventsBody.innerHTML = "";
      const sorted = [...events].sort((a,b) => new Date(a.ts) - new Date(b.ts));
      sorted.forEach(e => {
        const ts = new Date(e.ts);
        const impact = (e.impact || "MED").toUpperCase();
        const cls = impact === "HIGH" ? "high" : impact === "LOW" ? "low" : "med";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${ts.toLocaleString()}</td>
          <td>${escapeHtml(e.title || "")}</td>
          <td><span class="impact ${cls}"><span class="sq"></span>${impact}</span></td>
          <td class="mono" data-countdown="${ts.toISOString()}">--</td>
        `;
        el.eventsBody.appendChild(tr);
      });
    }

    function renderHeadlines(){
      el.headlinesBody.innerHTML = "";
      const sorted = [...headlines].sort((a,b)=> new Date(b.ts) - new Date(a.ts)).slice(0, 40);
      sorted.forEach(h => {
        const ts = new Date(h.ts);
        const tr = document.createElement("tr");
        const url = h.url || "#";
        tr.innerHTML = `
          <td class="mono">${ts.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}</td>
          <td class="mono">${escapeHtml(h.source || "")}</td>
          <td><a href="${escapeAttr(url)}" target="_blank" rel="noopener" style="color: var(--blue); text-decoration:none; font-weight:800;">
            ${escapeHtml(h.title || "")}
          </a></td>
        `;
        el.headlinesBody.appendChild(tr);
      });
    }

    function updateCountdowns(){
      const cells = el.eventsBody.querySelectorAll("[data-countdown]");
      const now = Date.now();
      cells.forEach(td => {
        const t = new Date(td.getAttribute("data-countdown")).getTime();
        const d = t - now;
        td.textContent = d <= 0 ? "LIVE / PASSED" : humanizeMs(d);
      });
    }

    function humanizeMs(ms){
      const s = Math.floor(ms/1000);
      const d = Math.floor(s/86400);
      const h = Math.floor((s%86400)/3600);
      const m = Math.floor((s%3600)/60);
      if (d>0) return `${d}d ${h}h`;
      if (h>0) return `${h}h ${m}m`;
      return `${m}m`;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }
    function escapeAttr(str){
      return String(str).replace(/"/g, "&quot;");
    }

    // Sparkline from real samples
    function drawSpark(){
      const ctx = el.spark.getContext("2d");
      const w = el.spark.width;
      const h = el.spark.height;
      ctx.clearRect(0,0,w,h);

      const data = recent.slice(-30).map(x => x.price).filter(x => typeof x === "number");
      if (data.length < 2){
        ctx.globalAlpha = 0.6;
        ctx.fillStyle = "rgba(226,232,240,0.5)";
        ctx.font = "12px ui-monospace";
        ctx.fillText("--", 6, 20);
        ctx.globalAlpha = 1;
        return;
      }

      const min = Math.min(...data);
      const max = Math.max(...data);
      const rng = (max-min) || 1e-9;

      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(96,165,250,0.9)";
      ctx.beginPath();

      for (let i=0;i<data.length;i++){
        const x = (i/(data.length-1))*(w-2) + 1;
        const y = h - ((data[i]-min)/rng)*(h-6) - 3;
        if (i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // faint glow
      ctx.strokeStyle = "rgba(16,185,129,0.25)";
      ctx.lineWidth = 6;
      ctx.beginPath();
      for (let i=0;i<data.length;i++){
        const x = (i/(data.length-1))*(w-2) + 1;
        const y = h - ((data[i]-min)/rng)*(h-6) - 3;
        if (i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }

    // --------------------------
    // 6) Main update loop
    // --------------------------
    async function poll(){
      if (!isLive) return;

      const q = await fetchEurusd();

      if (q.skipped){
        // do nothing if hidden
        return;
      }

      tick += 1;
      el.tickCount.textContent = String(tick);

      const ok = q.ok && typeof q.price === "number";
      if (!ok){
        setStatus(false, false);
        el.source.textContent = q.source || "--";
        el.latency.textContent = (q.latency != null ? `${q.latency}ms` : "--");
        el.delta.textContent = "--";
        el.stalePol.textContent = String(stalePolls);
        el.lastUpdate.textContent = nowStr();
        return;
      }

      lastLatency = q.latency;
      lastSource = q.source;
      el.feedName.textContent = q.source;

      const price = q.price;
      const stale = (lastPrice != null && Math.abs(price - lastPrice) < 1e-10);
      if (stale) stalePolls += 1; else stalePolls = 0;

      el.staleCount.textContent = String(stalePolls);
      el.stalePol.textContent = String(stalePolls);

      // Update UI spot and delta
      el.spot.textContent = price.toFixed(5);
      el.spotSmall.textContent = `EURUSD: ${price.toFixed(5)}`;

      let dlt = "--";
      if (lastPrice != null) dlt = (price - lastPrice).toFixed(5);
      el.delta.textContent = dlt;
      el.spotDelta.textContent = `Δ: ${dlt}`;

      el.source.textContent = q.source;
      el.latency.textContent = `${q.latency}ms`;

      // Stale detection: if unchanged for too long, still show but mark stale
      const isStale = stalePolls >= STALE_AFTER_POLLS;
      setStatus(true, isStale);

      if (!isStale){
        lastGoodTs = new Date();
        el.lastGood.textContent = nowStr();
      } else {
        if (!lastGoodTs) el.lastGood.textContent = "--";
      }

      // Build return and store
      let ret = null;
      if (lastPrice != null){
        ret = (price / lastPrice) - 1;
      }
      lastPrice = price;

      recent.push({ts: Date.now(), price, ret});
      if (recent.length > MAX_RECENT) recent = recent.slice(-MAX_RECENT);

      // Regime update only when we have enough real samples
      const f = computeFeatures();
      const probs = scoreStates(f);

      // Detector is argmax
      let top = 1;
      let topP = -1;
      for (let s=1;s<=8;s++){
        const p = probs[s];
        if (p > topP){ topP = p; top = s; }
      }
      detectorState = top;

      // Apply hysteresis to policy state
      const polRes = updatePolicy(probs, detectorState);
      const hystTxt = polRes.reason === "stable" ? "stable" :
                      polRes.reason === "holding" ? `holding (${holdTicks}/${HOLD_MIN_TICKS})` :
                      polRes.reason === "switched" ? "switched" : "not-leading";
      el.hystLine.textContent = hystTxt;

      // Update history if changed or every few ticks to keep it moving
      if (polRes.changed || tick % 2 === 0){
        stateHistory.push(policyState);
        stateHistory = stateHistory.slice(-12);
        renderHistory();
      }

      // Update titles
      el.detectorState.textContent = `S${detectorState}`;
      el.policyState.textContent = `S${policyState}`;
      el.policyConf.textContent = `${(policyConfidence*100).toFixed(1)}%`;
      el.policyTitle.textContent = `Policy State: S${policyState} ${STATE_NAMES[policyState]}`;
      setStateBubble(policyState);

      // Risk and probabilities UI
      renderBars(probs);
      setRiskUI(riskFromPolicy(policyState));

      // Log row (real price only)
      addLogRow({
        price,
        det: detectorState,
        pol: policyState,
        conf: policyConfidence,
        volx: f.volX,
        momBp: f.momBp,
        stale: isStale,
        src: q.source
      });

      // Sparkline
      drawSpark();

      // Persist policy state across refresh
      localStorage.setItem("qx_policy_state", String(policyState));
      localStorage.setItem("qx_detector_state", String(detectorState));
      localStorage.setItem("qx_last_price", String(price));
      localStorage.setItem("qx_last_source", String(q.source));
      localStorage.setItem("qx_last_good", lastGoodTs ? lastGoodTs.toISOString() : "");

      el.lastUpdate.textContent = nowStr();
    }

    function restoreSession(){
      const ps = Number(localStorage.getItem("qx_policy_state") || "1");
      const ds = Number(localStorage.getItem("qx_detector_state") || "1");
      const lp = Number(localStorage.getItem("qx_last_price") || "NaN");
      const src = localStorage.getItem("qx_last_source") || "--";

      if (ps>=1 && ps<=8) policyState = ps;
      if (ds>=1 && ds<=8) detectorState = ds;

      if (!Number.isNaN(lp)){
        lastPrice = lp;
        el.spot.textContent = lp.toFixed(5);
        el.spotSmall.textContent = `EURUSD: ${lp.toFixed(5)}`;
      }

      el.feedName.textContent = src;
      el.source.textContent = src;

      el.detectorState.textContent = `S${detectorState}`;
      el.policyState.textContent = `S${policyState}`;
      el.policyTitle.textContent = `Policy State: S${policyState} ${STATE_NAMES[policyState]}`;
      setStateBubble(policyState);
      setRiskUI(riskFromPolicy(policyState));

      const lg = localStorage.getItem("qx_last_good");
      if (lg){
        const d = new Date(lg);
        if (!isNaN(d.getTime())){
          el.lastGood.textContent = d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
        }
      }
    }

    // --------------------------
    // 7) Controls
    // --------------------------
    el.pauseBtn.addEventListener("click", () => {
      isLive = !isLive;
      el.pauseBtn.textContent = isLive ? "Pause" : "Resume";
      el.liveDot.style.background = isLive ? "var(--green)" : "rgba(148,163,184,0.85)";
      el.liveDot.style.boxShadow = isLive ? "0 0 0 3px rgba(16,185,129,0.18)" : "0 0 0 3px rgba(148,163,184,0.18)";
      el.liveLabel.textContent = isLive ? "LIVE" : "PAUSED";
      if (isLive) poll();
    });

    el.syncBtn.addEventListener("click", () => {
      // A manual refresh of quote and UI
      poll();
    });

    el.copyLogBtn.addEventListener("click", async () => {
      const headers = ["TIME","EURUSD","DET","POL","CONF","VOLX","MOM_BP","STALE","SRC"];
      const lines = [headers.join(",")].concat(
        logRows.map(r => [r.time,r.price,r.det,r.pol,r.conf,r.volx,r.mom,r.stale,r.src].join(","))
      );
      const csv = lines.join("\n");
      try{
        await navigator.clipboard.writeText(csv);
        el.copyLogBtn.textContent = "Copied";
        setTimeout(()=> el.copyLogBtn.textContent = "Copy as CSV", 900);
      }catch{
        // fallback
        prompt("Copy CSV:", csv);
      }
    });

    el.clearLogBtn.addEventListener("click", () => {
      logRows = [];
      localStorage.setItem("qx_regime_log", JSON.stringify(logRows));
      renderLog();
    });

    // Modal
    el.editFeedsBtn.addEventListener("click", () => openModal());
    el.closeModal.addEventListener("click", () => closeModal());
    el.modalBack.addEventListener("click", (e) => { if (e.target === el.modalBack) closeModal(); });

    function openModal(){
      el.eventsJson.value = JSON.stringify(events, null, 2);
      el.headsJson.value = JSON.stringify(headlines, null, 2);
      el.modalBack.style.display = "flex";
    }
    function closeModal(){
      el.modalBack.style.display = "none";
    }

    el.resetFeeds.addEventListener("click", () => {
      events = DEFAULT_EVENTS;
      headlines = DEFAULT_HEADLINES;
      localStorage.setItem("qx_events_json", JSON.stringify(events));
      localStorage.setItem("qx_heads_json", JSON.stringify(headlines));
      renderEvents();
      renderHeadlines();
      el.eventsJson.value = JSON.stringify(events, null, 2);
      el.headsJson.value = JSON.stringify(headlines, null, 2);
    });

    el.saveFeeds.addEventListener("click", () => {
      const ev = safeJsonParse(el.eventsJson.value, null);
      const hd = safeJsonParse(el.headsJson.value, null);

      if (!Array.isArray(ev) || !Array.isArray(hd)){
        alert("Invalid JSON. Events and Headlines must each be a JSON array.");
        return;
      }

      // light validation
      events = ev.map(x => ({
        ts: x.ts || new Date().toISOString(),
        title: x.title || "",
        impact: (x.impact || "MED").toUpperCase()
      }));

      headlines = hd.map(x => ({
        ts: x.ts || new Date().toISOString(),
        source: x.source || "",
        title: x.title || "",
        url: x.url || "#"
      }));

      localStorage.setItem("qx_events_json", JSON.stringify(events));
      localStorage.setItem("qx_heads_json", JSON.stringify(headlines));
      renderEvents();
      renderHeadlines();
      closeModal();
    });

    // --------------------------
    // 8) Init
    // --------------------------
    function init(){
      renderHistory();
      renderLog();
      renderEvents();
      renderHeadlines();
      updateCountdowns();
      restoreSession();

      // TradingView daily trend for EURUSD
      try{
        new TradingView.widget({
          autosize: true,
          symbol: "FX:EURUSD",
          interval: "D",
          timezone: "Etc/UTC",
          theme: "dark",
          style: "1",
          locale: "en",
          allow_symbol_change: false,
          hide_top_toolbar: true,
          hide_legend: false,
          withdateranges: true,
          save_image: false,
          container_id: "tv_chart"
        });
      } catch(e){
        // ignore
      }

      // countdown timer updates each second (lively without faking price)
      setInterval(updateCountdowns, 1000);

      // quote polling
      poll();
      setInterval(poll, PRICE_POLL_MS);

      // Keep sparkline updating on any render
      drawSpark();
    }

    init();
  </script>
</body>
</html>
