<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>QuadraX Risk Dashboard</title>
  <style>
    :root{
      --bg0:#050a1a;
      --bg1:#07122f;
      --card: rgba(10, 25, 60, 0.55);
      --card2: rgba(12, 34, 84, 0.42);
      --stroke: rgba(120, 170, 255, 0.22);
      --stroke2: rgba(120, 170, 255, 0.12);
      --text:#e9f0ff;
      --muted: rgba(233,240,255,0.7);
      --muted2: rgba(233,240,255,0.55);
      --blue:#2b6cff;
      --green:#18d18a;
      --amber:#ffb020;
      --red:#ff4d4d;
      --pink:#ff3aa5;
      --shadow: 0 18px 55px rgba(0,0,0,0.55);
      --shadow2: 0 10px 30px rgba(0,0,0,0.45);
      --radius: 22px;
      --radius2: 16px;
      --pad: 18px;
      --pad2: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 20%, rgba(80,140,255,0.22), transparent 55%),
        radial-gradient(900px 600px at 70% 35%, rgba(22,210,170,0.16), transparent 55%),
        radial-gradient(900px 700px at 35% 85%, rgba(255,80,180,0.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1400px;
      margin: 22px auto 40px;
      padding: 0 16px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding: 18px 18px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(50,115,255,0.55), rgba(35,85,200,0.42));
      border: 1px solid rgba(210,230,255,0.18);
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 14px;
      min-width: 280px;
    }

    .qxlogo{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      font-weight: 900;
      letter-spacing: 0.5px;
      background: rgba(10,25,60,0.45);
      border: 1px solid rgba(210,230,255,0.18);
      box-shadow: var(--shadow2);
    }

    .brand h1{
      margin:0;
      font-size: 18px;
      line-height: 1.1;
    }
    .brand .sub{
      margin-top: 2px;
      font-size: 12px;
      color: rgba(255,255,255,0.78);
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(10,25,60,0.35);
      border:1px solid rgba(210,230,255,0.16);
      color: rgba(255,255,255,0.9);
      font-size: 12px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.25);
      white-space:nowrap;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--green);
      box-shadow: 0 0 0 4px rgba(24,209,138,0.18);
    }

    .btn{
      cursor:pointer;
      border: 1px solid rgba(210,230,255,0.18);
      background: rgba(10,25,60,0.35);
      color: rgba(255,255,255,0.92);
      border-radius: 999px;
      padding: 9px 14px;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.2px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.25);
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.06); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: rgba(35,120,255,0.35);
      border-color: rgba(120,170,255,0.26);
    }

    .grid{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
    }

    .card{
      background: linear-gradient(180deg, rgba(10,25,60,0.55), rgba(7,12,30,0.35));
      border:1px solid rgba(210,230,255,0.16);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
    }

    .card .inner{
      padding: var(--pad);
    }

    .card-title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }

    .card-title h2{
      margin:0;
      font-size: 13px;
      color: rgba(255,255,255,0.82);
      letter-spacing: 0.9px;
      text-transform: uppercase;
    }
    .card-title .hint{
      font-size: 12px;
      color: rgba(255,255,255,0.55);
      text-align:right;
    }

    .stateBig{
      font-size: 40px;
      font-weight: 900;
      letter-spacing: 0.2px;
      margin: 6px 0 2px;
    }
    .muted{ color: var(--muted); font-size: 13px; }
    .muted2{ color: var(--muted2); }
    .chips{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
      align-items:center;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,0.88);
      background: rgba(10,25,60,0.30);
      border: 1px solid rgba(210,230,255,0.14);
      white-space:nowrap;
    }
    .chip b{ font-weight:900; }

    .history{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(210,230,255,0.12);
    }
    .hbox{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      font-weight: 900;
      background: rgba(10,25,60,0.25);
      border:1px solid rgba(210,230,255,0.12);
      color: rgba(255,255,255,0.82);
    }
    .hbox.active{
      border-color: rgba(120,170,255,0.35);
      box-shadow: 0 0 0 4px rgba(120,170,255,0.12);
    }

    .stateBadge{
      position:absolute;
      right: 18px;
      top: 18px;
      width: 68px;
      height: 68px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      font-weight: 1000;
      font-size: 26px;
      background: rgba(10,25,60,0.28);
      border:1px solid rgba(210,230,255,0.18);
      box-shadow: var(--shadow2);
    }

    .miniQuote{
      position:absolute;
      right: 104px;
      top: 18px;
      width: 210px;
      border-radius: 14px;
      background: rgba(10,25,60,0.28);
      border:1px solid rgba(210,230,255,0.14);
      box-shadow: var(--shadow2);
      padding: 10px 12px;
    }
    .miniQuote .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size: 12px;
      color: rgba(255,255,255,0.84);
    }
    .miniQuote .px{
      font-size: 18px;
      font-weight: 950;
      letter-spacing: 0.2px;
      margin: 4px 0 2px;
    }
    .miniQuote .bar{
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
      margin-top: 8px;
    }
    .miniQuote .bar > i{
      display:block;
      height:100%;
      width: 40%;
      background: rgba(24,209,138,0.85);
    }

    .riskLevel{
      text-align:center;
      padding: 22px 16px 14px;
    }
    .riskLevel .label{
      font-size: 12px;
      letter-spacing: 0.9px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.72);
    }
    .riskLevel .big{
      font-size: 42px;
      font-weight: 1000;
      margin: 6px 0 2px;
    }
    .riskLevel .rule{
      font-size: 12px;
      color: rgba(255,255,255,0.68);
    }

    .probRow{
      display:grid;
      grid-template-columns: 240px 1fr 72px;
      gap: 12px;
      align-items:center;
      padding: 10px 0;
      border-top: 1px solid rgba(210,230,255,0.08);
    }
    .probRow:first-child{ border-top:none; }
    .probName{
      font-size: 12px;
      color: rgba(255,255,255,0.88);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pdot{
      width: 14px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
    }
    .pbar{
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
      position:relative;
    }
    .pbar > i{
      display:block;
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: rgba(120,170,255,0.8);
    }
    .probVal{
      font-size: 12px;
      color: rgba(255,255,255,0.78);
      text-align:right;
      font-variant-numeric: tabular-nums;
    }

    .feedGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:stretch;
    }
    @media (max-width: 540px){
      .feedGrid{ grid-template-columns: 1fr; }
    }
    .feedBox{
      border-radius: 18px;
      background: rgba(10,25,60,0.25);
      border:1px solid rgba(210,230,255,0.12);
      padding: 14px;
    }
    .feedBox .k{
      font-size: 12px;
      color: rgba(255,255,255,0.7);
    }
    .feedBox .v{
      font-size: 30px;
      font-weight: 1000;
      margin-top: 6px;
      font-variant-numeric: tabular-nums;
    }
    .feedMeta{
      font-size: 12px;
      color: rgba(255,255,255,0.62);
      margin-top: 6px;
      line-height: 1.35;
    }
    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(210,230,255,0.14);
      background: rgba(10,25,60,0.26);
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,0.88);
      margin-top: 8px;
    }
    .sdot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--amber);
      box-shadow: 0 0 0 4px rgba(255,176,32,0.18);
    }
    .sdot.live{ background: var(--green); box-shadow: 0 0 0 4px rgba(24,209,138,0.18); }
    .sdot.err{ background: var(--red); box-shadow: 0 0 0 4px rgba(255,77,77,0.18); }

    .tableWrap{
      border-radius: 18px;
      background: rgba(10,25,60,0.20);
      border:1px solid rgba(210,230,255,0.12);
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size: 12px;
    }
    thead th{
      text-align:left;
      padding: 12px 12px;
      color: rgba(255,255,255,0.78);
      border-bottom: 1px solid rgba(210,230,255,0.10);
      background: rgba(10,25,60,0.22);
      font-weight: 900;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      font-size: 11px;
    }
    tbody td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(210,230,255,0.06);
      color: rgba(255,255,255,0.82);
      vertical-align:top;
      font-variant-numeric: tabular-nums;
    }
    tbody tr:hover{ background: rgba(255,255,255,0.04); }
    .scroll{
      max-height: 300px;
      overflow:auto;
    }
    .link{
      color: rgba(120,170,255,0.95);
      text-decoration:none;
      font-weight: 800;
    }
    .link:hover{ text-decoration:underline; }

    .impact{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(210,230,255,0.14);
      background: rgba(10,25,60,0.22);
      font-weight: 950;
      color: rgba(255,255,255,0.88);
      white-space:nowrap;
    }
    .folder{
      width: 10px;
      height: 10px;
      border-radius: 3px;
      background: var(--pink);
      box-shadow: 0 0 0 4px rgba(255,58,165,0.14);
    }
    .folder.med{ background: var(--amber); box-shadow: 0 0 0 4px rgba(255,176,32,0.14); }
    .folder.low{ background: rgba(255,255,255,0.30); box-shadow: none; }

    .snapGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    @media (max-width: 900px){
      .snapGrid{ grid-template-columns: repeat(2, 1fr); }
    }
    .snap{
      border-radius: 18px;
      background: rgba(10,25,60,0.25);
      border:1px solid rgba(210,230,255,0.12);
      padding: 14px;
    }
    .snap .k{ font-size:12px; color: rgba(255,255,255,0.62); }
    .snap .v{ margin-top:6px; font-size: 18px; font-weight: 950; }
    .pos{ color: rgba(24,209,138,0.95); }
    .neg{ color: rgba(255,77,77,0.95); }

    .stack{ display:grid; gap: 16px; }

    .foot{
      margin-top: 14px;
      display:flex;
      justify-content:space-between;
      color: rgba(255,255,255,0.5);
      font-size: 12px;
      padding: 0 6px;
      gap:12px;
      flex-wrap:wrap;
    }

    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 999;
      padding: 18px;
    }
    .modal{
      width:min(860px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(12,34,84,0.92), rgba(6,10,24,0.88));
      border: 1px solid rgba(210,230,255,0.18);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(210,230,255,0.12);
    }
    .modalHead h3{
      margin:0;
      font-size: 14px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.86);
    }
    .modalBody{
      padding: 16px 18px 18px;
      display:grid;
      gap: 14px;
    }
    textarea{
      width:100%;
      min-height: 180px;
      resize: vertical;
      border-radius: 16px;
      border: 1px solid rgba(210,230,255,0.18);
      background: rgba(10,25,60,0.35);
      color: rgba(255,255,255,0.9);
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.35;
      outline:none;
    }
    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
    }

    .tvWrap{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(210,230,255,0.12);
      background: rgba(10,25,60,0.20);
    }
    .tvWrap iframe{
      width:100%;
      height: 380px;
      border:0;
      display:block;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="qxlogo">QX</div>
        <div>
          <h1>QuadraX Risk Dashboard</h1>
          <div class="sub">Executive View: 8-State Monitoring and Control System (Live EUR/USD Spot)</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill"><span class="dot" id="liveDot"></span><span id="liveText">LIVE</span></div>
        <div class="pill">Last Update <b id="lastUpdate">--:--:--</b></div>
        <button class="btn" id="pauseBtn">Pause</button>
        <button class="btn primary" id="syncBtn">Sync</button>
        <button class="btn" id="editBtn">Edit Events + Headlines</button>
      </div>
    </div>

    <div class="grid">
      <div class="stack">
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Current Market State</h2>
              <div class="hint">With free endpoints, updates are spot-sampled. Still real price, lower frequency.</div>
            </div>

            <div class="stateBig" id="policyStateTitle">Policy State: --</div>
            <div class="muted" id="policyStateDesc">Waiting for live spot sample.</div>

            <div class="chips">
              <div class="chip">Detector <b id="detectorChip">--</b></div>
              <div class="chip">Policy <b id="policyChip">--</b></div>
              <div class="chip">Confidence <b id="confChip">--</b></div>
              <div class="chip">Hysteresis <b id="hystChip">--</b></div>
              <div class="chip">Tick <b id="tickChip">0</b></div>
              <div class="chip">Stale <b id="staleChip">0</b></div>
            </div>

            <div class="history" id="stateHistory"></div>

            <div class="miniQuote" title="Live spot sample summary">
              <div class="row">
                <div><b>EURUSD:</b></div>
                <div id="miniSrc" style="color: rgba(255,255,255,0.68)">--</div>
              </div>
              <div class="px" id="miniPrice">--</div>
              <div class="row" style="color: rgba(255,255,255,0.62)">
                <div>Δ</div>
                <div id="miniDelta">0.00000</div>
              </div>
              <div class="bar"><i id="miniBar"></i></div>
            </div>

            <div class="stateBadge" id="stateBadge">--</div>
          </div>
        </div>

        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>State Probability Distribution</h2>
              <div class="hint">Conditional regime likelihoods P(state | features)</div>
            </div>
            <div id="probList"></div>
            <div class="muted" style="margin-top:10px;">
              Note: probabilities can flatten if the quote feed is stale or the features are ambiguous.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Portfolio Snapshot</h2>
              <div class="hint">Demo placeholders until execution and risk feeds are connected</div>
            </div>
            <div class="snapGrid">
              <div class="snap">
                <div class="k">Account Balance</div>
                <div class="v">$1,000,000</div>
              </div>
              <div class="snap">
                <div class="k">Daily PnL</div>
                <div class="v pos">+$13,160</div>
              </div>
              <div class="snap">
                <div class="k">Total Exposure</div>
                <div class="v">$650,000</div>
              </div>
              <div class="snap">
                <div class="k">Max Drawdown</div>
                <div class="v neg">-3.2%</div>
              </div>
            </div>
            <div class="muted" style="margin-top:10px;">
              This section is intentionally demo. Tonight the goal is accurate regime visualization on real EUR/USD spot.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Regime Log</h2>
              <div class="hint">CSV-style telemetry (latest on top)</div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
              <button class="btn" id="copyCsvBtn">Copy as CSV</button>
              <button class="btn" id="clearLogBtn">Clear</button>
            </div>

            <div class="tableWrap">
              <div class="scroll" style="max-height: 320px;">
                <table>
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>EURUSD</th>
                      <th>DET</th>
                      <th>POL</th>
                      <th>CONF</th>
                      <th>VOL X</th>
                      <th>MOM (bp)</th>
                      <th>STALE</th>
                      <th>SRC</th>
                    </tr>
                  </thead>
                  <tbody id="logBody"></tbody>
                </table>
              </div>
            </div>

            <div class="muted" style="margin-top:10px;">
              Tip: Copy CSV and paste into Excel. It splits cleanly.
            </div>
          </div>
        </div>

        <div class="foot">
          <div>System Status: <b id="sysStatus">LIVE</b></div>
          <div>Smoothed Policy: <b id="footPolicy">--</b></div>
          <div>Detector: <b id="footDetector">--</b></div>
          <div>Hysteresis Hold: <b id="footHold">0</b></div>
        </div>
      </div>

      <div class="stack">
        <div class="card">
          <div class="inner riskLevel">
            <div class="label">Risk Level</div>
            <div class="big" id="riskBig">--</div>
            <div class="rule" id="riskRule">Policy: state-aware sizing and entry gating</div>
          </div>
        </div>

        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Feed Health</h2>
              <div class="hint">Proof the market data is updating</div>
            </div>

            <div class="feedGrid">
              <div class="feedBox">
                <div class="k">EUR/USD Spot (reference)</div>
                <div class="v" id="fxSpotPrice">--</div>
                <div class="feedMeta" id="fxSpotLast">Last good sample: --</div>
              </div>
              <div class="feedBox">
                <div class="k">Status</div>
                <div class="statusPill"><span class="sdot" id="fxStatusDot"></span><span id="fxSpotStatus">CHECKING</span></div>
                <div class="feedMeta" id="fxSpotMeta">Source: -- | Latency: --</div>
                <div class="feedMeta" id="fxSpotDelta">Delta (last): 0.00000</div>
              </div>
            </div>

            <div class="muted" style="margin-top:10px;">
              If the spot stays unchanged for a while, it might be a quiet market or endpoint caching or throttling.
              This dashboard never invents price.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>World Events Calendar</h2>
              <div class="hint">Demo: live geopolitics via GDELT, fallback curated list saved locally</div>
            </div>
            <div class="tableWrap">
              <div class="scroll" style="max-height: 260px;">
                <table>
                  <thead>
                    <tr>
                      <th>When</th>
                      <th>Event</th>
                      <th>Impact</th>
                      <th>Countdown</th>
                    </tr>
                  </thead>
                  <tbody id="eventsBody"></tbody>
                </table>
              </div>
            </div>
            <div class="muted" style="margin-top:10px;">
              Red folder style: High impact events are <span class="impact"><span class="folder"></span>HIGH</span>.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Headlines</h2>
              <div class="hint">Demo: live headlines via GDELT, fallback curated list saved locally</div>
            </div>

            <div class="tableWrap">
              <div class="scroll" style="max-height: 240px;">
                <table>
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>Source</th>
                      <th>Headline</th>
                    </tr>
                  </thead>
                  <tbody id="headlinesBody"></tbody>
                </table>
              </div>
            </div>

            <div class="muted" style="margin-top:10px;">
              Click opens source in a new tab.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Daily EUR/USD Trend</h2>
              <div class="hint">Embedded TradingView chart (no backend needed)</div>
            </div>

            <div class="tvWrap">
              <iframe
                title="TradingView EURUSD"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                src="https://s.tradingview.com/widgetembed/?frameElementId=tvchart&symbol=FX%3AEURUSD&interval=D&hidesidetoolbar=1&symboledit=0&saveimage=0&toolbarbg=0b1028&studies=%5B%5D&hideideas=1&theme=dark&style=1&locale=en&withdateranges=1&hidevolume=0&allow_symbol_change=0&details=0&hotlist=0&calendar=0"
              ></iframe>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Risk Metrics</h2>
              <div class="hint">Placeholders until execution integration</div>
            </div>
            <div class="snapGrid" style="grid-template-columns: 1fr 1fr;">
              <div class="snap">
                <div class="k">Value at Risk (95%)</div>
                <div class="v" style="color: rgba(255,77,77,0.95);">$28,500</div>
                <div class="muted2" style="margin-top:4px;">2.85% of account</div>
              </div>
              <div class="snap">
                <div class="k">Conditional VaR (95%)</div>
                <div class="v" style="color: rgba(255,77,77,0.95);">$42,300</div>
                <div class="muted2" style="margin-top:4px;">Expected loss if VaR exceeded</div>
              </div>
              <div class="snap">
                <div class="k">Portfolio Correlation</div>
                <div class="v" style="color: rgba(24,209,138,0.95);">32.0%</div>
                <div class="muted2" style="margin-top:4px;">Max allowed: 50.0%</div>
              </div>
              <div class="snap">
                <div class="k">Beta to Market</div>
                <div class="v" style="color: rgba(120,170,255,0.95);">0.15</div>
                <div class="muted2" style="margin-top:4px;">Low market correlation (good)</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <h3>Edit World Events + Headlines</h3>
        <button class="btn" id="closeModalBtn">Close</button>
      </div>
      <div class="modalBody">
        <div class="muted">
          This is the “tonight, ship it” approach. Save curated items locally so everyone sees the same list after refresh on their device.
          Later we can plug a real economic calendar feed once you decide what level of pain you want to pay for.
        </div>

        <div>
          <div class="muted" style="margin-bottom:8px;"><b>Events JSON</b> (array of objects: when, event, impact: HIGH|MED|LOW)</div>
          <textarea id="eventsEditor"></textarea>
        </div>

        <div>
          <div class="muted" style="margin-bottom:8px;"><b>Headlines JSON</b> (array of objects: time, source, title, url)</div>
          <textarea id="headlinesEditor"></textarea>
        </div>

        <div class="modalActions">
          <button class="btn" id="resetCuratedBtn">Reset to curated defaults</button>
          <button class="btn primary" id="saveCuratedBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const fmtTime = (ms) => new Date(ms).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const bp = (x)=> x * 10000;

  // ---------- State definitions ----------
  const STATES = [
    { id:1, name:"Mean-Reverting", desc:"Range-bound. Fade extremes and keep size disciplined.", color:"rgba(24,209,138,0.85)" },
    { id:2, name:"Liquidity Vacuum", desc:"Thin market, jumpy moves. Tighten risk and be selective.", color:"rgba(255,176,32,0.85)" },
    { id:3, name:"Slow Drift", desc:"Steady grind. Small edges, avoid forcing entries.", color:"rgba(120,170,255,0.85)" },
    { id:4, name:"Strong Trend", desc:"Directional. Trend-follow bias, avoid countertrend heroics.", color:"rgba(60,145,255,0.9)" },
    { id:5, name:"Stop Cascade", desc:"Fast continuation on stops. Reduce leverage, widen filters.", color:"rgba(255,138,64,0.9)" },
    { id:6, name:"News Shock", desc:"Event-driven. Consider standing down around releases.", color:"rgba(255,77,77,0.9)" },
    { id:7, name:"Dealer Unwind", desc:"Choppy reversal risk. Focus on protection and confirmation.", color:"rgba(160,120,255,0.9)" },
    { id:8, name:"Panic/Forced", desc:"Dislocation. Risk off. Protect capital first.", color:"rgba(255,58,165,0.9)" }
  ];

  // ---------- DOM wiring ----------
  const els = {
    liveDot: document.getElementById("liveDot"),
    liveText: document.getElementById("liveText"),
    lastUpdate: document.getElementById("lastUpdate"),
    pauseBtn: document.getElementById("pauseBtn"),
    syncBtn: document.getElementById("syncBtn"),
    editBtn: document.getElementById("editBtn"),
    modalBack: document.getElementById("modalBack"),
    closeModalBtn: document.getElementById("closeModalBtn"),
    saveCuratedBtn: document.getElementById("saveCuratedBtn"),
    resetCuratedBtn: document.getElementById("resetCuratedBtn"),
    eventsEditor: document.getElementById("eventsEditor"),
    headlinesEditor: document.getElementById("headlinesEditor"),

    policyStateTitle: document.getElementById("policyStateTitle"),
    policyStateDesc: document.getElementById("policyStateDesc"),
    detectorChip: document.getElementById("detectorChip"),
    policyChip: document.getElementById("policyChip"),
    confChip: document.getElementById("confChip"),
    hystChip: document.getElementById("hystChip"),
    tickChip: document.getElementById("tickChip"),
    staleChip: document.getElementById("staleChip"),
    stateHistory: document.getElementById("stateHistory"),
    stateBadge: document.getElementById("stateBadge"),
    miniPrice: document.getElementById("miniPrice"),
    miniSrc: document.getElementById("miniSrc"),
    miniDelta: document.getElementById("miniDelta"),
    miniBar: document.getElementById("miniBar"),
    probList: document.getElementById("probList"),

    fxSpotPrice: document.getElementById("fxSpotPrice"),
    fxSpotLast: document.getElementById("fxSpotLast"),
    fxSpotStatus: document.getElementById("fxSpotStatus"),
    fxStatusDot: document.getElementById("fxStatusDot"),
    fxSpotMeta: document.getElementById("fxSpotMeta"),
    fxSpotDelta: document.getElementById("fxSpotDelta"),

    eventsBody: document.getElementById("eventsBody"),
    headlinesBody: document.getElementById("headlinesBody"),

    riskBig: document.getElementById("riskBig"),
    riskRule: document.getElementById("riskRule"),

    logBody: document.getElementById("logBody"),
    copyCsvBtn: document.getElementById("copyCsvBtn"),
    clearLogBtn: document.getElementById("clearLogBtn"),

    sysStatus: document.getElementById("sysStatus"),
    footPolicy: document.getElementById("footPolicy"),
    footDetector: document.getElementById("footDetector"),
    footHold: document.getElementById("footHold"),
  };

  // ---------- Persistence keys ----------
  const KEY = {
    dashboard: "qx_dashboard_state_v1",
    events: "qx_events_v1",
    headlines: "qx_headlines_v1",
    log: "qx_regime_log_v1"
  };

  // ---------- Curated defaults ----------
  const curatedEventsDefault = [
    { when: "2026-02-17T21:18:47Z", event: "Eurozone CPI (flash)", impact: "HIGH" },
    { when: "2026-02-18T17:18:47Z", event: "US Initial Jobless Claims", impact: "MED" },
    { when: "2026-02-19T21:18:47Z", event: "US GDP (advance)", impact: "HIGH" },
    { when: "2026-02-22T15:18:47Z", event: "US Non-Farm Payrolls", impact: "HIGH" }
  ];

  const curatedHeadlinesDefault = [
    { time: "03:00 PM", source: "FinancialJuice", title: "Dollar firming ahead of major data window", url: "https://financialjuice.com/" },
    { time: "02:26 PM", source: "FinancialJuice", title: "Rates repricing drives short-term USD bid", url: "https://financialjuice.com/" },
    { time: "01:06 PM", source: "Market", title: "Risk tone mixed as equities stabilize", url: "https://www.investing.com/" }
  ];

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : fallback;
    }catch(e){ return fallback; }
  }

  let curatedEvents = loadJSON(KEY.events, curatedEventsDefault);
  let curatedHeadlines = loadJSON(KEY.headlines, curatedHeadlinesDefault);

  // ---------- Escape helpers ----------
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function escapeAttr(s){
    return String(s).replace(/"/g, "&quot;");
  }

  // ---------- Render events ----------
  function impactPill(impact){
    const imp = (impact || "").toUpperCase();
    if (imp === "HIGH") return `<span class="impact"><span class="folder"></span>HIGH</span>`;
    if (imp === "MED") return `<span class="impact"><span class="folder med"></span>MED</span>`;
    return `<span class="impact"><span class="folder low"></span>LOW</span>`;
  }

  function countdownText(iso){
    const t = new Date(iso).getTime();
    const now = Date.now();
    if (!Number.isFinite(t)) return "--";
    const d = t - now;
    if (d <= 0) return "Now";
    const mins = Math.floor(d/60000);
    const days = Math.floor(mins / (60*24));
    const hrs = Math.floor((mins - days*60*24)/60);
    const rem = mins - days*60*24 - hrs*60;
    if (days > 0) return `${days}d ${hrs}h`;
    if (hrs > 0) return `${hrs}h ${rem}m`;
    return `${rem}m`;
  }

  function renderEvents(){
    const rows = curatedEvents
      .slice()
      .sort((a,b)=> new Date(a.when)-new Date(b.when))
      .map(e=>{
        const when = new Date(e.when);
        const whenStr = isNaN(when.getTime()) ? String(e.when) : `${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}`;
        return `
          <tr>
            <td>${whenStr}</td>
            <td><a class="link" href="https://www.forexfactory.com/" target="_blank" rel="noopener noreferrer">${escapeHtml(e.event || "")}</a></td>
            <td>${impactPill(e.impact)}</td>
            <td>${countdownText(e.when)}</td>
          </tr>
        `;
      }).join("");

    els.eventsBody.innerHTML = rows || `<tr><td colspan="4" style="color:rgba(255,255,255,0.6)">No events set.</td></tr>`;
  }

  // ---------- Render headlines ----------
  function renderHeadlines(){
    const rows = curatedHeadlines.map(h=>{
      const url = h.url || "#";
      return `
        <tr>
          <td>${escapeHtml(h.time || "")}</td>
          <td>${escapeHtml(h.source || "")}</td>
          <td><a class="link" href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(h.title || "")}</a></td>
        </tr>
      `;
    }).join("");

    els.headlinesBody.innerHTML = rows || `<tr><td colspan="3" style="color:rgba(255,255,255,0.6)">No headlines set.</td></tr>`;
  }

  // ---------- Modal wiring ----------
  function openModal(){
    els.eventsEditor.value = JSON.stringify(curatedEvents, null, 2);
    els.headlinesEditor.value = JSON.stringify(curatedHeadlines, null, 2);
    els.modalBack.style.display = "flex";
  }
  function closeModal(){
    els.modalBack.style.display = "none";
  }

  els.editBtn.addEventListener("click", openModal);
  els.closeModalBtn.addEventListener("click", closeModal);
  els.modalBack.addEventListener("click", (e)=>{ if (e.target === els.modalBack) closeModal(); });

  els.resetCuratedBtn.addEventListener("click", ()=>{
    curatedEvents = structuredClone(curatedEventsDefault);
    curatedHeadlines = structuredClone(curatedHeadlinesDefault);
    els.eventsEditor.value = JSON.stringify(curatedEvents, null, 2);
    els.headlinesEditor.value = JSON.stringify(curatedHeadlines, null, 2);
  });

  els.saveCuratedBtn.addEventListener("click", ()=>{
    try{
      const ev = JSON.parse(els.eventsEditor.value);
      const hd = JSON.parse(els.headlinesEditor.value);
      if (!Array.isArray(ev) || !Array.isArray(hd)) throw new Error("Not arrays");
      curatedEvents = ev;
      curatedHeadlines = hd;
      localStorage.setItem(KEY.events, JSON.stringify(curatedEvents));
      localStorage.setItem(KEY.headlines, JSON.stringify(curatedHeadlines));
      renderEvents();
      renderHeadlines();
      closeModal();
    }catch(err){
      alert("Invalid JSON. Fix the JSON formatting before saving.");
    }
  });

  // ---------- Live headlines via GDELT ----------
  async function fetchGdeltHeadlines(){
    const q = encodeURIComponent('(eurusd OR "euro dollar" OR ECB OR Fed OR inflation OR jobs OR sanctions OR iran OR hormuz OR oil OR brent OR wti OR gold OR silver)');
    const url = `https://api.gdeltproject.org/api/v2/doc/doc?query=${q}&mode=ArtList&format=json&maxrecords=12&sort=datedesc`;

    try{
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("GDELT bad response");
      const j = await res.json();
      const arts = j?.articles || [];

      const live = arts.map(a => {
        const dt = a.seendate ? new Date(a.seendate) : null;
        const tm = dt && !isNaN(dt.getTime())
          ? dt.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" })
          : "--:--";
        return {
          time: tm,
          source: a.domain || "GDELT",
          title: a.title || "(no title)",
          url: a.url || "https://gdeltproject.org/"
        };
      });

      if (live.length){
        curatedHeadlines = live;
        renderHeadlines();
      }
    }catch(e){
      // keep curated if live fails
    }
  }

  // ---------- Live geopolitics events via GDELT (demo) ----------
  async function fetchGdeltEvents(){
    const q = encodeURIComponent('(iran OR hormuz OR "strait of hormuz" OR sanctions OR missile OR "oil facility" OR tanker OR opec OR venezuela OR libya)');
    const url = `https://api.gdeltproject.org/api/v2/doc/doc?query=${q}&mode=ArtList&format=json&maxrecords=8&sort=datedesc`;

    try{
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("GDELT bad response");
      const j = await res.json();
      const arts = j?.articles || [];

      const liveEvents = arts.map(a => {
        const dt = a.seendate ? new Date(a.seendate) : new Date();
        const iso = dt.toISOString();
        return { when: iso, event: a.title || "(no title)", impact: "MED" };
      });

      if (liveEvents.length){
        curatedEvents = liveEvents;
        renderEvents();
      }
    }catch(e){
      // keep curated if live fails
    }
  }

  // ---------- Spot feed: TradingView scanner first, then fallbacks ----------
  const SpotFeed = (() => {

    async function fetchTradingView(timeoutMs = 5500){
      const controller = new AbortController();
      const timer = setTimeout(()=> controller.abort(), timeoutMs);

      try{
        const url = "https://scanner.tradingview.com/forex/scan";
        const payload = {
          filter: [{ left: "name", operation: "equal", right: "EURUSD" }],
          options: { lang: "en" },
          symbols: { tickers: ["FX:EURUSD"], query: { types: [] } },
          columns: ["close","change","change_abs","change_pct","description"]
        };

        const t0 = performance.now();
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          cache: "no-store",
          signal: controller.signal
        });
        clearTimeout(timer);

        if (!res.ok) throw new Error(`TV HTTP ${res.status}`);
        const j = await res.json();
        const row = j?.data?.[0]?.d;
        const px = Number(row?.[0]);

        if (!Number.isFinite(px) || px <= 0) throw new Error("TV parse failed");
        const latency = Math.round(performance.now() - t0);
        return { ok:true, price:px, source:"tradingview.scan", latencyMs:latency };
      }catch(e){
        clearTimeout(timer);
        return { ok:false };
      }
    }

    const fallbackSources = [
      {
        name: "exchangerate.host",
        url: () => `https://api.exchangerate.host/latest?base=EUR&symbols=USD&_=${Date.now()}`,
        parse: (j) => j?.rates?.USD
      },
      {
        name: "frankfurter.app",
        url: () => `https://api.frankfurter.app/latest?from=EUR&to=USD&_=${Date.now()}`,
        parse: (j) => j?.rates?.USD
      },
      {
        name: "open.er-api.com",
        url: () => `https://open.er-api.com/v6/latest/EUR?_=${Date.now()}`,
        parse: (j) => j?.rates?.USD
      }
    ];

    async function fetchFallback(timeoutMs = 5500){
      for (const s of fallbackSources){
        const t0 = performance.now();
        try{
          const controller = new AbortController();
          const timer = setTimeout(()=> controller.abort(), timeoutMs);

          const res = await fetch(s.url(), { method:"GET", cache:"no-store", signal: controller.signal });
          clearTimeout(timer);

          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const j = await res.json();
          const px = Number(s.parse(j));
          if (!Number.isFinite(px) || px <= 0) throw new Error("Bad parse");

          const latency = Math.round(performance.now() - t0);
          return { ok:true, price:px, source:s.name, latencyMs:latency };
        }catch(e){
          // try next
        }
      }
      return { ok:false };
    }

    let last = {
      price: null,
      ts: 0,
      source: null,
      latencyMs: null,
      staleCount: 0,
      lastChangeTs: 0,
      lastDelta: 0
    };

    const STALE_MS = 45_000;
    const MIN_MOVE = 0.000002;

    function status(now = Date.now()){
      if (!last.price) return { status: "CHECKING", stale: false };
      const stale = (now - last.lastChangeTs) > STALE_MS;
      return { status: stale ? "STALE" : "LIVE", stale };
    }

    async function tick(updateCb){
      const now = Date.now();

      let r = await fetchTradingView();
      if (!r.ok) r = await fetchFallback();

      if (!r.ok){
        last.staleCount += 1;
        updateCb?.({ ok:false, ...last, ...status(now) });
        return;
      }

      const prev = last.price;
      const moved = (prev == null) ? true : Math.abs(r.price - prev) > MIN_MOVE;
      const delta = (prev == null) ? 0 : (r.price - prev);

      last.price = r.price;
      last.ts = now;
      last.source = r.source;
      last.latencyMs = r.latencyMs;
      last.staleCount = 0;
      last.lastDelta = delta;

      if (moved) last.lastChangeTs = now;
      if (!last.lastChangeTs) last.lastChangeTs = now;

      updateCb?.({ ok:true, ...last, ...status(now) });
    }

    return { tick, getLast: ()=> ({...last}) };
  })();

  // ---------- Regime engine ----------
  const Engine = (() => {
    const HISTORY_N = 64;
    const MOM_WINDOW = 8;
    const VOL_WINDOW = 18;
    const HOLD_TICKS = 4;
    const PROB_TEMP = 1.35;

    let tickN = 0;
    let prices = [];
    let returns = [];

    let detectorState = null;
    let policyState = null;
    let hold = 0;
    let policyHistory = [];

    function softmax(logits){
      const m = Math.max(...logits);
      const exps = logits.map(v => Math.exp((v - m) / PROB_TEMP));
      const s = exps.reduce((a,b)=>a+b,0) || 1;
      return exps.map(v => v/s);
    }

    function computeFeatures(){
      if (prices.length < 3) return null;

      const p = prices[prices.length-1];
      const pPrev = prices[prices.length-2];

      const r = (pPrev ? (p - pPrev) : 0);
      const momBase = prices[Math.max(0, prices.length-1-MOM_WINDOW)];
      const mom = momBase ? (p - momBase) : 0;

      const recentR = returns.slice(-VOL_WINDOW);
      const absAvg = recentR.length ? recentR.reduce((a,b)=>a+Math.abs(b),0)/recentR.length : 0;
      const volx = clamp(absAvg / 0.00015, 0, 5);

      const shock = Math.abs(r) > 0.0007 ? 1 : 0;
      return { p, r, mom, volx, shock };
    }

    function scoreStates(f){
      const momBp = Math.abs(bp(f.mom));
      const rBp = Math.abs(bp(f.r));
      const vol = f.volx;

      const signChanges = (() => {
        const rr = returns.slice(-10);
        if (rr.length < 6) return 0;
        let changes = 0;
        for (let i=1;i<rr.length;i++){
          if (Math.sign(rr[i]) !== Math.sign(rr[i-1])) changes++;
        }
        return changes;
      })();

      const L = new Array(8).fill(0);
      L[0] = 2.4 - 0.7*vol - 0.04*momBp;
      L[1] = 1.1 + 0.55*vol - 0.03*momBp;
      L[2] = 1.6 - 0.25*vol - 0.02*momBp;
      L[3] = 0.9 + 0.25*vol + 0.045*momBp;
      L[4] = -0.2 + 0.55*vol + 0.02*momBp + 0.04*rBp;
      L[5] = -0.4 + (f.shock ? 3.0 : 0) + 0.2*vol;
      L[6] = 0.3 + 0.18*vol + 0.35*clamp(signChanges/6,0,1) - 0.02*momBp;
      L[7] = -0.8 + 0.95*Math.max(0, vol-2.2) + 0.04*rBp + (f.shock ? 0.6 : 0);

      return softmax(L);
    }

    function pickState(probs){
      let best = 0;
      for (let i=1;i<probs.length;i++) if (probs[i] > probs[best]) best = i;
      return best+1;
    }

    function confidence(probs, state){
      const s = state-1;
      const top = probs[s];
      const sorted = [...probs].sort((a,b)=>b-a);
      const gap = (sorted[0] - (sorted[1] || 0));
      return clamp((top*0.7 + gap*0.3), 0, 1);
    }

    function updatePolicy(det){
      if (policyState == null){
        policyState = det;
        hold = 0;
        return { policy: policyState, hold, changed:true };
      }
      if (det === policyState){
        hold = 0;
        return { policy: policyState, hold, changed:false };
      }
      hold += 1;
      if (hold >= HOLD_TICKS){
        policyState = det;
        hold = 0;
        return { policy: policyState, hold, changed:true };
      }
      return { policy: policyState, hold, changed:false };
    }

    function step(price){
      tickN += 1;

      const p = Number(price);
      if (!Number.isFinite(p) || p <= 0) return null;

      const prev = prices.length ? prices[prices.length-1] : null;
      prices.push(p);
      if (prices.length > HISTORY_N) prices.shift();

      if (prev != null){
        const r = p - prev;
        returns.push(r);
        if (returns.length > HISTORY_N) returns.shift();
      }

      const f = computeFeatures();
      if (!f) return null;

      const probs = scoreStates(f);
      const det = pickState(probs);

      const polRes = updatePolicy(det);
      policyHistory.unshift(polRes.policy);
      policyHistory = policyHistory.slice(0, 12);

      const conf = confidence(probs, polRes.policy);

      return {
        tickN,
        features: f,
        probs,
        detector: det,
        policy: polRes.policy,
        hold: polRes.hold,
        conf
      };
    }

    function getHistory(){ return policyHistory.slice(); }

    return { step, getHistory };
  })();

  // ---------- Probability UI skeleton ----------
  const probEls = [];
  function initProbUI(){
    els.probList.innerHTML = "";
    STATES.forEach((s)=> {
      const row = document.createElement("div");
      row.className = "probRow";
      row.innerHTML = `
        <div class="probName"><span class="pdot" style="background:${s.color}"></span>State ${s.id}: ${s.name}</div>
        <div class="pbar"><i></i></div>
        <div class="probVal">--%</div>
      `;
      els.probList.appendChild(row);
      probEls.push({
        bar: row.querySelector(".pbar > i"),
        val: row.querySelector(".probVal")
      });
    });
  }

  function renderHistory(history, active){
    els.stateHistory.innerHTML = "";
    const arr = history.length ? history : new Array(12).fill(null);

    arr.forEach((st, i)=>{
      const d = document.createElement("div");
      d.className = "hbox" + ((i===0) ? " active" : "");
      d.textContent = st ? String(st) : "-";
      els.stateHistory.appendChild(d);
    });

    els.stateBadge.textContent = active ? String(active) : "--";
    if (active){
      const color = STATES[active-1]?.color || "rgba(120,170,255,0.8)";
      els.stateBadge.style.borderColor = color;
      els.stateBadge.style.boxShadow = `0 0 0 6px rgba(120,170,255,0.14)`;
    }
  }

  function setRisk(policyState, conf){
    let level = "NORMAL";
    let rule = "Rule: Trade normally. Avoid overfitting. Keep size disciplined.";

    if (!policyState){
      level = "--";
      rule = "Policy: state-aware sizing and entry gating";
    } else {
      if (policyState === 1) { level = "NORMAL"; rule = "Rule: Range logic favored. Avoid forcing breakouts."; }
      if (policyState === 2) { level = "ELEVATED"; rule = "Rule: Thin liquidity risk. Reduce size and wait for confirmation."; }
      if (policyState === 3) { level = "NORMAL"; rule = "Rule: Drift regime. Small edges, avoid impulsive entries."; }
      if (policyState === 4) { level = "ELEVATED"; rule = "Rule: Trend regime. Bias with trend. Cut countertrend attempts."; }
      if (policyState === 5) { level = "HIGH"; rule = "Rule: Stop cascade risk. De-risk and widen filters."; }
      if (policyState === 6) { level = "HIGH"; rule = "Rule: News shock. Consider standing down around releases."; }
      if (policyState === 7) { level = "ELEVATED"; rule = "Rule: Unwind risk. Protect and demand confirmation."; }
      if (policyState === 8) { level = "CRITICAL"; rule = "Rule: Risk off. Protect capital first."; }

      if (conf != null && conf < 0.35 && (level === "NORMAL")) level = "ELEVATED";
      if (conf != null && conf < 0.25 && (level === "ELEVATED")) level = "HIGH";
    }

    els.riskBig.textContent = level;
    els.riskRule.textContent = rule;
  }

  // ---------- Regime log ----------
  let logRows = loadJSON(KEY.log, []);
  function persistLog(){
    localStorage.setItem(KEY.log, JSON.stringify(logRows.slice(0, 250)));
  }

  function renderLog(){
    const html = logRows.slice(0, 80).map(r=>`
      <tr>
        <td>${escapeHtml(r.time)}</td>
        <td>${escapeHtml(r.price)}</td>
        <td>${escapeHtml(r.det)}</td>
        <td>${escapeHtml(r.pol)}</td>
        <td>${escapeHtml(r.conf)}</td>
        <td>${escapeHtml(r.volx)}</td>
        <td>${escapeHtml(r.mom)}</td>
        <td>${escapeHtml(r.stale)}</td>
        <td>${escapeHtml(r.src)}</td>
      </tr>
    `).join("");
    els.logBody.innerHTML = html || `<tr><td colspan="9" style="color:rgba(255,255,255,0.6)">No samples yet.</td></tr>`;
  }

  function addLogSample(sample){
    logRows.unshift(sample);
    logRows = logRows.slice(0, 250);
    persistLog();
    renderLog();
  }

  function csvCell(v){
    const s = String(v ?? "");
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  els.copyCsvBtn.addEventListener("click", async ()=>{
    const header = ["time","eurusd","det","pol","conf","volx","mom_bp","stale","src"];
    const lines = [header.join(",")];
    for (const r of logRows.slice().reverse()){
      lines.push([r.time,r.price,r.det,r.pol,r.conf,r.volx,r.mom,r.stale,r.src].map(csvCell).join(","));
    }
    try{
      await navigator.clipboard.writeText(lines.join("\n"));
      els.copyCsvBtn.textContent = "Copied";
      setTimeout(()=> els.copyCsvBtn.textContent = "Copy as CSV", 900);
    }catch(e){
      alert("Clipboard copy failed. Your browser is being difficult.");
    }
  });

  els.clearLogBtn.addEventListener("click", ()=>{
    if (!confirm("Clear regime log?")) return;
    logRows = [];
    persistLog();
    renderLog();
  });

  // ---------- Pause + Sync ----------
  let paused = false;
  els.pauseBtn.addEventListener("click", ()=>{
    paused = !paused;
    els.pauseBtn.textContent = paused ? "Resume" : "Pause";
    els.sysStatus.textContent = paused ? "PAUSED" : "LIVE";
    if (paused){
      els.liveDot.style.background = "rgba(255,176,32,1)";
      els.liveDot.style.boxShadow = "0 0 0 4px rgba(255,176,32,0.18)";
    } else {
      els.liveDot.style.background = "rgba(24,209,138,1)";
      els.liveDot.style.boxShadow = "0 0 0 4px rgba(24,209,138,0.18)";
    }
  });

  els.syncBtn.addEventListener("click", ()=>{
    SpotFeed.tick(onSpotUpdate);
  });

  // ---------- Dashboard state persistence ----------
  let dashState = (function(){
    try{
      const raw = localStorage.getItem(KEY.dashboard);
      if (!raw) return {};
      return JSON.parse(raw) || {};
    }catch(e){ return {}; }
  })();

  function persistDashState(){
    try{
      localStorage.setItem(KEY.dashboard, JSON.stringify(dashState));
    }catch(e){}
  }

  // ---------- Spot rendering + engine drive ----------
  let stalePolls = 0;

  function setFxStatus(status){
    els.fxSpotStatus.textContent = status;
    els.fxStatusDot.classList.remove("live","err");
    if (status === "LIVE"){
      els.fxStatusDot.classList.add("live");
    } else if (status === "ERROR"){
      els.fxStatusDot.classList.add("err");
    }
  }

  function onSpotUpdate(s){
    const now = Date.now();
    els.lastUpdate.textContent = fmtTime(now);

    if (!s.ok){
      setFxStatus("ERROR");
      els.fxSpotMeta.textContent = `Source: -- | Latency: --`;
      els.fxSpotDelta.textContent = `Delta (last): 0.00000`;
      stalePolls += 1;
      els.staleChip.textContent = String(stalePolls);
      return;
    }

    els.fxSpotPrice.textContent = s.price.toFixed(5);
    els.fxSpotLast.textContent = `Last good sample: ${fmtTime(s.ts)}`;
    els.fxSpotMeta.textContent = `Source: ${s.source} | Latency: ${s.latencyMs}ms`;
    els.fxSpotDelta.textContent = `Delta (last): ${s.lastDelta.toFixed(5)}`;

    els.miniPrice.textContent = s.price.toFixed(5);
    els.miniSrc.textContent = `Feed ${s.source}`;
    els.miniDelta.textContent = s.lastDelta.toFixed(5);

    const w = clamp(Math.abs(s.lastDelta) / 0.0012, 0, 1) * 100;
    els.miniBar.style.width = `${Math.max(10, w)}%`;
    els.miniBar.style.background = (s.lastDelta >= 0) ? "rgba(24,209,138,0.85)" : "rgba(255,77,77,0.85)";

    setFxStatus(s.status);
    if (s.status === "STALE") stalePolls += 1;
    else stalePolls = 0;
    els.staleChip.textContent = String(stalePolls);

    if (paused) return;

    const step = Engine.step(s.price);
    if (!step) return;

    els.tickChip.textContent = String(step.tickN);

    const det = step.detector;
    const pol = step.policy;
    const confPct = (step.conf * 100).toFixed(1) + "%";

    const polName = STATES[pol-1]?.name || "--";
    const polDesc = STATES[pol-1]?.desc || "Waiting for signal.";

    els.policyStateTitle.textContent = `Policy State: S${pol} ${polName}`;
    els.policyStateDesc.textContent = polDesc;

    els.detectorChip.textContent = `S${det}`;
    els.policyChip.textContent = `S${pol}`;
    els.confChip.textContent = confPct;

    const hystLabel = (det === pol) ? "stable" : `holding`;
    els.hystChip.textContent = hystLabel;

    setRisk(pol, step.conf);

    step.probs.forEach((p, i)=>{
      const pct = (p*100);
      probEls[i].bar.style.width = `${clamp(pct, 0, 100)}%`;
      probEls[i].bar.style.background = STATES[i].color;
      probEls[i].val.textContent = `${pct.toFixed(1)}%`;
    });

    renderHistory(Engine.getHistory(), pol);

    els.footPolicy.textContent = `S${pol}`;
    els.footDetector.textContent = `S${det}`;
    els.footHold.textContent = String(step.hold);

    dashState = {
      lastPrice: s.price,
      lastTs: s.ts,
      lastSrc: s.source,
      lastPolicy: pol,
      lastDetector: det,
      lastConf: step.conf,
      lastProbs: step.probs,
      lastHold: step.hold,
      lastTick: step.tickN
    };
    persistDashState();

    addLogSample({
      time: fmtTime(s.ts),
      price: s.price.toFixed(5),
      det: `S${det}`,
      pol: `S${pol}`,
      conf: confPct,
      volx: step.features.volx.toFixed(2),
      mom: bp(step.features.mom).toFixed(2),
      stale: (s.status === "STALE") ? "Y" : "N",
      src: s.source
    });
  }

  function hydrateFromPersisted(){
    if (!dashState || !dashState.lastPrice) return;

    els.fxSpotPrice.textContent = Number(dashState.lastPrice).toFixed(5);
    els.fxSpotLast.textContent = `Last good sample: ${fmtTime(dashState.lastTs || Date.now())}`;
    els.fxSpotMeta.textContent = `Source: ${dashState.lastSrc || "--"} | Latency: --`;
    els.fxSpotDelta.textContent = `Delta (last): 0.00000`;

    els.miniPrice.textContent = Number(dashState.lastPrice).toFixed(5);
    els.miniSrc.textContent = `Feed ${dashState.lastSrc || "--"}`;
    els.miniDelta.textContent = "0.00000";

    if (dashState.lastPolicy){
      const pol = dashState.lastPolicy;
      const polName = STATES[pol-1]?.name || "--";
      const polDesc = STATES[pol-1]?.desc || "--";
      els.policyStateTitle.textContent = `Policy State: S${pol} ${polName}`;
      els.policyStateDesc.textContent = polDesc;
      els.policyChip.textContent = `S${pol}`;
      els.stateBadge.textContent = String(pol);
      els.footPolicy.textContent = `S${pol}`;
      renderHistory([pol], pol);
    }
    if (dashState.lastDetector){
      els.detectorChip.textContent = `S${dashState.lastDetector}`;
      els.footDetector.textContent = `S${dashState.lastDetector}`;
    }
    if (dashState.lastConf != null){
      els.confChip.textContent = (dashState.lastConf*100).toFixed(1) + "%";
      setRisk(dashState.lastPolicy, dashState.lastConf);
    }
    if (Array.isArray(dashState.lastProbs) && dashState.lastProbs.length === 8){
      dashState.lastProbs.forEach((p,i)=>{
        const pct = p*100;
        probEls[i].bar.style.width = `${clamp(pct,0,100)}%`;
        probEls[i].bar.style.background = STATES[i].color;
        probEls[i].val.textContent = `${pct.toFixed(1)}%`;
      });
    }
    if (dashState.lastTick){
      els.tickChip.textContent = String(dashState.lastTick);
    }
    if (dashState.lastHold != null){
      els.footHold.textContent = String(dashState.lastHold);
    }
  }

  // ---------- Start polling ----------
  const POLL_MS = 12_000;

  async function start(){
    initProbUI();
    renderEvents();
    renderHeadlines();
    renderLog();
    hydrateFromPersisted();
    renderHistory([], null);

    await SpotFeed.tick(onSpotUpdate);
    setInterval(()=> SpotFeed.tick(onSpotUpdate), POLL_MS);

    // Countdown refresh
    setInterval(()=> renderEvents(), 30_000);

    // Live demo feeds (fallback safe)
    fetchGdeltHeadlines();
    setInterval(fetchGdeltHeadlines, 3 * 60_000);

    fetchGdeltEvents();
    setInterval(fetchGdeltEvents, 5 * 60_000);
  }

  start();

})();
</script>
</body>
</html>
