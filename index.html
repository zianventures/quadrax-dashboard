<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>QuadraX Risk Dashboard</title>
  <style>
    :root{
      --bg0:#050a1a;
      --bg1:#07122f;
      --card: rgba(10, 25, 60, 0.55);
      --card2: rgba(12, 34, 84, 0.42);
      --stroke: rgba(120, 170, 255, 0.22);
      --stroke2: rgba(120, 170, 255, 0.12);
      --text:#e9f0ff;
      --muted: rgba(233,240,255,0.7);
      --muted2: rgba(233,240,255,0.55);
      --blue:#2b6cff;
      --green:#18d18a;
      --amber:#ffb020;
      --red:#ff4d4d;
      --pink:#ff3aa5;
      --shadow: 0 18px 55px rgba(0,0,0,0.55);
      --shadow2: 0 10px 30px rgba(0,0,0,0.45);
      --radius: 22px;
      --radius2: 16px;
      --pad: 18px;
      --pad2: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 20%, rgba(80,140,255,0.22), transparent 55%),
        radial-gradient(900px 600px at 70% 35%, rgba(22,210,170,0.16), transparent 55%),
        radial-gradient(900px 700px at 35% 85%, rgba(255,80,180,0.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1440px;
      margin: 22px auto 40px;
      padding: 0 16px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding: 18px 18px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(50,115,255,0.55), rgba(35,85,200,0.42));
      border: 1px solid rgba(210,230,255,0.18);
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 14px;
      min-width: 320px;
    }

    .qxlogo{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      font-weight: 1000;
      letter-spacing: 0.5px;
      background: rgba(10,25,60,0.45);
      border: 1px solid rgba(210,230,255,0.18);
      box-shadow: var(--shadow2);
      user-select:none;
    }

    .brand h1{
      margin:0;
      font-size: 18px;
      line-height: 1.1;
    }
    .brand .sub{
      margin-top: 2px;
      font-size: 12px;
      color: rgba(255,255,255,0.78);
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(10,25,60,0.35);
      border:1px solid rgba(210,230,255,0.16);
      color: rgba(255,255,255,0.9);
      font-size: 12px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.25);
      white-space:nowrap;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--green);
      box-shadow: 0 0 0 4px rgba(24,209,138,0.18);
    }

    .btn{
      cursor:pointer;
      border: 1px solid rgba(210,230,255,0.18);
      background: rgba(10,25,60,0.35);
      color: rgba(255,255,255,0.92);
      border-radius: 999px;
      padding: 9px 14px;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: 0.2px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.25);
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.06); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: rgba(35,120,255,0.35);
      border-color: rgba(120,170,255,0.26);
    }

    .grid{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
    }

    .stack{ display:grid; gap: 16px; }

    .card{
      background: linear-gradient(180deg, rgba(10,25,60,0.55), rgba(7,12,30,0.35));
      border:1px solid rgba(210,230,255,0.16);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
    }

    .card .inner{
      padding: var(--pad);
    }

    .card-title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }

    .card-title h2{
      margin:0;
      font-size: 13px;
      color: rgba(255,255,255,0.82);
      letter-spacing: 0.9px;
      text-transform: uppercase;
    }
    .card-title .hint{
      font-size: 12px;
      color: rgba(255,255,255,0.55);
      text-align:right;
      max-width: 520px;
    }

    /* Current market state layout (grown-up, not chaotic) */
    .cmsGrid{
      display:grid;
      grid-template-columns: 1.4fr 0.9fr;
      gap: 14px;
      align-items:stretch;
    }
    @media (max-width: 900px){
      .cmsGrid{ grid-template-columns: 1fr; }
    }

    .hero{
      border-radius: 22px;
      background: radial-gradient(900px 500px at 20% 10%, rgba(120,170,255,0.15), transparent 55%),
                  radial-gradient(700px 420px at 80% 20%, rgba(24,209,138,0.12), transparent 55%),
                  rgba(10,25,60,0.18);
      border: 1px solid rgba(210,230,255,0.10);
      padding: 18px;
      position:relative;
      overflow:hidden;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:-2px;
      background: linear-gradient(120deg, rgba(120,170,255,0.10), transparent 35%, rgba(255,58,165,0.08));
      pointer-events:none;
      opacity:0.7;
    }

    .stateBig{
      font-size: 44px;
      font-weight: 1000;
      letter-spacing: 0.2px;
      margin: 4px 0 2px;
      position:relative;
      z-index:1;
    }
    .muted{ color: var(--muted); font-size: 13px; position:relative; z-index:1; }

    .chipRow{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 12px;
      align-items:center;
      position:relative;
      z-index:1;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,0.88);
      background: rgba(10,25,60,0.30);
      border: 1px solid rgba(210,230,255,0.14);
      white-space:nowrap;
    }
    .chip b{ font-weight:1000; }

    .pillTag{
      font-family: var(--mono);
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(210,230,255,0.14);
      background: rgba(10,25,60,0.22);
      color: rgba(255,255,255,0.86);
    }

    /* Quote panel */
    .quoteCard{
      border-radius: 22px;
      background: rgba(10,25,60,0.20);
      border: 1px solid rgba(210,230,255,0.12);
      padding: 16px;
      display:grid;
      gap: 10px;
      position:relative;
      overflow:hidden;
    }
    .quoteTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .quoteSym{
      display:grid;
      gap: 2px;
    }
    .quoteSym .sym{
      font-weight: 1000;
      letter-spacing: 0.6px;
      font-size: 12px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.85);
    }
    .quoteSym .prov{
      font-size: 11px;
      color: rgba(255,255,255,0.58);
    }
    .qStatus{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(210,230,255,0.14);
      background: rgba(10,25,60,0.26);
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,0.88);
      white-space:nowrap;
    }
    .sdot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--amber);
      box-shadow: 0 0 0 4px rgba(255,176,32,0.18);
    }
    .sdot.live{ background: var(--green); box-shadow: 0 0 0 4px rgba(24,209,138,0.18); }
    .sdot.err{ background: var(--red); box-shadow: 0 0 0 4px rgba(255,77,77,0.18); }

    .quotePx{
      font-size: 42px;
      font-weight: 1000;
      letter-spacing: 0.4px;
      font-variant-numeric: tabular-nums;
      line-height: 1.0;
    }
    .quoteMetaRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      color: rgba(255,255,255,0.62);
      font-size: 12px;
      font-variant-numeric: tabular-nums;
    }
    .sparkBar{
      height: 7px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .sparkBar > i{
      display:block;
      height:100%;
      width: 15%;
      border-radius: 999px;
      background: rgba(24,209,138,0.85);
    }
    .quoteBadges{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    /* Inline probabilities inside current state (the “it factor” part) */
    .probBlock{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(210,230,255,0.10);
      position:relative;
      z-index:1;
    }
    .probRow{
      display:grid;
      grid-template-columns: 240px 1fr 64px;
      gap: 12px;
      align-items:center;
      padding: 9px 0;
      border-top: 1px solid rgba(210,230,255,0.06);
    }
    .probRow:first-child{ border-top:none; }
    .probName{
      font-size: 12px;
      color: rgba(255,255,255,0.88);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pdot{
      width: 14px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
    }
    .pbar{
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
      position:relative;
    }
    .pbar > i{
      display:block;
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: rgba(120,170,255,0.8);
    }
    .probVal{
      font-size: 12px;
      color: rgba(255,255,255,0.78);
      text-align:right;
      font-variant-numeric: tabular-nums;
    }

    /* Right column panels */
    .riskLevel{
      text-align:center;
      padding: 22px 16px 14px;
    }
    .riskLevel .label{
      font-size: 12px;
      letter-spacing: 0.9px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.72);
    }
    .riskLevel .big{
      font-size: 44px;
      font-weight: 1000;
      margin: 6px 0 2px;
    }
    .riskLevel .rule{
      font-size: 12px;
      color: rgba(255,255,255,0.68);
      max-width: 360px;
      margin: 0 auto;
      line-height: 1.35;
    }

    .macroHint{
      font-size: 12px;
      color: rgba(255,255,255,0.62);
      line-height: 1.35;
      max-width: 420px;
      text-align:right;
    }

    .macroGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:stretch;
    }
    .macroBox{
      border-radius: 18px;
      background: rgba(10,25,60,0.25);
      border:1px solid rgba(210,230,255,0.12);
      padding: 14px;
      min-height: 92px;
      display:grid;
      align-content:start;
      gap: 6px;
    }
    .macroBox .k{
      font-size: 12px;
      color: rgba(255,255,255,0.72);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .macroBox .v{
      font-size: 22px;
      font-weight: 1000;
      font-variant-numeric: tabular-nums;
      line-height: 1.1;
    }
    .macroBox .meta{
      font-size: 12px;
      color: rgba(255,255,255,0.58);
      font-variant-numeric: tabular-nums;
      line-height: 1.35;
    }
    .tagOk{
      font-family: var(--mono);
      font-size: 10.5px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(210,230,255,0.14);
      background: rgba(10,25,60,0.22);
      color: rgba(255,255,255,0.82);
      white-space:nowrap;
    }

    .impact{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(210,230,255,0.14);
      background: rgba(10,25,60,0.22);
      font-weight: 950;
      color: rgba(255,255,255,0.88);
      white-space:nowrap;
    }
    .folder{
      width: 10px;
      height: 10px;
      border-radius: 3px;
      background: var(--pink);
      box-shadow: 0 0 0 4px rgba(255,58,165,0.14);
    }
    .folder.med{ background: var(--amber); box-shadow: 0 0 0 4px rgba(255,176,32,0.14); }
    .folder.low{ background: rgba(255,255,255,0.30); box-shadow: none; }

    .tableWrap{
      border-radius: 18px;
      background: rgba(10,25,60,0.20);
      border:1px solid rgba(210,230,255,0.12);
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size: 12px;
    }
    thead th{
      text-align:left;
      padding: 12px 12px;
      color: rgba(255,255,255,0.78);
      border-bottom: 1px solid rgba(210,230,255,0.10);
      background: rgba(10,25,60,0.22);
      font-weight: 900;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      font-size: 11px;
    }
    tbody td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(210,230,255,0.06);
      color: rgba(255,255,255,0.82);
      vertical-align:top;
      font-variant-numeric: tabular-nums;
    }
    tbody tr:hover{ background: rgba(255,255,255,0.04); }
    .scroll{ max-height: 280px; overflow:auto; }

    .link{
      color: rgba(120,170,255,0.95);
      text-decoration:none;
      font-weight: 800;
    }
    .link:hover{ text-decoration:underline; }

    /* Forward projection */
    .fpGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      align-items:stretch;
    }
    @media (max-width: 1100px){
      .fpGrid{ grid-template-columns: repeat(2, 1fr); }
    }
    .fpBox{
      border-radius: 18px;
      background: rgba(10,25,60,0.22);
      border:1px solid rgba(210,230,255,0.12);
      padding: 14px;
      min-height: 92px;
      display:grid;
      gap: 6px;
      align-content:start;
    }
    .fpBox .k{ font-size: 12px; color: rgba(255,255,255,0.62); }
    .fpBox .v{ font-size: 26px; font-weight: 1000; }
    .fpBox .meta{ font-size: 12px; color: rgba(255,255,255,0.62); line-height:1.35; }

    .coneWrap{
      border-radius: 22px;
      background: rgba(10,25,60,0.18);
      border: 1px solid rgba(210,230,255,0.10);
      overflow:hidden;
      margin-top: 12px;
    }
    canvas{ display:block; width:100%; height: 260px; }

    /* Transmission mechanism */
    .tmGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .tmBox{
      border-radius: 18px;
      background: rgba(10,25,60,0.22);
      border:1px solid rgba(210,230,255,0.12);
      padding: 14px;
      display:grid;
      gap: 8px;
      align-content:start;
      min-height: 110px;
    }
    .tmTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .tmTop .k{
      font-size: 12px;
      color: rgba(255,255,255,0.78);
      line-height:1.2;
    }
    .tmTop .pct{
      font-size: 26px;
      font-weight: 1000;
      font-variant-numeric: tabular-nums;
    }
    .tmBar{
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .tmBar > i{
      display:block;
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: rgba(120,170,255,0.8);
    }
    .tmMeta{
      font-size: 12px;
      color: rgba(255,255,255,0.60);
      line-height:1.35;
    }

    /* TradingView */
    .tvWrap{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(210,230,255,0.12);
      background: rgba(10,25,60,0.20);
    }
    .tvWrap iframe{
      width:100%;
      height: 380px;
      border:0;
      display:block;
    }

    /* Footer */
    .foot{
      margin-top: 14px;
      display:flex;
      justify-content:space-between;
      color: rgba(255,255,255,0.5);
      font-size: 12px;
      padding: 0 6px;
      gap:12px;
      flex-wrap:wrap;
    }

    /* Modal */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 999;
      padding: 18px;
    }
    .modal{
      width:min(920px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(12,34,84,0.92), rgba(6,10,24,0.88));
      border: 1px solid rgba(210,230,255,0.18);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(210,230,255,0.12);
    }
    .modalHead h3{
      margin:0;
      font-size: 14px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.86);
    }
    .modalBody{
      padding: 16px 18px 18px;
      display:grid;
      gap: 14px;
    }
    textarea{
      width:100%;
      min-height: 170px;
      resize: vertical;
      border-radius: 16px;
      border: 1px solid rgba(210,230,255,0.18);
      background: rgba(10,25,60,0.35);
      color: rgba(255,255,255,0.9);
      padding: 12px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      outline:none;
    }
    .fieldRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 900px){ .fieldRow{ grid-template-columns: 1fr; } }
    .field{
      border-radius: 16px;
      border: 1px solid rgba(210,230,255,0.14);
      background: rgba(10,25,60,0.22);
      padding: 12px;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: rgba(255,255,255,0.70);
      margin-bottom: 6px;
      font-weight: 900;
      letter-spacing: 0.3px;
    }
    .field input{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(210,230,255,0.16);
      background: rgba(6,10,24,0.40);
      color: rgba(255,255,255,0.92);
      outline:none;
      font-family: var(--mono);
      font-size: 12px;
    }
    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
    }

    .smallNote{
      color: rgba(255,255,255,0.62);
      font-size: 12px;
      line-height: 1.35;
    }

    .pos{ color: rgba(24,209,138,0.95); }
    .neg{ color: rgba(255,77,77,0.95); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="qxlogo">QX</div>
        <div>
          <h1>QuadraX Risk Dashboard</h1>
          <div class="sub">Executive View: 8-State Monitoring and Control System (EUR/USD + Macro Transmission)</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill"><span class="dot" id="liveDot"></span><span id="liveText">LIVE</span></div>
        <div class="pill">Last Update <b id="lastUpdate">--:--:--</b></div>
        <button class="btn" id="pauseBtn">Pause</button>
        <button class="btn primary" id="syncBtn">Sync</button>
        <button class="btn" id="settingsBtn">Settings</button>
        <button class="btn" id="editBtn">Edit Events + Headlines</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT column -->
      <div class="stack">
        <!-- Current market state -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Current Market State</h2>
              <div class="hint">This demo never fabricates price. For true live FX, set a quote API key in Settings.</div>
            </div>

            <div class="cmsGrid">
              <div class="hero">
                <div class="stateBig" id="policyStateTitle">Policy State: --</div>
                <div class="muted" id="policyStateDesc">Waiting for live quote sample.</div>

                <div class="chipRow">
                  <div class="chip">Detector <b id="detectorChip">--</b></div>
                  <div class="chip">Policy <b id="policyChip">--</b></div>
                  <div class="chip">Confidence <b id="confChip">--</b></div>
                  <div class="chip">Hysteresis <b id="hystChip">--</b></div>
                  <div class="chip">Tick <b id="tickChip">0</b></div>
                  <div class="chip">Stale <b id="staleChip">0</b></div>
                  <span class="pillTag" id="modeTag">Mode: --</span>
                </div>

                <div class="chipRow" style="margin-top:10px;">
                  <div class="chip">Macro Bias <b id="macroBiasChip">--</b></div>
                  <div class="chip">Event Risk <b id="eventRiskChip">--</b></div>
                  <div class="chip">Transmission <b id="txScoreChip">--</b></div>
                </div>

                <div class="probBlock">
                  <div class="muted" style="margin-bottom:8px;">Conditional regime likelihoods P(state | features). Visualization layer, not the final alpha model.</div>
                  <div id="probList"></div>
                  <div class="muted" style="margin-top:10px;">
                    Probabilities flatten when feeds are stale or features are ambiguous. Humans still insist that means “certainty”.
                  </div>
                </div>
              </div>

              <div class="quoteCard" aria-label="EURUSD quote">
                <div class="quoteTop">
                  <div class="quoteSym">
                    <div class="sym">EURUSD</div>
                    <div class="prov" id="quoteProvider">Provider: --</div>
                  </div>
                  <div class="qStatus"><span class="sdot" id="fxStatusDot"></span><span id="fxSpotStatus">CHECKING</span></div>
                </div>

                <div class="quotePx" id="fxSpotPrice">--</div>

                <div class="quoteMetaRow">
                  <div>Δ</div>
                  <div id="fxSpotDelta">0.00000</div>
                </div>

                <div class="sparkBar"><i id="miniBar"></i></div>

                <div class="quoteBadges">
                  <span class="tagOk" id="fxLatencyTag">--</span>
                  <span class="tagOk" id="fxLastTag">Last: --</span>
                </div>

                <div class="smallNote" style="margin-top:4px;" id="fxSpotMeta">Source: --</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Forward projection -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Forward Projection</h2>
              <div class="hint">Projection cone based on regime volatility + macro transmission + event proximity. It’s a range, not a prophecy.</div>
            </div>

            <div class="fpGrid">
              <div class="fpBox">
                <div class="k">Trade Bias</div>
                <div class="v" id="tradeBias">--</div>
                <div class="meta" id="tradeBiasMeta">Macro -- · Mom -- · Event --</div>
              </div>
              <div class="fpBox">
                <div class="k">Move Range (1h)</div>
                <div class="v" id="rng1h">--</div>
                <div class="meta" id="rng1hMeta">Vol x-- · Macro x--</div>
              </div>
              <div class="fpBox">
                <div class="k">Move Range (4h)</div>
                <div class="v" id="rng4h">--</div>
                <div class="meta" id="rng4hMeta">Event x-- · Tx x--</div>
              </div>
              <div class="fpBox">
                <div class="k">Decision Confidence</div>
                <div class="v" id="decConf">--</div>
                <div class="meta" id="decConfMeta">Low agreement, caution</div>
              </div>
            </div>

            <div class="coneWrap">
              <canvas id="coneCanvas" width="1400" height="260"></canvas>
            </div>

            <div class="smallNote" style="margin-top:10px;">
              Cone reflects a probabilistic range, not a promise. If anyone confuses this for certainty, remove their trading permissions.
            </div>
          </div>
        </div>

        <!-- TradingView chart -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Daily EUR/USD Trend</h2>
              <div class="hint">Embedded TradingView chart. Clean, stable, doesn’t depend on your budget.</div>
            </div>

            <div class="tvWrap">
              <iframe
                title="TradingView EURUSD"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                src="https://s.tradingview.com/widgetembed/?frameElementId=tvchart&symbol=FX%3AEURUSD&interval=D&hidesidetoolbar=1&symboledit=0&saveimage=0&toolbarbg=0b1028&studies=%5B%5D&hideideas=1&theme=dark&style=1&locale=en&withdateranges=1&hidevolume=0&allow_symbol_change=0&details=0&hotlist=0&calendar=0"
              ></iframe>
            </div>
          </div>
        </div>

        <div class="foot">
          <div>System Status: <b id="sysStatus">LIVE</b></div>
          <div>Smoothed Policy: <b id="footPolicy">--</b></div>
          <div>Detector: <b id="footDetector">--</b></div>
          <div>Hysteresis Hold: <b id="footHold">0</b></div>
        </div>
      </div>

      <!-- RIGHT column -->
      <div class="stack">
        <!-- Risk level -->
        <div class="card">
          <div class="inner riskLevel">
            <div class="label">Risk Level</div>
            <div class="big" id="riskBig">--</div>
            <div class="rule" id="riskRule">Policy: state-aware sizing and entry gating</div>
          </div>
        </div>

        <!-- Macro drivers -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Macro Drivers</h2>
              <div class="macroHint">Oil, metals, USD proxy via Stooq CSV through a CORS helper. Works on GitHub Pages without keys.</div>
            </div>

            <div class="macroGrid">
              <div class="macroBox">
                <div class="k">Oil (USO proxy) <span class="tagOk" id="oilTag">--</span></div>
                <div class="v" id="oilPx">--</div>
                <div class="meta" id="oilMeta">No data</div>
              </div>
              <div class="macroBox">
                <div class="k">Gold (GLD proxy) <span class="tagOk" id="goldTag">--</span></div>
                <div class="v" id="goldPx">--</div>
                <div class="meta" id="goldMeta">No data</div>
              </div>
              <div class="macroBox">
                <div class="k">Silver (SLV proxy) <span class="tagOk" id="silverTag">--</span></div>
                <div class="v" id="silverPx">--</div>
                <div class="meta" id="silverMeta">No data</div>
              </div>
              <div class="macroBox">
                <div class="k">USD (UUP proxy) <span class="tagOk" id="usdTag">--</span></div>
                <div class="v" id="usdPx">--</div>
                <div class="meta" id="usdMeta">No data</div>
              </div>
              <div class="macroBox" style="grid-column: 1 / span 2;">
                <div class="k">Transmission Score</div>
                <div class="v" id="txBig">NEUTRAL</div>
                <div class="meta" id="txMeta">Score 0.00 · Neutral · Intensity 0%</div>
              </div>
            </div>

            <div class="smallNote" style="margin-top:10px;">
              In production: replace proxies with institutional feeds and learn weights from history (bucketing by regime + event archetype). The demo just needs to behave like a real system.
            </div>
          </div>
        </div>

        <!-- Transmission mechanism -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Transmission Mechanism</h2>
              <div class="hint">Three levers that typically move EURUSD around conflict + commodity shocks, plus event proximity.</div>
            </div>

            <div class="tmGrid">
              <div class="tmBox">
                <div class="tmTop">
                  <div class="k">Oil Lever (EU terms of trade)</div>
                  <div class="pct" id="oilLeverPct">0%</div>
                </div>
                <div class="tmBar"><i id="oilLeverBar"></i></div>
                <div class="tmMeta" id="oilLeverMeta">EU energy drag proxy</div>
              </div>

              <div class="tmBox">
                <div class="tmTop">
                  <div class="k">Dollar Lever (USD pressure)</div>
                  <div class="pct" id="usdLeverPct">0%</div>
                </div>
                <div class="tmBar"><i id="usdLeverBar"></i></div>
                <div class="tmMeta" id="usdLeverMeta">USD strength pressure proxy</div>
              </div>

              <div class="tmBox">
                <div class="tmTop">
                  <div class="k">Fear Lever (risk-off tone)</div>
                  <div class="pct" id="fearLeverPct">0%</div>
                </div>
                <div class="tmBar"><i id="fearLeverBar"></i></div>
                <div class="tmMeta" id="fearLeverMeta">Gold bid proxy</div>
              </div>

              <div class="tmBox">
                <div class="tmTop">
                  <div class="k">Event Risk (calendar proximity)</div>
                  <div class="pct" id="eventLeverPct">0%</div>
                </div>
                <div class="tmBar"><i id="eventLeverBar"></i></div>
                <div class="tmMeta" id="eventLeverMeta">High impact proximity</div>
              </div>
            </div>

            <div class="smallNote" style="margin-top:10px;">
              Demo mapping. Production version learns the mapping (features → expected pip distribution) by regime and event archetype, then runs scenario cones.
            </div>
          </div>
        </div>

        <!-- World events calendar -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>World Events Calendar</h2>
              <div class="hint">Curated list saved locally for demo. Countdown updates automatically.</div>
            </div>
            <div class="tableWrap">
              <div class="scroll" style="max-height: 260px;">
                <table>
                  <thead>
                    <tr>
                      <th>When</th>
                      <th>Event</th>
                      <th>Impact</th>
                      <th>Countdown</th>
                    </tr>
                  </thead>
                  <tbody id="eventsBody"></tbody>
                </table>
              </div>
            </div>
            <div class="muted" style="margin-top:10px;">
              High impact events are <span class="impact"><span class="folder"></span>HIGH</span>.
            </div>
          </div>
        </div>

        <!-- Headlines -->
        <div class="card">
          <div class="inner">
            <div class="card-title">
              <h2>Headlines</h2>
              <div class="hint">Curated list saved locally. Swap to a live feed later when the budget stops screaming.</div>
            </div>

            <div class="tableWrap">
              <div class="scroll" style="max-height: 240px;">
                <table>
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>Source</th>
                      <th>Headline</th>
                    </tr>
                  </thead>
                  <tbody id="headlinesBody"></tbody>
                </table>
              </div>
            </div>

            <div class="muted" style="margin-top:10px;">
              Click opens source in a new tab.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: edit events + headlines -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <h3>Edit World Events + Headlines</h3>
        <button class="btn" id="closeModalBtn">Close</button>
      </div>
      <div class="modalBody">
        <div class="smallNote">
          This is the “demo that works” approach. Save curated items locally so everyone sees the same list after refresh on their device.
          Production: plug a proper calendar + headline feed, then enrich with event archetypes.
        </div>

        <div class="fieldRow">
          <div>
            <div class="smallNote" style="margin-bottom:8px;"><b>Events JSON</b> (array of objects: when, event, impact: HIGH|MED|LOW)</div>
            <textarea id="eventsEditor"></textarea>
          </div>

          <div>
            <div class="smallNote" style="margin-bottom:8px;"><b>Headlines JSON</b> (array of objects: time, source, title, url)</div>
            <textarea id="headlinesEditor"></textarea>
          </div>
        </div>

        <div class="modalActions">
          <button class="btn" id="resetCuratedBtn">Reset to curated defaults</button>
          <button class="btn primary" id="saveCuratedBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: settings -->
  <div class="modalBack" id="settingsBack">
    <div class="modal">
      <div class="modalHead">
        <h3>Settings</h3>
        <button class="btn" id="closeSettingsBtn">Close</button>
      </div>
      <div class="modalBody">
        <div class="smallNote">
          If you want proper intraday FX, paste a TwelveData key. If you do nothing, we fall back to free FX endpoints.
          Macro drivers use ETF proxies through Stooq CSV, fetched via a public CORS helper because GitHub Pages won’t let you do grown-up networking.
        </div>

        <div class="fieldRow">
          <div class="field">
            <label>TwelveData API Key (optional)</label>
            <input id="tdKeyInput" placeholder="Paste key here (optional)" />
            <div class="smallNote" style="margin-top:8px;">Used for EURUSD spot. Stored locally in your browser.</div>
          </div>

          <div class="field">
            <label>Polling cadence</label>
            <input id="pollInput" placeholder="12000 (ms)" />
            <div class="smallNote" style="margin-top:8px;">Default 12000ms. Too fast = throttled. Too slow = pointless.</div>
          </div>
        </div>

        <div class="modalActions">
          <button class="btn" id="resetSettingsBtn">Reset settings</button>
          <button class="btn primary" id="saveSettingsBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =============================================================================
   QuadraX Risk Dashboard (single-file demo)
   - EURUSD spot: TwelveData (optional) -> free FX endpoints failover
   - Macro drivers: ETF proxies (USO, GLD, SLV, UUP) via Stooq CSV
     fetched through AllOrigins to bypass CORS on GitHub Pages
   - Transmission mechanism: Oil, USD, Fear, Event proximity
   - Projection cone: regime vol + transmission score + event risk
============================================================================= */

(function(){
  // ---------- Utilities ----------
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const fmtTime = (ms) => new Date(ms).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
  const bp = (x)=> x * 10000;
  const safeNum = (x, fallback=null) => (Number.isFinite(Number(x)) ? Number(x) : fallback);

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function escapeAttr(s){
    return String(s).replace(/"/g, "&quot;");
  }

  // ---------- DOM ----------
  const els = {
    liveDot: document.getElementById("liveDot"),
    liveText: document.getElementById("liveText"),
    lastUpdate: document.getElementById("lastUpdate"),
    pauseBtn: document.getElementById("pauseBtn"),
    syncBtn: document.getElementById("syncBtn"),
    editBtn: document.getElementById("editBtn"),
    settingsBtn: document.getElementById("settingsBtn"),

    // state
    policyStateTitle: document.getElementById("policyStateTitle"),
    policyStateDesc: document.getElementById("policyStateDesc"),
    detectorChip: document.getElementById("detectorChip"),
    policyChip: document.getElementById("policyChip"),
    confChip: document.getElementById("confChip"),
    hystChip: document.getElementById("hystChip"),
    tickChip: document.getElementById("tickChip"),
    staleChip: document.getElementById("staleChip"),
    modeTag: document.getElementById("modeTag"),
    macroBiasChip: document.getElementById("macroBiasChip"),
    eventRiskChip: document.getElementById("eventRiskChip"),
    txScoreChip: document.getElementById("txScoreChip"),
    probList: document.getElementById("probList"),

    // quote
    quoteProvider: document.getElementById("quoteProvider"),
    fxSpotPrice: document.getElementById("fxSpotPrice"),
    fxSpotStatus: document.getElementById("fxSpotStatus"),
    fxStatusDot: document.getElementById("fxStatusDot"),
    fxSpotDelta: document.getElementById("fxSpotDelta"),
    fxLatencyTag: document.getElementById("fxLatencyTag"),
    fxLastTag: document.getElementById("fxLastTag"),
    fxSpotMeta: document.getElementById("fxSpotMeta"),
    miniBar: document.getElementById("miniBar"),

    // risk
    riskBig: document.getElementById("riskBig"),
    riskRule: document.getElementById("riskRule"),

    // macro
    oilPx: document.getElementById("oilPx"),
    oilMeta: document.getElementById("oilMeta"),
    oilTag: document.getElementById("oilTag"),
    goldPx: document.getElementById("goldPx"),
    goldMeta: document.getElementById("goldMeta"),
    goldTag: document.getElementById("goldTag"),
    silverPx: document.getElementById("silverPx"),
    silverMeta: document.getElementById("silverMeta"),
    silverTag: document.getElementById("silverTag"),
    usdPx: document.getElementById("usdPx"),
    usdMeta: document.getElementById("usdMeta"),
    usdTag: document.getElementById("usdTag"),
    txBig: document.getElementById("txBig"),
    txMeta: document.getElementById("txMeta"),

    // levers
    oilLeverPct: document.getElementById("oilLeverPct"),
    oilLeverBar: document.getElementById("oilLeverBar"),
    oilLeverMeta: document.getElementById("oilLeverMeta"),
    usdLeverPct: document.getElementById("usdLeverPct"),
    usdLeverBar: document.getElementById("usdLeverBar"),
    usdLeverMeta: document.getElementById("usdLeverMeta"),
    fearLeverPct: document.getElementById("fearLeverPct"),
    fearLeverBar: document.getElementById("fearLeverBar"),
    fearLeverMeta: document.getElementById("fearLeverMeta"),
    eventLeverPct: document.getElementById("eventLeverPct"),
    eventLeverBar: document.getElementById("eventLeverBar"),
    eventLeverMeta: document.getElementById("eventLeverMeta"),

    // projection
    tradeBias: document.getElementById("tradeBias"),
    tradeBiasMeta: document.getElementById("tradeBiasMeta"),
    rng1h: document.getElementById("rng1h"),
    rng1hMeta: document.getElementById("rng1hMeta"),
    rng4h: document.getElementById("rng4h"),
    rng4hMeta: document.getElementById("rng4hMeta"),
    decConf: document.getElementById("decConf"),
    decConfMeta: document.getElementById("decConfMeta"),
    coneCanvas: document.getElementById("coneCanvas"),

    // events + headlines
    eventsBody: document.getElementById("eventsBody"),
    headlinesBody: document.getElementById("headlinesBody"),

    // footer
    sysStatus: document.getElementById("sysStatus"),
    footPolicy: document.getElementById("footPolicy"),
    footDetector: document.getElementById("footDetector"),
    footHold: document.getElementById("footHold"),

    // modals
    modalBack: document.getElementById("modalBack"),
    closeModalBtn: document.getElementById("closeModalBtn"),
    saveCuratedBtn: document.getElementById("saveCuratedBtn"),
    resetCuratedBtn: document.getElementById("resetCuratedBtn"),
    eventsEditor: document.getElementById("eventsEditor"),
    headlinesEditor: document.getElementById("headlinesEditor"),

    settingsBack: document.getElementById("settingsBack"),
    closeSettingsBtn: document.getElementById("closeSettingsBtn"),
    tdKeyInput: document.getElementById("tdKeyInput"),
    pollInput: document.getElementById("pollInput"),
    resetSettingsBtn: document.getElementById("resetSettingsBtn"),
    saveSettingsBtn: document.getElementById("saveSettingsBtn"),
  };

  // ---------- Persistence keys ----------
  const KEY = {
    settings: "qx_settings_v2",
    events: "qx_events_v1",
    headlines: "qx_headlines_v1",
    dash: "qx_dash_v2",
    macro: "qx_macro_v2"
  };

  function loadObj(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      const parsed = JSON.parse(raw);
      return (parsed && typeof parsed === "object") ? parsed : fallback;
    }catch(e){ return fallback; }
  }
  function loadJSONArr(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : fallback;
    }catch(e){ return fallback; }
  }

  // ---------- Settings ----------
  let settings = loadObj(KEY.settings, {
    twelvedataKey: "",
    pollMs: 12000
  });

  // ---------- Curated defaults ----------
  const curatedEventsDefault = [
    { when: "2026-02-17T21:18:47Z", event: "Eurozone CPI (flash)", impact: "HIGH" },
    { when: "2026-02-18T17:18:47Z", event: "US Initial Jobless Claims", impact: "MED" },
    { when: "2026-02-19T21:18:47Z", event: "US GDP (advance)", impact: "HIGH" },
    { when: "2026-02-22T15:18:47Z", event: "US Non-Farm Payrolls", impact: "HIGH" }
  ];

  const curatedHeadlinesDefault = [
    { time: "03:00 PM", source: "FinancialJuice", title: "Dollar firming ahead of major data window", url: "https://financialjuice.com/" },
    { time: "02:26 PM", source: "FinancialJuice", title: "Rates repricing drives short-term USD bid", url: "https://financialjuice.com/" },
    { time: "01:06 PM", source: "Market", title: "Risk tone mixed as equities stabilize", url: "https://www.investing.com/" }
  ];

  let curatedEvents = loadJSONArr(KEY.events, curatedEventsDefault);
  let curatedHeadlines = loadJSONArr(KEY.headlines, curatedHeadlinesDefault);

  // ---------- Impact pill ----------
  function impactPill(impact){
    const imp = (impact || "").toUpperCase();
    if (imp === "HIGH") return `<span class="impact"><span class="folder"></span>HIGH</span>`;
    if (imp === "MED") return `<span class="impact"><span class="folder med"></span>MED</span>`;
    return `<span class="impact"><span class="folder low"></span>LOW</span>`;
  }

  function countdownText(iso){
    const t = new Date(iso).getTime();
    const now = Date.now();
    if (!Number.isFinite(t)) return "--";
    const d = t - now;
    if (d <= 0) return "Now";
    const mins = Math.floor(d/60000);
    const days = Math.floor(mins / (60*24));
    const hrs = Math.floor((mins - days*60*24)/60);
    const rem = mins - days*60*24 - hrs*60;
    if (days > 0) return `${days}d ${hrs}h`;
    if (hrs > 0) return `${hrs}h ${rem}m`;
    return `${rem}m`;
  }

  function renderEvents(){
    const rows = curatedEvents
      .slice()
      .sort((a,b)=> new Date(a.when)-new Date(b.when))
      .map(e=>{
        const when = new Date(e.when);
        const whenStr = isNaN(when.getTime()) ? String(e.when) : `${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}`;
        return `
          <tr>
            <td>${whenStr}</td>
            <td><a class="link" href="https://www.forexfactory.com/" target="_blank" rel="noopener noreferrer">${escapeHtml(e.event || "")}</a></td>
            <td>${impactPill(e.impact)}</td>
            <td>${countdownText(e.when)}</td>
          </tr>
        `;
      }).join("");

    els.eventsBody.innerHTML = rows || `<tr><td colspan="4" style="color:rgba(255,255,255,0.6)">No events set.</td></tr>`;
  }

  function renderHeadlines(){
    const rows = curatedHeadlines.map(h=>{
      const url = h.url || "#";
      return `
        <tr>
          <td>${escapeHtml(h.time || "")}</td>
          <td>${escapeHtml(h.source || "")}</td>
          <td><a class="link" href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(h.title || "")}</a></td>
        </tr>
      `;
    }).join("");

    els.headlinesBody.innerHTML = rows || `<tr><td colspan="3" style="color:rgba(255,255,255,0.6)">No headlines set.</td></tr>`;
  }

  // ---------- Event risk (proximity lever) ----------
  function computeEventRisk01(){
    const now = Date.now();
    const upcoming = curatedEvents
      .map(e => ({...e, t: new Date(e.when).getTime()}))
      .filter(e => Number.isFinite(e.t) && e.t >= now);

    if (!upcoming.length) return 0;

    // find nearest HIGH then MED then LOW
    const weights = { HIGH: 1.0, MED: 0.6, LOW: 0.25 };
    let best = 0;

    for (const e of upcoming){
      const imp = (e.impact || "LOW").toUpperCase();
      const w = weights[imp] ?? 0.25;
      const mins = (e.t - now)/60000;

      // proximity curve: strongest within 60 minutes, fades over 24 hours
      const prox = (mins <= 60) ? 1
                 : (mins <= 6*60) ? (1 - (mins-60)/(5*60))*0.85
                 : (mins <= 24*60) ? (1 - (mins-6*60)/(18*60))*0.35
                 : 0;

      best = Math.max(best, w * prox);
    }

    return clamp(best, 0, 1);
  }

  function labelEventRisk(r){
    if (r >= 0.70) return "HIGH";
    if (r >= 0.35) return "MED";
    return "LOW";
  }

  // ---------- States ----------
  const STATES = [
    { id:1, name:"Mean-Reverting", desc:"Range-bound. Fade extremes and keep size disciplined.", color:"rgba(24,209,138,0.85)" },
    { id:2, name:"Liquidity Vacuum", desc:"Thin market, jumpy moves. Tighten risk and be selective.", color:"rgba(255,176,32,0.85)" },
    { id:3, name:"Slow Drift", desc:"Steady grind. Small edges, avoid forcing entries.", color:"rgba(120,170,255,0.85)" },
    { id:4, name:"Strong Trend", desc:"Directional. Trend-follow bias, avoid countertrend heroics.", color:"rgba(60,145,255,0.9)" },
    { id:5, name:"Stop Cascade", desc:"Fast continuation on stops. Reduce leverage, widen filters.", color:"rgba(255,138,64,0.9)" },
    { id:6, name:"News Shock", desc:"Event-driven. Consider standing down around releases.", color:"rgba(255,77,77,0.9)" },
    { id:7, name:"Dealer Unwind", desc:"Choppy reversal risk. Focus on protection and confirmation.", color:"rgba(160,120,255,0.9)" },
    { id:8, name:"Panic/Forced", desc:"Dislocation. Risk off. Protect capital first.", color:"rgba(255,58,165,0.9)" }
  ];

  // ---------- Probabilities UI ----------
  const probEls = [];
  function initProbUI(){
    els.probList.innerHTML = "";
    probEls.length = 0;

    STATES.forEach((s)=>{
      const row = document.createElement("div");
      row.className = "probRow";
      row.innerHTML = `
        <div class="probName"><span class="pdot" style="background:${s.color}"></span>State ${s.id}: ${s.name}</div>
        <div class="pbar"><i></i></div>
        <div class="probVal">--%</div>
      `;
      els.probList.appendChild(row);
      probEls.push({
        bar: row.querySelector(".pbar > i"),
        val: row.querySelector(".probVal")
      });
    });
  }

  // ---------- Risk mapping ----------
  function setRisk(policyState, conf){
    let level = "--";
    let rule = "Policy: state-aware sizing and entry gating";

    if (policyState){
      if (policyState === 1) { level = "NORMAL"; rule = "Rule: Range logic favored. Avoid forcing breakouts."; }
      if (policyState === 2) { level = "ELEVATED"; rule = "Rule: Thin liquidity risk. Reduce size and wait for confirmation."; }
      if (policyState === 3) { level = "NORMAL"; rule = "Rule: Drift regime. Small edges, avoid impulsive entries."; }
      if (policyState === 4) { level = "HIGH"; rule = "Rule: Trend regime. Bias with trend. Avoid countertrend heroics."; }
      if (policyState === 5) { level = "HIGH"; rule = "Rule: Stop cascade risk. De-risk and widen filters."; }
      if (policyState === 6) { level = "HIGH"; rule = "Rule: News shock. Consider standing down around releases."; }
      if (policyState === 7) { level = "ELEVATED"; rule = "Rule: Unwind risk. Protect and demand confirmation."; }
      if (policyState === 8) { level = "CRITICAL"; rule = "Rule: Risk off. Protect capital first."; }

      if (conf != null && conf < 0.35 && (level === "NORMAL")) level = "ELEVATED";
      if (conf != null && conf < 0.25 && (level === "ELEVATED")) level = "HIGH";
    }

    els.riskBig.textContent = level;
    els.riskRule.textContent = rule;
  }

  // ---------- Quote status dot ----------
  function setFxStatus(status){
    els.fxSpotStatus.textContent = status;
    els.fxStatusDot.classList.remove("live","err");
    if (status === "LIVE"){
      els.fxStatusDot.classList.add("live");
    } else if (status === "ERROR"){
      els.fxStatusDot.classList.add("err");
    }
  }

  // ---------- Spot feed (TwelveData + fallback endpoints) ----------
  const SpotFeed = (() => {
    // Free endpoints (can be cached / low frequency)
    const freeSources = [
      {
        name: "exchangerate.host",
        url: () => `https://api.exchangerate.host/latest?base=EUR&symbols=USD&_=${Date.now()}`,
        parse: (j) => j?.rates?.USD
      },
      {
        name: "frankfurter.app",
        url: () => `https://api.frankfurter.app/latest?from=EUR&to=USD&_=${Date.now()}`,
        parse: (j) => j?.rates?.USD
      },
      {
        name: "open.er-api.com",
        url: () => `https://open.er-api.com/v6/latest/EUR?_=${Date.now()}`,
        parse: (j) => j?.rates?.USD
      }
    ];

    let last = {
      price: null,
      ts: 0,
      source: null,
      provider: null,
      latencyMs: null,
      staleCount: 0,
      lastChangeTs: 0,
      lastDelta: 0
    };

    const STALE_MS = 60_000;
    const MIN_MOVE = 0.000001;

    function status(now = Date.now()){
      if (!last.price) return { status: "CHECKING", stale: false };
      const stale = (now - last.lastChangeTs) > STALE_MS;
      return { status: stale ? "STALE" : "LIVE", stale };
    }

    async function fetchWithTimeout(url, timeoutMs=6500){
      const t0 = performance.now();
      const controller = new AbortController();
      const timer = setTimeout(()=> controller.abort(), timeoutMs);
      try{
        const res = await fetch(url, { method:"GET", cache:"no-store", signal: controller.signal });
        clearTimeout(timer);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        return { ok:true, json, latencyMs: Math.round(performance.now() - t0) };
      }catch(e){
        clearTimeout(timer);
        return { ok:false, err:e };
      }
    }

    async function fetchTwelveData(){
      const key = (settings.twelvedataKey || "").trim();
      if (!key) return { ok:false };

      const url = `https://api.twelvedata.com/price?symbol=EUR/USD&apikey=${encodeURIComponent(key)}&_=${Date.now()}`;
      const r = await fetchWithTimeout(url, 6500);
      if (!r.ok) return { ok:false };
      const px = Number(r.json?.price);
      if (!Number.isFinite(px) || px <= 0) return { ok:false };
      return { ok:true, price:px, source:"TwelveData", provider:"TwelveData", latencyMs:r.latencyMs };
    }

    async function fetchFreeOnce(){
      for (const s of freeSources){
        const r = await fetchWithTimeout(s.url(), 6500);
        if (!r.ok) continue;
        const px = Number(s.parse(r.json));
        if (!Number.isFinite(px) || px <= 0) continue;
        return { ok:true, price:px, source:s.name, provider:s.name, latencyMs:r.latencyMs };
      }
      return { ok:false };
    }

    async function tick(updateCb){
      const now = Date.now();

      // try TwelveData first (best for intraday)
      let r = await fetchTwelveData();
      if (!r.ok) r = await fetchFreeOnce();

      if (!r.ok){
        last.staleCount += 1;
        updateCb?.({ ok:false, ...last, ...status(now) });
        return;
      }

      const prev = last.price;
      const moved = (prev == null) ? true : Math.abs(r.price - prev) > MIN_MOVE;
      const delta = (prev == null) ? 0 : (r.price - prev);

      last.price = r.price;
      last.ts = now;
      last.source = r.source;
      last.provider = r.provider;
      last.latencyMs = r.latencyMs;
      last.staleCount = 0;
      last.lastDelta = delta;

      if (moved) last.lastChangeTs = now;
      if (!last.lastChangeTs) last.lastChangeTs = now;

      updateCb?.({ ok:true, ...last, ...status(now) });
    }

    return { tick, getLast: ()=> ({...last}) };
  })();

  // ---------- Macro feed (Stooq CSV via AllOrigins) ----------
  const MacroFeed = (() => {
    // Stooq expects e=csv
    // We route through AllOrigins: https://api.allorigins.win/raw?url=<encoded>
    // This is a demo hack. Production uses real feeds.
    const series = [
      { key:"OIL", name:"USO", stooq:"uso.us", pxEl:"oilPx", metaEl:"oilMeta", tagEl:"oilTag" },
      { key:"GOLD", name:"GLD", stooq:"gld.us", pxEl:"goldPx", metaEl:"goldMeta", tagEl:"goldTag" },
      { key:"SILV", name:"SLV", stooq:"slv.us", pxEl:"silverPx", metaEl:"silverMeta", tagEl:"silverTag" },
      { key:"USD",  name:"UUP", stooq:"uup.us", pxEl:"usdPx", metaEl:"usdMeta", tagEl:"usdTag" },
    ];

    const state = loadObj(KEY.macro, {
      last: {}, // key -> { close, prevClose, changePct, ts, src }
    });

    function persist(){
      try{ localStorage.setItem(KEY.macro, JSON.stringify(state)); }catch(e){}
    }

    function stooqCsvUrl(symbol){
      // daily: last rows include latest close
      return `https://stooq.com/q/d/l/?s=${encodeURIComponent(symbol)}&i=d`;
    }

    async function fetchCsvViaAllOrigins(url, timeoutMs=8000){
      const t0 = performance.now();
      const controller = new AbortController();
      const timer = setTimeout(()=> controller.abort(), timeoutMs);
      try{
        const prox = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
        const res = await fetch(prox, { method:"GET", cache:"no-store", signal: controller.signal });
        clearTimeout(timer);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        return { ok:true, text, latencyMs: Math.round(performance.now() - t0) };
      }catch(e){
        clearTimeout(timer);
        return { ok:false, err:e };
      }
    }

    function parseStooqDailyCsv(text){
      // format:
      // Date,Open,High,Low,Close,Volume
      // 2026-02-14,xx,xx,xx,xx,xxxx
      const lines = String(text).trim().split(/\r?\n/).filter(Boolean);
      if (lines.length < 3) return null;
      const header = lines[0].split(",");
      const idxClose = header.findIndex(h => h.toLowerCase() === "close");
      if (idxClose < 0) return null;

      const lastLine = lines[lines.length - 1].split(",");
      const prevLine = lines[lines.length - 2].split(",");

      const close = Number(lastLine[idxClose]);
      const prevClose = Number(prevLine[idxClose]);
      const date = lastLine[0];

      if (!Number.isFinite(close) || close <= 0) return null;
      if (!Number.isFinite(prevClose) || prevClose <= 0) return null;

      const changePct = (close / prevClose - 1) * 100;
      return { close, prevClose, changePct, date };
    }

    function fmtPx(x){ return (Number.isFinite(x) ? x.toFixed(2) : "--"); }
    function fmtPct(x){
      if (!Number.isFinite(x)) return "--";
      const s = (x >= 0 ? "+" : "") + x.toFixed(2) + "%";
      return s;
    }

    function paintOne(item){
      const rec = state.last[item.key];
      const pxEl = document.getElementById(item.pxEl);
      const metaEl = document.getElementById(item.metaEl);
      const tagEl = document.getElementById(item.tagEl);

      if (!rec){
        pxEl.textContent = "--";
        metaEl.textContent = "No data";
        tagEl.textContent = "—";
        return;
      }

      pxEl.textContent = fmtPx(rec.close);
      const pct = rec.changePct;
      const pctStr = fmtPct(pct);
      metaEl.innerHTML = `Δ ${pctStr} · Prev ${fmtPx(rec.prevClose)} · ${escapeHtml(rec.date || "")}`;
      tagEl.textContent = `Stooq · ${rec.latencyMs ?? "--"}ms`;

      // subtle sign styling
      pxEl.classList.remove("pos","neg");
      if (Number.isFinite(pct) && pct > 0.05) pxEl.classList.add("pos");
      if (Number.isFinite(pct) && pct < -0.05) pxEl.classList.add("neg");
    }

    async function tick(){
      for (const item of series){
        const url = stooqCsvUrl(item.stooq);
        const r = await fetchCsvViaAllOrigins(url);
        if (!r.ok) continue;

        const parsed = parseStooqDailyCsv(r.text);
        if (!parsed) continue;

        state.last[item.key] = {
          ...parsed,
          ts: Date.now(),
          src: "stooq+allorigins",
          latencyMs: r.latencyMs
        };
      }

      persist();
      series.forEach(paintOne);
    }

    function get(key){
      return state.last[key] || null;
    }

    // hydrate UI from persisted macro cache
    function hydrate(){
      series.forEach(paintOne);
    }

    return { tick, get, hydrate };
  })();

  // ---------- Regime engine ----------
  const Engine = (() => {
    const HISTORY_N = 80;
    const MOM_WINDOW = 8;
    const VOL_WINDOW = 18;
    const HOLD_TICKS = 4;
    const PROB_TEMP = 1.35;

    let tickN = 0;
    let prices = [];
    let returns = [];

    let detectorState = null;
    let policyState = null;
    let hold = 0;

    function softmax(logits){
      const m = Math.max(...logits);
      const exps = logits.map(v => Math.exp((v - m) / PROB_TEMP));
      const s = exps.reduce((a,b)=>a+b,0) || 1;
      return exps.map(v => v/s);
    }

    function computeFeatures(){
      if (prices.length < 3) return null;

      const p = prices[prices.length-1];
      const pPrev = prices[prices.length-2];

      const r = (pPrev ? (p - pPrev) : 0);
      const momBase = prices[Math.max(0, prices.length-1-MOM_WINDOW)];
      const mom = momBase ? (p - momBase) : 0;

      const recentR = returns.slice(-VOL_WINDOW);
      const absAvg = recentR.length ? recentR.reduce((a,b)=>a+Math.abs(b),0)/recentR.length : 0;
      const volx = clamp(absAvg / 0.00015, 0, 5);

      const shock = Math.abs(r) > 0.0007 ? 1 : 0;

      return { p, r, mom, volx, shock };
    }

    function scoreStates(f){
      const momBp = Math.abs(bp(f.mom));
      const rBp = Math.abs(bp(f.r));
      const vol = f.volx;

      const signChanges = (() => {
        const rr = returns.slice(-10);
        if (rr.length < 6) return 0;
        let changes = 0;
        for (let i=1;i<rr.length;i++){
          if (Math.sign(rr[i]) !== Math.sign(rr[i-1])) changes++;
        }
        return changes;
      })();

      const L = new Array(8).fill(0);

      L[0] = 2.4 - 0.7*vol - 0.04*momBp;                       // mean reversion
      L[1] = 1.1 + 0.55*vol - 0.03*momBp;                      // liquidity vacuum
      L[2] = 1.6 - 0.25*vol - 0.02*momBp;                      // slow drift
      L[3] = 0.9 + 0.25*vol + 0.045*momBp;                     // trend
      L[4] = -0.2 + 0.55*vol + 0.02*momBp + 0.04*rBp;          // stop cascade
      L[5] = -0.4 + (f.shock ? 3.0 : 0) + 0.2*vol;             // news shock
      L[6] = 0.3 + 0.18*vol + 0.35*clamp(signChanges/6,0,1) - 0.02*momBp; // unwind
      L[7] = -0.8 + 0.95*Math.max(0, vol-2.2) + 0.04*rBp + (f.shock ? 0.6 : 0); // panic

      return softmax(L);
    }

    function pickState(probs){
      let best = 0;
      for (let i=1;i<probs.length;i++) if (probs[i] > probs[best]) best = i;
      return best+1;
    }

    function confidence(probs, state){
      const s = state-1;
      const top = probs[s];
      const sorted = [...probs].sort((a,b)=>b-a);
      const gap = (sorted[0] - (sorted[1] || 0));
      return clamp((top*0.7 + gap*0.3), 0, 1);
    }

    function updatePolicy(det){
      if (policyState == null){
        policyState = det;
        hold = 0;
        return { policy: policyState, hold, changed:true };
      }
      if (det === policyState){
        hold = 0;
        return { policy: policyState, hold, changed:false };
      }
      hold += 1;
      if (hold >= HOLD_TICKS){
        policyState = det;
        hold = 0;
        return { policy: policyState, hold, changed:true };
      }
      return { policy: policyState, hold, changed:false };
    }

    function step(price){
      tickN += 1;

      const p = Number(price);
      if (!Number.isFinite(p) || p <= 0) return null;

      const prev = prices.length ? prices[prices.length-1] : null;
      prices.push(p);
      if (prices.length > HISTORY_N) prices.shift();

      if (prev != null){
        const r = p - prev;
        returns.push(r);
        if (returns.length > HISTORY_N) returns.shift();
      }

      const f = computeFeatures();
      if (!f) return null;

      const probs = scoreStates(f);
      const det = pickState(probs);
      detectorState = det;

      const polRes = updatePolicy(det);
      const conf = confidence(probs, polRes.policy);

      return {
        tickN,
        features: f,
        probs,
        detector: det,
        policy: polRes.policy,
        hold: polRes.hold,
        conf
      };
    }

    return { step };
  })();

  // ---------- Macro → transmission ----------
  function normAbsPct(x, cap=1.5){
    // x is percent change, cap around 1.5% daily move for ETFs
    if (!Number.isFinite(x)) return 0;
    const a = Math.abs(x);
    return clamp(a / cap, 0, 1);
  }

  function computeTransmission(){
    const oil = MacroFeed.get("OIL");
    const gold = MacroFeed.get("GOLD");
    const silv = MacroFeed.get("SILV");
    const usd  = MacroFeed.get("USD");

    const eRisk = computeEventRisk01();

    // leverage sign: for EURUSD
    // oil up -> EUR down (negative)
    // usd up -> EUR down (negative)
    // gold up -> risk-off; often EUR down (negative)
    // silver up can be risk-on/growth; we treat it as slight offset to fear (optional)
    const oilInt = normAbsPct(oil?.changePct, 2.0);     // oil proxy can swing more
    const usdInt = normAbsPct(usd?.changePct, 1.0);
    const fearInt = normAbsPct(gold?.changePct, 1.5);
    const silvInt = normAbsPct(silv?.changePct, 2.0);

    // event lever is already 0..1
    const eventInt = eRisk;

    // directional components (negative bias for EURUSD)
    const oilDir = (oil?.changePct ?? 0) >= 0 ? -oilInt : +oilInt*0.4;  // oil down mildly supports EUR
    const usdDir = (usd?.changePct ?? 0) >= 0 ? -usdInt : +usdInt*0.5;  // weaker USD supports EUR
    const fearDir = (gold?.changePct ?? 0) >= 0 ? -fearInt : +fearInt*0.2;
    const silvDir = (silv?.changePct ?? 0) >= 0 ? +silvInt*0.25 : -silvInt*0.15;

    // combine into score in [-1, +1]
    const score =
      0.36*oilDir +
      0.44*usdDir +
      0.26*fearDir +
      0.10*silvDir +
      0.22*(-eventInt); // event proximity adds EUR risk premium

    const intensity = clamp(
      0.30*oilInt + 0.30*usdInt + 0.20*fearInt + 0.10*silvInt + 0.25*eventInt,
      0, 1
    );

    // macro bias label
    const bias = (score <= -0.18) ? "USD+RISK OFF" : (score >= 0.18) ? "USD WEAK / RISK ON" : "NEUTRAL";
    return { score: clamp(score, -1, 1), intensity, bias, components: { oilInt, usdInt, fearInt, eventInt } };
  }

  function leverPaint(barEl, pctEl, val01, dirHint){
    // val01 is 0..1
    const pct = Math.round(val01 * 100);
    pctEl.textContent = pct + "%";
    barEl.style.width = clamp(pct, 0, 100) + "%";

    // color by direction hint
    if (dirHint === "bad"){
      barEl.style.background = "rgba(255,77,77,0.85)";
    } else if (dirHint === "good"){
      barEl.style.background = "rgba(24,209,138,0.85)";
    } else {
      barEl.style.background = "rgba(120,170,255,0.80)";
    }
  }

  // ---------- Projection cone drawing ----------
  function drawCone({ spot, rng1hPips, rng4hPips, bias }){
    const c = els.coneCanvas;
    const ctx = c.getContext("2d");
    const w = c.width;
    const h = c.height;

    ctx.clearRect(0,0,w,h);

    // background grid
    ctx.globalAlpha = 1;
    ctx.fillStyle = "rgba(0,0,0,0)";
    ctx.fillRect(0,0,w,h);

    ctx.strokeStyle = "rgba(233,240,255,0.08)";
    ctx.lineWidth = 1;

    const gridX = 14, gridY = 8;
    for (let i=0;i<=gridX;i++){
      const x = i*(w/gridX);
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
    }
    for (let j=0;j<=gridY;j++){
      const y = j*(h/gridY);
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
    }

    // center point
    const cx = Math.round(w*0.46);
    const cy = Math.round(h*0.52);

    // cone extents
    const x1 = Math.round(w*0.62); // 1h marker
    const x4 = Math.round(w*0.90); // 4h marker

    // y scale: map pips to pixels
    const maxPips = Math.max(10, rng4hPips * 1.15);
    const pxPerPip = (h*0.35) / maxPips;

    const y1 = rng1hPips * pxPerPip;
    const y4 = rng4hPips * pxPerPip;

    // bias shading
    const biasUp = (bias === "LONG");
    const biasDn = (bias === "SHORT");

    // draw filled cone
    ctx.globalAlpha = 0.55;
    ctx.fillStyle = biasUp ? "rgba(24,209,138,0.20)" : biasDn ? "rgba(255,77,77,0.22)" : "rgba(120,170,255,0.18)";
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(x1, cy - y1);
    ctx.lineTo(x4, cy - y4);
    ctx.lineTo(x4, cy + y4);
    ctx.lineTo(x1, cy + y1);
    ctx.closePath();
    ctx.fill();

    // cone outlines
    ctx.globalAlpha = 0.9;
    ctx.strokeStyle = "rgba(233,240,255,0.28)";
    ctx.lineWidth = 1.5;

    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x4, cy - y4); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x4, cy + y4); ctx.stroke();

    ctx.globalAlpha = 1;
    // center line
    ctx.strokeStyle = "rgba(233,240,255,0.35)";
    ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(w,cy); ctx.stroke();

    // spot dot
    ctx.fillStyle = "rgba(233,240,255,0.95)";
    ctx.beginPath(); ctx.arc(cx, cy, 3.5, 0, Math.PI*2); ctx.fill();

    // labels
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    ctx.fillStyle = "rgba(233,240,255,0.72)";
    ctx.fillText(`Spot ${spot.toFixed(5)}`, cx + 10, cy + 4);

    ctx.fillText(`1h ±${rng1hPips}p`, x1 - 60, 18);
    ctx.fillText(`4h ±${rng4hPips}p`, x4 - 60, 18);

    // bias tag
    ctx.font = "14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillStyle = biasUp ? "rgba(24,209,138,0.95)" : biasDn ? "rgba(255,77,77,0.95)" : "rgba(233,240,255,0.80)";
    ctx.fillText(bias, 22, 24);
  }

  // ---------- Projection calc ----------
  function computeProjection(step, tx){
    // baseline pip ranges by regime (rough demo defaults)
    const basePips1hByState = {
      1: 6, 2: 10, 3: 7, 4: 12, 5: 18, 6: 16, 7: 14, 8: 26
    };
    const pol = step?.policy || 1;
    const volx = step?.features?.volx ?? 1;
    const momBp = bp(step?.features?.mom ?? 0);
    const conf = step?.conf ?? 0.25;

    const base1h = basePips1hByState[pol] ?? 8;

    // scale by vol proxy
    const volMult = clamp(0.75 + 0.18*volx, 0.65, 1.85);

    // transmission increases expected range by intensity
    const txMult = clamp(1.0 + 0.55*tx.intensity, 1.0, 1.6);

    // event risk inflates short-term range
    const eRisk = tx.components.eventInt;
    const evMult1h = clamp(1.0 + 0.65*eRisk, 1.0, 1.7);
    const evMult4h = clamp(1.0 + 0.35*eRisk, 1.0, 1.35);

    const rng1h = Math.round(base1h * volMult * txMult * evMult1h);
    const rng4h = Math.round(rng1h * 2.6 * evMult4h);

    // bias logic: blend momentum + transmission score
    const momDir = Math.tanh(momBp / 18); // [-1, +1]
    const score = clamp(0.55*momDir + 0.75*tx.score, -1, 1);

    const bias = (score >= 0.20) ? "LONG" : (score <= -0.20) ? "SHORT" : "NEUTRAL";

    // decision confidence: agreement between momentum and macro + base conf
    const agree = 1 - Math.abs(momDir - tx.score)/2; // 0..1
    const dec = clamp(0.35*conf + 0.45*agree + 0.20*(1 - eRisk*0.6), 0, 1);
    const decPct = Math.round(dec*100);

    return {
      bias,
      score,
      rng1hPips: clamp(rng1h, 3, 80),
      rng4hPips: clamp(rng4h, 6, 160),
      decPct,
      volMult,
      txMult,
      eRisk
    };
  }

  // ---------- Curated modal wiring ----------
  function openModal(){
    els.eventsEditor.value = JSON.stringify(curatedEvents, null, 2);
    els.headlinesEditor.value = JSON.stringify(curatedHeadlines, null, 2);
    els.modalBack.style.display = "flex";
  }
  function closeModal(){
    els.modalBack.style.display = "none";
  }
  els.editBtn.addEventListener("click", openModal);
  els.closeModalBtn.addEventListener("click", closeModal);
  els.modalBack.addEventListener("click", (e)=>{ if (e.target === els.modalBack) closeModal(); });

  els.resetCuratedBtn.addEventListener("click", ()=>{
    curatedEvents = structuredClone(curatedEventsDefault);
    curatedHeadlines = structuredClone(curatedHeadlinesDefault);
    els.eventsEditor.value = JSON.stringify(curatedEvents, null, 2);
    els.headlinesEditor.value = JSON.stringify(curatedHeadlines, null, 2);
  });

  els.saveCuratedBtn.addEventListener("click", ()=>{
    try{
      const ev = JSON.parse(els.eventsEditor.value);
      const hd = JSON.parse(els.headlinesEditor.value);
      if (!Array.isArray(ev) || !Array.isArray(hd)) throw new Error("Not arrays");
      curatedEvents = ev;
      curatedHeadlines = hd;
      localStorage.setItem(KEY.events, JSON.stringify(curatedEvents));
      localStorage.setItem(KEY.headlines, JSON.stringify(curatedHeadlines));
      renderEvents();
      renderHeadlines();
      closeModal();
    }catch(err){
      alert("Invalid JSON. Fix the JSON formatting before saving.");
    }
  });

  // ---------- Settings modal wiring ----------
  function openSettings(){
    els.tdKeyInput.value = settings.twelvedataKey || "";
    els.pollInput.value = String(settings.pollMs || 12000);
    els.settingsBack.style.display = "flex";
  }
  function closeSettings(){
    els.settingsBack.style.display = "none";
  }
  els.settingsBtn.addEventListener("click", openSettings);
  els.closeSettingsBtn.addEventListener("click", closeSettings);
  els.settingsBack.addEventListener("click", (e)=>{ if (e.target === els.settingsBack) closeSettings(); });

  els.resetSettingsBtn.addEventListener("click", ()=>{
    settings = { twelvedataKey: "", pollMs: 12000 };
    localStorage.setItem(KEY.settings, JSON.stringify(settings));
    openSettings();
  });

  els.saveSettingsBtn.addEventListener("click", ()=>{
    const key = String(els.tdKeyInput.value || "").trim();
    const poll = Number(els.pollInput.value || 12000);
    settings.twelvedataKey = key;
    settings.pollMs = Number.isFinite(poll) && poll >= 6000 ? Math.round(poll) : 12000;
    localStorage.setItem(KEY.settings, JSON.stringify(settings));
    closeSettings();
    // apply new poll interval on next reload (simple + safe)
    alert("Saved. Reload the page to apply polling cadence changes cleanly.");
  });

  // ---------- Pause + Sync ----------
  let paused = false;
  let stalePolls = 0;

  els.pauseBtn.addEventListener("click", ()=>{
    paused = !paused;
    els.pauseBtn.textContent = paused ? "Resume" : "Pause";
    els.sysStatus.textContent = paused ? "PAUSED" : "LIVE";

    if (paused){
      els.liveDot.style.background = "rgba(255,176,32,1)";
      els.liveDot.style.boxShadow = "0 0 0 4px rgba(255,176,32,0.18)";
      els.modeTag.textContent = "Mode: PAUSED";
    } else {
      els.liveDot.style.background = "rgba(24,209,138,1)";
      els.liveDot.style.boxShadow = "0 0 0 4px rgba(24,209,138,0.18)";
    }
  });

  els.syncBtn.addEventListener("click", async ()=>{
    await SpotFeed.tick(onSpotUpdate);
    await MacroFeed.tick();
    updateTransmissionAndProjection(lastStep);
  });

  // ---------- Transmission + projection update ----------
  let lastSpot = null;
  let lastStep = null;

  function updateTransmissionAndProjection(step){
    // compute transmission from macro + events
    const tx = computeTransmission();

    // chips
    els.macroBiasChip.textContent = tx.bias;
    const eRisk = tx.components.eventInt;
    els.eventRiskChip.textContent = labelEventRisk(eRisk);

    const txScoreStr = tx.score.toFixed(2);
    els.txScoreChip.textContent = txScoreStr;

    // macro transmission card
    const intensityPct = Math.round(tx.intensity * 100);
    let txLabel = "NEUTRAL";
    if (tx.score <= -0.18) txLabel = "BEAR EURUSD";
    if (tx.score >= 0.18) txLabel = "BULL EURUSD";

    els.txBig.textContent = txLabel;
    els.txMeta.textContent = `Score ${txScoreStr} · ${tx.bias} · Intensity ${intensityPct}%`;

    // levers (0..1)
    leverPaint(els.oilLeverBar, els.oilLeverPct, tx.components.oilInt, (MacroFeed.get("OIL")?.changePct ?? 0) >= 0 ? "bad" : "good");
    els.oilLeverMeta.textContent = "EU energy drag proxy (USO daily change)";

    leverPaint(els.usdLeverBar, els.usdLeverPct, tx.components.usdInt, (MacroFeed.get("USD")?.changePct ?? 0) >= 0 ? "bad" : "good");
    els.usdLeverMeta.textContent = "USD pressure proxy (UUP daily change)";

    leverPaint(els.fearLeverBar, els.fearLeverPct, tx.components.fearInt, (MacroFeed.get("GOLD")?.changePct ?? 0) >= 0 ? "bad" : "good");
    els.fearLeverMeta.textContent = "Risk-off tone proxy (GLD daily change)";

    leverPaint(els.eventLeverBar, els.eventLeverPct, tx.components.eventInt, tx.components.eventInt >= 0.35 ? "bad" : "neutral");
    els.eventLeverMeta.textContent = "High impact proximity (calendar)";

    // if we have a step + spot, project
    if (step && lastSpot && Number.isFinite(lastSpot.price)){
      const proj = computeProjection(step, tx);

      els.tradeBias.textContent = proj.bias;
      els.tradeBias.classList.remove("pos","neg");
      if (proj.bias === "LONG") els.tradeBias.classList.add("pos");
      if (proj.bias === "SHORT") els.tradeBias.classList.add("neg");

      const momBp = bp(step.features.mom).toFixed(1);
      els.tradeBiasMeta.textContent = `Macro ${txLabel} · Mom ${momBp}bp · Event ${Math.round(proj.eRisk*100)}%`;

      els.rng1h.textContent = `±${proj.rng1hPips} pips`;
      els.rng1hMeta.textContent = `Vol x${proj.volMult.toFixed(2)} · Macro x${proj.txMult.toFixed(2)}`;

      els.rng4h.textContent = `±${proj.rng4hPips} pips`;
      els.rng4hMeta.textContent = `Event x${(1.0 + 0.35*proj.eRisk).toFixed(2)} · Tx ${txScoreStr}`;

      els.decConf.textContent = `${proj.decPct}%`;
      els.decConf.classList.remove("pos","neg");
      if (proj.decPct >= 55) els.decConf.classList.add("pos");
      if (proj.decPct <= 30) els.decConf.classList.add("neg");

      els.decConfMeta.textContent = proj.decPct >= 55 ? "Higher agreement" : proj.decPct >= 40 ? "Mixed agreement" : "Low agreement, caution";

      // draw cone
      drawCone({ spot: lastSpot.price, rng1hPips: proj.rng1hPips, rng4hPips: proj.rng4hPips, bias: proj.bias });
    } else {
      // keep placeholders reasonable
      els.tradeBias.textContent = "--";
      els.rng1h.textContent = "--";
      els.rng4h.textContent = "--";
      els.decConf.textContent = "--";
    }
  }

  // ---------- Spot update handler ----------
  function onSpotUpdate(s){
    const now = Date.now();
    els.lastUpdate.textContent = fmtTime(now);

    if (!s.ok){
      setFxStatus("ERROR");
      els.quoteProvider.textContent = "Provider: --";
      els.fxSpotMeta.textContent = "Source: --";
      els.fxLatencyTag.textContent = "--";
      els.fxLastTag.textContent = "Last: --";
      els.fxSpotDelta.textContent = "0.00000";
      els.modeTag.textContent = "Mode: ERROR";
      stalePolls += 1;
      els.staleChip.textContent = String(stalePolls);
      return;
    }

    lastSpot = s;

    // quote UI
    els.fxSpotPrice.textContent = s.price.toFixed(5);
    els.quoteProvider.textContent = `Provider: ${s.provider || s.source || "--"}`;
    els.fxSpotMeta.textContent = `Source: ${s.source} · Cache: none · Demo safe`;
    els.fxSpotDelta.textContent = s.lastDelta.toFixed(5);
    els.fxLatencyTag.textContent = `${s.latencyMs ?? "--"}ms`;
    els.fxLastTag.textContent = `Last: ${fmtTime(s.ts)}`;
    els.modeTag.textContent = settings.twelvedataKey ? "Mode: LIVE" : "Mode: FREE";

    // delta spark bar
    const w = clamp(Math.abs(s.lastDelta) / 0.0012, 0, 1) * 100;
    els.miniBar.style.width = `${Math.max(10, w)}%`;
    els.miniBar.style.background = (s.lastDelta >= 0) ? "rgba(24,209,138,0.85)" : "rgba(255,77,77,0.85)";

    setFxStatus(s.status);

    if (s.status === "STALE") stalePolls += 1;
    else stalePolls = 0;
    els.staleChip.textContent = String(stalePolls);

    if (paused) return;

    const step = Engine.step(s.price);
    if (!step) return;

    lastStep = step;

    // state UI
    els.tickChip.textContent = String(step.tickN);
    const det = step.detector;
    const pol = step.policy;

    const confPct = (step.conf * 100).toFixed(1) + "%";
    const polName = STATES[pol-1]?.name || "--";
    const polDesc = STATES[pol-1]?.desc || "Waiting for signal.";

    els.policyStateTitle.textContent = `Policy State: S${pol} ${polName}`;
    els.policyStateDesc.textContent = polDesc;

    els.detectorChip.textContent = `S${det}`;
    els.policyChip.textContent = `S${pol}`;
    els.confChip.textContent = confPct;

    els.hystChip.textContent = (det === pol) ? "stable" : "holding";

    // risk card
    setRisk(pol, step.conf);

    // probabilities
    step.probs.forEach((p, i)=>{
      const pct = (p*100);
      probEls[i].bar.style.width = `${clamp(pct, 0, 100)}%`;
      probEls[i].bar.style.background = STATES[i].color;
      probEls[i].val.textContent = `${pct.toFixed(1)}%`;
    });

    // footer
    els.footPolicy.textContent = `S${pol}`;
    els.footDetector.textContent = `S${det}`;
    els.footHold.textContent = String(step.hold);

    // update transmission + projection
    updateTransmissionAndProjection(step);
  }

  // ---------- Start ----------
  async function start(){
    initProbUI();
    renderEvents();
    renderHeadlines();

    // hydrate macro cache immediately
    MacroFeed.hydrate();

    // initial transmission even before fresh macro
    updateTransmissionAndProjection(lastStep);

    // first tick
    await SpotFeed.tick(onSpotUpdate);

    // macro tick now, then periodically
    await MacroFeed.tick();
    updateTransmissionAndProjection(lastStep);

    // cadence
    const poll = Number(settings.pollMs) || 12000;

    setInterval(()=> SpotFeed.tick(onSpotUpdate), poll);

    // macro can be slower (daily data)
    setInterval(async ()=>{
      await MacroFeed.tick();
      updateTransmissionAndProjection(lastStep);
    }, 90_000);

    // countdown refresh
    setInterval(()=>{
      renderEvents();
      updateTransmissionAndProjection(lastStep);
    }, 30_000);
  }

  start();

})();
</script>
</body>
</html>
